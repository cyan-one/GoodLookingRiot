"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _FromWidgetPostMessageApi = _interopRequireDefault(require("./FromWidgetPostMessageApi"));

var _ToWidgetPostMessageApi = _interopRequireDefault(require("./ToWidgetPostMessageApi"));

var _Modal = _interopRequireDefault(require("./Modal"));

var _MatrixClientPeg = require("./MatrixClientPeg");

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _WidgetOpenIDPermissionsDialog = _interopRequireDefault(require("./components/views/dialogs/WidgetOpenIDPermissionsDialog"));

var _WidgetUtils = _interopRequireDefault(require("./utils/WidgetUtils"));

var _WidgetApi = require("./widgets/WidgetApi");

/*
Copyright 2017 New Vector Ltd
Copyright 2019 Travis Ralston

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/*
* See - https://docs.google.com/document/d/1uPF7XWY_dXTKVKV7jZQ2KmsI19wn9-kFRgQ1tFQP7wQ/edit?usp=sharing for
* spec. details / documentation.
*/
if (!global.mxFromWidgetMessaging) {
  global.mxFromWidgetMessaging = new _FromWidgetPostMessageApi.default();
  global.mxFromWidgetMessaging.start();
}

if (!global.mxToWidgetMessaging) {
  global.mxToWidgetMessaging = new _ToWidgetPostMessageApi.default();
  global.mxToWidgetMessaging.start();
}

const OUTBOUND_API_NAME = 'toWidget';

class WidgetMessaging {
  /**
   * @param {string} widgetId The widget's ID
   * @param {string} wurl The raw URL of the widget as in the event (the 'wURL')
   * @param {string} renderedUrl The url used in the widget's iframe (either similar to the wURL
   *     or a different URL of the clients choosing if it is using its own impl).
   * @param {bool} isUserWidget If true, the widget is a user widget, otherwise it's a room widget
   * @param {object} target Where widget messages should be sent (eg. the iframe object)
   */
  constructor(widgetId, wurl, renderedUrl, isUserWidget, target) {
    this.widgetId = widgetId;
    this.wurl = wurl;
    this.renderedUrl = renderedUrl;
    this.isUserWidget = isUserWidget;
    this.target = target;
    this.fromWidget = global.mxFromWidgetMessaging;
    this.toWidget = global.mxToWidgetMessaging;
    this._onOpenIdRequest = this._onOpenIdRequest.bind(this);
    this.start();
  }

  messageToWidget(action) {
    action.widgetId = this.widgetId; // Required to be sent for all outbound requests

    return this.toWidget.exec(action, this.target).then(data => {
      // Check for errors and reject if found
      if (data.response === undefined) {
        // null is valid
        throw new Error("Missing 'response' field");
      }

      if (data.response && data.response.error) {
        const err = data.response.error;
        const msg = String(err.message ? err.message : "An error was returned");

        if (err._error) {
          console.error(err._error);
        } // Potential XSS attack if 'msg' is not appropriately sanitized,
        // as it is untrusted input by our parent window (which we assume is Riot).
        // We can't aggressively sanitize [A-z0-9] since it might be a translation.


        throw new Error(msg);
      } // Return the response field for the request


      return data.response;
    });
  }
  /**
   * Tells the widget that the client is ready to handle further widget requests.
   * @returns {Promise<*>} Resolves after the widget has acknowledged the ready message.
   */


  flagReadyToContinue() {
    return this.messageToWidget({
      api: OUTBOUND_API_NAME,
      action: _WidgetApi.KnownWidgetActions.ClientReady
    });
  }
  /**
   * Request a screenshot from a widget
   * @return {Promise} To be resolved with screenshot data when it has been generated
   */


  getScreenshot() {
    console.log('Requesting screenshot for', this.widgetId);
    return this.messageToWidget({
      api: OUTBOUND_API_NAME,
      action: "screenshot"
    }).catch(error => new Error("Failed to get screenshot: " + error.message)).then(response => response.screenshot);
  }
  /**
   * Request capabilities required by the widget
   * @return {Promise} To be resolved with an array of requested widget capabilities
   */


  getCapabilities() {
    console.log('Requesting capabilities for', this.widgetId);
    return this.messageToWidget({
      api: OUTBOUND_API_NAME,
      action: "capabilities"
    }).then(response => {
      console.log('Got capabilities for', this.widgetId, response.capabilities);
      return response.capabilities;
    });
  }

  sendVisibility(visible) {
    return this.messageToWidget({
      api: OUTBOUND_API_NAME,
      action: "visibility",
      visible
    }).catch(error => {
      console.error("Failed to send visibility: ", error);
    });
  }

  start() {
    this.fromWidget.addEndpoint(this.widgetId, this.renderedUrl);
    this.fromWidget.addListener("get_openid", this._onOpenIdRequest);
  }

  stop() {
    this.fromWidget.removeEndpoint(this.widgetId, this.renderedUrl);
    this.fromWidget.removeListener("get_openid", this._onOpenIdRequest);
  }

  async _onOpenIdRequest(ev, rawEv) {
    if (ev.widgetId !== this.widgetId) return; // not interesting

    const widgetSecurityKey = _WidgetUtils.default.getWidgetSecurityKey(this.widgetId, this.wurl, this.isUserWidget);

    const settings = _SettingsStore.default.getValue("widgetOpenIDPermissions");

    if (settings.deny && settings.deny.includes(widgetSecurityKey)) {
      this.fromWidget.sendResponse(rawEv, {
        state: "blocked"
      });
      return;
    }

    if (settings.allow && settings.allow.includes(widgetSecurityKey)) {
      const responseBody = {
        state: "allowed"
      };
      const credentials = await _MatrixClientPeg.MatrixClientPeg.get().getOpenIdToken();
      Object.assign(responseBody, credentials);
      this.fromWidget.sendResponse(rawEv, responseBody);
      return;
    } // Confirm that we received the request


    this.fromWidget.sendResponse(rawEv, {
      state: "request"
    }); // Actually ask for permission to send the user's data

    _Modal.default.createTrackedDialog("OpenID widget permissions", '', _WidgetOpenIDPermissionsDialog.default, {
      widgetUrl: this.wurl,
      widgetId: this.widgetId,
      isUserWidget: this.isUserWidget,
      onFinished: async confirm => {
        const responseBody = {
          success: confirm
        };

        if (confirm) {
          const credentials = await _MatrixClientPeg.MatrixClientPeg.get().getOpenIdToken();
          Object.assign(responseBody, credentials);
        }

        this.messageToWidget({
          api: OUTBOUND_API_NAME,
          action: "openid_credentials",
          data: responseBody
        }).catch(error => {
          console.error("Failed to send OpenID credentials: ", error);
        });
      }
    });
  }

}

exports.default = WidgetMessaging;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XaWRnZXRNZXNzYWdpbmcuanMiXSwibmFtZXMiOlsiZ2xvYmFsIiwibXhGcm9tV2lkZ2V0TWVzc2FnaW5nIiwiRnJvbVdpZGdldFBvc3RNZXNzYWdlQXBpIiwic3RhcnQiLCJteFRvV2lkZ2V0TWVzc2FnaW5nIiwiVG9XaWRnZXRQb3N0TWVzc2FnZUFwaSIsIk9VVEJPVU5EX0FQSV9OQU1FIiwiV2lkZ2V0TWVzc2FnaW5nIiwiY29uc3RydWN0b3IiLCJ3aWRnZXRJZCIsInd1cmwiLCJyZW5kZXJlZFVybCIsImlzVXNlcldpZGdldCIsInRhcmdldCIsImZyb21XaWRnZXQiLCJ0b1dpZGdldCIsIl9vbk9wZW5JZFJlcXVlc3QiLCJiaW5kIiwibWVzc2FnZVRvV2lkZ2V0IiwiYWN0aW9uIiwiZXhlYyIsInRoZW4iLCJkYXRhIiwicmVzcG9uc2UiLCJ1bmRlZmluZWQiLCJFcnJvciIsImVycm9yIiwiZXJyIiwibXNnIiwiU3RyaW5nIiwibWVzc2FnZSIsIl9lcnJvciIsImNvbnNvbGUiLCJmbGFnUmVhZHlUb0NvbnRpbnVlIiwiYXBpIiwiS25vd25XaWRnZXRBY3Rpb25zIiwiQ2xpZW50UmVhZHkiLCJnZXRTY3JlZW5zaG90IiwibG9nIiwiY2F0Y2giLCJzY3JlZW5zaG90IiwiZ2V0Q2FwYWJpbGl0aWVzIiwiY2FwYWJpbGl0aWVzIiwic2VuZFZpc2liaWxpdHkiLCJ2aXNpYmxlIiwiYWRkRW5kcG9pbnQiLCJhZGRMaXN0ZW5lciIsInN0b3AiLCJyZW1vdmVFbmRwb2ludCIsInJlbW92ZUxpc3RlbmVyIiwiZXYiLCJyYXdFdiIsIndpZGdldFNlY3VyaXR5S2V5IiwiV2lkZ2V0VXRpbHMiLCJnZXRXaWRnZXRTZWN1cml0eUtleSIsInNldHRpbmdzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiZGVueSIsImluY2x1ZGVzIiwic2VuZFJlc3BvbnNlIiwic3RhdGUiLCJhbGxvdyIsInJlc3BvbnNlQm9keSIsImNyZWRlbnRpYWxzIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0T3BlbklkVG9rZW4iLCJPYmplY3QiLCJhc3NpZ24iLCJNb2RhbCIsImNyZWF0ZVRyYWNrZWREaWFsb2ciLCJXaWRnZXRPcGVuSURQZXJtaXNzaW9uc0RpYWxvZyIsIndpZGdldFVybCIsIm9uRmluaXNoZWQiLCJjb25maXJtIiwic3VjY2VzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBc0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQTdCQTs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkE7Ozs7QUFjQSxJQUFJLENBQUNBLE1BQU0sQ0FBQ0MscUJBQVosRUFBbUM7QUFDL0JELEVBQUFBLE1BQU0sQ0FBQ0MscUJBQVAsR0FBK0IsSUFBSUMsaUNBQUosRUFBL0I7QUFDQUYsRUFBQUEsTUFBTSxDQUFDQyxxQkFBUCxDQUE2QkUsS0FBN0I7QUFDSDs7QUFDRCxJQUFJLENBQUNILE1BQU0sQ0FBQ0ksbUJBQVosRUFBaUM7QUFDN0JKLEVBQUFBLE1BQU0sQ0FBQ0ksbUJBQVAsR0FBNkIsSUFBSUMsK0JBQUosRUFBN0I7QUFDQUwsRUFBQUEsTUFBTSxDQUFDSSxtQkFBUCxDQUEyQkQsS0FBM0I7QUFDSDs7QUFFRCxNQUFNRyxpQkFBaUIsR0FBRyxVQUExQjs7QUFFZSxNQUFNQyxlQUFOLENBQXNCO0FBQ2pDOzs7Ozs7OztBQVFBQyxFQUFBQSxXQUFXLENBQUNDLFFBQUQsRUFBV0MsSUFBWCxFQUFpQkMsV0FBakIsRUFBOEJDLFlBQTlCLEVBQTRDQyxNQUE1QyxFQUFvRDtBQUMzRCxTQUFLSixRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkEsWUFBcEI7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxVQUFMLEdBQWtCZCxNQUFNLENBQUNDLHFCQUF6QjtBQUNBLFNBQUtjLFFBQUwsR0FBZ0JmLE1B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QUFyQixFQUlHeEIsS0FKSCxDQUlVYixLQUFELElBQVc7QUFDaEJNLFVBQUFBLE9BQU8sQ0FBQ04sS0FBUixDQUFjLHFDQUFkLEVBQXFEQSxLQUFyRDtBQUNILFNBTkQ7QUFPSDtBQWxCMEIsS0FEbkM7QUFzQkg7O0FBdEpnQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgVHJhdmlzIFJhbHN0b25cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG4vKlxuKiBTZWUgLSBodHRwczovL2RvY3MuZ29vZ2xlLmNvbS9kb2N1bWVudC9kLzF1UEY3WFdZX2RYVEtWS1Y3alpRMkttc0kxOXduOS1rRlJnUTF0RlFQN3dRL2VkaXQ/dXNwPXNoYXJpbmcgZm9yXG4qIHNwZWMuIGRldGFpbHMgLyBkb2N1bWVudGF0aW9uLlxuKi9cblxuaW1wb3J0IEZyb21XaWRnZXRQb3N0TWVzc2FnZUFwaSBmcm9tICcuL0Zyb21XaWRnZXRQb3N0TWVzc2FnZUFwaSc7XG5pbXBvcnQgVG9XaWRnZXRQb3N0TWVzc2FnZUFwaSBmcm9tICcuL1RvV2lkZ2V0UG9zdE1lc3NhZ2VBcGknO1xuaW1wb3J0IE1vZGFsIGZyb20gXCIuL01vZGFsXCI7XG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSBcIi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgV2lkZ2V0T3BlbklEUGVybWlzc2lvbnNEaWFsb2cgZnJvbSBcIi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL1dpZGdldE9wZW5JRFBlcm1pc3Npb25zRGlhbG9nXCI7XG5pbXBvcnQgV2lkZ2V0VXRpbHMgZnJvbSBcIi4vdXRpbHMvV2lkZ2V0VXRpbHNcIjtcbmltcG9ydCB7S25vd25XaWRnZXRBY3Rpb25zfSBmcm9tIFwiLi93aWRnZXRzL1dpZGdldEFwaVwiO1xuXG5pZiAoIWdsb2JhbC5teEZyb21XaWRnZXRNZXNzYWdpbmcpIHtcbiAgICBnbG9iYWwubXhGcm9tV2lkZ2V0TWVzc2FnaW5nID0gbmV3IEZyb21XaWRnZXRQb3N0TWVzc2FnZUFwaSgpO1xuICAgIGdsb2JhbC5teEZyb21XaWRnZXRNZXNzYWdpbmcuc3RhcnQoKTtcbn1cbmlmICghZ2xvYmFsLm14VG9XaWRnZXRNZXNzYWdpbmcpIHtcbiAgICBnbG9iYWwubXhUb1dpZGdldE1lc3NhZ2luZyA9IG5ldyBUb1dpZGdldFBvc3RNZXNzYWdlQXBpKCk7XG4gICAgZ2xvYmFsLm14VG9XaWRnZXRNZXNzYWdpbmcuc3RhcnQoKTtcbn1cblxuY29uc3QgT1VUQk9VTkRfQVBJX05BTUUgPSAndG9XaWRnZXQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXaWRnZXRNZXNzYWdpbmcge1xuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aWRnZXRJZCBUaGUgd2lkZ2V0J3MgSURcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gd3VybCBUaGUgcmF3IFVSTCBvZiB0aGUgd2lkZ2V0IGFzIGluIHRoZSBldmVudCAodGhlICd3VVJMJylcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVuZGVyZWRVcmwgVGhlIHVybCB1c2VkIGluIHRoZSB3aWRnZXQncyBpZnJhbWUgKGVpdGhlciBzaW1pbGFyIHRvIHRoZSB3VVJMXG4gICAgICogICAgIG9yIGEgZGlmZmVyZW50IFVSTCBvZiB0aGUgY2xpZW50cyBjaG9vc2luZyBpZiBpdCBpcyB1c2luZyBpdHMgb3duIGltcGwpLlxuICAgICAqIEBwYXJhbSB7Ym9vbH0gaXNVc2VyV2lkZ2V0IElmIHRydWUsIHRoZSB3aWRnZXQgaXMgYSB1c2VyIHdpZGdldCwgb3RoZXJ3aXNlIGl0J3MgYSByb29tIHdpZGdldFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSB0YXJnZXQgV2hlcmUgd2lkZ2V0IG1lc3NhZ2VzIHNob3VsZCBiZSBzZW50IChlZy4gdGhlIGlmcmFtZSBvYmplY3QpXG4gICAgICovXG4gICAgY29uc3RydWN0b3Iod2lkZ2V0SWQsIHd1cmwsIHJlbmRlcmVkVXJsLCBpc1VzZXJXaWRnZXQsIHRhcmdldCkge1xuICAgICAgICB0aGlzLndpZGdldElkID0gd2lkZ2V0SWQ7XG4gICAgICAgIHRoaXMud3VybCA9IHd1cmw7XG4gICAgICAgIHRoaXMucmVuZGVyZWRVcmwgPSByZW5kZXJlZFVybDtcbiAgICAgICAgdGhpcy5pc1VzZXJXaWRnZXQgPSBpc1VzZXJXaWRnZXQ7XG4gICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0O1xuICAgICAgICB0aGlzLmZyb21XaWRnZXQgPSBnbG9iYWwubXhGcm9tV2lkZ2V0TWVzc2FnaW5nO1xuICAgICAgICB0aGlzLnRvV2lkZ2V0ID0gZ2xvYmFsLm14VG9XaWRnZXRNZXNzYWdpbmc7XG4gICAgICAgIHRoaXMuX29uT3BlbklkUmVxdWVzdCA9IHRoaXMuX29uT3BlbklkUmVxdWVzdC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgbWVzc2FnZVRvV2lkZ2V0KGFjdGlvbikge1xuICAgICAgICBhY3Rpb24ud2lkZ2V0SWQgPSB0aGlzLndpZGdldElkOyAvLyBSZXF1aXJlZCB0byBiZSBzZW50IGZvciBhbGwgb3V0Ym91bmQgcmVxdWVzdHNcblxuICAgICAgICByZXR1cm4gdGhpcy50b1dpZGdldC5leGVjKGFjdGlvbiwgdGhpcy50YXJnZXQpLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgIC8vIENoZWNrIGZvciBlcnJvcnMgYW5kIHJlamVjdCBpZiBmb3VuZFxuICAgICAgICAgICAgaWYgKGRhdGEucmVzcG9uc2UgPT09IHVuZGVmaW5lZCkgeyAvLyBudWxsIGlzIHZhbGlkXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzc2luZyAncmVzcG9uc2UnIGZpZWxkXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRhdGEucmVzcG9uc2UgJiYgZGF0YS5yZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVyciA9IGRhdGEucmVzcG9uc2UuZXJyb3I7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0gU3RyaW5nKGVyci5tZXNzYWdlID8gZXJyLm1lc3NhZ2UgOiBcIkFuIGVycm9yIHdhcyByZXR1cm5lZFwiKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLl9lcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVyci5fZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBQb3RlbnRpYWwgWFNTIGF0dGFjayBpZiAnbXNnJyBpcyBub3QgYXBwcm9wcmlhdGVseSBzYW5pdGl6ZWQsXG4gICAgICAgICAgICAgICAgLy8gYXMgaXQgaXMgdW50cnVzdGVkIGlucHV0IGJ5IG91ciBwYXJlbnQgd2luZG93ICh3aGljaCB3ZSBhc3N1bWUgaXMgUmlvdCkuXG4gICAgICAgICAgICAgICAgLy8gV2UgY2FuJ3QgYWdncmVzc2l2ZWx5IHNhbml0aXplIFtBLXowLTldIHNpbmNlIGl0IG1pZ2h0IGJlIGEgdHJhbnNsYXRpb24uXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBSZXR1cm4gdGhlIHJlc3BvbnNlIGZpZWxkIGZvciB0aGUgcmVxdWVzdFxuICAgICAgICAgICAgcmV0dXJuIGRhdGEucmVzcG9uc2U7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlbGxzIHRoZSB3aWRnZXQgdGhhdCB0aGUgY2xpZW50IGlzIHJlYWR5IHRvIGhhbmRsZSBmdXJ0aGVyIHdpZGdldCByZXF1ZXN0cy5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTwqPn0gUmVzb2x2ZXMgYWZ0ZXIgdGhlIHdpZGdldCBoYXMgYWNrbm93bGVkZ2VkIHRoZSByZWFkeSBtZXNzYWdlLlxuICAgICAqL1xuICAgIGZsYWdSZWFkeVRvQ29udGludWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VUb1dpZGdldCh7XG4gICAgICAgICAgICBhcGk6IE9VVEJPVU5EX0FQSV9OQU1FLFxuICAgICAgICAgICAgYWN0aW9uOiBLbm93bldpZGdldEFjdGlvbnMuQ2xpZW50UmVhZHksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVlc3QgYSBzY3JlZW5zaG90IGZyb20gYSB3aWRnZXRcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBUbyBiZSByZXNvbHZlZCB3aXRoIHNjcmVlbnNob3QgZGF0YSB3aGVuIGl0IGhhcyBiZWVuIGdlbmVyYXRlZFxuICAgICAqL1xuICAgIGdldFNjcmVlbnNob3QoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0aW5nIHNjcmVlbnNob3QgZm9yJywgdGhpcy53aWRnZXRJZCk7XG4gICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VUb1dpZGdldCh7XG4gICAgICAgICAgICAgICAgYXBpOiBPVVRCT1VORF9BUElfTkFNRSxcbiAgICAgICAgICAgICAgICBhY3Rpb246IFwic2NyZWVuc2hvdFwiLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IG5ldyBFcnJvcihcIkZhaWxlZCB0byBnZXQgc2NyZWVuc2hvdDogXCIgKyBlcnJvci5tZXNzYWdlKSlcbiAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2Uuc2NyZWVuc2hvdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVxdWVzdCBjYXBhYmlsaXRpZXMgcmVxdWlyZWQgYnkgdGhlIHdpZGdldFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9IFRvIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkgb2YgcmVxdWVzdGVkIHdpZGdldCBjYXBhYmlsaXRpZXNcbiAgICAgKi9cbiAgICBnZXRDYXBhYmlsaXRpZXMoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0aW5nIGNhcGFiaWxpdGllcyBmb3InLCB0aGlzLndpZGdldElkKTtcbiAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZVRvV2lkZ2V0KHtcbiAgICAgICAgICAgICAgICBhcGk6IE9VVEJPVU5EX0FQSV9OQU1FLFxuICAgICAgICAgICAgICAgIGFjdGlvbjogXCJjYXBhYmlsaXRpZXNcIixcbiAgICAgICAgICAgIH0pLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0dvdCBjYXBhYmlsaXRpZXMgZm9yJywgdGhpcy53aWRnZXRJZCwgcmVzcG9uc2UuY2FwYWJpbGl0aWVzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuY2FwYWJpbGl0aWVzO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2VuZFZpc2liaWxpdHkodmlzaWJsZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlVG9XaWRnZXQoe1xuICAgICAgICAgICAgYXBpOiBPVVRCT1VORF9BUElfTkFNRSxcbiAgICAgICAgICAgIGFjdGlvbjogXCJ2aXNpYmlsaXR5XCIsXG4gICAgICAgICAgICB2aXNpYmxlLFxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHNlbmQgdmlzaWJpbGl0eTogXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMuZnJvbVdpZGdldC5hZGRFbmRwb2ludCh0aGlzLndpZGdldElkLCB0aGlzLnJlbmRlcmVkVXJsKTtcbiAgICAgICAgdGhpcy5mcm9tV2lkZ2V0LmFkZExpc3RlbmVyKFwiZ2V0X29wZW5pZFwiLCB0aGlzLl9vbk9wZW5JZFJlcXVlc3QpO1xuICAgIH1cblxuICAgIHN0b3AoKSB7XG4gICAgICAgIHRoaXMuZnJvbVdpZGdldC5yZW1vdmVFbmRwb2ludCh0aGlzLndpZGdldElkLCB0aGlzLnJlbmRlcmVkVXJsKTtcbiAgICAgICAgdGhpcy5mcm9tV2lkZ2V0LnJlbW92ZUxpc3RlbmVyKFwiZ2V0X29wZW5pZFwiLCB0aGlzLl9vbk9wZW5JZFJlcXVlc3QpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vbk9wZW5JZFJlcXVlc3QoZXYsIHJhd0V2KSB7XG4gICAgICAgIGlmIChldi53aWRnZXRJZCAhPT0gdGhpcy53aWRnZXRJZCkgcmV0dXJuOyAvLyBub3QgaW50ZXJlc3RpbmdcblxuICAgICAgICBjb25zdCB3aWRnZXRTZWN1cml0eUtleSA9IFdpZGdldFV0aWxzLmdldFdpZGdldFNlY3VyaXR5S2V5KHRoaXMud2lkZ2V0SWQsIHRoaXMud3VybCwgdGhpcy5pc1VzZXJXaWRnZXQpO1xuXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIndpZGdldE9wZW5JRFBlcm1pc3Npb25zXCIpO1xuICAgICAgICBpZiAoc2V0dGluZ3MuZGVueSAmJiBzZXR0aW5ncy5kZW55LmluY2x1ZGVzKHdpZGdldFNlY3VyaXR5S2V5KSkge1xuICAgICAgICAgICAgdGhpcy5mcm9tV2lkZ2V0LnNlbmRSZXNwb25zZShyYXdFdiwge3N0YXRlOiBcImJsb2NrZWRcIn0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzZXR0aW5ncy5hbGxvdyAmJiBzZXR0aW5ncy5hbGxvdy5pbmNsdWRlcyh3aWRnZXRTZWN1cml0eUtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlQm9keSA9IHtzdGF0ZTogXCJhbGxvd2VkXCJ9O1xuICAgICAgICAgICAgY29uc3QgY3JlZGVudGlhbHMgPSBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0T3BlbklkVG9rZW4oKTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocmVzcG9uc2VCb2R5LCBjcmVkZW50aWFscyk7XG4gICAgICAgICAgICB0aGlzLmZyb21XaWRnZXQuc2VuZFJlc3BvbnNlKHJhd0V2LCByZXNwb25zZUJvZHkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ29uZmlybSB0aGF0IHdlIHJlY2VpdmVkIHRoZSByZXF1ZXN0XG4gICAgICAgIHRoaXMuZnJvbVdpZGdldC5zZW5kUmVzcG9uc2UocmF3RXYsIHtzdGF0ZTogXCJyZXF1ZXN0XCJ9KTtcblxuICAgICAgICAvLyBBY3R1YWxseSBhc2sgZm9yIHBlcm1pc3Npb24gdG8gc2VuZCB0aGUgdXNlcidzIGRhdGFcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIk9wZW5JRCB3aWRnZXQgcGVybWlzc2lvbnNcIiwgJycsXG4gICAgICAgICAgICBXaWRnZXRPcGVuSURQZXJtaXNzaW9uc0RpYWxvZywge1xuICAgICAgICAgICAgICAgIHdpZGdldFVybDogdGhpcy53dXJsLFxuICAgICAgICAgICAgICAgIHdpZGdldElkOiB0aGlzLndpZGdldElkLFxuICAgICAgICAgICAgICAgIGlzVXNlcldpZGdldDogdGhpcy5pc1VzZXJXaWRnZXQsXG5cbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkOiBhc3luYyAoY29uZmlybSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZUJvZHkgPSB7c3VjY2VzczogY29uZmlybX07XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25maXJtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVkZW50aWFscyA9IGF3YWl0IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRPcGVuSWRUb2tlbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihyZXNwb25zZUJvZHksIGNyZWRlbnRpYWxzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VUb1dpZGdldCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcGk6IE9VVEJPVU5EX0FQSV9OQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBcIm9wZW5pZF9jcmVkZW50aWFsc1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2VCb2R5LFxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gc2VuZCBPcGVuSUQgY3JlZGVudGlhbHM6IFwiLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==