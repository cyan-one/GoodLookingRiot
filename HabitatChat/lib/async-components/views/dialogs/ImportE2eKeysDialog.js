"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var _matrixJsSdk = require("matrix-js-sdk");

var MegolmExportEncryption = _interopRequireWildcard(require("../../../utils/MegolmExportEncryption"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _languageHandler = require("../../../languageHandler");

/*
Copyright 2017 Vector Creations Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function readFileAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = e => {
      resolve(e.target.result);
    };

    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

const PHASE_EDIT = 1;
const PHASE_IMPORTING = 2;

var _default = (0, _createReactClass.default)({
  displayName: 'ImportE2eKeysDialog',
  propTypes: {
    matrixClient: _propTypes.default.instanceOf(_matrixJsSdk.MatrixClient).isRequired,
    onFinished: _propTypes.default.func.isRequired
  },
  getInitialState: function () {
    return {
      enableSubmit: false,
      phase: PHASE_EDIT,
      errStr: null
    };
  },
  // TODO: [REACT-WARNING] Replace component with real class, use constructor for refs
  UNSAFE_componentWillMount: function () {
    this._unmounted = false;
    this._file = (0, _react.createRef)();
    this._passphrase = (0, _react.createRef)();
  },
  componentWillUnmount: function () {
    this._unmounted = true;
  },
  _onFormChange: function (ev) {
    const files = this._file.current.files || [];
    this.setState({
      enableSubmit: this._passphrase.current.value !== "" && files.length > 0
    });
  },
  _onFormSubmit: function (ev) {
    ev.preventDefault();

    this._startImport(this._file.current.files[0], this._passphrase.current.value);

    return false;
  },
  _startImport: function (file, passphrase) {
    this.setState({
      errStr: null,
      phase: PHASE_IMPORTING
    });
    return readFileAsArrayBuffer(file).then(arrayBuffer => {
      return MegolmExportEncryption.decryptMegolmKeyFile(arrayBuffer, passphrase);
    }).then(keys => {
      return this.props.matrixClient.importRoomKeys(JSON.parse(keys));
    }).then(() => {
      // TODO: it would probably be nice to give some feedback about what we've imported here.
      this.props.onFinished(true);
    }).catch(e => {
      console.error("Error importing e2e keys:", e);

      if (this._unmounted) {
        return;
      }

      const msg = e.friendlyText || (0, _languageHandler._t)('Unknown error');
      this.setState({
        errStr: msg,
        phase: PHASE_EDIT
      });
    });
  },
  _onCancelClick: function (ev) {
    ev.preventDefault();
    this.props.onFinished(false);
    return false;
  },
  render: function () {
    const BaseDialog = sdk.getComponent('views.dialogs.BaseDialog');
    const disableForm = this.state.phase !== PHASE_EDIT;
    return /*#__PURE__*/_react.default.createElement(BaseDialog, {
      className: "mx_importE2eKeysDialog",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("Import room keys")
    }, /*#__PURE__*/_react.default.createElement("form", {
      onSubmit: this._onFormSubmit
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_content"
    }, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('This process allows you to import encryption keys ' + 'that you had previously exported from another Matrix ' + 'client. You will then be able to decrypt any ' + 'messages that the other client could decrypt.')), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)('The export file will be protected with a passphrase. ' + 'You should enter the passphrase here, to decrypt the file.')), /*#__PURE__*/_react.default.createElement("div", {
      className: "error"
    }, this.state.errStr), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputTable"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "importFile"
    }, (0, _languageHandler._t)("File to import"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this._file,
      id: "importFile",
      type: "file",
      autoFocus: true,
      onChange: this._onFormChange,
      disabled: disableForm
    }))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputRow"
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputLabel"
    }, /*#__PURE__*/_react.default.createElement("label", {
      htmlFor: "passphrase"
    }, (0, _languageHandler._t)("Enter passphrase"))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_E2eKeysDialog_inputCell"
    }, /*#__PURE__*/_react.default.createElement("input", {
      ref: this._passphrase,
      id: "passphrase",
      size: "64",
      type: "password",
      onChange: this._onFormChange,
      disabled: disableForm
    }))))), /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_buttons"
    }, /*#__PURE__*/_react.default.createElement("input", {
      className: "mx_Dialog_primary",
      type: "submit",
      value: (0, _languageHandler._t)('Import'),
      disabled: !this.state.enableSubmit || disableForm
    }), /*#__PURE__*/_react.default.createElement("button", {
      onClick: this._onCancelClick,
      disabled: disableForm
    }, (0, _languageHandler._t)("Cancel")))));
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hc3luYy1jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW1wb3J0RTJlS2V5c0RpYWxvZy5qcyJdLCJuYW1lcyI6WyJyZWFkRmlsZUFzQXJyYXlCdWZmZXIiLCJmaWxlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJyZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiZSIsInRhcmdldCIsInJlc3VsdCIsIm9uZXJyb3IiLCJyZWFkQXNBcnJheUJ1ZmZlciIsIlBIQVNFX0VESVQiLCJQSEFTRV9JTVBPUlRJTkciLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsIm1hdHJpeENsaWVudCIsIlByb3BUeXBlcyIsImluc3RhbmNlT2YiLCJNYXRyaXhDbGllbnQiLCJpc1JlcXVpcmVkIiwib25GaW5pc2hlZCIsImZ1bmMiLCJnZXRJbml0aWFsU3RhdGUiLCJlbmFibGVTdWJtaXQiLCJwaGFzZSIsImVyclN0ciIsIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiLCJfdW5tb3VudGVkIiwiX2ZpbGUiLCJfcGFzc3BocmFzZSIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiX29uRm9ybUNoYW5nZSIsImV2IiwiZmlsZXMiLCJjdXJyZW50Iiwic2V0U3RhdGUiLCJ2YWx1ZSIsImxlbmd0aCIsIl9vbkZvcm1TdWJtaXQiLCJwcmV2ZW50RGVmYXVsdCIsIl9zdGFydEltcG9ydCIsInBhc3NwaHJhc2UiLCJ0aGVuIiwiYXJyYXlCdWZmZXIiLCJNZWdvbG1FeHBvcnRFbmNyeXB0aW9uIiwiZGVjcnlwdE1lZ29sbUtleUZpbGUiLCJrZXlzIiwicHJvcHMiLCJpbXBvcnRSb29tS2V5cyIsIkpTT04iLCJwYXJzZSIsImNhdGNoIiwiY29uc29sZSIsImVycm9yIiwibXNnIiwiZnJpZW5kbHlUZXh0IiwiX29uQ2FuY2VsQ2xpY2siLCJyZW5kZXIiLCJCYXNlRGlhbG9nIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiZGlzYWJsZUZvcm0iLCJzdGF0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OEI7QUFOZCxNQURKLENBTkgsQ0FqQkosQ0FsQkosQ0FESixlQXNESTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0k7QUFBTyxNQUFBLFNBQVMsRUFBQyxtQkFBakI7QUFBcUMsTUFBQSxJQUFJLEVBQUMsUUFBMUM7QUFBbUQsTUFBQSxLQUFLLEVBQUUseUJBQUcsUUFBSCxDQUExRDtBQUNJLE1BQUEsUUFBUSxFQUFFLENBQUMsS0FBS0MsS0FBTCxDQUFXdkMsWUFBWixJQUE0QnNDO0FBRDFDLE1BREosZUFJSTtBQUFRLE1BQUEsT0FBTyxFQUFFLEtBQUtMLGNBQXRCO0FBQXNDLE1BQUEsUUFBUSxFQUFFSztBQUFoRCxPQUNNLHlCQUFHLFFBQUgsQ0FETixDQUpKLENBdERKLENBSkosQ0FESjtBQXNFSDtBQXRKMkIsQ0FBakIsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwge2NyZWF0ZVJlZn0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gJ21hdHJpeC1qcy1zZGsnO1xuaW1wb3J0ICogYXMgTWVnb2xtRXhwb3J0RW5jcnlwdGlvbiBmcm9tICcuLi8uLi8uLi91dGlscy9NZWdvbG1FeHBvcnRFbmNyeXB0aW9uJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi8uLi8uLi9pbmRleCc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5cbmZ1bmN0aW9uIHJlYWRGaWxlQXNBcnJheUJ1ZmZlcihmaWxlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChlKSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKGUudGFyZ2V0LnJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICAgIHJlYWRlci5vbmVycm9yID0gcmVqZWN0O1xuXG4gICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlKTtcbiAgICB9KTtcbn1cblxuY29uc3QgUEhBU0VfRURJVCA9IDE7XG5jb25zdCBQSEFTRV9JTVBPUlRJTkcgPSAyO1xuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVSZWFjdENsYXNzKHtcbiAgICBkaXNwbGF5TmFtZTogJ0ltcG9ydEUyZUtleXNEaWFsb2cnLFxuXG4gICAgcHJvcFR5cGVzOiB7XG4gICAgICAgIG1hdHJpeENsaWVudDogUHJvcFR5cGVzLmluc3RhbmNlT2YoTWF0cml4Q2xpZW50KS5pc1JlcXVpcmVkLFxuICAgICAgICBvbkZpbmlzaGVkOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIH0sXG5cbiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZW5hYmxlU3VibWl0OiBmYWxzZSxcbiAgICAgICAgICAgIHBoYXNlOiBQSEFTRV9FRElULFxuICAgICAgICAgICAgZXJyU3RyOiBudWxsLFxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICAvLyBUT0RPOiBbUkVBQ1QtV0FSTklOR10gUmVwbGFjZSBjb21wb25lbnQgd2l0aCByZWFsIGNsYXNzLCB1c2UgY29uc3RydWN0b3IgZm9yIHJlZnNcbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5fdW5tb3VudGVkID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5fZmlsZSA9IGNyZWF0ZVJlZigpO1xuICAgICAgICB0aGlzLl9wYXNzcGhyYXNlID0gY3JlYXRlUmVmKCk7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5fdW5tb3VudGVkID0gdHJ1ZTtcbiAgICB9LFxuXG4gICAgX29uRm9ybUNoYW5nZTogZnVuY3Rpb24oZXYpIHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLl9maWxlLmN1cnJlbnQuZmlsZXMgfHwgW107XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgZW5hYmxlU3VibWl0OiAodGhpcy5fcGFzc3BocmFzZS5jdXJyZW50LnZhbHVlICE9PSBcIlwiICYmIGZpbGVzLmxlbmd0aCA+IDApLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgX29uRm9ybVN1Ym1pdDogZnVuY3Rpb24oZXYpIHtcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5fc3RhcnRJbXBvcnQodGhpcy5fZmlsZS5jdXJyZW50LmZpbGVzWzBdLCB0aGlzLl9wYXNzcGhyYXNlLmN1cnJlbnQudmFsdWUpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSxcblxuICAgIF9zdGFydEltcG9ydDogZnVuY3Rpb24oZmlsZSwgcGFzc3BocmFzZSkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGVyclN0cjogbnVsbCxcbiAgICAgICAgICAgIHBoYXNlOiBQSEFTRV9JTVBPUlRJTkcsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZWFkRmlsZUFzQXJyYXlCdWZmZXIoZmlsZSkudGhlbigoYXJyYXlCdWZmZXIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBNZWdvbG1FeHBvcnRFbmNyeXB0aW9uLmRlY3J5cHRNZWdvbG1LZXlGaWxlKFxuICAgICAgICAgICAgICAgIGFycmF5QnVmZmVyLCBwYXNzcGhyYXNlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSkudGhlbigoa2V5cykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWF0cml4Q2xpZW50LmltcG9ydFJvb21LZXlzKEpTT04ucGFyc2Uoa2V5cykpO1xuICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIC8vIFRPRE86IGl0IHdvdWxkIHByb2JhYmx5IGJlIG5pY2UgdG8gZ2l2ZSBzb21lIGZlZWRiYWNrIGFib3V0IHdoYXQgd2UndmUgaW1wb3J0ZWQgaGVyZS5cbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCh0cnVlKTtcbiAgICAgICAgfSkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBpbXBvcnRpbmcgZTJlIGtleXM6XCIsIGUpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX3VubW91bnRlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGUuZnJpZW5kbHlUZXh0IHx8IF90KCdVbmtub3duIGVycm9yJyk7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBlcnJTdHI6IG1zZyxcbiAgICAgICAgICAgICAgICBwaGFzZTogUEhBU0VfRURJVCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgX29uQ2FuY2VsQ2xpY2s6IGZ1bmN0aW9uKGV2KSB7XG4gICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZChmYWxzZSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc3QgQmFzZURpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoJ3ZpZXdzLmRpYWxvZ3MuQmFzZURpYWxvZycpO1xuXG4gICAgICAgIGNvbnN0IGRpc2FibGVGb3JtID0gKHRoaXMuc3RhdGUucGhhc2UgIT09IFBIQVNFX0VESVQpO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZyBjbGFzc05hbWU9J214X2ltcG9ydEUyZUtleXNEaWFsb2cnXG4gICAgICAgICAgICAgICAgb25GaW5pc2hlZD17dGhpcy5wcm9wcy5vbkZpbmlzaGVkfVxuICAgICAgICAgICAgICAgIHRpdGxlPXtfdChcIkltcG9ydCByb29tIGtleXNcIil9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGZvcm0gb25TdWJtaXQ9e3RoaXMuX29uRm9ybVN1Ym1pdH0+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGlhbG9nX2NvbnRlbnRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdUaGlzIHByb2Nlc3MgYWxsb3dzIHlvdSB0byBpbXBvcnQgZW5jcnlwdGlvbiBrZXlzICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGhhdCB5b3UgaGFkIHByZXZpb3VzbHkgZXhwb3J0ZWQgZnJvbSBhbm90aGVyIE1hdHJpeCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NsaWVudC4gWW91IHdpbGwgdGhlbiBiZSBhYmxlIHRvIGRlY3J5cHQgYW55ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZXMgdGhhdCB0aGUgb3RoZXIgY2xpZW50IGNvdWxkIGRlY3J5cHQuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvcD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdUaGUgZXhwb3J0IGZpbGUgd2lsbCBiZSBwcm90ZWN0ZWQgd2l0aCBhIHBhc3NwaHJhc2UuICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnWW91IHNob3VsZCBlbnRlciB0aGUgcGFzc3BocmFzZSBoZXJlLCB0byBkZWNyeXB0IHRoZSBmaWxlLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nZXJyb3InPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5lcnJTdHIgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dFRhYmxlJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dFJvdyc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRMYWJlbCc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBodG1sRm9yPSdpbXBvcnRGaWxlJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoXCJGaWxlIHRvIGltcG9ydFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvbGFiZWw+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0UyZUtleXNEaWFsb2dfaW5wdXRDZWxsJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWY9e3RoaXMuX2ZpbGV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0naW1wb3J0RmlsZSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9J2ZpbGUnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvRm9jdXM9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5fb25Gb3JtQ2hhbmdlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVGb3JtfSAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0Um93Jz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nbXhfRTJlS2V5c0RpYWxvZ19pbnB1dExhYmVsJz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGh0bWxGb3I9J3Bhc3NwaHJhc2UnPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkVudGVyIHBhc3NwaHJhc2VcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdteF9FMmVLZXlzRGlhbG9nX2lucHV0Q2VsbCc+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmPXt0aGlzLl9wYXNzcGhyYXNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ9J3Bhc3NwaHJhc2UnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPSc2NCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9J3Bhc3N3b3JkJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMuX29uRm9ybUNoYW5nZX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlRm9ybX0gLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0RpYWxvZ19idXR0b25zJz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzc05hbWU9J214X0RpYWxvZ19wcmltYXJ5JyB0eXBlPSdzdWJtaXQnIHZhbHVlPXtfdCgnSW1wb3J0Jyl9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ9eyF0aGlzLnN0YXRlLmVuYWJsZVN1Ym1pdCB8fCBkaXNhYmxlRm9ybX1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9e3RoaXMuX29uQ2FuY2VsQ2xpY2t9IGRpc2FibGVkPXtkaXNhYmxlRm9ybX0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkNhbmNlbFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPC9mb3JtPlxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH0sXG59KTtcbiJdfQ==