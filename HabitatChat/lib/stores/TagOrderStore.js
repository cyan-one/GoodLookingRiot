"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _utils = require("flux/utils");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _GroupStore = _interopRequireDefault(require("./GroupStore"));

var _Analytics = _interopRequireDefault(require("../Analytics"));

var RoomNotifs = _interopRequireWildcard(require("../RoomNotifs"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

/*
Copyright 2017 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const INITIAL_STATE = {
  orderedTags: null,
  orderedTagsAccountData: null,
  hasSynced: false,
  joinedGroupIds: null,
  selectedTags: [],
  // Last selected tag when shift was not being pressed
  anchorTag: null
};
/**
 * A class for storing application state for ordering tags in the TagPanel.
 */

class TagOrderStore extends _utils.Store {
  constructor() {
    super(_dispatcher.default); // Initialise state

    this._state = Object.assign({}, INITIAL_STATE);

    _SettingsStore.default.monitorSetting("TagPanel.enableTagPanel", null);
  }

  _setState(newState) {
    this._state = Object.assign(this._state, newState);

    this.__emitChange();
  }

  __onDispatch(payload) {
    switch (payload.action) {
      // Initialise state after initial sync
      case 'view_room':
        {
          const relatedGroupIds = _GroupStore.default.getGroupIdsForRoomId(payload.room_id);

          this._updateBadges(relatedGroupIds);

          break;
        }

      case 'MatrixActions.sync':
        {
          if (payload.state === 'SYNCING' || payload.state === 'PREPARED') {
            this._updateBadges();
          }

          if (!(payload.prevState !== 'PREPARED' && payload.state === 'PREPARED')) {
            break;
          }

          const tagOrderingEvent = payload.matrixClient.getAccountData('im.vector.web.tag_ordering');
          const tagOrderingEventContent = tagOrderingEvent ? tagOrderingEvent.getContent() : {};

          this._setState({
            orderedTagsAccountData: tagOrderingEventContent.tags || null,
            removedTagsAccountData: tagOrderingEventContent.removedTags || null,
            hasSynced: true
          });

          this._updateOrderedTags();

          break;
        }
      // Get ordering from account data

      case 'MatrixActions.accountData':
        {
          if (payload.event_type !== 'im.vector.web.tag_ordering') break; // Ignore remote echos caused by this store so as to avoid setting
          // state back to old state.

          if (payload.event_content._storeId === this.getStoreId()) break;

          this._setState({
            orderedTagsAccountData: payload.event_content ? payload.event_content.tags : null,
            removedTagsAccountData: payload.event_content ? payload.event_content.removedTags : null
          });

          this._updateOrderedTags();

          break;
        }
      // Initialise the state such that if account data is unset, default to joined groups

      case 'GroupActions.fetchJoinedGroups.success':
        {
          this._setState({
            joinedGroupIds: payload.result.groups.sort(),
            // Sort lexically
            hasFetchedJoinedGroups: true
          });

          this._updateOrderedTags();

          break;
        }

      case 'TagOrderActions.moveTag.pending':
        {
          // Optimistic update of a moved tag
          this._setState({
            orderedTags: payload.request.tags,
            removedTagsAccountData: payload.request.removedTags
          });

          break;
        }

      case 'TagOrderActions.removeTag.pending':
        {
          // Optimistic update of a removed tag
          this._setState({
            removedTagsAccountData: payload.request.removedTags
          });

          this._updateOrderedTags();

          break;
        }

      case 'select_tag':
        {
          let newTags = []; // Shift-click semantics

          if (payload.shiftKey) {
            // Select range of tags
            let start = this._state.orderedTags.indexOf(this._state.anchorTag);

            let end = this._state.orderedTags.indexOf(payload.tag);

            if (start === -1) {
              start = end;
            }

            if (start > end) {
              const temp = start;
              start = end;
              end = temp;
            }

            newTags = payload.ctrlOrCmdKey ? this._state.selectedTags : [];
            newTags = [...new Set(this._state.orderedTags.slice(start, end + 1).concat(newTags))];
          } else {
            if (payload.ctrlOrCmdKey) {
              // Toggle individual tag
              if (this._state.selectedTags.includes(payload.tag)) {
                newTags = this._state.selectedTags.filter(t => t !== payload.tag);
              } else {
                newTags = [...this._state.selectedTags, payload.tag];
              }
            } else {
              if (this._state.selectedTags.length === 1 && this._state.selectedTags.includes(payload.tag)) {
                // Existing (only) selected tag is being normally clicked again, clear tags
                newTags = [];
              } else {
                // Select individual tag
                newTags = [payload.tag];
              }
            } // Only set the anchor tag if the tag was previously unselected, otherwise
            // the next range starts with an unselected tag.


            if (!this._state.selectedTags.includes(payload.tag)) {
              this._setState({
                anchorTag: payload.tag
              });
            }
          }

          this._setState({
            selectedTags: newTags
          });

          _Analytics.default.trackEvent('FilterStore', 'select_tag');
        }
        break;

      case 'deselect_tags':
        if (payload.tag) {
          // if a tag is passed, only deselect that tag
          this._setState({
            selectedTags: this._state.selectedTags.filter(tag => tag !== payload.tag)
          });
        } else {
          this._setState({
            selectedTags: []
          });
        }

        _Analytics.default.trackEvent('FilterStore', 'deselect_tags');

        break;

      case 'on_client_not_viable':
      case 'on_logged_out':
        {
          // Reset state without pushing an update to the view, which generally assumes that
          // the matrix client isn't `null` and so causing a re-render will cause NPEs.
          this._state = Object.assign({}, INITIAL_STATE);
          break;
        }

      case 'setting_updated':
        if (payload.settingName === 'TagPanel.enableTagPanel' && !payload.newValue) {
          this._setState({
            selectedTags: []
          });

          _Analytics.default.trackEvent('FilterStore', 'disable_tags');
        }

        break;
    }
  }

  _updateBadges(groupIds = this._state.joinedGroupIds) {
    if (groupIds && groupIds.length) {
      const client = _MatrixClientPeg.MatrixClientPeg.get();

      const changedBadges = {};
      groupIds.forEach(groupId => {
        const rooms = _GroupStore.default.getGroupRooms(groupId).map(r => client.getRoom(r.roomId)) // to Room objects
        .filter(r => r !== null && r !== undefined); // filter out rooms we haven't joined from the group


        const badge = rooms && RoomNotifs.aggregateNotificationCount(rooms);
        changedBadges[groupId] = badge && badge.count !== 0 ? badge : undefined;
      });
      const newBadges = Object.assign({}, this._state.badges, changedBadges);

      this._setState({
        badges: newBadges
      });
    }
  }

  _updateOrderedTags() {
    this._setState({
      orderedTags: this._state.hasSynced && this._state.hasFetchedJoinedGroups ? this._mergeGroupsAndTags() : null
    });
  }

  _mergeGroupsAndTags() {
    const groupIds = this._state.joinedGroupIds || [];
    const tags = this._state.orderedTagsAccountData || [];
    const removedTags = new Set(this._state.removedTagsAccountData || []);
    const tagsToKeep = tags.filter(t => (t[0] !== '+' || groupIds.includes(t)) && !removedTags.has(t));
    const groupIdsToAdd = groupIds.filter(groupId => !tags.includes(groupId) && !removedTags.has(groupId));
    return tagsToKeep.concat(groupIdsToAdd);
  }

  getGroupBadge(groupId) {
    const badges = this._state.badges;
    return badges && badges[groupId];
  }

  getOrderedTags() {
    return this._state.orderedTags;
  }

  getRemovedTagsAccountData() {
    return this._state.removedTagsAccountData;
  }

  getStoreId() {
    // Generate a random ID to prevent this store from clobbering its
    // state with redundant remote echos.
    if (!this._id) this._id = Math.random().toString(16).slice(2, 10);
    return this._id;
  }

  getSelectedTags() {
    return this._state.selectedTags;
  }

}

if (global.singletonTagOrderStore === undefined) {
  global.singletonTagOrderStore = new TagOrderStore();
}

var _default = global.singletonTagOrderStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvVGFnT3JkZXJTdG9yZS5qcyJdLCJuYW1lcyI6WyJJTklUSUFMX1NUQVRFIiwib3JkZXJlZFRhZ3MiLCJvcmRlcmVkVGFnc0FjY291bnREYXRhIiwiaGFzU3luY2VkIiwiam9pbmVkR3JvdXBJZHMiLCJzZWxlY3RlZFRhZ3MiLCJhbmNob3JUYWciLCJUYWdPcmRlclN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsImRpcyIsIl9zdGF0ZSIsIk9iamVjdCIsImFzc2lnbiIsIlNldHRpbmdzU3RvcmUiLCJtb25pdG9yU2V0dGluZyIsIl9zZXRTdGF0ZSIsIm5ld1N0YXRlIiwiX19lbWl0Q2hhbmdlIiwiX19vbkRpc3BhdGNoIiwicGF5bG9hZCIsImFjdGlvbiIsInJlbGF0ZWRHcm91cElkcyIsIkdyb3VwU3RvcmUiLCJnZXRHcm91cElkc0ZvclJvb21JZCIsInJvb21faWQiLCJfdXBkYXRlQmFkZ2VzIiwic3RhdGUiLCJwcmV2U3RhdGUiLCJ0YWdPcmRlcmluZ0V2ZW50IiwibWF0cml4Q2xpZW50IiwiZ2V0QWNjb3VudERhdGEiLCJ0YWdPcmRlcmluZ0V2ZW50Q29udGVudCIsImdldENvbnRlbnQiLCJ0YWdzIiwicmVtb3ZlZFRhZ3NBY2NvdW50RGF0YSIsInJlbW92ZWRUYWdzIiwiX3VwZGF0ZU9yZGVyZWRUYWdzIiwiZXZlbnRfdHlwZSIsImV2ZW50X2NvbnRlbnQiLCJfc3RvcmVJZCIsImdldFN0b3JlSWQiLCJyZXN1bHQiLCJncm91cHMiLCJzb3J0IiwiaGFzRmV0Y2hlZEpvaW5lZEdyb3VwcyIsInJlcXVlc3QiLCJuZXdUYWdzIiwic2hpZnRLZXkiLCJzdGFydCIsImluZGV4T2YiLCJlbmQiLCJ0YWciLCJ0ZW1wIiwiY3RybE9yQ21kS2V5IiwiU2V0Iiwic2xpY2UiLCJjb25jYXQiLCJpbmNsdWRlcyIsImZpbHRlciIsInQiLCJsZW5ndGgiLCJBbmFseXRpY3MiLCJ0cmFja0V2ZW50Iiwic2V0dGluZ05hbWUiLCJuZXdWYWx1ZSIsImdyb3VwSWRzIiwiY2xpZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiY2hhbmdlZEJhZGdlcyIsImZvckVhY2giLCJncm91cElkIiwicm9vbXMiLCJnZXRHcm91cFJvb21zIiwibWFwIiwiciIsImdldFJvb20iLCJyb29tSWQiLCJ1bmRlZmluZWQiLCJiYWRnZSIsIlJvb21Ob3RpZnMiLCJhZ2dyZWdhdGVOb3RpZmljYXRpb25Db3VudCIsImNvdW50IiwibmV3QmFkZ2VzIiwiYmFkZ2VzIiwiX21lcmdlR3JvdXBzQW5kVGFncyIsInRhZ3NUb0tlZXAiLCJoYXMiLCJncm91cElkc1RvQWRkIiwiZ2V0R3JvdXBCYWRnZSIsImdldE9yZGVyZWRUYWdzIiwiZ2V0UmVtb3ZlZFRhZ3NBY2NvdW50RGF0YSIsIl9pZCIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsImdldFNlbGVjdGVkVGFncyIsImdsb2JhbCIsInNpbmdsZXRvblRhZ09yZGVyU3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBckJBOzs7Ozs7Ozs7Ozs7Ozs7QUF1QkEsTUFBTUEsYUFBYSxHQUFHO0FBQ2xCQyxFQUFBQSxXQUFXLEVBQUUsSUFESztBQUVsQkMsRUFBQUEsc0JBQXNCLEVBQUUsSUFGTjtBQUdsQkMsRUFBQUEsU0FBUyxFQUFFLEtBSE87QUFJbEJDLEVBQUFBLGNBQWMsRUFBRSxJQUpFO0FBTWxCQyxFQUFBQSxZQUFZLEVBQUUsRUFOSTtBQU9sQjtBQUNBQyxFQUFBQSxTQUFTLEVBQUU7QUFSTyxDQUF0QjtBQVdBOzs7O0FBR0EsTUFBTUMsYUFBTixTQUE0QkMsWUFBNUIsQ0FBa0M7QUFDOUJDLEVBQUFBLFdBQVcsR0FBRztBQUNWLFVBQU1DLG1CQUFOLEVBRFUsQ0FHVjs7QUFDQSxTQUFLQyxNQUFMLEdBQWNDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JiLGFBQWxCLENBQWQ7O0FBQ0FjLDJCQUFjQyxjQUFk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TUFBTSxDQUFDQyxzQkFBUCxLQUFrQ3BCLFNBQXRDLEVBQWlEO0FBQzdDbUIsRUFBQUEsTUFBTSxDQUFDQyxzQkFBUCxHQUFnQyxJQUFJNUYsYUFBSixFQUFoQztBQUNIOztlQUNjMkYsTUFBTSxDQUFDQyxzQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5pbXBvcnQge1N0b3JlfSBmcm9tICdmbHV4L3V0aWxzJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCBHcm91cFN0b3JlIGZyb20gJy4vR3JvdXBTdG9yZSc7XG5pbXBvcnQgQW5hbHl0aWNzIGZyb20gJy4uL0FuYWx5dGljcyc7XG5pbXBvcnQgKiBhcyBSb29tTm90aWZzIGZyb20gXCIuLi9Sb29tTm90aWZzXCI7XG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSAnLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5cbmNvbnN0IElOSVRJQUxfU1RBVEUgPSB7XG4gICAgb3JkZXJlZFRhZ3M6IG51bGwsXG4gICAgb3JkZXJlZFRhZ3NBY2NvdW50RGF0YTogbnVsbCxcbiAgICBoYXNTeW5jZWQ6IGZhbHNlLFxuICAgIGpvaW5lZEdyb3VwSWRzOiBudWxsLFxuXG4gICAgc2VsZWN0ZWRUYWdzOiBbXSxcbiAgICAvLyBMYXN0IHNlbGVjdGVkIHRhZyB3aGVuIHNoaWZ0IHdhcyBub3QgYmVpbmcgcHJlc3NlZFxuICAgIGFuY2hvclRhZzogbnVsbCxcbn07XG5cbi8qKlxuICogQSBjbGFzcyBmb3Igc3RvcmluZyBhcHBsaWNhdGlvbiBzdGF0ZSBmb3Igb3JkZXJpbmcgdGFncyBpbiB0aGUgVGFnUGFuZWwuXG4gKi9cbmNsYXNzIFRhZ09yZGVyU3RvcmUgZXh0ZW5kcyBTdG9yZSB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKGRpcyk7XG5cbiAgICAgICAgLy8gSW5pdGlhbGlzZSBzdGF0ZVxuICAgICAgICB0aGlzLl9zdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIElOSVRJQUxfU1RBVEUpO1xuICAgICAgICBTZXR0aW5nc1N0b3JlLm1vbml0b3JTZXR0aW5nKFwiVGFnUGFuZWwuZW5hYmxlVGFnUGFuZWxcIiwgbnVsbCk7XG4gICAgfVxuXG4gICAgX3NldFN0YXRlKG5ld1N0YXRlKSB7XG4gICAgICAgIHRoaXMuX3N0YXRlID0gT2JqZWN0LmFzc2lnbih0aGlzLl9zdGF0ZSwgbmV3U3RhdGUpO1xuICAgICAgICB0aGlzLl9fZW1pdENoYW5nZSgpO1xuICAgIH1cblxuICAgIF9fb25EaXNwYXRjaChwYXlsb2FkKSB7XG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5hY3Rpb24pIHtcbiAgICAgICAgICAgIC8vIEluaXRpYWxpc2Ugc3RhdGUgYWZ0ZXIgaW5pdGlhbCBzeW5jXG4gICAgICAgICAgICBjYXNlICd2aWV3X3Jvb20nOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVsYXRlZEdyb3VwSWRzID0gR3JvdXBTdG9yZS5nZXRHcm91cElkc0ZvclJvb21JZChwYXlsb2FkLnJvb21faWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUJhZGdlcyhyZWxhdGVkR3JvdXBJZHMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSAnTWF0cml4QWN0aW9ucy5zeW5jJzoge1xuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLnN0YXRlID09PSAnU1lOQ0lORycgfHwgcGF5bG9hZC5zdGF0ZSA9PT0gJ1BSRVBBUkVEJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVCYWRnZXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCEocGF5bG9hZC5wcmV2U3RhdGUgIT09ICdQUkVQQVJFRCcgJiYgcGF5bG9hZC5zdGF0ZSA9PT0gJ1BSRVBBUkVEJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHRhZ09yZGVyaW5nRXZlbnQgPSBwYXlsb2FkLm1hdHJpeENsaWVudC5nZXRBY2NvdW50RGF0YSgnaW0udmVjdG9yLndlYi50YWdfb3JkZXJpbmcnKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0YWdPcmRlcmluZ0V2ZW50Q29udGVudCA9IHRhZ09yZGVyaW5nRXZlbnQgPyB0YWdPcmRlcmluZ0V2ZW50LmdldENvbnRlbnQoKSA6IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJlZFRhZ3NBY2NvdW50RGF0YTogdGFnT3JkZXJpbmdFdmVudENvbnRlbnQudGFncyB8fCBudWxsLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVkVGFnc0FjY291bnREYXRhOiB0YWdPcmRlcmluZ0V2ZW50Q29udGVudC5yZW1vdmVkVGFncyB8fCBudWxsLFxuICAgICAgICAgICAgICAgICAgICBoYXNTeW5jZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlT3JkZXJlZFRhZ3MoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEdldCBvcmRlcmluZyBmcm9tIGFjY291bnQgZGF0YVxuICAgICAgICAgICAgY2FzZSAnTWF0cml4QWN0aW9ucy5hY2NvdW50RGF0YSc6IHtcbiAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5ldmVudF90eXBlICE9PSAnaW0udmVjdG9yLndlYi50YWdfb3JkZXJpbmcnKSBicmVhaztcblxuICAgICAgICAgICAgICAgIC8vIElnbm9yZSByZW1vdGUgZWNob3MgY2F1c2VkIGJ5IHRoaXMgc3RvcmUgc28gYXMgdG8gYXZvaWQgc2V0dGluZ1xuICAgICAgICAgICAgICAgIC8vIHN0YXRlIGJhY2sgdG8gb2xkIHN0YXRlLlxuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLmV2ZW50X2NvbnRlbnQuX3N0b3JlSWQgPT09IHRoaXMuZ2V0U3RvcmVJZCgpKSBicmVhaztcblxuICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJlZFRhZ3NBY2NvdW50RGF0YTogcGF5bG9hZC5ldmVudF9jb250ZW50ID8gcGF5bG9hZC5ldmVudF9jb250ZW50LnRhZ3MgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVkVGFnc0FjY291bnREYXRhOiBwYXlsb2FkLmV2ZW50X2NvbnRlbnQgPyBwYXlsb2FkLmV2ZW50X2NvbnRlbnQucmVtb3ZlZFRhZ3MgOiBudWxsLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZU9yZGVyZWRUYWdzKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBJbml0aWFsaXNlIHRoZSBzdGF0ZSBzdWNoIHRoYXQgaWYgYWNjb3VudCBkYXRhIGlzIHVuc2V0LCBkZWZhdWx0IHRvIGpvaW5lZCBncm91cHNcbiAgICAgICAgICAgIGNhc2UgJ0dyb3VwQWN0aW9ucy5mZXRjaEpvaW5lZEdyb3Vwcy5zdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgam9pbmVkR3JvdXBJZHM6IHBheWxvYWQucmVzdWx0Lmdyb3Vwcy5zb3J0KCksIC8vIFNvcnQgbGV4aWNhbGx5XG4gICAgICAgICAgICAgICAgICAgIGhhc0ZldGNoZWRKb2luZWRHcm91cHM6IHRydWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlT3JkZXJlZFRhZ3MoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgJ1RhZ09yZGVyQWN0aW9ucy5tb3ZlVGFnLnBlbmRpbmcnOiB7XG4gICAgICAgICAgICAgICAgLy8gT3B0aW1pc3RpYyB1cGRhdGUgb2YgYSBtb3ZlZCB0YWdcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVyZWRUYWdzOiBwYXlsb2FkLnJlcXVlc3QudGFncyxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZFRhZ3NBY2NvdW50RGF0YTogcGF5bG9hZC5yZXF1ZXN0LnJlbW92ZWRUYWdzLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSAnVGFnT3JkZXJBY3Rpb25zLnJlbW92ZVRhZy5wZW5kaW5nJzoge1xuICAgICAgICAgICAgICAgIC8vIE9wdGltaXN0aWMgdXBkYXRlIG9mIGEgcmVtb3ZlZCB0YWdcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZWRUYWdzQWNjb3VudERhdGE6IHBheWxvYWQucmVxdWVzdC5yZW1vdmVkVGFncyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVPcmRlcmVkVGFncygpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSAnc2VsZWN0X3RhZyc6IHtcbiAgICAgICAgICAgICAgICBsZXQgbmV3VGFncyA9IFtdO1xuICAgICAgICAgICAgICAgIC8vIFNoaWZ0LWNsaWNrIHNlbWFudGljc1xuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLnNoaWZ0S2V5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNlbGVjdCByYW5nZSBvZiB0YWdzXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IHRoaXMuX3N0YXRlLm9yZGVyZWRUYWdzLmluZGV4T2YodGhpcy5fc3RhdGUuYW5jaG9yVGFnKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IHRoaXMuX3N0YXRlLm9yZGVyZWRUYWdzLmluZGV4T2YocGF5bG9hZC50YWcpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZW5kO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcCA9IHN0YXJ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBlbmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSB0ZW1wO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG5ld1RhZ3MgPSBwYXlsb2FkLmN0cmxPckNtZEtleSA/IHRoaXMuX3N0YXRlLnNlbGVjdGVkVGFncyA6IFtdO1xuICAgICAgICAgICAgICAgICAgICBuZXdUYWdzID0gWy4uLm5ldyBTZXQoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5vcmRlcmVkVGFncy5zbGljZShzdGFydCwgZW5kICsgMSkuY29uY2F0KG5ld1RhZ3MpLFxuICAgICAgICAgICAgICAgICAgICApXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5jdHJsT3JDbWRLZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRvZ2dsZSBpbmRpdmlkdWFsIHRhZ1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXRlLnNlbGVjdGVkVGFncy5pbmNsdWRlcyhwYXlsb2FkLnRhZykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUYWdzID0gdGhpcy5fc3RhdGUuc2VsZWN0ZWRUYWdzLmZpbHRlcigodCkgPT4gdCAhPT0gcGF5bG9hZC50YWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUYWdzID0gWy4uLnRoaXMuX3N0YXRlLnNlbGVjdGVkVGFncywgcGF5bG9hZC50YWddO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXRlLnNlbGVjdGVkVGFncy5sZW5ndGggPT09IDEgJiYgdGhpcy5fc3RhdGUuc2VsZWN0ZWRUYWdzLmluY2x1ZGVzKHBheWxvYWQudGFnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEV4aXN0aW5nIChvbmx5KSBzZWxlY3RlZCB0YWcgaXMgYmVpbmcgbm9ybWFsbHkgY2xpY2tlZCBhZ2FpbiwgY2xlYXIgdGFnc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RhZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VsZWN0IGluZGl2aWR1YWwgdGFnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3VGFncyA9IFtwYXlsb2FkLnRhZ107XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzZXQgdGhlIGFuY2hvciB0YWcgaWYgdGhlIHRhZyB3YXMgcHJldmlvdXNseSB1bnNlbGVjdGVkLCBvdGhlcndpc2VcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIG5leHQgcmFuZ2Ugc3RhcnRzIHdpdGggYW4gdW5zZWxlY3RlZCB0YWcuXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fc3RhdGUuc2VsZWN0ZWRUYWdzLmluY2x1ZGVzKHBheWxvYWQudGFnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuY2hvclRhZzogcGF5bG9hZC50YWcsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUYWdzOiBuZXdUYWdzLFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgQW5hbHl0aWNzLnRyYWNrRXZlbnQoJ0ZpbHRlclN0b3JlJywgJ3NlbGVjdF90YWcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZGVzZWxlY3RfdGFncyc6XG4gICAgICAgICAgICAgICAgaWYgKHBheWxvYWQudGFnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIGEgdGFnIGlzIHBhc3NlZCwgb25seSBkZXNlbGVjdCB0aGF0IHRhZ1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFRhZ3M6IHRoaXMuX3N0YXRlLnNlbGVjdGVkVGFncy5maWx0ZXIodGFnID0+IHRhZyAhPT0gcGF5bG9hZC50YWcpLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFRhZ3M6IFtdLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgQW5hbHl0aWNzLnRyYWNrRXZlbnQoJ0ZpbHRlclN0b3JlJywgJ2Rlc2VsZWN0X3RhZ3MnKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnb25fY2xpZW50X25vdF92aWFibGUnOlxuICAgICAgICAgICAgY2FzZSAnb25fbG9nZ2VkX291dCc6IHtcbiAgICAgICAgICAgICAgICAvLyBSZXNldCBzdGF0ZSB3aXRob3V0IHB1c2hpbmcgYW4gdXBkYXRlIHRvIHRoZSB2aWV3LCB3aGljaCBnZW5lcmFsbHkgYXNzdW1lcyB0aGF0XG4gICAgICAgICAgICAgICAgLy8gdGhlIG1hdHJpeCBjbGllbnQgaXNuJ3QgYG51bGxgIGFuZCBzbyBjYXVzaW5nIGEgcmUtcmVuZGVyIHdpbGwgY2F1c2UgTlBFcy5cbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIElOSVRJQUxfU1RBVEUpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSAnc2V0dGluZ191cGRhdGVkJzpcbiAgICAgICAgICAgICAgICBpZiAocGF5bG9hZC5zZXR0aW5nTmFtZSA9PT0gJ1RhZ1BhbmVsLmVuYWJsZVRhZ1BhbmVsJyAmJiAhcGF5bG9hZC5uZXdWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFRhZ3M6IFtdLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgQW5hbHl0aWNzLnRyYWNrRXZlbnQoJ0ZpbHRlclN0b3JlJywgJ2Rpc2FibGVfdGFncycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF91cGRhdGVCYWRnZXMoZ3JvdXBJZHMgPSB0aGlzLl9zdGF0ZS5qb2luZWRHcm91cElkcykge1xuICAgICAgICBpZiAoZ3JvdXBJZHMgJiYgZ3JvdXBJZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgICAgICBjb25zdCBjaGFuZ2VkQmFkZ2VzID0ge307XG4gICAgICAgICAgICBncm91cElkcy5mb3JFYWNoKGdyb3VwSWQgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvb21zID1cbiAgICAgICAgICAgICAgICAgICAgR3JvdXBTdG9yZS5nZXRHcm91cFJvb21zKGdyb3VwSWQpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAociA9PiBjbGllbnQuZ2V0Um9vbShyLnJvb21JZCkpIC8vIHRvIFJvb20gb2JqZWN0c1xuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHIgPT4gciAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQpOyAgIC8vIGZpbHRlciBvdXQgcm9vbXMgd2UgaGF2ZW4ndCBqb2luZWQgZnJvbSB0aGUgZ3JvdXBcbiAgICAgICAgICAgICAgICBjb25zdCBiYWRnZSA9IHJvb21zICYmIFJvb21Ob3RpZnMuYWdncmVnYXRlTm90aWZpY2F0aW9uQ291bnQocm9vbXMpO1xuICAgICAgICAgICAgICAgIGNoYW5nZWRCYWRnZXNbZ3JvdXBJZF0gPSAoYmFkZ2UgJiYgYmFkZ2UuY291bnQgIT09IDApID8gYmFkZ2UgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IG5ld0JhZGdlcyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX3N0YXRlLmJhZGdlcywgY2hhbmdlZEJhZGdlcyk7XG4gICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7YmFkZ2VzOiBuZXdCYWRnZXN9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF91cGRhdGVPcmRlcmVkVGFncygpIHtcbiAgICAgICAgdGhpcy5fc2V0U3RhdGUoe1xuICAgICAgICAgICAgb3JkZXJlZFRhZ3M6XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhdGUuaGFzU3luY2VkICYmXG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhdGUuaGFzRmV0Y2hlZEpvaW5lZEdyb3VwcyA/XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX21lcmdlR3JvdXBzQW5kVGFncygpIDogbnVsbCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX21lcmdlR3JvdXBzQW5kVGFncygpIHtcbiAgICAgICAgY29uc3QgZ3JvdXBJZHMgPSB0aGlzLl9zdGF0ZS5qb2luZWRHcm91cElkcyB8fCBbXTtcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuX3N0YXRlLm9yZGVyZWRUYWdzQWNjb3VudERhdGEgfHwgW107XG4gICAgICAgIGNvbnN0IHJlbW92ZWRUYWdzID0gbmV3IFNldCh0aGlzLl9zdGF0ZS5yZW1vdmVkVGFnc0FjY291bnREYXRhIHx8IFtdKTtcblxuXG4gICAgICAgIGNvbnN0IHRhZ3NUb0tlZXAgPSB0YWdzLmZpbHRlcihcbiAgICAgICAgICAgICh0KSA9PiAodFswXSAhPT0gJysnIHx8IGdyb3VwSWRzLmluY2x1ZGVzKHQpKSAmJiAhcmVtb3ZlZFRhZ3MuaGFzKHQpLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGdyb3VwSWRzVG9BZGQgPSBncm91cElkcy5maWx0ZXIoXG4gICAgICAgICAgICAoZ3JvdXBJZCkgPT4gIXRhZ3MuaW5jbHVkZXMoZ3JvdXBJZCkgJiYgIXJlbW92ZWRUYWdzLmhhcyhncm91cElkKSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGFnc1RvS2VlcC5jb25jYXQoZ3JvdXBJZHNUb0FkZCk7XG4gICAgfVxuXG4gICAgZ2V0R3JvdXBCYWRnZShncm91cElkKSB7XG4gICAgICAgIGNvbnN0IGJhZGdlcyA9IHRoaXMuX3N0YXRlLmJhZGdlcztcbiAgICAgICAgcmV0dXJuIGJhZGdlcyAmJiBiYWRnZXNbZ3JvdXBJZF07XG4gICAgfVxuXG4gICAgZ2V0T3JkZXJlZFRhZ3MoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5vcmRlcmVkVGFncztcbiAgICB9XG5cbiAgICBnZXRSZW1vdmVkVGFnc0FjY291bnREYXRhKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUucmVtb3ZlZFRhZ3NBY2NvdW50RGF0YTtcbiAgICB9XG5cbiAgICBnZXRTdG9yZUlkKCkge1xuICAgICAgICAvLyBHZW5lcmF0ZSBhIHJhbmRvbSBJRCB0byBwcmV2ZW50IHRoaXMgc3RvcmUgZnJvbSBjbG9iYmVyaW5nIGl0c1xuICAgICAgICAvLyBzdGF0ZSB3aXRoIHJlZHVuZGFudCByZW1vdGUgZWNob3MuXG4gICAgICAgIGlmICghdGhpcy5faWQpIHRoaXMuX2lkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc2xpY2UoMiwgMTApO1xuICAgICAgICByZXR1cm4gdGhpcy5faWQ7XG4gICAgfVxuXG4gICAgZ2V0U2VsZWN0ZWRUYWdzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUuc2VsZWN0ZWRUYWdzO1xuICAgIH1cbn1cblxuaWYgKGdsb2JhbC5zaW5nbGV0b25UYWdPcmRlclN0b3JlID09PSB1bmRlZmluZWQpIHtcbiAgICBnbG9iYWwuc2luZ2xldG9uVGFnT3JkZXJTdG9yZSA9IG5ldyBUYWdPcmRlclN0b3JlKCk7XG59XG5leHBvcnQgZGVmYXVsdCBnbG9iYWwuc2luZ2xldG9uVGFnT3JkZXJTdG9yZTtcbiJdfQ==