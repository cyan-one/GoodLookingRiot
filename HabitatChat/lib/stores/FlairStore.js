"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _events = _interopRequireDefault(require("events"));

/*
Copyright 2017 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const BULK_REQUEST_DEBOUNCE_MS = 200; // Does the server support groups? Assume yes until we receive M_UNRECOGNIZED.
// If true, flair can function and we should keep sending requests for groups and avatars.

let groupSupport = true;
const USER_GROUPS_CACHE_BUST_MS = 1800000; // 30 mins

const GROUP_PROFILES_CACHE_BUST_MS = 1800000; // 30 mins

/**
 * Stores data used by <Flair/>
 */

class FlairStore extends _events.default {
  constructor(matrixClient) {
    super();
    this._matrixClient = matrixClient;
    this._userGroups = {// $userId: ['+group1:domain', '+group2:domain', ...]
    };
    this._groupProfiles = {//  $groupId: {
      //      avatar_url: 'mxc://...'
      //  }
    };
    this._groupProfilesPromise = {//  $groupId: Promise
    };
    this._usersPending = {//  $userId: {
      //      prom: Promise
      //      resolve: () => {}
      //      reject: () => {}
      //  }
    };
    this._usersInFlight = {// This has the same schema as _usersPending
    };
    this._debounceTimeoutID = null;
  }

  groupSupport() {
    return groupSupport;
  }

  invalidatePublicisedGroups(userId) {
    delete this._userGroups[userId];
  }

  getPublicisedGroupsCached(matrixClient, userId) {
    if (this._userGroups[userId]) {
      return Promise.resolve(this._userGroups[userId]);
    } // Bulk lookup ongoing, return promise to resolve/reject


    if (this._usersPending[userId]) {
      return this._usersPending[userId].prom;
    } // User has been moved from pending to in-flight


    if (this._usersInFlight[userId]) {
      return this._usersInFlight[userId].prom;
    }

    this._usersPending[userId] = {};
    this._usersPending[userId].prom = new Promise((resolve, reject) => {
      this._usersPending[userId].resolve = resolve;
      this._usersPending[userId].reject = reject;
    }).then(groups => {
      this._userGroups[userId] = groups;
      setTimeout(() => {
        delete this._userGroups[userId];
      }, USER_GROUPS_CACHE_BUST_MS);
      return this._userGroups[userId];
    }).catch(err => {
      // Indicate whether the homeserver supports groups
      if (err.errcode === 'M_UNRECOGNIZED') {
        console.warn('Cannot display flair, server does not support groups');
        groupSupport = false; // Return silently to avoid spamming for non-supporting servers

        return;
      }

      console.error('Could not get groups for user', userId, err);
      throw err;
    }).finally(() => {
      delete this._usersInFlight[userId];
    }); // This debounce will allow consecutive requests for the public groups of users that
    // are sent in intervals of < BULK_REQUEST_DEBOUNCE_MS to be batched and only requested
    // when no more requests are received within the next BULK_REQUEST_DEBOUNCE_MS. The naive
    // implementation would do a request that only requested the groups for `userId`, leading
    // to a worst and best case of 1 user per request. This implementation's worst is still
    // 1 user per request but only if the requests are > BULK_REQUEST_DEBOUNCE_MS apart and the
    // best case is N users per request.
    //
    // This is to reduce the number of requests made whilst trading off latency when viewing
    // a Flair component.

    if (this._debounceTimeoutID) clearTimeout(this._debounceTimeoutID);
    this._debounceTimeoutID = setTimeout(() => {
      this._batchedGetPublicGroups(matrixClient);
    }, BULK_REQUEST_DEBOUNCE_MS);
    return this._usersPending[userId].prom;
  }

  async _batchedGetPublicGroups(matrixClient) {
    // Move users pending to users in flight
    this._usersInFlight = this._usersPending;
    this._usersPending = {};
    let resp = {
      users: []
    };

    try {
      resp = await matrixClient.getPublicisedGroups(Object.keys(this._usersInFlight));
    } catch (err) {
      // Propagate the same error to all usersInFlight
      Object.keys(this._usersInFlight).forEach(userId => {
        // The promise should always exist for userId, but do a null-check anyway
        if (!this._usersInFlight[userId]) return;

        this._usersInFlight[userId].reject(err);
      });
      return;
    }

    const updatedUserGroups = resp.users;
    Object.keys(this._usersInFlight).forEach(userId => {
      // The promise should always exist for userId, but do a null-check anyway
      if (!this._usersInFlight[userId]) return;

      this._usersInFlight[userId].resolve(updatedUserGroups[userId] || []);
    });
  }

  async getGroupProfileCached(matrixClient, groupId) {
    if (this._groupProfiles[groupId]) {
      return this._groupProfiles[groupId];
    } // A request is ongoing, wait for it to complete and return the group profile.


    if (this._groupProfilesPromise[groupId]) {
      try {
        await this._groupProfilesPromise[groupId];
      } catch (e) {
        // Don't log the error; this is done below
        return null;
      }

      return this._groupProfiles[groupId];
    } // No request yet, start one


    console.log('FlairStore: Request group profile of ' + groupId);
    this._groupProfilesPromise[groupId] = matrixClient.getGroupProfile(groupId);
    let profile;

    try {
      profile = await this._groupProfilesPromise[groupId];
    } catch (e) {
      console.log('FlairStore: Failed to get group profile for ' + groupId, e); // Don't retry, but allow a retry when the profile is next requested

      delete this._groupProfilesPromise[groupId];
      return null;
    }

    this._groupProfiles[groupId] = {
      groupId,
      avatarUrl: profile.avatar_url,
      name: profile.name,
      shortDescription: profile.short_description
    };
    delete this._groupProfilesPromise[groupId]; /// XXX: This is verging on recreating a third "Flux"-looking Store. We really
    /// should replace FlairStore with a Flux store and some async actions.

    console.log('FlairStore: Emit updateGroupProfile for ' + groupId);
    this.emit('updateGroupProfile');
    setTimeout(() => {
      this.refreshGroupProfile(matrixClient, groupId);
    }, GROUP_PROFILES_CACHE_BUST_MS);
    return this._groupProfiles[groupId];
  }

  refreshGroupProfile(matrixClient, groupId) {
    // Invalidate the cache
    delete this._groupProfiles[groupId]; // Fetch new profile data, and cache it

    return this.getGroupProfileCached(matrixClient, groupId);
  }

}

if (global.singletonFlairStore === undefined) {
  global.singletonFlairStore = new FlairStore();
}

var _default = global.singletonFlairStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvRmxhaXJTdG9yZS5qcyJdLCJuYW1lcyI6WyJCVUxLX1JFUVVFU1RfREVCT1VOQ0VfTVMiLCJncm91cFN1cHBvcnQiLCJVU0VSX0dST1VQU19DQUNIRV9CVVNUX01TIiwiR1JPVVBfUFJPRklMRVNfQ0FDSEVfQlVTVF9NUyIsIkZsYWlyU3RvcmUiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm1hdHJpeENsaWVudCIsIl9tYXRyaXhDbGllbnQiLCJfdXNlckdyb3VwcyIsIl9ncm91cFByb2ZpbGVzIiwiX2dyb3VwUHJvZmlsZXNQcm9taXNlIiwiX3VzZXJzUGVuZGluZyIsIl91c2Vyc0luRmxpZ2h0IiwiX2RlYm91bmNlVGltZW91dElEIiwiaW52YWxpZGF0ZVB1YmxpY2lzZWRHcm91cHMiLCJ1c2VySWQiLCJnZXRQdWJsaWNpc2VkR3JvdXBzQ2FjaGVkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJwcm9tIiwicmVqZWN0IiwidGhlbiIsImdyb3VwcyIsInNldFRpbWVvdXQiLCJjYXRjaCIsImVyciIsImVycmNvZGUiLCJjb25zb2xlIiwid2FybiIsImVycm9yIiwiZmluYWxseSIsImNsZWFyVGltZW91dCIsIl9iYXRjaGVkR2V0UHVibGljR3JvdXBzIiwicmVzcCIsInVzZXJzIiwiZ2V0UHVibGljaXNlZEdyb3VwcyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwidXBkYXRlZFVzZXJHcm91cHMiLCJnZXRHcm91cFByb2ZpbGVDYWNoZWQiLCJncm91cElkIiwiZSIsImxvZyIsImdldEdyb3VwUHJvZmlsZSIsInByb2ZpbGUiLCJhdmF0YXJVcmwiLCJhdmF0YXJfdXJsIiwibmFtZSIsInNob3J0RGVzY3JpcHRpb24iLCJzaG9ydF9kZXNjcmlwdGlvbiIsImVtaXQiLCJyZWZyZXNoR3JvdXBQcm9maWxlIiwiZ2xvYmFsIiwic2luZ2xldG9uRmxhaXJTdG9yZSIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7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dXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcblxuY29uc3QgQlVMS19SRVFVRVNUX0RFQk9VTkNFX01TID0gMjAwO1xuXG4vLyBEb2VzIHRoZSBzZXJ2ZXIgc3VwcG9ydCBncm91cHM/IEFzc3VtZSB5ZXMgdW50aWwgd2UgcmVjZWl2ZSBNX1VOUkVDT0dOSVpFRC5cbi8vIElmIHRydWUsIGZsYWlyIGNhbiBmdW5jdGlvbiBhbmQgd2Ugc2hvdWxkIGtlZXAgc2VuZGluZyByZXF1ZXN0cyBmb3IgZ3JvdXBzIGFuZCBhdmF0YXJzLlxubGV0IGdyb3VwU3VwcG9ydCA9IHRydWU7XG5cbmNvbnN0IFVTRVJfR1JPVVBTX0NBQ0hFX0JVU1RfTVMgPSAxODAwMDAwOyAvLyAzMCBtaW5zXG5jb25zdCBHUk9VUF9QUk9GSUxFU19DQUNIRV9CVVNUX01TID0gMTgwMDAwMDsgLy8gMzAgbWluc1xuXG4vKipcbiAqIFN0b3JlcyBkYXRhIHVzZWQgYnkgPEZsYWlyLz5cbiAqL1xuY2xhc3MgRmxhaXJTdG9yZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IobWF0cml4Q2xpZW50KSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX21hdHJpeENsaWVudCA9IG1hdHJpeENsaWVudDtcbiAgICAgICAgdGhpcy5fdXNlckdyb3VwcyA9IHtcbiAgICAgICAgICAgIC8vICR1c2VySWQ6IFsnK2dyb3VwMTpkb21haW4nLCAnK2dyb3VwMjpkb21haW4nLCAuLi5dXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2dyb3VwUHJvZmlsZXMgPSB7XG4gICAgICAgICAgICAvLyAgJGdyb3VwSWQ6IHtcbiAgICAgICAgICAgIC8vICAgICAgYXZhdGFyX3VybDogJ214YzovLy4uLidcbiAgICAgICAgICAgIC8vICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2dyb3VwUHJvZmlsZXNQcm9taXNlID0ge1xuICAgICAgICAgICAgLy8gICRncm91cElkOiBQcm9taXNlXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX3VzZXJzUGVuZGluZyA9IHtcbiAgICAgICAgICAgIC8vICAkdXNlcklkOiB7XG4gICAgICAgICAgICAvLyAgICAgIHByb206IFByb21pc2VcbiAgICAgICAgICAgIC8vICAgICAgcmVzb2x2ZTogKCkgPT4ge31cbiAgICAgICAgICAgIC8vICAgICAgcmVqZWN0OiAoKSA9PiB7fVxuICAgICAgICAgICAgLy8gIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fdXNlcnNJbkZsaWdodCA9IHtcbiAgICAgICAgICAgIC8vIFRoaXMgaGFzIHRoZSBzYW1lIHNjaGVtYSBhcyBfdXNlcnNQZW5kaW5nXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fZGVib3VuY2VUaW1lb3V0SUQgPSBudWxsO1xuICAgIH1cblxuICAgIGdyb3VwU3VwcG9ydCgpIHtcbiAgICAgICAgcmV0dXJuIGdyb3VwU3VwcG9ydDtcbiAgICB9XG5cbiAgICBpbnZhbGlkYXRlUHVibGljaXNlZEdyb3Vwcyh1c2VySWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX3VzZXJHcm91cHNbdXNlcklkXTtcbiAgICB9XG5cbiAgICBnZXRQdWJsaWNpc2VkR3JvdXBzQ2FjaGVkKG1hdHJpeENsaWVudCwgdXNlcklkKSB7XG4gICAgICAgIGlmICh0aGlzLl91c2VyR3JvdXBzW3VzZXJJZF0pIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5fdXNlckdyb3Vwc1t1c2VySWRdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEJ1bGsgbG9va3VwIG9uZ29pbmcsIHJldHVybiBwcm9taXNlIHRvIHJlc29sdmUvcmVqZWN0XG4gICAgICAgIGlmICh0aGlzLl91c2Vyc1BlbmRpbmdbdXNlcklkXSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3VzZXJzUGVuZGluZ1t1c2VySWRdLnByb207XG4gICAgICAgIH1cbiAgICAgICAgLy8gVXNlciBoYXMgYmVlbiBtb3ZlZCBmcm9tIHBlbmRpbmcgdG8gaW4tZmxpZ2h0XG4gICAgICAgIGlmICh0aGlzLl91c2Vyc0luRmxpZ2h0W3VzZXJJZF0pIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl91c2Vyc0luRmxpZ2h0W3VzZXJJZF0ucHJvbTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3VzZXJzUGVuZGluZ1t1c2VySWRdID0ge307XG4gICAgICAgIHRoaXMuX3VzZXJzUGVuZGluZ1t1c2VySWRdLnByb20gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLl91c2Vyc1BlbmRpbmdbdXNlcklkXS5yZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgICAgICAgIHRoaXMuX3VzZXJzUGVuZGluZ1t1c2VySWRdLnJlamVjdCA9IHJlamVjdDtcbiAgICAgICAgfSkudGhlbigoZ3JvdXBzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl91c2VyR3JvdXBzW3VzZXJJZF0gPSBncm91cHM7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fdXNlckdyb3Vwc1t1c2VySWRdO1xuICAgICAgICAgICAgfSwgVVNFUl9HUk9VUFNfQ0FDSEVfQlVTVF9NUyk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdXNlckdyb3Vwc1t1c2VySWRdO1xuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAvLyBJbmRpY2F0ZSB3aGV0aGVyIHRoZSBob21lc2VydmVyIHN1cHBvcnRzIGdyb3Vwc1xuICAgICAgICAgICAgaWYgKGVyci5lcnJjb2RlID09PSAnTV9VTlJFQ09HTklaRUQnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdDYW5ub3QgZGlzcGxheSBmbGFpciwgc2VydmVyIGRvZXMgbm90IHN1cHBvcnQgZ3JvdXBzJyk7XG4gICAgICAgICAgICAgICAgZ3JvdXBTdXBwb3J0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgLy8gUmV0dXJuIHNpbGVudGx5IHRvIGF2b2lkIHNwYW1taW5nIGZvciBub24tc3VwcG9ydGluZyBzZXJ2ZXJzXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignQ291bGQgbm90IGdldCBncm91cHMgZm9yIHVzZXInLCB1c2VySWQsIGVycik7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3VzZXJzSW5GbGlnaHRbdXNlcklkXTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVGhpcyBkZWJvdW5jZSB3aWxsIGFsbG93IGNvbnNlY3V0aXZlIHJlcXVlc3RzIGZvciB0aGUgcHVibGljIGdyb3VwcyBvZiB1c2VycyB0aGF0XG4gICAgICAgIC8vIGFyZSBzZW50IGluIGludGVydmFscyBvZiA8IEJVTEtfUkVRVUVTVF9ERUJPVU5DRV9NUyB0byBiZSBiYXRjaGVkIGFuZCBvbmx5IHJlcXVlc3RlZFxuICAgICAgICAvLyB3aGVuIG5vIG1vcmUgcmVxdWVzdHMgYXJlIHJlY2VpdmVkIHdpdGhpbiB0aGUgbmV4dCBCVUxLX1JFUVVFU1RfREVCT1VOQ0VfTVMuIFRoZSBuYWl2ZVxuICAgICAgICAvLyBpbXBsZW1lbnRhdGlvbiB3b3VsZCBkbyBhIHJlcXVlc3QgdGhhdCBvbmx5IHJlcXVlc3RlZCB0aGUgZ3JvdXBzIGZvciBgdXNlcklkYCwgbGVhZGluZ1xuICAgICAgICAvLyB0byBhIHdvcnN0IGFuZCBiZXN0IGNhc2Ugb2YgMSB1c2VyIHBlciByZXF1ZXN0LiBUaGlzIGltcGxlbWVudGF0aW9uJ3Mgd29yc3QgaXMgc3RpbGxcbiAgICAgICAgLy8gMSB1c2VyIHBlciByZXF1ZXN0IGJ1dCBvbmx5IGlmIHRoZSByZXF1ZXN0cyBhcmUgPiBCVUxLX1JFUVVFU1RfREVCT1VOQ0VfTVMgYXBhcnQgYW5kIHRoZVxuICAgICAgICAvLyBiZXN0IGNhc2UgaXMgTiB1c2VycyBwZXIgcmVxdWVzdC5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gVGhpcyBpcyB0byByZWR1Y2UgdGhlIG51bWJlciBvZiByZXF1ZXN0cyBtYWRlIHdoaWxzdCB0cmFkaW5nIG9mZiBsYXRlbmN5IHdoZW4gdmlld2luZ1xuICAgICAgICAvLyBhIEZsYWlyIGNvbXBvbmVudC5cbiAgICAgICAgaWYgKHRoaXMuX2RlYm91bmNlVGltZW91dElEKSBjbGVhclRpbWVvdXQodGhpcy5fZGVib3VuY2VUaW1lb3V0SUQpO1xuICAgICAgICB0aGlzLl9kZWJvdW5jZVRpbWVvdXRJRCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fYmF0Y2hlZEdldFB1YmxpY0dyb3VwcyhtYXRyaXhDbGllbnQpO1xuICAgICAgICB9LCBCVUxLX1JFUVVFU1RfREVCT1VOQ0VfTVMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl91c2Vyc1BlbmRpbmdbdXNlcklkXS5wcm9tO1xuICAgIH1cblxuICAgIGFzeW5jIF9iYXRjaGVkR2V0UHVibGljR3JvdXBzKG1hdHJpeENsaWVudCkge1xuICAgICAgICAvLyBNb3ZlIHVzZXJzIHBlbmRpbmcgdG8gdXNlcnMgaW4gZmxpZ2h0XG4gICAgICAgIHRoaXMuX3VzZXJzSW5GbGlnaHQgPSB0aGlzLl91c2Vyc1BlbmRpbmc7XG4gICAgICAgIHRoaXMuX3VzZXJzUGVuZGluZyA9IHt9O1xuXG4gICAgICAgIGxldCByZXNwID0ge1xuICAgICAgICAgICAgdXNlcnM6IFtdLFxuICAgICAgICB9O1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzcCA9IGF3YWl0IG1hdHJpeENsaWVudC5nZXRQdWJsaWNpc2VkR3JvdXBzKE9iamVjdC5rZXlzKHRoaXMuX3VzZXJzSW5GbGlnaHQpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAvLyBQcm9wYWdhdGUgdGhlIHNhbWUgZXJyb3IgdG8gYWxsIHVzZXJzSW5GbGlnaHRcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMuX3VzZXJzSW5GbGlnaHQpLmZvckVhY2goKHVzZXJJZCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFRoZSBwcm9taXNlIHNob3VsZCBhbHdheXMgZXhpc3QgZm9yIHVzZXJJZCwgYnV0IGRvIGEgbnVsbC1jaGVjayBhbnl3YXlcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3VzZXJzSW5GbGlnaHRbdXNlcklkXSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VzZXJzSW5GbGlnaHRbdXNlcklkXS5yZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHVwZGF0ZWRVc2VyR3JvdXBzID0gcmVzcC51c2VycztcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5fdXNlcnNJbkZsaWdodCkuZm9yRWFjaCgodXNlcklkKSA9PiB7XG4gICAgICAgICAgICAvLyBUaGUgcHJvbWlzZSBzaG91bGQgYWx3YXlzIGV4aXN0IGZvciB1c2VySWQsIGJ1dCBkbyBhIG51bGwtY2hlY2sgYW55d2F5XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3VzZXJzSW5GbGlnaHRbdXNlcklkXSkgcmV0dXJuO1xuICAgICAgICAgICAgdGhpcy5fdXNlcnNJbkZsaWdodFt1c2VySWRdLnJlc29sdmUodXBkYXRlZFVzZXJHcm91cHNbdXNlcklkXSB8fCBbXSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEdyb3VwUHJvZmlsZUNhY2hlZChtYXRyaXhDbGllbnQsIGdyb3VwSWQpIHtcbiAgICAgICAgaWYgKHRoaXMuX2dyb3VwUHJvZmlsZXNbZ3JvdXBJZF0pIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9ncm91cFByb2ZpbGVzW2dyb3VwSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQSByZXF1ZXN0IGlzIG9uZ29pbmcsIHdhaXQgZm9yIGl0IHRvIGNvbXBsZXRlIGFuZCByZXR1cm4gdGhlIGdyb3VwIHByb2ZpbGUuXG4gICAgICAgIGlmICh0aGlzLl9ncm91cFByb2ZpbGVzUHJvbWlzZVtncm91cElkXSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9ncm91cFByb2ZpbGVzUHJvbWlzZVtncm91cElkXTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAvLyBEb24ndCBsb2cgdGhlIGVycm9yOyB0aGlzIGlzIGRvbmUgYmVsb3dcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9ncm91cFByb2ZpbGVzW2dyb3VwSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTm8gcmVxdWVzdCB5ZXQsIHN0YXJ0IG9uZVxuICAgICAgICBjb25zb2xlLmxvZygnRmxhaXJTdG9yZTogUmVxdWVzdCBncm91cCBwcm9maWxlIG9mICcgKyBncm91cElkKTtcbiAgICAgICAgdGhpcy5fZ3JvdXBQcm9maWxlc1Byb21pc2VbZ3JvdXBJZF0gPSBtYXRyaXhDbGllbnQuZ2V0R3JvdXBQcm9maWxlKGdyb3VwSWQpO1xuXG4gICAgICAgIGxldCBwcm9maWxlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcHJvZmlsZSA9IGF3YWl0IHRoaXMuX2dyb3VwUHJvZmlsZXNQcm9taXNlW2dyb3VwSWRdO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnRmxhaXJTdG9yZTogRmFpbGVkIHRvIGdldCBncm91cCBwcm9maWxlIGZvciAnICsgZ3JvdXBJZCwgZSk7XG4gICAgICAgICAgICAvLyBEb24ndCByZXRyeSwgYnV0IGFsbG93IGEgcmV0cnkgd2hlbiB0aGUgcHJvZmlsZSBpcyBuZXh0IHJlcXVlc3RlZFxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2dyb3VwUHJvZmlsZXNQcm9taXNlW2dyb3VwSWRdO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9ncm91cFByb2ZpbGVzW2dyb3VwSWRdID0ge1xuICAgICAgICAgICAgZ3JvdXBJZCxcbiAgICAgICAgICAgIGF2YXRhclVybDogcHJvZmlsZS5hdmF0YXJfdXJsLFxuICAgICAgICAgICAgbmFtZTogcHJvZmlsZS5uYW1lLFxuICAgICAgICAgICAgc2hvcnREZXNjcmlwdGlvbjogcHJvZmlsZS5zaG9ydF9kZXNjcmlwdGlvbixcbiAgICAgICAgfTtcbiAgICAgICAgZGVsZXRlIHRoaXMuX2dyb3VwUHJvZmlsZXNQcm9taXNlW2dyb3VwSWRdO1xuXG4gICAgICAgIC8vLyBYWFg6IFRoaXMgaXMgdmVyZ2luZyBvbiByZWNyZWF0aW5nIGEgdGhpcmQgXCJGbHV4XCItbG9va2luZyBTdG9yZS4gV2UgcmVhbGx5XG4gICAgICAgIC8vLyBzaG91bGQgcmVwbGFjZSBGbGFpclN0b3JlIHdpdGggYSBGbHV4IHN0b3JlIGFuZCBzb21lIGFzeW5jIGFjdGlvbnMuXG4gICAgICAgIGNvbnNvbGUubG9nKCdGbGFpclN0b3JlOiBFbWl0IHVwZGF0ZUdyb3VwUHJvZmlsZSBmb3IgJyArIGdyb3VwSWQpO1xuICAgICAgICB0aGlzLmVtaXQoJ3VwZGF0ZUdyb3VwUHJvZmlsZScpO1xuXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWZyZXNoR3JvdXBQcm9maWxlKG1hdHJpeENsaWVudCwgZ3JvdXBJZCk7XG4gICAgICAgIH0sIEdST1VQX1BST0ZJTEVTX0NBQ0hFX0JVU1RfTVMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9ncm91cFByb2ZpbGVzW2dyb3VwSWRdO1xuICAgIH1cblxuICAgIHJlZnJlc2hHcm91cFByb2ZpbGUobWF0cml4Q2xpZW50LCBncm91cElkKSB7XG4gICAgICAgIC8vIEludmFsaWRhdGUgdGhlIGNhY2hlXG4gICAgICAgIGRlbGV0ZSB0aGlzLl9ncm91cFByb2ZpbGVzW2dyb3VwSWRdO1xuICAgICAgICAvLyBGZXRjaCBuZXcgcHJvZmlsZSBkYXRhLCBhbmQgY2FjaGUgaXRcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBQcm9maWxlQ2FjaGVkKG1hdHJpeENsaWVudCwgZ3JvdXBJZCk7XG4gICAgfVxufVxuXG5pZiAoZ2xvYmFsLnNpbmdsZXRvbkZsYWlyU3RvcmUgPT09IHVuZGVmaW5lZCkge1xuICAgIGdsb2JhbC5zaW5nbGV0b25GbGFpclN0b3JlID0gbmV3IEZsYWlyU3RvcmUoKTtcbn1cbmV4cG9ydCBkZWZhdWx0IGdsb2JhbC5zaW5nbGV0b25GbGFpclN0b3JlO1xuIl19