"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var RoomNotifs = _interopRequireWildcard(require("../RoomNotifs"));

var _RoomListStore = _interopRequireDefault(require("./RoomListStore"));

var _events = _interopRequireDefault(require("events"));

var _lodash = require("lodash");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

/*
Copyright 2019 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const STANDARD_TAGS_REGEX = /^(m\.(favourite|lowpriority|server_notice)|im\.vector\.fake\.(invite|recent|direct|archived))$/;

function commonPrefix(a, b) {
  const len = Math.min(a.length, b.length);
  let prefix;

  for (let i = 0; i < len; ++i) {
    if (a.charAt(i) !== b.charAt(i)) {
      prefix = a.substr(0, i);
      break;
    }
  }

  if (prefix === undefined) {
    prefix = a.substr(0, len);
  }

  const spaceIdx = prefix.indexOf(' ');

  if (spaceIdx !== -1) {
    prefix = prefix.substr(0, spaceIdx + 1);
  }

  if (prefix.length >= 2) {
    return prefix;
  }

  return "";
}
/**
 * A class for storing application state for ordering tags in the TagPanel.
 */


class CustomRoomTagStore extends _events.default {
  constructor() {
    super(); // Initialise state

    this._state = {
      tags: {}
    }; // as RoomListStore gets updated by every timeline event
    // throttle this to only run every 500ms

    this._getUpdatedTags = (0, _lodash.throttle)(this._getUpdatedTags, 500, {
      leading: true,
      trailing: true
    });
    this._roomListStoreToken = _RoomListStore.default.addListener(() => {
      this._setState({
        tags: this._getUpdatedTags()
      });
    });

    _dispatcher.default.register(payload => this._onDispatch(payload));
  }

  getTags() {
    return this._state.tags;
  }

  _setState(newState) {
    this._state = Object.assign(this._state, newState);
    this.emit("change");
  }

  addListener(callback) {
    this.on("change", callback);
    return {
      remove: () => {
        this.removeListener("change", callback);
      }
    };
  }

  getSortedTags() {
    const roomLists = _RoomListStore.default.getRoomLists();

    const tagNames = Object.keys(this._state.tags).sort();
    const prefixes = tagNames.map((name, i) => {
      const isFirst = i === 0;
      const isLast = i === tagNames.length - 1;
      const backwardsPrefix = !isFirst ? commonPrefix(name, tagNames[i - 1]) : "";
      const forwardsPrefix = !isLast ? commonPrefix(name, tagNames[i + 1]) : "";
      const longestPrefix = backwardsPrefix.length > forwardsPrefix.length ? backwardsPrefix : forwardsPrefix;
      return longestPrefix;
    });
    return tagNames.map((name, i) => {
      const notifs = RoomNotifs.aggregateNotificationCount(roomLists[name]);
      let badge;

      if (notifs.count !== 0) {
        badge = notifs;
      }

      const avatarLetter = name.substr(prefixes[i].length, 1);
      const selected = this._state.tags[name];
      return {
        name,
        avatarLetter,
        badge,
        selected
      };
    });
  }

  _onDispatch(payload) {
    switch (payload.action) {
      case 'select_custom_room_tag':
        {
          const oldTags = this._state.tags;

          if (oldTags.hasOwnProperty(payload.tag)) {
            const tag = {};
            tag[payload.tag] = !oldTags[payload.tag];
            const tags = Object.assign({}, oldTags, tag);

            this._setState({
              tags
            });
          }
        }
        break;

      case 'on_client_not_viable':
      case 'on_logged_out':
        {
          // we assume to always have a tags object in the state
          this._state = {
            tags: {}
          };

          if (this._roomListStoreToken) {
            this._roomListStoreToken.remove();

            this._roomListStoreToken = null;
          }
        }
        break;
    }
  }

  _getUpdatedTags() {
    if (!_SettingsStore.default.isFeatureEnabled("feature_custom_tags")) {
      return;
    }

    const newTagNames = Object.keys(_RoomListStore.default.getRoomLists()).filter(tagName => {
      return !tagName.match(STANDARD_TAGS_REGEX);
    }).sort();
    const prevTags = this._state && this._state.tags;
    const newTags = newTagNames.reduce((newTags, tagName) => {
      newTags[tagName] = prevTags && prevTags[tagName] || false;
      return newTags;
    }, {});
    return newTags;
  }

}

if (global.singletonCustomRoomTagStore === undefined) {
  global.singletonCustomRoomTagStore = new CustomRoomTagStore();
}

var _default = global.singletonCustomRoomTagStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvQ3VzdG9tUm9vbVRhZ1N0b3JlLmpzIl0sIm5hbWVzIjpbIlNUQU5EQVJEX1RBR1NfUkVHRVgiLCJjb21tb25QcmVmaXgiLCJhIiwiYiIsImxlbiIsIk1hdGgiLCJtaW4iLCJsZW5ndGgiLCJwcmVmaXgiLCJpIiwiY2hhckF0Iiwic3Vic3RyIiwidW5kZWZpbmVkIiwic3BhY2VJZHgiLCJpbmRleE9mIiwiQ3VzdG9tUm9vbVRhZ1N0b3JlIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJfc3RhdGUiLCJ0YWdzIiwiX2dldFVwZGF0ZWRUYWdzIiwibGVhZGluZyIsInRyYWlsaW5nIiwiX3Jvb21MaXN0U3RvcmVUb2tlbiIsIlJvb21MaXN0U3RvcmUiLCJhZGRMaXN0ZW5lciIsIl9zZXRTdGF0ZSIsImRpcyIsInJlZ2lzdGVyIiwicGF5bG9hZCIsIl9vbkRpc3BhdGNoIiwiZ2V0VGFncyIsIm5ld1N0YXRlIiwiT2JqZWN0IiwiYXNzaWduIiwiZW1pdCIsImNhbGxiYWNrIiwib24iLCJyZW1vdmUiLCJyZW1vdmVMaXN0ZW5lciIsImdldFNvcnRlZFRhZ3MiLCJyb29tTGlzdHMiLCJnZXRSb29tTGlzdHMiLCJ0YWdOYW1lcyIsImtleXMiLCJzb3J0IiwicHJlZml4ZXMiLCJtYXAiLCJuYW1lIiwiaXNGaXJzdCIsImlzTGFzdCIsImJhY2t3YXJkc1ByZWZpeCIsImZvcndhcmRzUHJlZml4IiwibG9uZ2VzdFByZWZpeCIsIm5vdGlmcyIsIlJvb21Ob3RpZnMiLCJhZ2dyZWdhdGVOb3RpZmljYXRpb25Db3VudCIsImJhZGdlIiwiY291bnQiLCJhdmF0YXJMZXR0ZXIiLCJzZWxlY3RlZCIsImFjdGlvbiIsIm9sZFRhZ3MiLCJoYXNPd25Qcm9wZXJ0eSIsInRhZyIsIlNldHRpbmdzU3RvcmUiLCJpc0ZlYXR1cmVFbmFibGVkIiwibmV3VGFnTmFtZXMiLCJmaWx0ZXIiLCJ0YWdOYW1lIiwibWF0Y2giLCJwcmV2VGFncyIsIm5ld1RhZ3MiLCJyZWR1Y2UiLCJnbG9iYWwiLCJzaW5nbGV0b25DdXN0b21Sb29tVGFnU3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBcEJBOzs7Ozs7Ozs7Ozs7Ozs7QUFzQkEsTUFBTUEsbUJBQW1CLEdBQUcsZ0dBQTVCOztBQUVBLFNBQVNDLFlBQVQsQ0FBc0JDLENBQXRCLEVBQXlCQyxDQUF6QixFQUE0QjtBQUN4QixRQUFNQyxHQUFHLEdBQUdDLElBQUksQ0FBQ0MsR0FBTCxDQUFTSixDQUFDLENBQUNLLE1BQVgsRUFBbUJKLENBQUMsQ0FBQ0ksTUFBckIsQ0FBWjtBQUNBLE1BQUlDLE1BQUo7O0FBQ0EsT0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHTCxHQUFwQixFQUF5QixFQUFFSyxDQUEzQixFQUE4QjtBQUMxQixRQUFJUCxDQUFDLENBQUNRLE1BQUYsQ0FBU0QsQ0FBVCxNQUFnQk4sQ0FBQyxDQUFDTyxNQUFGLENBQVNELENBQVQsQ0FBcEIsRUFBaUM7QUFDN0JELE1BQUFBLE1BQU0sR0FBR04sQ0FBQyxDQUFDUyxNQUFGLENBQVMsQ0FBVCxFQUFZRixDQUFaLENBQVQ7QUFDQTtBQUNIO0FBQ0o7O0FBQ0QsTUFBSUQsTUFBTSxLQUFLSSxTQUFmLEVBQTBCO0FBQ3RCSixJQUFBQSxNQUFNLEdBQUdOLENBQUMsQ0FBQ1MsTUFBRixDQUFTLENBQVQsRUFBWVAsR0FBWixDQUFUO0FBQ0g7O0FBQ0QsUUFBTVMsUUFBUSxHQUFHTCxNQUFNLENBQUNNLE9BQVAsQ0FBZSxHQUFmLENBQWpCOztBQUNBLE1BQUlELFFBQVEsS0FBSyxDQUFDLENBQWxCLEVBQXFCO0FBQ2pCTCxJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0csTUFBUCxDQUFjLENBQWQsRUFBaUJFLFFBQVEsR0FBRyxDQUE1QixDQUFUO0FBQ0g7O0FBQ0QsTUFBSUwsTUFBTSxDQUFDRCxNQUFQLElBQWlCLENBQXJCLEVBQXdCO0FBQ3BCLFdBQU9DLE1BQVA7QUFDSDs7QUFDRCxTQUFPLEVBQVA7QUFDSDtBQUNEOzs7OztBQUdBLE1BQU1PLGtCQUFOLFNBQWlDQyxlQUFqQyxDQUE4QztBQUMxQ0MsRUFBQUEsV0FBVyxHQUFHO0FBQ1YsWUFEVSxDQUVWOztBQUNBLFNBQUtDLE1BQUwsR0FBYztBQUFDQyxNQUFBQSxJQUFJLEVBQUU7QUFBUCxLQUFkLENBSFUsQ0FLVjtBQUNBOztBQUNBLFNBQUtDLGVBQUwsR0FBdUIsc0JBQ25CLEtBQUtBLGVBRGMsRUFDRyxHQURILEVBQ1E7QUFDdkJDLE1BQUFBLE9BQU8sRUFBRSxJQURjO0FBRXZCQyxNQUFBQSxRQUFRLEVBQUU7QUFGYSxLQURSLENBQXZCO0FBTUEsU0FBS0MsbUJBQUwsR0FBMkJDLHVCQUFjQyxXQUFkLENBQTBCLE1BQU07QUFDdkQsV0FBS0MsU0FBTCxDQUFlO0FBQUNQLFFBQUFBLElBQUksRUFBRSxLQUFLQyxlQUFMO0FBQVAsT0FBZjtBQUNILEtBRjBCLENBQTNCOztBQUdBTyx3QkFBSUMsUUFBSixDQUFhQyxPQUFPLElBQUksS0FBS0MsV0FBTCxDQUFpQkQsT0FBakIsQ0FBeEI7QUFDSDs7QUFFREUsRUFBQUEsT0FBTyxHQUFHO0FBQ04sV0FBTyxLQUFLYixNQUFMLENBQVlDLElBQW5CO0FBQ0g7O0FBRURPLEVBQUFBLFNBQVMsQ0FBQ00sUUFBRCxFQUFXO0FBQ2hCLFNBQUtkLE1BQUwsR0FBY2UsTUFBTSxDQUFDQyxNQUFQLENBQWMsS0FBS2hCLE1BQW5CLEVBQTJCYyxRQUEzQixDQUFkO0FBQ0EsU0FBS0csSUFBTCxDQUFVLFFBQVY7QUFDSDs7QUFFRFYsRUFBQUEsV0FBVyxDQUFDVyxRQUFELEVBQVc7QUFDbEIsU0FBS0MsRUFBTCxDQUFRLFFBQVIsRUFBa0JELFFBQWxCO0FBQ0EsV0FBTztBQUNIRSxNQUFBQSxNQUFNLEVBQUUsTUFBTTtBQUNWLGFBQUtDLGNBQUwsQ0FBb0IsUUFBcEIsRUFBOEJILFFBQTlCO0FBQ0g7QUFIRSxLQUFQO0FBS0g7O0FBRURJLEVBQUFBLGFBQWEsR0FBRztBQUNaLFVBQU1DLFNBQVMsR0FBR2pCLHVCQUFja0IsWUFBZCxFQUFsQjs7QUFFQSxVQUFNQyxRQUFRLEdBQUdWLE1BQU0sQ0FBQ1csSUFBUCxDQUFZLEtBQUsxQixNQUFMLENBQVlDLElBQXhCLEVBQThCMEIsSUFBOUIsRUFBakI7QUFDQSxVQUFNQyxRQUFRLEdBQUdILFFBQVEsQ0FBQ0ksR0FBVCxDQUFhLENBQUNDLElBQUQsRUFBT3ZDLENBQVAsS0FBYTtBQUN2QyxZQUFNd0MsT0FBTyxHQUFHeEMsQ0FBQyxLQUFLLENBQXRCO0FBQ0EsWUFBTXlDLE1BQU0sR0FBR3pDLENBQUMsS0FBS2tDLFFBQVEsQ0FBQ3BDLE1BQVQsR0FBa0IsQ0FBdkM7QUFDQSxZQUFNNEMsZUFBZSxHQUFHLENBQUNGLE9BQUQsR0FBV2hELFlBQVksQ0FBQytDLElBQUQsRUFBT0wsUUFBUSxDQUFDbEMsQ0FBQyxHQUFHLENBQUwsQ0FBZixDQUF2QixHQUFpRCxFQUF6RTtBQUNBLFlBQU0yQyxjQUFjLEdBQUcsQ0FBQ0YsTUFBRCxHQUFVakQsWUFBWSxDQUFDK0MsSUFBRCxFQUFPTCxRQUFRLENBQUNsQyxDQUFDLEdBQUcsQ0FBTCxDQUFmLENBQXRCLEdBQWdELEVBQXZFO0FBQ0EsWUFBTTRDLGFBQWEsR0FBR0YsZUFBZSxDQUFDNUMsTUFBaEIsR0FBeUI2QyxjQUFjLENBQUM3QyxNQUF4QyxHQUNsQjRDLGVBRGtCLEdBQ0FDLGNBRHRCO0FBRUEsYUFBT0MsYUFBUDtBQUNILEtBUmdCLENBQWpCO0FBU0EsV0FBT1YsUUFBUSxDQUFDSSxHQUFULENBQWEsQ0FBQ0MsSUFBRCxFQUFPdkMsQ0FBUCxLQUFhO0FBQzdCLFlBQU02QyxNQUFNLEdBQUdDLFVBQVUsQ0FBQ0MsMEJBQVgsQ0FBc0NmLFNBQVMsQ0FBQ08sSUFBRCxDQUEvQyxDQUFmO0FBQ0EsVUFBSVMsS0FBSjs7QUFDQSxVQUFJSCxNQUFNLENBQUNJLEtBQVAsS0FBaUIsQ0FBckIsRUFBd0I7QUFDcEJELFFBQUFBLEtBQUssR0FBR0gsTUFBUjtBQUNIOztBQUNELFlBQU1LLFlBQVksR0FBR1gsSUFBSSxDQUFDckMsTUFBTCxDQUFZbUMsUUFBUSxDQUFDckMsQ0FBRCxDQUFSLENBQVlGLE1BQXhCLEVBQWdDLENBQWhDLENBQXJCO0FBQ0EsWUFBTXFELFFBQVEsR0FBRyxLQUFLMUMsTUFBTCxDQUFZQyxJQUFaLENBQWlCNkIsSUFBakIsQ0FBakI7QUFDQSxhQUFPO0FBQUNBLFFBQUFBLElBQUQ7QUFBT1csUUFBQUEsWUFBUDtBQUFxQkYsUUFBQUEsS0FBckI7QUFBNEJHLFFBQUFBO0FBQTVCLE9BQVA7QUFDSCxLQVRNLENBQVA7QUFVSDs7QUFHRDlCLEVBQUFBLFdBQVcsQ0FBQ0QsT0FBRCxFQUFVO0FBQ2pCLFlBQVFBLE9BQU8sQ0FBQ2dDLE1BQWhCO0FBQ0ksV0FBSyx3QkFBTDtBQUErQjtBQUMzQixnQkFBTUMsT0FBTyxHQUFHLEtBQUs1QyxNQUFMLENBQVlDLElBQTVCOztBQUNBLGNBQUkyQyxPQUFPLENBQUNDLGNBQVIsQ0FBdUJsQyxPQUFPLENBQUNtQyxHQUEvQixDQUFKLEVBQXlDO0FBQ3JDLGtCQUFNQSxHQUFHLEdBQUcsRUFBWjtBQUNBQSxZQUFBQSxHQUFHLENBQUNuQyxPQUFPLENBQUNtQyxHQUFULENBQUgsR0FBbUIsQ0FBQ0YsT0FBTyxDQUFDakMsT0FBTyxDQUFDbUMsR0FBVCxDQUEzQjtBQUNBLGtCQUFNN0MsSUFBSSxHQUFHYyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCNEIsT0FBbEIsRUFBMkJFLEdBQTNCLENBQWI7O0FBQ0EsaUJBQUt0QyxTQUFMLENBQWU7QUFBQ1AsY0FBQUE7QUFBRCxhQUFmO0FBQ0g7QUFDSjtBQUNEOztBQUNBLFdBQUssc0JBQUw7QUFDQSxXQUFLLGVBQUw7QUFBc0I7QUFDbEI7QUFDQSxlQUFLRCxNQUFMLEdBQWM7QUFBQ0MsWUFBQUEsSUFBSSxFQUFFO0FBQVAsV0FBZDs7QUFDQSxjQUFJLEtBQUtJLG1CQUFULEVBQThCO0FBQzFCLGlCQUFLQSxtQkFBTCxDQUF5QmUsTUFBekI7O0FBQ0EsaUJBQUtmLG1CQUFMLEdBQTJCLElBQTNCO0FBQ0g7QUFDSjtBQUNEO0FBcEJKO0FBc0JIOztBQUVESCxFQUFBQSxlQUFlLEdBQUc7QUFDZCxRQUFJLENBQUM2Qyx1QkFBY0MsZ0JBQWQsQ0FBK0IscUJBQS9CLENBQUwsRUFBNEQ7QUFDeEQ7QUFDSDs7QUFFRCxVQUFNQyxXQUFXLEdBQUdsQyxNQUFNLENBQUNXLElBQVAsQ0FBWXBCLHVCQUFja0IsWUFBZCxFQUFaLEVBQ2YwQixNQURlLENBQ1BDLE9BQUQsSUFBYTtBQUNqQixhQUFPLENBQUNBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjdEUsbUJBQWQsQ0FBUjtBQUNILEtBSGUsRUFHYjZDLElBSGEsRUFBcEI7QUFJQSxVQUFNMEIsUUFBUSxHQUFHLEtBQUtyRCxNQUFMLElBQWUsS0FBS0EsTUFBTCxDQUFZQyxJQUE1QztBQUNBLFVBQU1xRCxPQUFPLEdBQUdMLFdBQVcsQ0FBQ00sTUFBWixDQUFtQixDQUFDRCxPQUFELEVBQVVILE9BQVYsS0FBc0I7QUFDckRHLE1BQUFBLE9BQU8sQ0FBQ0gsT0FBRCxDQUFQLEdBQW9CRSxRQUFRLElBQUlBLFFBQVEsQ0FBQ0YsT0FBRCxDQUFyQixJQUFtQyxLQUF0RDtBQUNBLGFBQU9HLE9BQVA7QUFDSCxLQUhlLEVBR2IsRUFIYSxDQUFoQjtBQUlBLFdBQU9BLE9BQVA7QUFDSDs7QUF4R3lDOztBQTJHOUMsSUFBSUUsTUFBTSxDQUFDQywyQkFBUCxLQUF1Qy9ELFNBQTNDLEVBQXNEO0FBQ2xEOEQsRUFBQUEsTUFBTSxDQUFDQywyQkFBUCxHQUFxQyxJQUFJNUQsa0JBQUosRUFBckM7QUFDSDs7ZUFDYzJELE1BQU0sQ0FBQ0MsMkIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgTmV3IFZlY3RvciBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuaW1wb3J0IGRpcyBmcm9tICcuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0ICogYXMgUm9vbU5vdGlmcyBmcm9tICcuLi9Sb29tTm90aWZzJztcbmltcG9ydCBSb29tTGlzdFN0b3JlIGZyb20gJy4vUm9vbUxpc3RTdG9yZSc7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5cbmNvbnN0IFNUQU5EQVJEX1RBR1NfUkVHRVggPSAvXihtXFwuKGZhdm91cml0ZXxsb3dwcmlvcml0eXxzZXJ2ZXJfbm90aWNlKXxpbVxcLnZlY3RvclxcLmZha2VcXC4oaW52aXRlfHJlY2VudHxkaXJlY3R8YXJjaGl2ZWQpKSQvO1xuXG5mdW5jdGlvbiBjb21tb25QcmVmaXgoYSwgYikge1xuICAgIGNvbnN0IGxlbiA9IE1hdGgubWluKGEubGVuZ3RoLCBiLmxlbmd0aCk7XG4gICAgbGV0IHByZWZpeDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgIGlmIChhLmNoYXJBdChpKSAhPT0gYi5jaGFyQXQoaSkpIHtcbiAgICAgICAgICAgIHByZWZpeCA9IGEuc3Vic3RyKDAsIGkpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHByZWZpeCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHByZWZpeCA9IGEuc3Vic3RyKDAsIGxlbik7XG4gICAgfVxuICAgIGNvbnN0IHNwYWNlSWR4ID0gcHJlZml4LmluZGV4T2YoJyAnKTtcbiAgICBpZiAoc3BhY2VJZHggIT09IC0xKSB7XG4gICAgICAgIHByZWZpeCA9IHByZWZpeC5zdWJzdHIoMCwgc3BhY2VJZHggKyAxKTtcbiAgICB9XG4gICAgaWYgKHByZWZpeC5sZW5ndGggPj0gMikge1xuICAgICAgICByZXR1cm4gcHJlZml4O1xuICAgIH1cbiAgICByZXR1cm4gXCJcIjtcbn1cbi8qKlxuICogQSBjbGFzcyBmb3Igc3RvcmluZyBhcHBsaWNhdGlvbiBzdGF0ZSBmb3Igb3JkZXJpbmcgdGFncyBpbiB0aGUgVGFnUGFuZWwuXG4gKi9cbmNsYXNzIEN1c3RvbVJvb21UYWdTdG9yZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIC8vIEluaXRpYWxpc2Ugc3RhdGVcbiAgICAgICAgdGhpcy5fc3RhdGUgPSB7dGFnczoge319O1xuXG4gICAgICAgIC8vIGFzIFJvb21MaXN0U3RvcmUgZ2V0cyB1cGRhdGVkIGJ5IGV2ZXJ5IHRpbWVsaW5lIGV2ZW50XG4gICAgICAgIC8vIHRocm90dGxlIHRoaXMgdG8gb25seSBydW4gZXZlcnkgNTAwbXNcbiAgICAgICAgdGhpcy5fZ2V0VXBkYXRlZFRhZ3MgPSB0aHJvdHRsZShcbiAgICAgICAgICAgIHRoaXMuX2dldFVwZGF0ZWRUYWdzLCA1MDAsIHtcbiAgICAgICAgICAgICAgICBsZWFkaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRyYWlsaW5nOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5fcm9vbUxpc3RTdG9yZVRva2VuID0gUm9vbUxpc3RTdG9yZS5hZGRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9zZXRTdGF0ZSh7dGFnczogdGhpcy5fZ2V0VXBkYXRlZFRhZ3MoKX0pO1xuICAgICAgICB9KTtcbiAgICAgICAgZGlzLnJlZ2lzdGVyKHBheWxvYWQgPT4gdGhpcy5fb25EaXNwYXRjaChwYXlsb2FkKSk7XG4gICAgfVxuXG4gICAgZ2V0VGFncygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLnRhZ3M7XG4gICAgfVxuXG4gICAgX3NldFN0YXRlKG5ld1N0YXRlKSB7XG4gICAgICAgIHRoaXMuX3N0YXRlID0gT2JqZWN0LmFzc2lnbih0aGlzLl9zdGF0ZSwgbmV3U3RhdGUpO1xuICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIik7XG4gICAgfVxuXG4gICAgYWRkTGlzdGVuZXIoY2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5vbihcImNoYW5nZVwiLCBjYWxsYmFjayk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZW1vdmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKFwiY2hhbmdlXCIsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0U29ydGVkVGFncygpIHtcbiAgICAgICAgY29uc3Qgcm9vbUxpc3RzID0gUm9vbUxpc3RTdG9yZS5nZXRSb29tTGlzdHMoKTtcblxuICAgICAgICBjb25zdCB0YWdOYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuX3N0YXRlLnRhZ3MpLnNvcnQoKTtcbiAgICAgICAgY29uc3QgcHJlZml4ZXMgPSB0YWdOYW1lcy5tYXAoKG5hbWUsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlzRmlyc3QgPSBpID09PSAwO1xuICAgICAgICAgICAgY29uc3QgaXNMYXN0ID0gaSA9PT0gdGFnTmFtZXMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgIGNvbnN0IGJhY2t3YXJkc1ByZWZpeCA9ICFpc0ZpcnN0ID8gY29tbW9uUHJlZml4KG5hbWUsIHRhZ05hbWVzW2kgLSAxXSkgOiBcIlwiO1xuICAgICAgICAgICAgY29uc3QgZm9yd2FyZHNQcmVmaXggPSAhaXNMYXN0ID8gY29tbW9uUHJlZml4KG5hbWUsIHRhZ05hbWVzW2kgKyAxXSkgOiBcIlwiO1xuICAgICAgICAgICAgY29uc3QgbG9uZ2VzdFByZWZpeCA9IGJhY2t3YXJkc1ByZWZpeC5sZW5ndGggPiBmb3J3YXJkc1ByZWZpeC5sZW5ndGggP1xuICAgICAgICAgICAgICAgIGJhY2t3YXJkc1ByZWZpeCA6IGZvcndhcmRzUHJlZml4O1xuICAgICAgICAgICAgcmV0dXJuIGxvbmdlc3RQcmVmaXg7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGFnTmFtZXMubWFwKChuYW1lLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3RpZnMgPSBSb29tTm90aWZzLmFnZ3JlZ2F0ZU5vdGlmaWNhdGlvbkNvdW50KHJvb21MaXN0c1tuYW1lXSk7XG4gICAgICAgICAgICBsZXQgYmFkZ2U7XG4gICAgICAgICAgICBpZiAobm90aWZzLmNvdW50ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgYmFkZ2UgPSBub3RpZnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBhdmF0YXJMZXR0ZXIgPSBuYW1lLnN1YnN0cihwcmVmaXhlc1tpXS5sZW5ndGgsIDEpO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSB0aGlzLl9zdGF0ZS50YWdzW25hbWVdO1xuICAgICAgICAgICAgcmV0dXJuIHtuYW1lLCBhdmF0YXJMZXR0ZXIsIGJhZGdlLCBzZWxlY3RlZH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgX29uRGlzcGF0Y2gocGF5bG9hZCkge1xuICAgICAgICBzd2l0Y2ggKHBheWxvYWQuYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdzZWxlY3RfY3VzdG9tX3Jvb21fdGFnJzoge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9sZFRhZ3MgPSB0aGlzLl9zdGF0ZS50YWdzO1xuICAgICAgICAgICAgICAgIGlmIChvbGRUYWdzLmhhc093blByb3BlcnR5KHBheWxvYWQudGFnKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWcgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdGFnW3BheWxvYWQudGFnXSA9ICFvbGRUYWdzW3BheWxvYWQudGFnXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFncyA9IE9iamVjdC5hc3NpZ24oe30sIG9sZFRhZ3MsIHRhZyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHt0YWdzfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdvbl9jbGllbnRfbm90X3ZpYWJsZSc6XG4gICAgICAgICAgICBjYXNlICdvbl9sb2dnZWRfb3V0Jzoge1xuICAgICAgICAgICAgICAgIC8vIHdlIGFzc3VtZSB0byBhbHdheXMgaGF2ZSBhIHRhZ3Mgb2JqZWN0IGluIHRoZSBzdGF0ZVxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlID0ge3RhZ3M6IHt9fTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcm9vbUxpc3RTdG9yZVRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jvb21MaXN0U3RvcmVUb2tlbi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcm9vbUxpc3RTdG9yZVRva2VuID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9nZXRVcGRhdGVkVGFncygpIHtcbiAgICAgICAgaWYgKCFTZXR0aW5nc1N0b3JlLmlzRmVhdHVyZUVuYWJsZWQoXCJmZWF0dXJlX2N1c3RvbV90YWdzXCIpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXdUYWdOYW1lcyA9IE9iamVjdC5rZXlzKFJvb21MaXN0U3RvcmUuZ2V0Um9vbUxpc3RzKCkpXG4gICAgICAgICAgICAuZmlsdGVyKCh0YWdOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICF0YWdOYW1lLm1hdGNoKFNUQU5EQVJEX1RBR1NfUkVHRVgpO1xuICAgICAgICAgICAgfSkuc29ydCgpO1xuICAgICAgICBjb25zdCBwcmV2VGFncyA9IHRoaXMuX3N0YXRlICYmIHRoaXMuX3N0YXRlLnRhZ3M7XG4gICAgICAgIGNvbnN0IG5ld1RhZ3MgPSBuZXdUYWdOYW1lcy5yZWR1Y2UoKG5ld1RhZ3MsIHRhZ05hbWUpID0+IHtcbiAgICAgICAgICAgIG5ld1RhZ3NbdGFnTmFtZV0gPSAocHJldlRhZ3MgJiYgcHJldlRhZ3NbdGFnTmFtZV0pIHx8IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuIG5ld1RhZ3M7XG4gICAgICAgIH0sIHt9KTtcbiAgICAgICAgcmV0dXJuIG5ld1RhZ3M7XG4gICAgfVxufVxuXG5pZiAoZ2xvYmFsLnNpbmdsZXRvbkN1c3RvbVJvb21UYWdTdG9yZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgZ2xvYmFsLnNpbmdsZXRvbkN1c3RvbVJvb21UYWdTdG9yZSA9IG5ldyBDdXN0b21Sb29tVGFnU3RvcmUoKTtcbn1cbmV4cG9ydCBkZWZhdWx0IGdsb2JhbC5zaW5nbGV0b25DdXN0b21Sb29tVGFnU3RvcmU7XG4iXX0=