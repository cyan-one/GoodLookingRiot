"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _events = _interopRequireDefault(require("events"));

var _groups = require("../groups");

var _FlairStore = _interopRequireDefault(require("./FlairStore"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

/*
Copyright 2017 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function parseMembersResponse(response) {
  return response.chunk.map(apiMember => (0, _groups.groupMemberFromApiObject)(apiMember));
}

function parseRoomsResponse(response) {
  return response.chunk.map(apiRoom => (0, _groups.groupRoomFromApiObject)(apiRoom));
} // The number of ongoing group requests


let ongoingRequestCount = 0; // This has arbitrarily been set to a small number to lower the priority
// of doing group-related requests because we care about other important
// requests like hitting /sync.

const LIMIT = 3; // Maximum number of ongoing group requests
// FIFO queue of functions to call in the backlog

const backlogQueue = [// () => {...}
]; // Pull from the FIFO queue

function checkBacklog() {
  const item = backlogQueue.shift();
  if (typeof item === 'function') item();
} // Limit the maximum number of ongoing promises returned by fn to LIMIT and
// use a FIFO queue to handle the backlog.


async function limitConcurrency(fn) {
  if (ongoingRequestCount >= LIMIT) {
    // Enqueue this request for later execution
    await new Promise((resolve, reject) => {
      backlogQueue.push(resolve);
    });
  }

  ongoingRequestCount++;

  try {
    return await fn();
  } catch (err) {
    // We explicitly do not handle the error here, but let it propogate.
    throw err;
  } finally {
    ongoingRequestCount--;
    checkBacklog();
  }
}
/**
 * Global store for tracking group summary, members, invited members and rooms.
 */


class GroupStore extends _events.default {
  constructor() {
    super();
    (0, _defineProperty2.default)(this, "STATE_KEY", {
      GroupMembers: 'GroupMembers',
      GroupInvitedMembers: 'GroupInvitedMembers',
      Summary: 'Summary',
      GroupRooms: 'GroupRooms'
    });
    this._state = {};
    this._state[this.STATE_KEY.Summary] = {};
    this._state[this.STATE_KEY.GroupRooms] = {};
    this._state[this.STATE_KEY.GroupMembers] = {};
    this._state[this.STATE_KEY.GroupInvitedMembers] = {};
    this._ready = {};
    this._ready[this.STATE_KEY.Summary] = {};
    this._ready[this.STATE_KEY.GroupRooms] = {};
    this._ready[this.STATE_KEY.GroupMembers] = {};
    this._ready[this.STATE_KEY.GroupInvitedMembers] = {};
    this._fetchResourcePromise = {
      [this.STATE_KEY.Summary]: {},
      [this.STATE_KEY.GroupRooms]: {},
      [this.STATE_KEY.GroupMembers]: {},
      [this.STATE_KEY.GroupInvitedMembers]: {}
    };
    this._resourceFetcher = {
      [this.STATE_KEY.Summary]: groupId => {
        return limitConcurrency(() => _MatrixClientPeg.MatrixClientPeg.get().getGroupSummary(groupId));
      },
      [this.STATE_KEY.GroupRooms]: groupId => {
        return limitConcurrency(() => _MatrixClientPeg.MatrixClientPeg.get().getGroupRooms(groupId).then(parseRoomsResponse));
      },
      [this.STATE_KEY.GroupMembers]: groupId => {
        return limitConcurrency(() => _MatrixClientPeg.MatrixClientPeg.get().getGroupUsers(groupId).then(parseMembersResponse));
      },
      [this.STATE_KEY.GroupInvitedMembers]: groupId => {
        return limitConcurrency(() => _MatrixClientPeg.MatrixClientPeg.get().getGroupInvitedUsers(groupId).then(parseMembersResponse));
      }
    };
  }

  _fetchResource(stateKey, groupId) {
    // Ongoing request, ignore
    if (this._fetchResourcePromise[stateKey][groupId]) return;

    const clientPromise = this._resourceFetcher[stateKey](groupId); // Indicate ongoing request


    this._fetchResourcePromise[stateKey][groupId] = clientPromise;
    clientPromise.then(result => {
      this._state[stateKey][groupId] = result;
      this._ready[stateKey][groupId] = true;

      this._notifyListeners();
    }).catch(err => {
      // Invited users not visible to non-members
      if (stateKey === this.STATE_KEY.GroupInvitedMembers && err.httpStatus === 403) {
        return;
      }

      console.error("Failed to get resource ".concat(stateKey, " for ").concat(groupId), err);
      this.emit('error', err, groupId, stateKey);
    }).finally(() => {
      // Indicate finished request, allow for future fetches
      delete this._fetchResourcePromise[stateKey][groupId];
    });
    return clientPromise;
  }

  _notifyListeners() {
    this.emit('update');
  }
  /**
   * Register a listener to recieve updates from the store. This also
   * immediately triggers an update to send the current state of the
   * store (which could be the initial state).
   *
   * If a group ID is specified, this also causes a fetch of all data
   * of the specified group, which might cause 4 separate HTTP
   * requests, but only if said requests aren't already ongoing.
   *
   * @param {string?} groupId the ID of the group to fetch data for.
   *                          Optional.
   * @param {function} fn the function to call when the store updates.
   * @return {Object} tok a registration "token" with a single
   *                      property `unregister`, a function that can
   *                      be called to unregister the listener such
   *                      that it won't be called any more.
   */


  registerListener(groupId, fn) {
    this.on('update', fn); // Call to set initial state (before fetching starts)

    this.emit('update');

    if (groupId) {
      this._fetchResource(this.STATE_KEY.Summary, groupId);

      this._fetchResource(this.STATE_KEY.GroupRooms, groupId);

      this._fetchResource(this.STATE_KEY.GroupMembers, groupId);

      this._fetchResource(this.STATE_KEY.GroupInvitedMembers, groupId);
    } // Similar to the Store of flux/utils, we return a "token" that
    // can be used to unregister the listener.


    return {
      unregister: () => {
        this.unregisterListener(fn);
      }
    };
  }

  unregisterListener(fn) {
    this.removeListener('update', fn);
  }

  isStateReady(groupId, id) {
    return this._ready[id][groupId];
  }

  getGroupIdsForRoomId(roomId) {
    const groupIds = Object.keys(this._state[this.STATE_KEY.GroupRooms]);
    return groupIds.filter(groupId => {
      const rooms = this._state[this.STATE_KEY.GroupRooms][groupId] || [];
      return rooms.some(room => room.roomId === roomId);
    });
  }

  getSummary(groupId) {
    return this._state[this.STATE_KEY.Summary][groupId] || {};
  }

  getGroupRooms(groupId) {
    return this._state[this.STATE_KEY.GroupRooms][groupId] || [];
  }

  getGroupMembers(groupId) {
    return this._state[this.STATE_KEY.GroupMembers][groupId] || [];
  }

  getGroupInvitedMembers(groupId) {
    return this._state[this.STATE_KEY.GroupInvitedMembers][groupId] || [];
  }

  getGroupPublicity(groupId) {
    return (this._state[this.STATE_KEY.Summary][groupId] || {}).user ? (this._state[this.STATE_KEY.Summary][groupId] || {}).user.is_publicised : null;
  }

  isUserPrivileged(groupId) {
    return (this._state[this.STATE_KEY.Summary][groupId] || {}).user ? (this._state[this.STATE_KEY.Summary][groupId] || {}).user.is_privileged : null;
  }

  refreshGroupRooms(groupId) {
    return this._fetchResource(this.STATE_KEY.GroupRooms, groupId);
  }

  refreshGroupMembers(groupId) {
    return this._fetchResource(this.STATE_KEY.GroupMembers, groupId);
  }

  addRoomToGroup(groupId, roomId, isPublic) {
    return _MatrixClientPeg.MatrixClientPeg.get().addRoomToGroup(groupId, roomId, isPublic).then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId));
  }

  updateGroupRoomVisibility(groupId, roomId, isPublic) {
    return _MatrixClientPeg.MatrixClientPeg.get().updateGroupRoomVisibility(groupId, roomId, isPublic).then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId));
  }

  removeRoomFromGroup(groupId, roomId) {
    return _MatrixClientPeg.MatrixClientPeg.get().removeRoomFromGroup(groupId, roomId) // Room might be in the summary, refresh just in case
    .then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId)).then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId));
  }

  inviteUserToGroup(groupId, userId) {
    return _MatrixClientPeg.MatrixClientPeg.get().inviteUserToGroup(groupId, userId).then(this._fetchResource.bind(this, this.STATE_KEY.GroupInvitedMembers, groupId));
  }

  acceptGroupInvite(groupId) {
    return _MatrixClientPeg.MatrixClientPeg.get().acceptGroupInvite(groupId) // The user should now be able to access (personal) group settings
    .then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId)) // The user might be able to see more rooms now
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId)) // The user should now appear as a member
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupMembers, groupId)) // The user should now not appear as an invited member
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupInvitedMembers, groupId));
  }

  joinGroup(groupId) {
    return _MatrixClientPeg.MatrixClientPeg.get().joinGroup(groupId) // The user should now be able to access (personal) group settings
    .then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId)) // The user might be able to see more rooms now
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId)) // The user should now appear as a member
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupMembers, groupId)) // The user should now not appear as an invited member
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupInvitedMembers, groupId));
  }

  leaveGroup(groupId) {
    // ensure the tag panel filter is cleared if the group was selected
    _dispatcher.default.dispatch({
      action: "deselect_tags",
      tag: groupId
    });

    return _MatrixClientPeg.MatrixClientPeg.get().leaveGroup(groupId) // The user should now not be able to access group settings
    .then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId)) // The user might only be able to see a subset of rooms now
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupRooms, groupId)) // The user should now not appear as a member
    .then(this._fetchResource.bind(this, this.STATE_KEY.GroupMembers, groupId));
  }

  addRoomToGroupSummary(groupId, roomId, categoryId) {
    return _MatrixClientPeg.MatrixClientPeg.get().addRoomToGroupSummary(groupId, roomId, categoryId).then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId));
  }

  addUserToGroupSummary(groupId, userId, roleId) {
    return _MatrixClientPeg.MatrixClientPeg.get().addUserToGroupSummary(groupId, userId, roleId).then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId));
  }

  removeRoomFromGroupSummary(groupId, roomId) {
    return _MatrixClientPeg.MatrixClientPeg.get().removeRoomFromGroupSummary(groupId, roomId).then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId));
  }

  removeUserFromGroupSummary(groupId, userId) {
    return _MatrixClientPeg.MatrixClientPeg.get().removeUserFromGroupSummary(groupId, userId).then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId));
  }

  setGroupPublicity(groupId, isPublished) {
    return _MatrixClientPeg.MatrixClientPeg.get().setGroupPublicity(groupId, isPublished).then(() => {
      _FlairStore.default.invalidatePublicisedGroups(_MatrixClientPeg.MatrixClientPeg.get().credentials.userId);
    }).then(this._fetchResource.bind(this, this.STATE_KEY.Summary, groupId));
  }

}

let singletonGroupStore = null;

if (!singletonGroupStore) {
  singletonGroupStore = new GroupStore();
}

var _default = singletonGroupStore;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yZXMvR3JvdXBTdG9yZS5qcyJdLCJuYW1lcyI6WyJwYXJzZU1lbWJlcnNSZXNwb25zZSIsInJlc3BvbnNlIiwiY2h1bmsiLCJtYXAiLCJhcGlNZW1iZXIiLCJwYXJzZVJvb21zUmVzcG9uc2UiLCJhcGlSb29tIiwib25nb2luZ1JlcXVlc3RDb3VudCIsIkxJTUlUIiwiYmFja2xvZ1F1ZXVlIiwiY2hlY2tCYWNrbG9nIiwiaXRlbSIsInNoaWZ0IiwibGltaXRDb25jdXJyZW5jeSIsImZuIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwdXNoIiwiZXJyIiwiR3JvdXBTdG9yZSIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwiR3JvdXBNZW1iZXJzIiwiR3JvdXBJbnZpdGVkTWVtYmVycyIsIlN1bW1hcnkiLCJHcm91cFJvb21zIiwiX3N0YXRlIiwiU1RBVEVfS0VZIiwiX3JlYWR5IiwiX2ZldGNoUmVzb3VyY2VQcm9taXNlIiwiX3Jlc291cmNlRmV0Y2hlciIsImdyb3VwSWQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJnZXRHcm91cFN1bW1hcnkiLCJnZXRHcm91cFJvb21zIiwidGhlbiIsImdldEdyb3VwVXNlcnMiLCJnZXRHcm91cEludml0ZWRVc2VycyIsIl9mZXRjaFJlc291cmNlIiwic3RhdGVLZXkiLCJjbGllbnRQcm9taXNlIiwicmVzdWx0IiwiX25vdGlmeUxpc3RlbmVycyIsImNhdGNoIiwiaHR0cFN0YXR1cyIsImNvbnNvbGUiLCJlcnJvciIsImVtaXQiLCJmaW5hbGx5IiwicmVnaXN0ZXJMaXN0ZW5lciIsIm9uIiwidW5yZWdpc3RlciIsInVucmVnaXN0ZXJMaXN0ZW5lciIsInJlbW92ZUxpc3RlbmVyIiwiaXNTdGF0ZVJlYWR5IiwiaWQiLCJnZXRHcm91cElkc0ZvclJvb21JZCIsInJvb21JZCIsImdyb3VwSWRzIiwiT2JqZWN0Iiwia2V5cyIsImZpbHRlciIsInJvb21zIiwic29tZSIsInJvb20iLCJnZXRTdW1tYXJ5IiwiZ2V0R3JvdXBNZW1iZXJzIiwiZ2V0R3JvdXBJbnZpdGVkTWVtYmVycyIsImdldEdyb3VwUHVibGljaXR5IiwidXNlciIsImlzX3B1YmxpY2lzZWQiLCJpc1VzZXJQcml2aWxlZ2VkIiwiaXNfcHJpdmlsZWdlZCIsInJlZnJlc2hHcm91cFJvb21zIiwicmVmcmVzaEdyb3VwTWVtYmVycyIsImFkZFJvb21Ub0dyb3VwIiwiaXNQdWJsaWMiLCJiaW5kIiwidXBkYXRlR3JvdXBSb29tVmlzaWJpbGl0eSIsInJlbW92ZVJvb21Gcm9tR3JvdXAiLCJpbnZpdGVVc2VyVG9Hcm91cCIsInVzZXJJZCIsImFjY2VwdEdyb3VwSW52aXRlIiwiam9pbkdyb3VwIiwibGVhdmVHcm91cCIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwidGFnIiwiYWRkUm9vbVRvR3JvdXBTdW1tYXJ5IiwiY2F0ZWdvcnlJZCIsImFkZFVzZXJUb0dyb3VwU3VtbWFyeSIsInJvbGVJZCIsInJlbW92ZVJvb21Gcm9tR3JvdXBTdW1tYXJ5IiwicmVtb3ZlVXNlckZyb21Hcm91cFN1bW1hcnkiLCJzZXRHcm91cFB1YmxpY2l0eSIsImlzUHVibGlzaGVkIiwiRmxhaXJTdG9yZSIsImludmFsaWRhdGVQdWJsaWNpc2VkR3JvdXBzIiwiY3JlZGVudGlhbHMiLCJzaW5nbGV0b25Hcm91cFN0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFwQkE7Ozs7Ozs7Ozs7Ozs7OztBQXNCQSxTQUFTQSxvQkFBVCxDQUE4QkMsUUFBOUIsRUFBd0M7QUFDcEMsU0FBT0EsUUFBUSxDQUFDQyxLQUFULENBQWVDLEdBQWYsQ0FBb0JDLFNBQUQsSUFBZSxzQ0FBeUJBLFNBQXpCLENBQWxDLENBQVA7QUFDSDs7QUFFRCxTQUFTQyxrQkFBVCxDQUE0QkosUUFBNUIsRUFBc0M7QUFDbEMsU0FBT0EsUUFBUSxDQUFDQyxLQUFULENBQWVDLEdBQWYsQ0FBb0JHLE9BQUQsSUFBYSxv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a0NtRCxNQURsQyxFQUVGOUMsSUFGRSxDQUVHLEtBQUtHLGNBQUwsQ0FBb0J1QyxJQUFwQixDQUF5QixJQUF6QixFQUErQixLQUFLbkQsU0FBTCxDQUFlSCxPQUE5QyxFQUF1RE8sT0FBdkQsQ0FGSCxDQUFQO0FBR0g7O0FBRURpRSxFQUFBQSxpQkFBaUIsQ0FBQ2pFLE9BQUQsRUFBVWtFLFdBQVYsRUFBdUI7QUFDcEMsV0FBT2pFLGlDQUFnQkMsR0FBaEIsR0FDRitELGlCQURFLENBQ2dCakUsT0FEaEIsRUFDeUJrRSxXQUR6QixFQUVGN0QsSUFGRSxDQUVHLE1BQU07QUFBRThELDBCQUFXQywwQkFBWCxDQUFzQ25FLGlDQUFnQkMsR0FBaEIsR0FBc0JtRSxXQUF0QixDQUFrQ2xCLE1BQXhFO0FBQWtGLEtBRjdGLEVBR0Y5QyxJQUhFLENBR0csS0FBS0csY0FBTCxDQUFvQnVDLElBQXBCLENBQXlCLElBQXpCLEVBQStCLEtBQUtuRCxTQUFMLENBQWVILE9BQTlDLEVBQXVETyxPQUF2RCxDQUhILENBQVA7QUFJSDs7QUEzUWlDOztBQThRdEMsSUFBSXNFLG1CQUFtQixHQUFHLElBQTFCOztBQUNBLElBQUksQ0FBQ0EsbUJBQUwsRUFBMEI7QUFDdEJBLEVBQUFBLG1CQUFtQixHQUFHLElBQUlsRixVQUFKLEVBQXRCO0FBQ0g7O2VBQ2NrRixtQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGdyb3VwTWVtYmVyRnJvbUFwaU9iamVjdCwgZ3JvdXBSb29tRnJvbUFwaU9iamVjdCB9IGZyb20gJy4uL2dyb3Vwcyc7XG5pbXBvcnQgRmxhaXJTdG9yZSBmcm9tICcuL0ZsYWlyU3RvcmUnO1xuaW1wb3J0IHtNYXRyaXhDbGllbnRQZWd9IGZyb20gJy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgZGlzIGZyb20gJy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5cbmZ1bmN0aW9uIHBhcnNlTWVtYmVyc1Jlc3BvbnNlKHJlc3BvbnNlKSB7XG4gICAgcmV0dXJuIHJlc3BvbnNlLmNodW5rLm1hcCgoYXBpTWVtYmVyKSA9PiBncm91cE1lbWJlckZyb21BcGlPYmplY3QoYXBpTWVtYmVyKSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlUm9vbXNSZXNwb25zZShyZXNwb25zZSkge1xuICAgIHJldHVybiByZXNwb25zZS5jaHVuay5tYXAoKGFwaVJvb20pID0+IGdyb3VwUm9vbUZyb21BcGlPYmplY3QoYXBpUm9vbSkpO1xufVxuXG4vLyBUaGUgbnVtYmVyIG9mIG9uZ29pbmcgZ3JvdXAgcmVxdWVzdHNcbmxldCBvbmdvaW5nUmVxdWVzdENvdW50ID0gMDtcblxuLy8gVGhpcyBoYXMgYXJiaXRyYXJpbHkgYmVlbiBzZXQgdG8gYSBzbWFsbCBudW1iZXIgdG8gbG93ZXIgdGhlIHByaW9yaXR5XG4vLyBvZiBkb2luZyBncm91cC1yZWxhdGVkIHJlcXVlc3RzIGJlY2F1c2Ugd2UgY2FyZSBhYm91dCBvdGhlciBpbXBvcnRhbnRcbi8vIHJlcXVlc3RzIGxpa2UgaGl0dGluZyAvc3luYy5cbmNvbnN0IExJTUlUID0gMzsgLy8gTWF4aW11bSBudW1iZXIgb2Ygb25nb2luZyBncm91cCByZXF1ZXN0c1xuXG4vLyBGSUZPIHF1ZXVlIG9mIGZ1bmN0aW9ucyB0byBjYWxsIGluIHRoZSBiYWNrbG9nXG5jb25zdCBiYWNrbG9nUXVldWUgPSBbXG4gICAgLy8gKCkgPT4gey4uLn1cbl07XG5cbi8vIFB1bGwgZnJvbSB0aGUgRklGTyBxdWV1ZVxuZnVuY3Rpb24gY2hlY2tCYWNrbG9nKCkge1xuICAgIGNvbnN0IGl0ZW0gPSBiYWNrbG9nUXVldWUuc2hpZnQoKTtcbiAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdmdW5jdGlvbicpIGl0ZW0oKTtcbn1cblxuLy8gTGltaXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIG9uZ29pbmcgcHJvbWlzZXMgcmV0dXJuZWQgYnkgZm4gdG8gTElNSVQgYW5kXG4vLyB1c2UgYSBGSUZPIHF1ZXVlIHRvIGhhbmRsZSB0aGUgYmFja2xvZy5cbmFzeW5jIGZ1bmN0aW9uIGxpbWl0Q29uY3VycmVuY3koZm4pIHtcbiAgICBpZiAob25nb2luZ1JlcXVlc3RDb3VudCA+PSBMSU1JVCkge1xuICAgICAgICAvLyBFbnF1ZXVlIHRoaXMgcmVxdWVzdCBmb3IgbGF0ZXIgZXhlY3V0aW9uXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGJhY2tsb2dRdWV1ZS5wdXNoKHJlc29sdmUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbmdvaW5nUmVxdWVzdENvdW50Kys7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIFdlIGV4cGxpY2l0bHkgZG8gbm90IGhhbmRsZSB0aGUgZXJyb3IgaGVyZSwgYnV0IGxldCBpdCBwcm9wb2dhdGUuXG4gICAgICAgIHRocm93IGVycjtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgICBvbmdvaW5nUmVxdWVzdENvdW50LS07XG4gICAgICAgIGNoZWNrQmFja2xvZygpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBHbG9iYWwgc3RvcmUgZm9yIHRyYWNraW5nIGdyb3VwIHN1bW1hcnksIG1lbWJlcnMsIGludml0ZWQgbWVtYmVycyBhbmQgcm9vbXMuXG4gKi9cbmNsYXNzIEdyb3VwU3RvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIFNUQVRFX0tFWSA9IHtcbiAgICAgICAgR3JvdXBNZW1iZXJzOiAnR3JvdXBNZW1iZXJzJyxcbiAgICAgICAgR3JvdXBJbnZpdGVkTWVtYmVyczogJ0dyb3VwSW52aXRlZE1lbWJlcnMnLFxuICAgICAgICBTdW1tYXJ5OiAnU3VtbWFyeScsXG4gICAgICAgIEdyb3VwUm9vbXM6ICdHcm91cFJvb21zJyxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX3N0YXRlID0ge307XG4gICAgICAgIHRoaXMuX3N0YXRlW3RoaXMuU1RBVEVfS0VZLlN1bW1hcnldID0ge307XG4gICAgICAgIHRoaXMuX3N0YXRlW3RoaXMuU1RBVEVfS0VZLkdyb3VwUm9vbXNdID0ge307XG4gICAgICAgIHRoaXMuX3N0YXRlW3RoaXMuU1RBVEVfS0VZLkdyb3VwTWVtYmVyc10gPSB7fTtcbiAgICAgICAgdGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuR3JvdXBJbnZpdGVkTWVtYmVyc10gPSB7fTtcblxuICAgICAgICB0aGlzLl9yZWFkeSA9IHt9O1xuICAgICAgICB0aGlzLl9yZWFkeVt0aGlzLlNUQVRFX0tFWS5TdW1tYXJ5XSA9IHt9O1xuICAgICAgICB0aGlzLl9yZWFkeVt0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zXSA9IHt9O1xuICAgICAgICB0aGlzLl9yZWFkeVt0aGlzLlNUQVRFX0tFWS5Hcm91cE1lbWJlcnNdID0ge307XG4gICAgICAgIHRoaXMuX3JlYWR5W3RoaXMuU1RBVEVfS0VZLkdyb3VwSW52aXRlZE1lbWJlcnNdID0ge307XG5cbiAgICAgICAgdGhpcy5fZmV0Y2hSZXNvdXJjZVByb21pc2UgPSB7XG4gICAgICAgICAgICBbdGhpcy5TVEFURV9LRVkuU3VtbWFyeV06IHt9LFxuICAgICAgICAgICAgW3RoaXMuU1RBVEVfS0VZLkdyb3VwUm9vbXNdOiB7fSxcbiAgICAgICAgICAgIFt0aGlzLlNUQVRFX0tFWS5Hcm91cE1lbWJlcnNdOiB7fSxcbiAgICAgICAgICAgIFt0aGlzLlNUQVRFX0tFWS5Hcm91cEludml0ZWRNZW1iZXJzXToge30sXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fcmVzb3VyY2VGZXRjaGVyID0ge1xuICAgICAgICAgICAgW3RoaXMuU1RBVEVfS0VZLlN1bW1hcnldOiAoZ3JvdXBJZCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaW1pdENvbmN1cnJlbmN5KFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0R3JvdXBTdW1tYXJ5KGdyb3VwSWQpLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgW3RoaXMuU1RBVEVfS0VZLkdyb3VwUm9vbXNdOiAoZ3JvdXBJZCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaW1pdENvbmN1cnJlbmN5KFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0R3JvdXBSb29tcyhncm91cElkKS50aGVuKHBhcnNlUm9vbXNSZXNwb25zZSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBbdGhpcy5TVEFURV9LRVkuR3JvdXBNZW1iZXJzXTogKGdyb3VwSWQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbGltaXRDb25jdXJyZW5jeShcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldEdyb3VwVXNlcnMoZ3JvdXBJZCkudGhlbihwYXJzZU1lbWJlcnNSZXNwb25zZSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBbdGhpcy5TVEFURV9LRVkuR3JvdXBJbnZpdGVkTWVtYmVyc106IChncm91cElkKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxpbWl0Q29uY3VycmVuY3koXG4gICAgICAgICAgICAgICAgICAgICgpID0+IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRHcm91cEludml0ZWRVc2Vycyhncm91cElkKS50aGVuKHBhcnNlTWVtYmVyc1Jlc3BvbnNlKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfZmV0Y2hSZXNvdXJjZShzdGF0ZUtleSwgZ3JvdXBJZCkge1xuICAgICAgICAvLyBPbmdvaW5nIHJlcXVlc3QsIGlnbm9yZVxuICAgICAgICBpZiAodGhpcy5fZmV0Y2hSZXNvdXJjZVByb21pc2Vbc3RhdGVLZXldW2dyb3VwSWRdKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgY2xpZW50UHJvbWlzZSA9IHRoaXMuX3Jlc291cmNlRmV0Y2hlcltzdGF0ZUtleV0oZ3JvdXBJZCk7XG5cbiAgICAgICAgLy8gSW5kaWNhdGUgb25nb2luZyByZXF1ZXN0XG4gICAgICAgIHRoaXMuX2ZldGNoUmVzb3VyY2VQcm9taXNlW3N0YXRlS2V5XVtncm91cElkXSA9IGNsaWVudFByb21pc2U7XG5cbiAgICAgICAgY2xpZW50UHJvbWlzZS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3N0YXRlW3N0YXRlS2V5XVtncm91cElkXSA9IHJlc3VsdDtcbiAgICAgICAgICAgIHRoaXMuX3JlYWR5W3N0YXRlS2V5XVtncm91cElkXSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLl9ub3RpZnlMaXN0ZW5lcnMoKTtcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgLy8gSW52aXRlZCB1c2VycyBub3QgdmlzaWJsZSB0byBub24tbWVtYmVyc1xuICAgICAgICAgICAgaWYgKHN0YXRlS2V5ID09PSB0aGlzLlNUQVRFX0tFWS5Hcm91cEludml0ZWRNZW1iZXJzICYmIGVyci5odHRwU3RhdHVzID09PSA0MDMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBnZXQgcmVzb3VyY2UgJHtzdGF0ZUtleX0gZm9yICR7Z3JvdXBJZH1gLCBlcnIpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVyciwgZ3JvdXBJZCwgc3RhdGVLZXkpO1xuICAgICAgICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICAgIC8vIEluZGljYXRlIGZpbmlzaGVkIHJlcXVlc3QsIGFsbG93IGZvciBmdXR1cmUgZmV0Y2hlc1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ZldGNoUmVzb3VyY2VQcm9taXNlW3N0YXRlS2V5XVtncm91cElkXTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudFByb21pc2U7XG4gICAgfVxuXG4gICAgX25vdGlmeUxpc3RlbmVycygpIHtcbiAgICAgICAgdGhpcy5lbWl0KCd1cGRhdGUnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBhIGxpc3RlbmVyIHRvIHJlY2lldmUgdXBkYXRlcyBmcm9tIHRoZSBzdG9yZS4gVGhpcyBhbHNvXG4gICAgICogaW1tZWRpYXRlbHkgdHJpZ2dlcnMgYW4gdXBkYXRlIHRvIHNlbmQgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlXG4gICAgICogc3RvcmUgKHdoaWNoIGNvdWxkIGJlIHRoZSBpbml0aWFsIHN0YXRlKS5cbiAgICAgKlxuICAgICAqIElmIGEgZ3JvdXAgSUQgaXMgc3BlY2lmaWVkLCB0aGlzIGFsc28gY2F1c2VzIGEgZmV0Y2ggb2YgYWxsIGRhdGFcbiAgICAgKiBvZiB0aGUgc3BlY2lmaWVkIGdyb3VwLCB3aGljaCBtaWdodCBjYXVzZSA0IHNlcGFyYXRlIEhUVFBcbiAgICAgKiByZXF1ZXN0cywgYnV0IG9ubHkgaWYgc2FpZCByZXF1ZXN0cyBhcmVuJ3QgYWxyZWFkeSBvbmdvaW5nLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmc/fSBncm91cElkIHRoZSBJRCBvZiB0aGUgZ3JvdXAgdG8gZmV0Y2ggZGF0YSBmb3IuXG4gICAgICogICAgICAgICAgICAgICAgICAgICAgICAgIE9wdGlvbmFsLlxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZuIHRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIHN0b3JlIHVwZGF0ZXMuXG4gICAgICogQHJldHVybiB7T2JqZWN0fSB0b2sgYSByZWdpc3RyYXRpb24gXCJ0b2tlblwiIHdpdGggYSBzaW5nbGVcbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eSBgdW5yZWdpc3RlcmAsIGEgZnVuY3Rpb24gdGhhdCBjYW5cbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICBiZSBjYWxsZWQgdG8gdW5yZWdpc3RlciB0aGUgbGlzdGVuZXIgc3VjaFxuICAgICAqICAgICAgICAgICAgICAgICAgICAgIHRoYXQgaXQgd29uJ3QgYmUgY2FsbGVkIGFueSBtb3JlLlxuICAgICAqL1xuICAgIHJlZ2lzdGVyTGlzdGVuZXIoZ3JvdXBJZCwgZm4pIHtcbiAgICAgICAgdGhpcy5vbigndXBkYXRlJywgZm4pO1xuICAgICAgICAvLyBDYWxsIHRvIHNldCBpbml0aWFsIHN0YXRlIChiZWZvcmUgZmV0Y2hpbmcgc3RhcnRzKVxuICAgICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpO1xuXG4gICAgICAgIGlmIChncm91cElkKSB7XG4gICAgICAgICAgICB0aGlzLl9mZXRjaFJlc291cmNlKHRoaXMuU1RBVEVfS0VZLlN1bW1hcnksIGdyb3VwSWQpO1xuICAgICAgICAgICAgdGhpcy5fZmV0Y2hSZXNvdXJjZSh0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zLCBncm91cElkKTtcbiAgICAgICAgICAgIHRoaXMuX2ZldGNoUmVzb3VyY2UodGhpcy5TVEFURV9LRVkuR3JvdXBNZW1iZXJzLCBncm91cElkKTtcbiAgICAgICAgICAgIHRoaXMuX2ZldGNoUmVzb3VyY2UodGhpcy5TVEFURV9LRVkuR3JvdXBJbnZpdGVkTWVtYmVycywgZ3JvdXBJZCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTaW1pbGFyIHRvIHRoZSBTdG9yZSBvZiBmbHV4L3V0aWxzLCB3ZSByZXR1cm4gYSBcInRva2VuXCIgdGhhdFxuICAgICAgICAvLyBjYW4gYmUgdXNlZCB0byB1bnJlZ2lzdGVyIHRoZSBsaXN0ZW5lci5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVucmVnaXN0ZXI6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnVucmVnaXN0ZXJMaXN0ZW5lcihmbik7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHVucmVnaXN0ZXJMaXN0ZW5lcihmbikge1xuICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCd1cGRhdGUnLCBmbik7XG4gICAgfVxuXG4gICAgaXNTdGF0ZVJlYWR5KGdyb3VwSWQsIGlkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWFkeVtpZF1bZ3JvdXBJZF07XG4gICAgfVxuXG4gICAgZ2V0R3JvdXBJZHNGb3JSb29tSWQocm9vbUlkKSB7XG4gICAgICAgIGNvbnN0IGdyb3VwSWRzID0gT2JqZWN0LmtleXModGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuR3JvdXBSb29tc10pO1xuICAgICAgICByZXR1cm4gZ3JvdXBJZHMuZmlsdGVyKGdyb3VwSWQgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm9vbXMgPSB0aGlzLl9zdGF0ZVt0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zXVtncm91cElkXSB8fCBbXTtcbiAgICAgICAgICAgIHJldHVybiByb29tcy5zb21lKHJvb20gPT4gcm9vbS5yb29tSWQgPT09IHJvb21JZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldFN1bW1hcnkoZ3JvdXBJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuU3VtbWFyeV1bZ3JvdXBJZF0gfHwge307XG4gICAgfVxuXG4gICAgZ2V0R3JvdXBSb29tcyhncm91cElkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZVt0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zXVtncm91cElkXSB8fCBbXTtcbiAgICB9XG5cbiAgICBnZXRHcm91cE1lbWJlcnMoZ3JvdXBJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuR3JvdXBNZW1iZXJzXVtncm91cElkXSB8fCBbXTtcbiAgICB9XG5cbiAgICBnZXRHcm91cEludml0ZWRNZW1iZXJzKGdyb3VwSWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlW3RoaXMuU1RBVEVfS0VZLkdyb3VwSW52aXRlZE1lbWJlcnNdW2dyb3VwSWRdIHx8IFtdO1xuICAgIH1cblxuICAgIGdldEdyb3VwUHVibGljaXR5KGdyb3VwSWQpIHtcbiAgICAgICAgcmV0dXJuICh0aGlzLl9zdGF0ZVt0aGlzLlNUQVRFX0tFWS5TdW1tYXJ5XVtncm91cElkXSB8fCB7fSkudXNlciA/XG4gICAgICAgICAgICAodGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuU3VtbWFyeV1bZ3JvdXBJZF0gfHwge30pLnVzZXIuaXNfcHVibGljaXNlZCA6IG51bGw7XG4gICAgfVxuXG4gICAgaXNVc2VyUHJpdmlsZWdlZChncm91cElkKSB7XG4gICAgICAgIHJldHVybiAodGhpcy5fc3RhdGVbdGhpcy5TVEFURV9LRVkuU3VtbWFyeV1bZ3JvdXBJZF0gfHwge30pLnVzZXIgP1xuICAgICAgICAgICAgKHRoaXMuX3N0YXRlW3RoaXMuU1RBVEVfS0VZLlN1bW1hcnldW2dyb3VwSWRdIHx8IHt9KS51c2VyLmlzX3ByaXZpbGVnZWQgOiBudWxsO1xuICAgIH1cblxuICAgIHJlZnJlc2hHcm91cFJvb21zKGdyb3VwSWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoUmVzb3VyY2UodGhpcy5TVEFURV9LRVkuR3JvdXBSb29tcywgZ3JvdXBJZCk7XG4gICAgfVxuXG4gICAgcmVmcmVzaEdyb3VwTWVtYmVycyhncm91cElkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9mZXRjaFJlc291cmNlKHRoaXMuU1RBVEVfS0VZLkdyb3VwTWVtYmVycywgZ3JvdXBJZCk7XG4gICAgfVxuXG4gICAgYWRkUm9vbVRvR3JvdXAoZ3JvdXBJZCwgcm9vbUlkLCBpc1B1YmxpYykge1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpXG4gICAgICAgICAgICAuYWRkUm9vbVRvR3JvdXAoZ3JvdXBJZCwgcm9vbUlkLCBpc1B1YmxpYylcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zLCBncm91cElkKSk7XG4gICAgfVxuXG4gICAgdXBkYXRlR3JvdXBSb29tVmlzaWJpbGl0eShncm91cElkLCByb29tSWQsIGlzUHVibGljKSB7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KClcbiAgICAgICAgICAgIC51cGRhdGVHcm91cFJvb21WaXNpYmlsaXR5KGdyb3VwSWQsIHJvb21JZCwgaXNQdWJsaWMpXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuR3JvdXBSb29tcywgZ3JvdXBJZCkpO1xuICAgIH1cblxuICAgIHJlbW92ZVJvb21Gcm9tR3JvdXAoZ3JvdXBJZCwgcm9vbUlkKSB7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KClcbiAgICAgICAgICAgIC5yZW1vdmVSb29tRnJvbUdyb3VwKGdyb3VwSWQsIHJvb21JZClcbiAgICAgICAgICAgIC8vIFJvb20gbWlnaHQgYmUgaW4gdGhlIHN1bW1hcnksIHJlZnJlc2gganVzdCBpbiBjYXNlXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuU3VtbWFyeSwgZ3JvdXBJZCkpXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuR3JvdXBSb29tcywgZ3JvdXBJZCkpO1xuICAgIH1cblxuICAgIGludml0ZVVzZXJUb0dyb3VwKGdyb3VwSWQsIHVzZXJJZCkge1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLmludml0ZVVzZXJUb0dyb3VwKGdyb3VwSWQsIHVzZXJJZClcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5Hcm91cEludml0ZWRNZW1iZXJzLCBncm91cElkKSk7XG4gICAgfVxuXG4gICAgYWNjZXB0R3JvdXBJbnZpdGUoZ3JvdXBJZCkge1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLmFjY2VwdEdyb3VwSW52aXRlKGdyb3VwSWQpXG4gICAgICAgICAgICAvLyBUaGUgdXNlciBzaG91bGQgbm93IGJlIGFibGUgdG8gYWNjZXNzIChwZXJzb25hbCkgZ3JvdXAgc2V0dGluZ3NcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5TdW1tYXJ5LCBncm91cElkKSlcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIG1pZ2h0IGJlIGFibGUgdG8gc2VlIG1vcmUgcm9vbXMgbm93XG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuR3JvdXBSb29tcywgZ3JvdXBJZCkpXG4gICAgICAgICAgICAvLyBUaGUgdXNlciBzaG91bGQgbm93IGFwcGVhciBhcyBhIG1lbWJlclxuICAgICAgICAgICAgLnRoZW4odGhpcy5fZmV0Y2hSZXNvdXJjZS5iaW5kKHRoaXMsIHRoaXMuU1RBVEVfS0VZLkdyb3VwTWVtYmVycywgZ3JvdXBJZCkpXG4gICAgICAgICAgICAvLyBUaGUgdXNlciBzaG91bGQgbm93IG5vdCBhcHBlYXIgYXMgYW4gaW52aXRlZCBtZW1iZXJcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5Hcm91cEludml0ZWRNZW1iZXJzLCBncm91cElkKSk7XG4gICAgfVxuXG4gICAgam9pbkdyb3VwKGdyb3VwSWQpIHtcbiAgICAgICAgcmV0dXJuIE1hdHJpeENsaWVudFBlZy5nZXQoKS5qb2luR3JvdXAoZ3JvdXBJZClcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIHNob3VsZCBub3cgYmUgYWJsZSB0byBhY2Nlc3MgKHBlcnNvbmFsKSBncm91cCBzZXR0aW5nc1xuICAgICAgICAgICAgLnRoZW4odGhpcy5fZmV0Y2hSZXNvdXJjZS5iaW5kKHRoaXMsIHRoaXMuU1RBVEVfS0VZLlN1bW1hcnksIGdyb3VwSWQpKVxuICAgICAgICAgICAgLy8gVGhlIHVzZXIgbWlnaHQgYmUgYWJsZSB0byBzZWUgbW9yZSByb29tcyBub3dcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5Hcm91cFJvb21zLCBncm91cElkKSlcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIHNob3VsZCBub3cgYXBwZWFyIGFzIGEgbWVtYmVyXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuR3JvdXBNZW1iZXJzLCBncm91cElkKSlcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIHNob3VsZCBub3cgbm90IGFwcGVhciBhcyBhbiBpbnZpdGVkIG1lbWJlclxuICAgICAgICAgICAgLnRoZW4odGhpcy5fZmV0Y2hSZXNvdXJjZS5iaW5kKHRoaXMsIHRoaXMuU1RBVEVfS0VZLkdyb3VwSW52aXRlZE1lbWJlcnMsIGdyb3VwSWQpKTtcbiAgICB9XG5cbiAgICBsZWF2ZUdyb3VwKGdyb3VwSWQpIHtcbiAgICAgICAgLy8gZW5zdXJlIHRoZSB0YWcgcGFuZWwgZmlsdGVyIGlzIGNsZWFyZWQgaWYgdGhlIGdyb3VwIHdhcyBzZWxlY3RlZFxuICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgYWN0aW9uOiBcImRlc2VsZWN0X3RhZ3NcIixcbiAgICAgICAgICAgIHRhZzogZ3JvdXBJZCxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkubGVhdmVHcm91cChncm91cElkKVxuICAgICAgICAgICAgLy8gVGhlIHVzZXIgc2hvdWxkIG5vdyBub3QgYmUgYWJsZSB0byBhY2Nlc3MgZ3JvdXAgc2V0dGluZ3NcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5TdW1tYXJ5LCBncm91cElkKSlcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIG1pZ2h0IG9ubHkgYmUgYWJsZSB0byBzZWUgYSBzdWJzZXQgb2Ygcm9vbXMgbm93XG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuR3JvdXBSb29tcywgZ3JvdXBJZCkpXG4gICAgICAgICAgICAvLyBUaGUgdXNlciBzaG91bGQgbm93IG5vdCBhcHBlYXIgYXMgYSBtZW1iZXJcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5Hcm91cE1lbWJlcnMsIGdyb3VwSWQpKTtcbiAgICB9XG5cbiAgICBhZGRSb29tVG9Hcm91cFN1bW1hcnkoZ3JvdXBJZCwgcm9vbUlkLCBjYXRlZ29yeUlkKSB7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KClcbiAgICAgICAgICAgIC5hZGRSb29tVG9Hcm91cFN1bW1hcnkoZ3JvdXBJZCwgcm9vbUlkLCBjYXRlZ29yeUlkKVxuICAgICAgICAgICAgLnRoZW4odGhpcy5fZmV0Y2hSZXNvdXJjZS5iaW5kKHRoaXMsIHRoaXMuU1RBVEVfS0VZLlN1bW1hcnksIGdyb3VwSWQpKTtcbiAgICB9XG5cbiAgICBhZGRVc2VyVG9Hcm91cFN1bW1hcnkoZ3JvdXBJZCwgdXNlcklkLCByb2xlSWQpIHtcbiAgICAgICAgcmV0dXJuIE1hdHJpeENsaWVudFBlZy5nZXQoKVxuICAgICAgICAgICAgLmFkZFVzZXJUb0dyb3VwU3VtbWFyeShncm91cElkLCB1c2VySWQsIHJvbGVJZClcbiAgICAgICAgICAgIC50aGVuKHRoaXMuX2ZldGNoUmVzb3VyY2UuYmluZCh0aGlzLCB0aGlzLlNUQVRFX0tFWS5TdW1tYXJ5LCBncm91cElkKSk7XG4gICAgfVxuXG4gICAgcmVtb3ZlUm9vbUZyb21Hcm91cFN1bW1hcnkoZ3JvdXBJZCwgcm9vbUlkKSB7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KClcbiAgICAgICAgICAgIC5yZW1vdmVSb29tRnJvbUdyb3VwU3VtbWFyeShncm91cElkLCByb29tSWQpXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuU3VtbWFyeSwgZ3JvdXBJZCkpO1xuICAgIH1cblxuICAgIHJlbW92ZVVzZXJGcm9tR3JvdXBTdW1tYXJ5KGdyb3VwSWQsIHVzZXJJZCkge1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpXG4gICAgICAgICAgICAucmVtb3ZlVXNlckZyb21Hcm91cFN1bW1hcnkoZ3JvdXBJZCwgdXNlcklkKVxuICAgICAgICAgICAgLnRoZW4odGhpcy5fZmV0Y2hSZXNvdXJjZS5iaW5kKHRoaXMsIHRoaXMuU1RBVEVfS0VZLlN1bW1hcnksIGdyb3VwSWQpKTtcbiAgICB9XG5cbiAgICBzZXRHcm91cFB1YmxpY2l0eShncm91cElkLCBpc1B1Ymxpc2hlZCkge1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpXG4gICAgICAgICAgICAuc2V0R3JvdXBQdWJsaWNpdHkoZ3JvdXBJZCwgaXNQdWJsaXNoZWQpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7IEZsYWlyU3RvcmUuaW52YWxpZGF0ZVB1YmxpY2lzZWRHcm91cHMoTWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWRlbnRpYWxzLnVzZXJJZCk7IH0pXG4gICAgICAgICAgICAudGhlbih0aGlzLl9mZXRjaFJlc291cmNlLmJpbmQodGhpcywgdGhpcy5TVEFURV9LRVkuU3VtbWFyeSwgZ3JvdXBJZCkpO1xuICAgIH1cbn1cblxubGV0IHNpbmdsZXRvbkdyb3VwU3RvcmUgPSBudWxsO1xuaWYgKCFzaW5nbGV0b25Hcm91cFN0b3JlKSB7XG4gICAgc2luZ2xldG9uR3JvdXBTdG9yZSA9IG5ldyBHcm91cFN0b3JlKCk7XG59XG5leHBvcnQgZGVmYXVsdCBzaW5nbGV0b25Hcm91cFN0b3JlO1xuIl19