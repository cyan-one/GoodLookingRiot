"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

/*
Copyright 2019 New Vector Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class AutocompleteWrapperModel {
  constructor(updateCallback, getAutocompleterComponent, updateQuery, partCreator) {
    this._updateCallback = updateCallback;
    this._getAutocompleterComponent = getAutocompleterComponent;
    this._updateQuery = updateQuery;
    this._partCreator = partCreator;
    this._query = null;
  }

  onEscape(e) {
    this._getAutocompleterComponent().onEscape(e);

    this._updateCallback({
      replaceParts: [this._partCreator.plain(this._queryPart.text)],
      close: true
    });
  }

  close() {
    this._updateCallback({
      close: true
    });
  }

  hasSelection() {
    return this._getAutocompleterComponent().hasSelection();
  }

  hasCompletions() {
    const ac = this._getAutocompleterComponent();

    return ac && ac.countCompletions() > 0;
  }

  onEnter() {
    this._updateCallback({
      close: true
    });
  }

  async onTab(e) {
    const acComponent = this._getAutocompleterComponent();

    if (acComponent.countCompletions() === 0) {
      // Force completions to show for the text currently entered
      await acComponent.forceComplete(); // Select the first item by moving "down"

      await acComponent.moveSelection(+1);
    } else {
      await acComponent.moveSelection(e.shiftKey ? -1 : +1);
    }
  }

  onUpArrow() {
    this._getAutocompleterComponent().moveSelection(-1);
  }

  onDownArrow() {
    this._getAutocompleterComponent().moveSelection(+1);
  }

  onPartUpdate(part, pos) {
    // cache the typed value and caret here
    // so we can restore it in onComponentSelectionChange when the value is undefined (meaning it should be the typed text)
    this._queryPart = part;
    this._partIndex = pos.index;
    return this._updateQuery(part.text);
  }

  onComponentSelectionChange(completion) {
    if (!completion) {
      this._updateCallback({
        replaceParts: [this._queryPart]
      });
    } else {
      this._updateCallback({
        replaceParts: this._partForCompletion(completion)
      });
    }
  }

  onComponentConfirm(completion) {
    this._updateCallback({
      replaceParts: this._partForCompletion(completion),
      close: true
    });
  }

  _partForCompletion(completion) {
    const {
      completionId
    } = completion;
    const text = completion.completion;

    switch (completion.type) {
      case "room":
        return [this._partCreator.roomPill(text, completionId), this._partCreator.plain(completion.suffix)];

      case "at-room":
        return [this._partCreator.atRoomPill(completionId), this._partCreator.plain(completion.suffix)];

      case "user":
        // not using suffix here, because we also need to calculate
        // the suffix when clicking a display name to insert a mention,
        // which happens in createMentionParts
        return this._partCreator.createMentionParts(this._partIndex, text, completionId);

      case "command":
        // command needs special handling for auto complete, but also renders as plain texts
        return [this._partCreator.command(text)];

      default:
        // used for emoji and other plain text completion replacement
        return [this._partCreator.plain(text)];
    }
  }

}

exports.default = AutocompleteWrapperModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3IvYXV0b2NvbXBsZXRlLmpzIl0sIm5hbWVzIjpbIkF1dG9jb21wbGV0ZVdyYXBwZXJNb2RlbCIsImNvbnN0cnVjdG9yIiwidXBkYXRlQ2FsbGJhY2siLCJnZXRBdXRvY29tcGxldGVyQ29tcG9uZW50IiwidXBkYXRlUXVlcnkiLCJwYXJ0Q3JlYXRvciIsIl91cGRhdGVDYWxsYmFjayIsIl9nZXRBdXRvY29tcGxldGVyQ29tcG9uZW50IiwiX3VwZGF0ZVF1ZXJ5IiwiX3BhcnRDcmVhdG9yIiwiX3F1ZXJ5Iiwib25Fc2NhcGUiLCJlIiwicmVwbGFjZVBhcnRzIiwicGxhaW4iLCJfcXVlcnlQYXJ0IiwidGV4dCIsImNsb3NlIiwiaGFzU2VsZWN0aW9uIiwiaGFzQ29tcGxldGlvbnMiLCJhYyIsImNvdW50Q29tcGxldGlvbnMiLCJvbkVudGVyIiwib25UYWIiLCJhY0NvbXBvbmVudCIsImZvcmNlQ29tcGxldGUiLCJtb3ZlU2VsZWN0aW9uIiwic2hpZnRLZXkiLCJvblVwQXJyb3ciLCJvbkRvd25BcnJvdyIsIm9uUGFydFVwZGF0ZSIsInBhcnQiLCJwb3MiLCJfcGFydEluZGV4IiwiaW5kZXgiLCJvbkNvbXBvbmVudFNlbGVjdGlvbkNoYW5nZSIsImNvbXBsZXRpb24iLCJfcGFydEZvckNvbXBsZXRpb24iLCJvbkNvbXBvbmVudENvbmZpcm0iLCJjb21wbGV0aW9uSWQiLCJ0eXBlIiwicm9vbVBpbGwiLCJzdWZmaXgiLCJhdFJvb21QaWxsIiwiY3JlYXRlTWVudGlvblBhcnRzIiwiY29tbWFuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7Ozs7O0FBaUJlLE1BQU1BLHdCQUFOLENBQStCO0FBQzFDQyxFQUFBQSxXQUFXLENBQUNDLGNBQUQsRUFBaUJDLHlCQUFqQixFQUE0Q0MsV0FBNUMsRUFBeURDLFdBQXpELEVBQXNFO0FBQzdFLFNBQUtDLGVBQUwsR0FBdUJKLGNBQXZCO0FBQ0EsU0FBS0ssMEJBQUwsR0FB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TTtBQUFDRyxNQUFBQTtBQUFELFFBQWlCSCxVQUF2QjtBQUNBLFVBQU1wQixJQUFJLEdBQUdvQixVQUFVLENBQUNBLFVBQXhCOztBQUNBLFlBQVFBLFVBQVUsQ0FBQ0ksSUFBbkI7QUFDSSxXQUFLLE1BQUw7QUFDSSxlQUFPLENBQUMsS0FBSy9CLFlBQUwsQ0FBa0JnQyxRQUFsQixDQUEyQnpCLElBQTNCLEVBQWlDdUIsWUFBakMsQ0FBRCxFQUFpRCxLQUFLOUIsWUFBTCxDQUFrQkssS0FBbEIsQ0FBd0JzQixVQUFVLENBQUNNLE1BQW5DLENBQWpELENBQVA7O0FBQ0osV0FBSyxTQUFMO0FBQ0ksZUFBTyxDQUFDLEtBQUtqQyxZQUFMLENBQWtCa0MsVUFBbEIsQ0FBNkJKLFlBQTdCLENBQUQsRUFBNkMsS0FBSzlCLFlBQUwsQ0FBa0JLLEtBQWxCLENBQXdCc0IsVUFBVSxDQUFDTSxNQUFuQyxDQUE3QyxDQUFQOztBQUNKLFdBQUssTUFBTDtBQUNJO0FBQ0E7QUFDQTtBQUNBLGVBQU8sS0FBS2pDLFlBQUwsQ0FBa0JtQyxrQkFBbEIsQ0FBcUMsS0FBS1gsVUFBMUMsRUFBc0RqQixJQUF0RCxFQUE0RHVCLFlBQTVELENBQVA7O0FBQ0osV0FBSyxTQUFMO0FBQ0k7QUFDQSxlQUFPLENBQUMsS0FBSzlCLFlBQUwsQ0FBa0JvQyxPQUFsQixDQUEwQjdCLElBQTFCLENBQUQsQ0FBUDs7QUFDSjtBQUNJO0FBQ0EsZUFBTyxDQUFDLEtBQUtQLFlBQUwsQ0FBa0JLLEtBQWxCLENBQXdCRSxJQUF4QixDQUFELENBQVA7QUFmUjtBQWlCSDs7QUF0R3lDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9jb21wbGV0ZVdyYXBwZXJNb2RlbCB7XG4gICAgY29uc3RydWN0b3IodXBkYXRlQ2FsbGJhY2ssIGdldEF1dG9jb21wbGV0ZXJDb21wb25lbnQsIHVwZGF0ZVF1ZXJ5LCBwYXJ0Q3JlYXRvcikge1xuICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrO1xuICAgICAgICB0aGlzLl9nZXRBdXRvY29tcGxldGVyQ29tcG9uZW50ID0gZ2V0QXV0b2NvbXBsZXRlckNvbXBvbmVudDtcbiAgICAgICAgdGhpcy5fdXBkYXRlUXVlcnkgPSB1cGRhdGVRdWVyeTtcbiAgICAgICAgdGhpcy5fcGFydENyZWF0b3IgPSBwYXJ0Q3JlYXRvcjtcbiAgICAgICAgdGhpcy5fcXVlcnkgPSBudWxsO1xuICAgIH1cblxuICAgIG9uRXNjYXBlKGUpIHtcbiAgICAgICAgdGhpcy5fZ2V0QXV0b2NvbXBsZXRlckNvbXBvbmVudCgpLm9uRXNjYXBlKGUpO1xuICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayh7XG4gICAgICAgICAgICByZXBsYWNlUGFydHM6IFt0aGlzLl9wYXJ0Q3JlYXRvci5wbGFpbih0aGlzLl9xdWVyeVBhcnQudGV4dCldLFxuICAgICAgICAgICAgY2xvc2U6IHRydWUsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNsb3NlKCkge1xuICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayh7Y2xvc2U6IHRydWV9KTtcbiAgICB9XG5cbiAgICBoYXNTZWxlY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRBdXRvY29tcGxldGVyQ29tcG9uZW50KCkuaGFzU2VsZWN0aW9uKCk7XG4gICAgfVxuXG4gICAgaGFzQ29tcGxldGlvbnMoKSB7XG4gICAgICAgIGNvbnN0IGFjID0gdGhpcy5fZ2V0QXV0b2NvbXBsZXRlckNvbXBvbmVudCgpO1xuICAgICAgICByZXR1cm4gYWMgJiYgYWMuY291bnRDb21wbGV0aW9ucygpID4gMDtcbiAgICB9XG5cbiAgICBvbkVudGVyKCkge1xuICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayh7Y2xvc2U6IHRydWV9KTtcbiAgICB9XG5cbiAgICBhc3luYyBvblRhYihlKSB7XG4gICAgICAgIGNvbnN0IGFjQ29tcG9uZW50ID0gdGhpcy5fZ2V0QXV0b2NvbXBsZXRlckNvbXBvbmVudCgpO1xuXG4gICAgICAgIGlmIChhY0NvbXBvbmVudC5jb3VudENvbXBsZXRpb25zKCkgPT09IDApIHtcbiAgICAgICAgICAgIC8vIEZvcmNlIGNvbXBsZXRpb25zIHRvIHNob3cgZm9yIHRoZSB0ZXh0IGN1cnJlbnRseSBlbnRlcmVkXG4gICAgICAgICAgICBhd2FpdCBhY0NvbXBvbmVudC5mb3JjZUNvbXBsZXRlKCk7XG4gICAgICAgICAgICAvLyBTZWxlY3QgdGhlIGZpcnN0IGl0ZW0gYnkgbW92aW5nIFwiZG93blwiXG4gICAgICAgICAgICBhd2FpdCBhY0NvbXBvbmVudC5tb3ZlU2VsZWN0aW9uKCsxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IGFjQ29tcG9uZW50Lm1vdmVTZWxlY3Rpb24oZS5zaGlmdEtleSA/IC0xIDogKzEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25VcEFycm93KCkge1xuICAgICAgICB0aGlzLl9nZXRBdXRvY29tcGxldGVyQ29tcG9uZW50KCkubW92ZVNlbGVjdGlvbigtMSk7XG4gICAgfVxuXG4gICAgb25Eb3duQXJyb3coKSB7XG4gICAgICAgIHRoaXMuX2dldEF1dG9jb21wbGV0ZXJDb21wb25lbnQoKS5tb3ZlU2VsZWN0aW9uKCsxKTtcbiAgICB9XG5cbiAgICBvblBhcnRVcGRhdGUocGFydCwgcG9zKSB7XG4gICAgICAgIC8vIGNhY2hlIHRoZSB0eXBlZCB2YWx1ZSBhbmQgY2FyZXQgaGVyZVxuICAgICAgICAvLyBzbyB3ZSBjYW4gcmVzdG9yZSBpdCBpbiBvbkNvbXBvbmVudFNlbGVjdGlvbkNoYW5nZSB3aGVuIHRoZSB2YWx1ZSBpcyB1bmRlZmluZWQgKG1lYW5pbmcgaXQgc2hvdWxkIGJlIHRoZSB0eXBlZCB0ZXh0KVxuICAgICAgICB0aGlzLl9xdWVyeVBhcnQgPSBwYXJ0O1xuICAgICAgICB0aGlzLl9wYXJ0SW5kZXggPSBwb3MuaW5kZXg7XG4gICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVRdWVyeShwYXJ0LnRleHQpO1xuICAgIH1cblxuICAgIG9uQ29tcG9uZW50U2VsZWN0aW9uQ2hhbmdlKGNvbXBsZXRpb24pIHtcbiAgICAgICAgaWYgKCFjb21wbGV0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayh7XG4gICAgICAgICAgICAgICAgcmVwbGFjZVBhcnRzOiBbdGhpcy5fcXVlcnlQYXJ0XSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlQ2FsbGJhY2soe1xuICAgICAgICAgICAgICAgIHJlcGxhY2VQYXJ0czogdGhpcy5fcGFydEZvckNvbXBsZXRpb24oY29tcGxldGlvbiksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uQ29tcG9uZW50Q29uZmlybShjb21wbGV0aW9uKSB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUNhbGxiYWNrKHtcbiAgICAgICAgICAgIHJlcGxhY2VQYXJ0czogdGhpcy5fcGFydEZvckNvbXBsZXRpb24oY29tcGxldGlvbiksXG4gICAgICAgICAgICBjbG9zZTogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3BhcnRGb3JDb21wbGV0aW9uKGNvbXBsZXRpb24pIHtcbiAgICAgICAgY29uc3Qge2NvbXBsZXRpb25JZH0gPSBjb21wbGV0aW9uO1xuICAgICAgICBjb25zdCB0ZXh0ID0gY29tcGxldGlvbi5jb21wbGV0aW9uO1xuICAgICAgICBzd2l0Y2ggKGNvbXBsZXRpb24udHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcInJvb21cIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gW3RoaXMuX3BhcnRDcmVhdG9yLnJvb21QaWxsKHRleHQsIGNvbXBsZXRpb25JZCksIHRoaXMuX3BhcnRDcmVhdG9yLnBsYWluKGNvbXBsZXRpb24uc3VmZml4KV07XG4gICAgICAgICAgICBjYXNlIFwiYXQtcm9vbVwiOlxuICAgICAgICAgICAgICAgIHJldHVybiBbdGhpcy5fcGFydENyZWF0b3IuYXRSb29tUGlsbChjb21wbGV0aW9uSWQpLCB0aGlzLl9wYXJ0Q3JlYXRvci5wbGFpbihjb21wbGV0aW9uLnN1ZmZpeCldO1xuICAgICAgICAgICAgY2FzZSBcInVzZXJcIjpcbiAgICAgICAgICAgICAgICAvLyBub3QgdXNpbmcgc3VmZml4IGhlcmUsIGJlY2F1c2Ugd2UgYWxzbyBuZWVkIHRvIGNhbGN1bGF0ZVxuICAgICAgICAgICAgICAgIC8vIHRoZSBzdWZmaXggd2hlbiBjbGlja2luZyBhIGRpc3BsYXkgbmFtZSB0byBpbnNlcnQgYSBtZW50aW9uLFxuICAgICAgICAgICAgICAgIC8vIHdoaWNoIGhhcHBlbnMgaW4gY3JlYXRlTWVudGlvblBhcnRzXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRDcmVhdG9yLmNyZWF0ZU1lbnRpb25QYXJ0cyh0aGlzLl9wYXJ0SW5kZXgsIHRleHQsIGNvbXBsZXRpb25JZCk7XG4gICAgICAgICAgICBjYXNlIFwiY29tbWFuZFwiOlxuICAgICAgICAgICAgICAgIC8vIGNvbW1hbmQgbmVlZHMgc3BlY2lhbCBoYW5kbGluZyBmb3IgYXV0byBjb21wbGV0ZSwgYnV0IGFsc28gcmVuZGVycyBhcyBwbGFpbiB0ZXh0c1xuICAgICAgICAgICAgICAgIHJldHVybiBbdGhpcy5fcGFydENyZWF0b3IuY29tbWFuZCh0ZXh0KV07XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIC8vIHVzZWQgZm9yIGVtb2ppIGFuZCBvdGhlciBwbGFpbiB0ZXh0IGNvbXBsZXRpb24gcmVwbGFjZW1lbnRcbiAgICAgICAgICAgICAgICByZXR1cm4gW3RoaXMuX3BhcnRDcmVhdG9yLnBsYWluKHRleHQpXTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==