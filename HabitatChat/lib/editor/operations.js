"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.replaceRangeAndExpandSelection = replaceRangeAndExpandSelection;
exports.replaceRangeAndMoveCaret = replaceRangeAndMoveCaret;
exports.rangeStartsAtBeginningOfLine = rangeStartsAtBeginningOfLine;
exports.rangeEndsAtEndOfLine = rangeEndsAtEndOfLine;
exports.formatRangeAsQuote = formatRangeAsQuote;
exports.formatRangeAsCode = formatRangeAsCode;
exports.toggleInlineFormat = toggleInlineFormat;

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Some common queries and transformations on the editor model
 */
function replaceRangeAndExpandSelection(range, newParts) {
  const {
    model
  } = range;
  model.transform(() => {
    const oldLen = range.length;
    const addedLen = range.replace(newParts);
    const firstOffset = range.start.asOffset(model);
    const lastOffset = firstOffset.add(oldLen + addedLen);
    return model.startRange(firstOffset.asPosition(model), lastOffset.asPosition(model));
  });
}

function replaceRangeAndMoveCaret(range, newParts) {
  const {
    model
  } = range;
  model.transform(() => {
    const oldLen = range.length;
    const addedLen = range.replace(newParts);
    const firstOffset = range.start.asOffset(model);
    const lastOffset = firstOffset.add(oldLen + addedLen);
    return lastOffset.asPosition(model);
  });
}

function rangeStartsAtBeginningOfLine(range) {
  const {
    model
  } = range;
  const startsWithPartial = range.start.offset !== 0;
  const isFirstPart = range.start.index === 0;
  const previousIsNewline = !isFirstPart && model.parts[range.start.index - 1].type === "newline";
  return !startsWithPartial && (isFirstPart || previousIsNewline);
}

function rangeEndsAtEndOfLine(range) {
  const {
    model
  } = range;
  const lastPart = model.parts[range.end.index];
  const endsWithPartial = range.end.offset !== lastPart.length;
  const isLastPart = range.end.index === model.parts.length - 1;
  const nextIsNewline = !isLastPart && model.parts[range.end.index + 1].type === "newline";
  return !endsWithPartial && (isLastPart || nextIsNewline);
}

function formatRangeAsQuote(range) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model;

  for (let i = 0; i < parts.length; ++i) {
    const part = parts[i];

    if (part.type === "newline") {
      parts.splice(i + 1, 0, partCreator.plain("> "));
    }
  }

  parts.unshift(partCreator.plain("> "));

  if (!rangeStartsAtBeginningOfLine(range)) {
    parts.unshift(partCreator.newline());
  }

  if (!rangeEndsAtEndOfLine(range)) {
    parts.push(partCreator.newline());
  }

  parts.push(partCreator.newline());
  replaceRangeAndExpandSelection(range, parts);
}

function formatRangeAsCode(range) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model;
  const needsBlock = parts.some(p => p.type === "newline");

  if (needsBlock) {
    parts.unshift(partCreator.plain("```"), partCreator.newline());

    if (!rangeStartsAtBeginningOfLine(range)) {
      parts.unshift(partCreator.newline());
    }

    parts.push(partCreator.newline(), partCreator.plain("```"));

    if (!rangeEndsAtEndOfLine(range)) {
      parts.push(partCreator.newline());
    }
  } else {
    parts.unshift(partCreator.plain("`"));
    parts.push(partCreator.plain("`"));
  }

  replaceRangeAndExpandSelection(range, parts);
} // parts helper methods


const isBlank = part => !part.text || !/\S/.test(part.text);

const isNL = part => part.type === "newline";

function toggleInlineFormat(range, prefix, suffix = prefix) {
  const {
    model,
    parts
  } = range;
  const {
    partCreator
  } = model; // compute paragraph [start, end] indexes

  const paragraphIndexes = [];
  let startIndex = 0; // start at i=2 because we look at i and up to two parts behind to detect paragraph breaks at their end

  for (let i = 2; i < parts.length; i++) {
    // paragraph breaks can be denoted in a multitude of ways,
    // - 2 newline parts in sequence
    // - newline part, plain(<empty or just spaces>), newline part
    // bump startIndex onto the first non-blank after the paragraph ending
    if (isBlank(parts[i - 2]) && isNL(parts[i - 1]) && !isNL(parts[i]) && !isBlank(parts[i])) {
      startIndex = i;
    } // if at a paragraph break, store the indexes of the paragraph


    if (isNL(parts[i - 1]) && isNL(parts[i])) {
      paragraphIndexes.push([startIndex, i - 1]);
      startIndex = i + 1;
    } else if (isNL(parts[i - 2]) && isBlank(parts[i - 1]) && isNL(parts[i])) {
      paragraphIndexes.push([startIndex, i - 2]);
      startIndex = i + 1;
    }
  }

  const lastNonEmptyPart = parts.map(isBlank).lastIndexOf(false); // If we have not yet included the final paragraph then add it now

  if (startIndex <= lastNonEmptyPart) {
    paragraphIndexes.push([startIndex, lastNonEmptyPart + 1]);
  } // keep track of how many things we have inserted as an offset:=0


  let offset = 0;
  paragraphIndexes.forEach(([startIndex, endIndex]) => {
    // for each paragraph apply the same rule
    const base = startIndex + offset;
    const index = endIndex + offset;
    const isFormatted = index - base > 0 && parts[base].text.startsWith(prefix) && parts[index - 1].text.endsWith(suffix);

    if (isFormatted) {
      // remove prefix and suffix
      const partWithoutPrefix = parts[base].serialize();
      partWithoutPrefix.text = partWithoutPrefix.text.substr(prefix.length);
      parts[base] = partCreator.deserializePart(partWithoutPrefix);
      const partWithoutSuffix = parts[index - 1].serialize();
      const suffixPartText = partWithoutSuffix.text;
      partWithoutSuffix.text = suffixPartText.substring(0, suffixPartText.length - suffix.length);
      parts[index - 1] = partCreator.deserializePart(partWithoutSuffix);
    } else {
      parts.splice(index, 0, partCreator.plain(suffix)); // splice in the later one first to not change offset

      parts.splice(base, 0, partCreator.plain(prefix));
      offset += 2; // offset index to account for the two items we just spliced in
    }
  });
  replaceRangeAndExpandSelection(range, parts);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3Ivb3BlcmF0aW9ucy5qcyJdLCJuYW1lcyI6WyJyZXBsYWNlUmFuZ2VBbmRFeHBhbmRTZWxlY3Rpb24iLCJyYW5nZSIsIm5ld1BhcnRzIiwibW9kZWwiLCJ0cmFuc2Zvcm0iLCJvbGRMZW4iLCJsZW5ndGgiLCJhZGRlZExlbiIsInJlcGxhY2UiLCJmaXJzdE9mZnNldCIsInN0YXJ0IiwiYXNPZmZzZXQiLCJsYXN0T2Zmc2V0IiwiYWRkIiwic3RhcnRSYW5nZSIsImFzUG9zaXRpb24iLCJyZXBsYWNlUmFuZ2VBbmRNb3ZlQ2FyZXQiLCJyYW5nZVN0YXJ0c0F0QmVnaW5uaW5nT2ZMaW5lIiwic3RhcnRzV2l0aFBhcnRpYWwiLCJvZmZzZXQiLCJpc0ZpcnN0UGFydCIsImluZGV4IiwicHJldmlvdXNJc05ld2xpbmUiLCJwYXJ0cyIsInR5cGUiLCJyYW5nZUVuZHNBdEVuZE9mTGluZSIsImxhc3RQYXJ0IiwiZW5kIiwiZW5kc1dpdGhQYXJ0aWFsIiwiaXNMYXN0UGFydCIsIm5leHRJc05ld2xpbmUiLCJmb3JtYXRSYW5nZUFzUXVvdGUiLCJwYXJ0Q3JlYXRvciIsImkiLCJwYXJ0Iiwic3BsaWNlIiwicGxhaW4iLCJ1bnNoaWZ0IiwibmV3bGluZSIsInB1c2giLCJmb3JtYXRSYW5nZUFzQ29kZSIsIm5lZWRzQmxvY2siLCJzb21lIiwicCIsImlzQmxhbmsiLCJ0ZXh0IiwidGVzdCIsImlzTkwiLCJ0b2dnbGVJbmxpbmVGb3JtYXQiLCJwcmVmaXgiLCJzdWZmaXgiLCJwYXJhZ3JhcGhJbmRleGVzIiwic3RhcnRJbmRleCIsImxhc3ROb25FbXB0eVBhcnQiLCJtYXAiLCJsYXN0SW5kZXhPZiIsImZvckVhY2giLCJlbmRJbmRleCIsImJhc2UiLCJpc0Zvcm1hdHRlZCIsInN0YXJ0c1dpdGgiLCJlbmRzV2l0aCIsInBhcnRXaXRob3V0UHJlZml4Iiwic2VyaWFsaXplIiwic3Vic3RyIiwiZGVzZXJpYWxpemVQYXJ0IiwicGFydFdpdGhvdXRT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Q0FBcEIsRUFBdUJXLFdBQVcsQ0FBQ0ksS0FBWixDQUFrQmMsTUFBbEIsQ0FBdkIsRUFERyxDQUNnRDs7QUFDbkQzQixNQUFBQSxLQUFLLENBQUNZLE1BQU4sQ0FBYXVCLElBQWIsRUFBbUIsQ0FBbkIsRUFBc0IxQixXQUFXLENBQUNJLEtBQVosQ0FBa0JhLE1BQWxCLENBQXRCO0FBQ0E5QixNQUFBQSxNQUFNLElBQUksQ0FBVixDQUhHLENBR1U7QUFDaEI7QUFDSixHQXhCRDtBQTBCQW5CLEVBQUFBLDhCQUE4QixDQUFDQyxLQUFELEVBQVFzQixLQUFSLENBQTlCO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG4vKipcbiAqIFNvbWUgY29tbW9uIHF1ZXJpZXMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGUgZWRpdG9yIG1vZGVsXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VSYW5nZUFuZEV4cGFuZFNlbGVjdGlvbihyYW5nZSwgbmV3UGFydHMpIHtcbiAgICBjb25zdCB7bW9kZWx9ID0gcmFuZ2U7XG4gICAgbW9kZWwudHJhbnNmb3JtKCgpID0+IHtcbiAgICAgICAgY29uc3Qgb2xkTGVuID0gcmFuZ2UubGVuZ3RoO1xuICAgICAgICBjb25zdCBhZGRlZExlbiA9IHJhbmdlLnJlcGxhY2UobmV3UGFydHMpO1xuICAgICAgICBjb25zdCBmaXJzdE9mZnNldCA9IHJhbmdlLnN0YXJ0LmFzT2Zmc2V0KG1vZGVsKTtcbiAgICAgICAgY29uc3QgbGFzdE9mZnNldCA9IGZpcnN0T2Zmc2V0LmFkZChvbGRMZW4gKyBhZGRlZExlbik7XG4gICAgICAgIHJldHVybiBtb2RlbC5zdGFydFJhbmdlKGZpcnN0T2Zmc2V0LmFzUG9zaXRpb24obW9kZWwpLCBsYXN0T2Zmc2V0LmFzUG9zaXRpb24obW9kZWwpKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VSYW5nZUFuZE1vdmVDYXJldChyYW5nZSwgbmV3UGFydHMpIHtcbiAgICBjb25zdCB7bW9kZWx9ID0gcmFuZ2U7XG4gICAgbW9kZWwudHJhbnNmb3JtKCgpID0+IHtcbiAgICAgICAgY29uc3Qgb2xkTGVuID0gcmFuZ2UubGVuZ3RoO1xuICAgICAgICBjb25zdCBhZGRlZExlbiA9IHJhbmdlLnJlcGxhY2UobmV3UGFydHMpO1xuICAgICAgICBjb25zdCBmaXJzdE9mZnNldCA9IHJhbmdlLnN0YXJ0LmFzT2Zmc2V0KG1vZGVsKTtcbiAgICAgICAgY29uc3QgbGFzdE9mZnNldCA9IGZpcnN0T2Zmc2V0LmFkZChvbGRMZW4gKyBhZGRlZExlbik7XG4gICAgICAgIHJldHVybiBsYXN0T2Zmc2V0LmFzUG9zaXRpb24obW9kZWwpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmFuZ2VTdGFydHNBdEJlZ2lubmluZ09mTGluZShyYW5nZSkge1xuICAgIGNvbnN0IHttb2RlbH0gPSByYW5nZTtcbiAgICBjb25zdCBzdGFydHNXaXRoUGFydGlhbCA9IHJhbmdlLnN0YXJ0Lm9mZnNldCAhPT0gMDtcbiAgICBjb25zdCBpc0ZpcnN0UGFydCA9IHJhbmdlLnN0YXJ0LmluZGV4ID09PSAwO1xuICAgIGNvbnN0IHByZXZpb3VzSXNOZXdsaW5lID0gIWlzRmlyc3RQYXJ0ICYmIG1vZGVsLnBhcnRzW3JhbmdlLnN0YXJ0LmluZGV4IC0gMV0udHlwZSA9PT0gXCJuZXdsaW5lXCI7XG4gICAgcmV0dXJuICFzdGFydHNXaXRoUGFydGlhbCAmJiAoaXNGaXJzdFBhcnQgfHwgcHJldmlvdXNJc05ld2xpbmUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmFuZ2VFbmRzQXRFbmRPZkxpbmUocmFuZ2UpIHtcbiAgICBjb25zdCB7bW9kZWx9ID0gcmFuZ2U7XG4gICAgY29uc3QgbGFzdFBhcnQgPSBtb2RlbC5wYXJ0c1tyYW5nZS5lbmQuaW5kZXhdO1xuICAgIGNvbnN0IGVuZHNXaXRoUGFydGlhbCA9IHJhbmdlLmVuZC5vZmZzZXQgIT09IGxhc3RQYXJ0Lmxlbmd0aDtcbiAgICBjb25zdCBpc0xhc3RQYXJ0ID0gcmFuZ2UuZW5kLmluZGV4ID09PSBtb2RlbC5wYXJ0cy5sZW5ndGggLSAxO1xuICAgIGNvbnN0IG5leHRJc05ld2xpbmUgPSAhaXNMYXN0UGFydCAmJiBtb2RlbC5wYXJ0c1tyYW5nZS5lbmQuaW5kZXggKyAxXS50eXBlID09PSBcIm5ld2xpbmVcIjtcbiAgICByZXR1cm4gIWVuZHNXaXRoUGFydGlhbCAmJiAoaXNMYXN0UGFydCB8fCBuZXh0SXNOZXdsaW5lKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFJhbmdlQXNRdW90ZShyYW5nZSkge1xuICAgIGNvbnN0IHttb2RlbCwgcGFydHN9ID0gcmFuZ2U7XG4gICAgY29uc3Qge3BhcnRDcmVhdG9yfSA9IG1vZGVsO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgICBpZiAocGFydC50eXBlID09PSBcIm5ld2xpbmVcIikge1xuICAgICAgICAgICAgcGFydHMuc3BsaWNlKGkgKyAxLCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihcIj4gXCIpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwYXJ0cy51bnNoaWZ0KHBhcnRDcmVhdG9yLnBsYWluKFwiPiBcIikpO1xuICAgIGlmICghcmFuZ2VTdGFydHNBdEJlZ2lubmluZ09mTGluZShyYW5nZSkpIHtcbiAgICAgICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgIH1cbiAgICBpZiAoIXJhbmdlRW5kc0F0RW5kT2ZMaW5lKHJhbmdlKSkge1xuICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgfVxuXG4gICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgIHJlcGxhY2VSYW5nZUFuZEV4cGFuZFNlbGVjdGlvbihyYW5nZSwgcGFydHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0UmFuZ2VBc0NvZGUocmFuZ2UpIHtcbiAgICBjb25zdCB7bW9kZWwsIHBhcnRzfSA9IHJhbmdlO1xuICAgIGNvbnN0IHtwYXJ0Q3JlYXRvcn0gPSBtb2RlbDtcbiAgICBjb25zdCBuZWVkc0Jsb2NrID0gcGFydHMuc29tZShwID0+IHAudHlwZSA9PT0gXCJuZXdsaW5lXCIpO1xuICAgIGlmIChuZWVkc0Jsb2NrKSB7XG4gICAgICAgIHBhcnRzLnVuc2hpZnQocGFydENyZWF0b3IucGxhaW4oXCJgYGBcIiksIHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgICAgIGlmICghcmFuZ2VTdGFydHNBdEJlZ2lubmluZ09mTGluZShyYW5nZSkpIHtcbiAgICAgICAgICAgIHBhcnRzLnVuc2hpZnQocGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICAgICAgfVxuICAgICAgICBwYXJ0cy5wdXNoKFxuICAgICAgICAgICAgcGFydENyZWF0b3IubmV3bGluZSgpLFxuICAgICAgICAgICAgcGFydENyZWF0b3IucGxhaW4oXCJgYGBcIikpO1xuICAgICAgICBpZiAoIXJhbmdlRW5kc0F0RW5kT2ZMaW5lKHJhbmdlKSkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5wbGFpbihcImBcIikpO1xuICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLnBsYWluKFwiYFwiKSk7XG4gICAgfVxuICAgIHJlcGxhY2VSYW5nZUFuZEV4cGFuZFNlbGVjdGlvbihyYW5nZSwgcGFydHMpO1xufVxuXG4vLyBwYXJ0cyBoZWxwZXIgbWV0aG9kc1xuY29uc3QgaXNCbGFuayA9IHBhcnQgPT4gIXBhcnQudGV4dCB8fCAhL1xcUy8udGVzdChwYXJ0LnRleHQpO1xuY29uc3QgaXNOTCA9IHBhcnQgPT4gcGFydC50eXBlID09PSBcIm5ld2xpbmVcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIHRvZ2dsZUlubGluZUZvcm1hdChyYW5nZSwgcHJlZml4LCBzdWZmaXggPSBwcmVmaXgpIHtcbiAgICBjb25zdCB7bW9kZWwsIHBhcnRzfSA9IHJhbmdlO1xuICAgIGNvbnN0IHtwYXJ0Q3JlYXRvcn0gPSBtb2RlbDtcblxuICAgIC8vIGNvbXB1dGUgcGFyYWdyYXBoIFtzdGFydCwgZW5kXSBpbmRleGVzXG4gICAgY29uc3QgcGFyYWdyYXBoSW5kZXhlcyA9IFtdO1xuICAgIGxldCBzdGFydEluZGV4ID0gMDtcbiAgICAvLyBzdGFydCBhdCBpPTIgYmVjYXVzZSB3ZSBsb29rIGF0IGkgYW5kIHVwIHRvIHR3byBwYXJ0cyBiZWhpbmQgdG8gZGV0ZWN0IHBhcmFncmFwaCBicmVha3MgYXQgdGhlaXIgZW5kXG4gICAgZm9yIChsZXQgaSA9IDI7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAvLyBwYXJhZ3JhcGggYnJlYWtzIGNhbiBiZSBkZW5vdGVkIGluIGEgbXVsdGl0dWRlIG9mIHdheXMsXG4gICAgICAgIC8vIC0gMiBuZXdsaW5lIHBhcnRzIGluIHNlcXVlbmNlXG4gICAgICAgIC8vIC0gbmV3bGluZSBwYXJ0LCBwbGFpbig8ZW1wdHkgb3IganVzdCBzcGFjZXM+KSwgbmV3bGluZSBwYXJ0XG5cbiAgICAgICAgLy8gYnVtcCBzdGFydEluZGV4IG9udG8gdGhlIGZpcnN0IG5vbi1ibGFuayBhZnRlciB0aGUgcGFyYWdyYXBoIGVuZGluZ1xuICAgICAgICBpZiAoaXNCbGFuayhwYXJ0c1tpIC0gMl0pICYmIGlzTkwocGFydHNbaSAtIDFdKSAmJiAhaXNOTChwYXJ0c1tpXSkgJiYgIWlzQmxhbmsocGFydHNbaV0pKSB7XG4gICAgICAgICAgICBzdGFydEluZGV4ID0gaTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmIGF0IGEgcGFyYWdyYXBoIGJyZWFrLCBzdG9yZSB0aGUgaW5kZXhlcyBvZiB0aGUgcGFyYWdyYXBoXG4gICAgICAgIGlmIChpc05MKHBhcnRzW2kgLSAxXSkgJiYgaXNOTChwYXJ0c1tpXSkpIHtcbiAgICAgICAgICAgIHBhcmFncmFwaEluZGV4ZXMucHVzaChbc3RhcnRJbmRleCwgaSAtIDFdKTtcbiAgICAgICAgICAgIHN0YXJ0SW5kZXggPSBpICsgMTtcbiAgICAgICAgfSBlbHNlIGlmIChpc05MKHBhcnRzW2kgLSAyXSkgJiYgaXNCbGFuayhwYXJ0c1tpIC0gMV0pICYmIGlzTkwocGFydHNbaV0pKSB7XG4gICAgICAgICAgICBwYXJhZ3JhcGhJbmRleGVzLnB1c2goW3N0YXJ0SW5kZXgsIGkgLSAyXSk7XG4gICAgICAgICAgICBzdGFydEluZGV4ID0gaSArIDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBsYXN0Tm9uRW1wdHlQYXJ0ID0gcGFydHMubWFwKGlzQmxhbmspLmxhc3RJbmRleE9mKGZhbHNlKTtcbiAgICAvLyBJZiB3ZSBoYXZlIG5vdCB5ZXQgaW5jbHVkZWQgdGhlIGZpbmFsIHBhcmFncmFwaCB0aGVuIGFkZCBpdCBub3dcbiAgICBpZiAoc3RhcnRJbmRleCA8PSBsYXN0Tm9uRW1wdHlQYXJ0KSB7XG4gICAgICAgIHBhcmFncmFwaEluZGV4ZXMucHVzaChbc3RhcnRJbmRleCwgbGFzdE5vbkVtcHR5UGFydCArIDFdKTtcbiAgICB9XG5cbiAgICAvLyBrZWVwIHRyYWNrIG9mIGhvdyBtYW55IHRoaW5ncyB3ZSBoYXZlIGluc2VydGVkIGFzIGFuIG9mZnNldDo9MFxuICAgIGxldCBvZmZzZXQgPSAwO1xuICAgIHBhcmFncmFwaEluZGV4ZXMuZm9yRWFjaCgoW3N0YXJ0SW5kZXgsIGVuZEluZGV4XSkgPT4ge1xuICAgICAgICAvLyBmb3IgZWFjaCBwYXJhZ3JhcGggYXBwbHkgdGhlIHNhbWUgcnVsZVxuICAgICAgICBjb25zdCBiYXNlID0gc3RhcnRJbmRleCArIG9mZnNldDtcbiAgICAgICAgY29uc3QgaW5kZXggPSBlbmRJbmRleCArIG9mZnNldDtcblxuICAgICAgICBjb25zdCBpc0Zvcm1hdHRlZCA9IChpbmRleCAtIGJhc2UgPiAwKSAmJlxuICAgICAgICAgICAgcGFydHNbYmFzZV0udGV4dC5zdGFydHNXaXRoKHByZWZpeCkgJiZcbiAgICAgICAgICAgIHBhcnRzW2luZGV4IC0gMV0udGV4dC5lbmRzV2l0aChzdWZmaXgpO1xuXG4gICAgICAgIGlmIChpc0Zvcm1hdHRlZCkge1xuICAgICAgICAgICAgLy8gcmVtb3ZlIHByZWZpeCBhbmQgc3VmZml4XG4gICAgICAgICAgICBjb25zdCBwYXJ0V2l0aG91dFByZWZpeCA9IHBhcnRzW2Jhc2VdLnNlcmlhbGl6ZSgpO1xuICAgICAgICAgICAgcGFydFdpdGhvdXRQcmVmaXgudGV4dCA9IHBhcnRXaXRob3V0UHJlZml4LnRleHQuc3Vic3RyKHByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgcGFydHNbYmFzZV0gPSBwYXJ0Q3JlYXRvci5kZXNlcmlhbGl6ZVBhcnQocGFydFdpdGhvdXRQcmVmaXgpO1xuXG4gICAgICAgICAgICBjb25zdCBwYXJ0V2l0aG91dFN1ZmZpeCA9IHBhcnRzW2luZGV4IC0gMV0uc2VyaWFsaXplKCk7XG4gICAgICAgICAgICBjb25zdCBzdWZmaXhQYXJ0VGV4dCA9IHBhcnRXaXRob3V0U3VmZml4LnRleHQ7XG4gICAgICAgICAgICBwYXJ0V2l0aG91dFN1ZmZpeC50ZXh0ID0gc3VmZml4UGFydFRleHQuc3Vic3RyaW5nKDAsIHN1ZmZpeFBhcnRUZXh0Lmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgcGFydHNbaW5kZXggLSAxXSA9IHBhcnRDcmVhdG9yLmRlc2VyaWFsaXplUGFydChwYXJ0V2l0aG91dFN1ZmZpeCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwYXJ0cy5zcGxpY2UoaW5kZXgsIDAsIHBhcnRDcmVhdG9yLnBsYWluKHN1ZmZpeCkpOyAvLyBzcGxpY2UgaW4gdGhlIGxhdGVyIG9uZSBmaXJzdCB0byBub3QgY2hhbmdlIG9mZnNldFxuICAgICAgICAgICAgcGFydHMuc3BsaWNlKGJhc2UsIDAsIHBhcnRDcmVhdG9yLnBsYWluKHByZWZpeCkpO1xuICAgICAgICAgICAgb2Zmc2V0ICs9IDI7IC8vIG9mZnNldCBpbmRleCB0byBhY2NvdW50IGZvciB0aGUgdHdvIGl0ZW1zIHdlIGp1c3Qgc3BsaWNlZCBpblxuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICByZXBsYWNlUmFuZ2VBbmRFeHBhbmRTZWxlY3Rpb24ocmFuZ2UsIHBhcnRzKTtcbn1cbiJdfQ==