"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parsePlainTextMessage = parsePlainTextMessage;
exports.parseEvent = parseEvent;

var _dom = require("./dom");

var _HtmlUtils = require("../HtmlUtils");

var _Permalinks = require("../utils/permalinks/Permalinks");

/*
Copyright 2019 New Vector Ltd
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function parseAtRoomMentions(text
/*: string*/
, partCreator
/*: PartCreator*/
) {
  const ATROOM = "@room";
  const parts = [];
  text.split(ATROOM).forEach((textPart, i, arr) => {
    if (textPart.length) {
      parts.push(partCreator.plain(textPart));
    } // it's safe to never append @room after the last textPart
    // as split will report an empty string at the end if
    // `text` ended in @room.


    const isLast = i === arr.length - 1;

    if (!isLast) {
      parts.push(partCreator.atRoomPill(ATROOM));
    }
  });
  return parts;
}

function parseLink(a
/*: HTMLAnchorElement*/
, partCreator
/*: PartCreator*/
) {
  const {
    href
  } = a;
  const resourceId = (0, _Permalinks.getPrimaryPermalinkEntity)(href); // The room/user ID

  const prefix = resourceId ? resourceId[0] : undefined; // First character of ID

  switch (prefix) {
    case "@":
      return partCreator.userPill(a.textContent, resourceId);

    case "#":
      return partCreator.roomPill(resourceId);

    default:
      {
        if (href === a.textContent) {
          return partCreator.plain(a.textContent);
        } else {
          return partCreator.plain("[".concat(a.textContent.replace(/[[\\\]]/g, c => "\\" + c), "](").concat(href, ")"));
        }
      }
  }
}

function parseCodeBlock(n
/*: HTMLElement*/
, partCreator
/*: PartCreator*/
) {
  const parts = [];
  let language = "";

  if (n.firstChild && n.firstChild.nodeName === "CODE") {
    for (const className of n.firstChild.classList) {
      if (className.startsWith("language-")) {
        language = className.substr("language-".length);
        break;
      }
    }
  }

  const preLines = ("```" + language + "\n" + n.textContent + "```").split("\n");
  preLines.forEach((l, i) => {
    parts.push(partCreator.plain(l));

    if (i < preLines.length - 1) {
      parts.push(partCreator.newline());
    }
  });
  return parts;
}

function parseHeader(el
/*: HTMLElement*/
, partCreator
/*: PartCreator*/
) {
  const depth = parseInt(el.nodeName.substr(1), 10);
  return partCreator.plain("#".repeat(depth) + " ");
}

function parseElement(n
/*: HTMLElement*/
, partCreator
/*: PartCreator*/
, lastNode
/*: HTMLElement | undefined*/
, state
/*: IState*/
) {
  switch (n.nodeName) {
    case "H1":
    case "H2":
    case "H3":
    case "H4":
    case "H5":
    case "H6":
      return parseHeader(n, partCreator);

    case "A":
      return parseLink(n, partCreator);

    case "BR":
      return partCreator.newline();

    case "EM":
      return partCreator.plain("_".concat(n.textContent, "_"));

    case "STRONG":
      return partCreator.plain("**".concat(n.textContent, "**"));

    case "PRE":
      return parseCodeBlock(n, partCreator);

    case "CODE":
      return partCreator.plain("`".concat(n.textContent, "`"));

    case "DEL":
      return partCreator.plain("<del>".concat(n.textContent, "</del>"));

    case "LI":
      {
        const indent = "  ".repeat(state.listDepth - 1);

        if (n.parentElement.nodeName === "OL") {
          // The markdown parser doesn't do nested indexed lists at all, but this supports it anyway.
          const index = state.listIndex[state.listIndex.length - 1];
          state.listIndex[state.listIndex.length - 1] += 1;
          return partCreator.plain("".concat(indent).concat(index, ". "));
        } else {
          return partCreator.plain("".concat(indent, "- "));
        }
      }

    case "P":
      {
        if (lastNode) {
          return partCreator.newline();
        }

        break;
      }

    case "OL":
      state.listIndex.push(n.start || 1);

    /* falls through */

    case "UL":
      state.listDepth = (state.listDepth || 0) + 1;

    /* falls through */

    default:
      // don't textify block nodes we'll descend into
      if (!checkDescendInto(n)) {
        return partCreator.plain(n.textContent);
      }

  }
}

function checkDescendInto(node) {
  switch (node.nodeName) {
    case "PRE":
      // a code block is textified in parseCodeBlock
      // as we don't want to preserve markup in it,
      // so no need to descend into it
      return false;

    default:
      return (0, _HtmlUtils.checkBlockNode)(node);
  }
}

function checkIgnored(n) {
  if (n.nodeType === Node.TEXT_NODE) {
    // riot adds \n text nodes in a lot of places,
    // which should be ignored
    return n.nodeValue === "\n";
  } else if (n.nodeType === Node.ELEMENT_NODE) {
    return n.nodeName === "MX-REPLY";
  }

  return true;
}

const QUOTE_LINE_PREFIX = "> ";

function prefixQuoteLines(isFirstNode, parts, partCreator) {
  // a newline (to append a > to) wouldn't be added to parts for the first line
  // if there was no content before the BLOCKQUOTE, so handle that
  if (isFirstNode) {
    parts.splice(0, 0, partCreator.plain(QUOTE_LINE_PREFIX));
  }

  for (let i = 0; i < parts.length; i += 1) {
    if (parts[i].type === "newline") {
      parts.splice(i + 1, 0, partCreator.plain(QUOTE_LINE_PREFIX));
      i += 1;
    }
  }
}

function parseHtmlMessage(html
/*: string*/
, partCreator
/*: PartCreator*/
, isQuotedMessage
/*: boolean*/
) {
  // no nodes from parsing here should be inserted in the document,
  // as scripts in event handlers, etc would be executed then.
  // we're only taking text, so that is fine
  const rootNode = new DOMParser().parseFromString(html, "text/html").body;
  const parts = [];
  let lastNode;
  let inQuote = isQuotedMessage;
  const state
  /*: IState*/
  = {
    listIndex: []
  };

  function onNodeEnter(n) {
    if (checkIgnored(n)) {
      return false;
    }

    if (n.nodeName === "BLOCKQUOTE") {
      inQuote = true;
    }

    const newParts = [];

    if (lastNode && ((0, _HtmlUtils.checkBlockNode)(lastNode) || (0, _HtmlUtils.checkBlockNode)(n))) {
      newParts.push(partCreator.newline());
    }

    if (n.nodeType === Node.TEXT_NODE) {
      newParts.push(...parseAtRoomMentions(n.nodeValue, partCreator));
    } else if (n.nodeType === Node.ELEMENT_NODE) {
      const parseResult = parseElement(n, partCreator, lastNode, state);

      if (parseResult) {
        if (Array.isArray(parseResult)) {
          newParts.push(...parseResult);
        } else {
          newParts.push(parseResult);
        }
      }
    }

    if (newParts.length && inQuote) {
      const isFirstPart = parts.length === 0;
      prefixQuoteLines(isFirstPart, newParts, partCreator);
    }

    parts.push(...newParts);
    const descend = checkDescendInto(n); // when not descending (like for PRE), onNodeLeave won't be called to set lastNode
    // so do that here.

    lastNode = descend ? null : n;
    return descend;
  }

  function onNodeLeave(n) {
    if (checkIgnored(n)) {
      return;
    }

    switch (n.nodeName) {
      case "BLOCKQUOTE":
        inQuote = false;
        break;

      case "OL":
        state.listIndex.pop();

      /* falls through */

      case "UL":
        state.listDepth -= 1;
        break;
    }

    lastNode = n;
  }

  (0, _dom.walkDOMDepthFirst)(rootNode, onNodeEnter, onNodeLeave);
  return parts;
}

function parsePlainTextMessage(body
/*: string*/
, partCreator
/*: PartCreator*/
, isQuotedMessage
/*: boolean*/
) {
  const lines = body.split(/\r\n|\r|\n/g); // split on any new-line combination not just \n, collapses \r\n

  return lines.reduce((parts, line, i) => {
    if (isQuotedMessage) {
      parts.push(partCreator.plain(QUOTE_LINE_PREFIX));
    }

    parts.push(...parseAtRoomMentions(line, partCreator));
    const isLast = i === lines.length - 1;

    if (!isLast) {
      parts.push(partCreator.newline());
    }

    return parts;
  }, []);
}

function parseEvent(event
/*: MatrixEvent*/
, partCreator
/*: PartCreator*/
, {
  isQuotedMessage = false
} = {}) {
  const content = event.getContent();
  let parts;

  if (content.format === "org.matrix.custom.html") {
    parts = parseHtmlMessage(content.formatted_body || "", partCreator, isQuotedMessage);
  } else {
    parts = parsePlainTextMessage(content.body || "", partCreator, isQuotedMessage);
  }

  if (content.msgtype === "m.emote") {
    parts.unshift(partCreator.plain("/me "));
  }

  return parts;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3IvZGVzZXJpYWxpemUudHMiXSwibmFtZXMiOlsicGFyc2VBdFJvb21NZW50aW9ucyIsInRleHQiLCJwYXJ0Q3JlYXRvciIsIkFUUk9PTSIsInBhcnRzIiwic3BsaXQiLCJmb3JFYWNoIiwidGV4dFBhcnQiLCJpIiwiYXJyIiwibGVuZ3RoIiwicHVzaCIsInBsYWluIiwiaXNMYXN0IiwiYXRSb29tUGlsbCIsInBhcnNlTGluayIsImEiLCJocmVmIiwicmVzb3VyY2VJZCIsInByZWZpeCIsInVuZGVmaW5lZCIsInVzZXJQaWxsIiwidGV4dENvbnRlbnQiLCJyb29tUGlsbCIsInJlcGxhY2UiLCJjIiwicGFyc2VDb2RlQmxvY2siLCJuIiwibGFuZ3VhZ2UiLCJmaXJzdENoaWxkIiwibm9kZU5hbWUiLCJjbGFzc05hbWUiLCJjbGFzc0xpc3QiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwicHJlTGluZXMiLCJsIiwibmV3bGluZSIsInBhcnNlSGVhZGVyIiwiZWwiLCJkZXB0aCIsInBhcnNlSW50IiwicmVwZWF0IiwicGFyc2VFbGVtZW50IiwibGFzdE5vZGUiLCJzdGF0ZSIsImluZGVudCIsImxpc3REZXB0aCIsInBhcmVudEVsZW1lbnQiLCJpbmRleCIsImxpc3RJbmRleCIsInN0YXJ0IiwiY2hlY2tEZXNjZW5kSW50byIsIm5vZGUiLCJjaGVja0lnbm9yZWQiLCJub2RlVHlwZSIsIk5vZGUiLCJURVhUX05PREUiLCJub2RlVmFsdWUiLCJFTEVNRU5UX05PREUiLCJRVU9URV9MSU5FX1BSRUZJWCIsInByZWZpeFF1b3RlTGluZXMiLCJpc0ZpcnN0Tm9kZSIsInNwbGljZSIsInR5cGUiLCJwYXJzZUh0bWxNZXNzYWdlIiwiaHRtbCIsImlzUXVvdGVkTWVzc2FnZSIsInJvb3ROb2RlIiwiRE9NUGFyc2VyIiwicGFyc2VGcm9tU3RyaW5nIiwiYm9keSIsImluUXVvdGUiLCJvbk5vZGVFbnRlciIsIm5ld1BhcnRzIiwicGFyc2VSZXN1bHQiLCJBcnJheSIsImlzQXJyYXkiLCJpc0ZpcnN0UGFydCIsImRlc2NlbmQiLCJvbk5vZGVMZWF2ZSIsInBvcCIsInBhcnNlUGxhaW5UZXh0TWVzc2FnZSIsImxpbmVzIiwicmVkdWNlIiwibGluZSIsInBhcnNlRXZlbnQiLCJldmVudCIsImNvbnRlbnQiLCJnZXRDb250ZW50IiwiZm9ybWF0IiwiZm9ybWF0dGVkX2JvZHkiLCJtc2d0eXBlIiwidW5zaGlmdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBQ0E7O0FBckJBOzs7Ozs7Ozs7Ozs7Ozs7O0FBd0JBLFNBQVNBLG1CQUFULENBQTZCQztBQUE3QjtBQUFBLEVBQTJDQztBQUEzQztBQUFBLEVBQXFFO0FBQ2pFLFFBQU1DLE1BQU0sR0FBRyxPQUFmO0FBQ0EsUUFBTUMsS0FBSyxHQUFHLEVBQWQ7QUFDQUgsRUFBQUEsSUFBSSxDQUFDSSxLQUFMLENBQVdGLE1BQVgsRUFBbUJHLE9BQW5CLENBQTJCLENBQUNDLFFBQUQsRUFBV0MsQ0FBWCxFQUFjQyxHQUFkLEtBQXNCO0FBQzdDLFFBQUlGLFFBQVEsQ0FBQ0csTUFBYixFQUFxQjtBQUNqQk4sTUFBQUEsS0FBSyxDQUFDTyxJQUFOLENBQVdULFdBQVcsQ0FBQ1UsS0FBWixDQUFrQkwsUUFBbEIsQ0FBWDtBQUNILEtBSDRDLENBSTdDO0FBQ0E7QUFDQTs7O0FBQ0EsVUFBTU0sTUFBTSxHQUFHTCxDQUFDLEtBQUtDLEdBQUcsQ0FBQ0MsTUFBSixHQUFhLENBQWxDOztBQUNBLFFBQUksQ0FBQ0csTUFBTCxFQUFhO0FBQ1RULE1BQUFBLEtBQUssQ0FBQ08sSUFBTixDQUFXVCxXQUFXLENBQUNZLFVBQVosQ0FBdUJYLE1BQXZCLENBQVg7QUFDSDtBQUNKLEdBWEQ7QUFZQSxTQUFPQyxLQUFQO0FBQ0g7O0FBRUQsU0FBU1csU0FBVCxDQUFtQkM7QUFBbkI7QUFBQSxFQUF5Q2Q7QUFBekM7QUFBQSxFQUFtRTtBQUMvRCxRQUFNO0FBQUNlLElBQUFBO0FBQUQsTUFBU0QsQ0FBZjtBQUNBLFFB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QU8sQ0FBQ0ksT0FBUixLQUFvQixTQUF4QixFQUFtQztBQUMvQnhGLElBQUFBLEtBQUssQ0FBQ3lGLE9BQU4sQ0FBYzNGLFdBQVcsQ0FBQ1UsS0FBWixDQUFrQixNQUFsQixDQUFkO0FBQ0g7O0FBQ0QsU0FBT1IsS0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuXG5pbXBvcnQgeyB3YWxrRE9NRGVwdGhGaXJzdCB9IGZyb20gXCIuL2RvbVwiO1xuaW1wb3J0IHsgY2hlY2tCbG9ja05vZGUgfSBmcm9tIFwiLi4vSHRtbFV0aWxzXCI7XG5pbXBvcnQgeyBnZXRQcmltYXJ5UGVybWFsaW5rRW50aXR5IH0gZnJvbSBcIi4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IHsgUGFydENyZWF0b3IgfSBmcm9tIFwiLi9wYXJ0c1wiO1xuXG5mdW5jdGlvbiBwYXJzZUF0Um9vbU1lbnRpb25zKHRleHQ6IHN0cmluZywgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgQVRST09NID0gXCJAcm9vbVwiO1xuICAgIGNvbnN0IHBhcnRzID0gW107XG4gICAgdGV4dC5zcGxpdChBVFJPT00pLmZvckVhY2goKHRleHRQYXJ0LCBpLCBhcnIpID0+IHtcbiAgICAgICAgaWYgKHRleHRQYXJ0Lmxlbmd0aCkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5wbGFpbih0ZXh0UGFydCkpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGl0J3Mgc2FmZSB0byBuZXZlciBhcHBlbmQgQHJvb20gYWZ0ZXIgdGhlIGxhc3QgdGV4dFBhcnRcbiAgICAgICAgLy8gYXMgc3BsaXQgd2lsbCByZXBvcnQgYW4gZW1wdHkgc3RyaW5nIGF0IHRoZSBlbmQgaWZcbiAgICAgICAgLy8gYHRleHRgIGVuZGVkIGluIEByb29tLlxuICAgICAgICBjb25zdCBpc0xhc3QgPSBpID09PSBhcnIubGVuZ3RoIC0gMTtcbiAgICAgICAgaWYgKCFpc0xhc3QpIHtcbiAgICAgICAgICAgIHBhcnRzLnB1c2gocGFydENyZWF0b3IuYXRSb29tUGlsbChBVFJPT00pKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXJ0cztcbn1cblxuZnVuY3Rpb24gcGFyc2VMaW5rKGE6IEhUTUxBbmNob3JFbGVtZW50LCBwYXJ0Q3JlYXRvcjogUGFydENyZWF0b3IpIHtcbiAgICBjb25zdCB7aHJlZn0gPSBhO1xuICAgIGNvbnN0IHJlc291cmNlSWQgPSBnZXRQcmltYXJ5UGVybWFsaW5rRW50aXR5KGhyZWYpOyAvLyBUaGUgcm9vbS91c2VyIElEXG4gICAgY29uc3QgcHJlZml4ID0gcmVzb3VyY2VJZCA/IHJlc291cmNlSWRbMF0gOiB1bmRlZmluZWQ7IC8vIEZpcnN0IGNoYXJhY3RlciBvZiBJRFxuICAgIHN3aXRjaCAocHJlZml4KSB7XG4gICAgICAgIGNhc2UgXCJAXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IudXNlclBpbGwoYS50ZXh0Q29udGVudCwgcmVzb3VyY2VJZCk7XG4gICAgICAgIGNhc2UgXCIjXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3Iucm9vbVBpbGwocmVzb3VyY2VJZCk7XG4gICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgIGlmIChocmVmID09PSBhLnRleHRDb250ZW50KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGEudGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYFske2EudGV4dENvbnRlbnQucmVwbGFjZSgvW1tcXFxcXFxdXS9nLCBjID0+IFwiXFxcXFwiICsgYyl9XSgke2hyZWZ9KWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUNvZGVCbG9jayhuOiBIVE1MRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgcGFydHMgPSBbXTtcbiAgICBsZXQgbGFuZ3VhZ2UgPSBcIlwiO1xuICAgIGlmIChuLmZpcnN0Q2hpbGQgJiYgbi5maXJzdENoaWxkLm5vZGVOYW1lID09PSBcIkNPREVcIikge1xuICAgICAgICBmb3IgKGNvbnN0IGNsYXNzTmFtZSBvZiAoPEhUTUxFbGVtZW50Pm4uZmlyc3RDaGlsZCkuY2xhc3NMaXN0KSB7XG4gICAgICAgICAgICBpZiAoY2xhc3NOYW1lLnN0YXJ0c1dpdGgoXCJsYW5ndWFnZS1cIikpIHtcbiAgICAgICAgICAgICAgICBsYW5ndWFnZSA9IGNsYXNzTmFtZS5zdWJzdHIoXCJsYW5ndWFnZS1cIi5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHByZUxpbmVzID0gKFwiYGBgXCIgKyBsYW5ndWFnZSArIFwiXFxuXCIgKyBuLnRleHRDb250ZW50ICsgXCJgYGBcIikuc3BsaXQoXCJcXG5cIik7XG4gICAgcHJlTGluZXMuZm9yRWFjaCgobCwgaSkgPT4ge1xuICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLnBsYWluKGwpKTtcbiAgICAgICAgaWYgKGkgPCBwcmVMaW5lcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICBwYXJ0cy5wdXNoKHBhcnRDcmVhdG9yLm5ld2xpbmUoKSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGFydHM7XG59XG5cbmZ1bmN0aW9uIHBhcnNlSGVhZGVyKGVsOiBIVE1MRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yKSB7XG4gICAgY29uc3QgZGVwdGggPSBwYXJzZUludChlbC5ub2RlTmFtZS5zdWJzdHIoMSksIDEwKTtcbiAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oXCIjXCIucmVwZWF0KGRlcHRoKSArIFwiIFwiKTtcbn1cblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgbGlzdEluZGV4OiBudW1iZXJbXTtcbiAgICBsaXN0RGVwdGg/OiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBhcnNlRWxlbWVudChuOiBIVE1MRWxlbWVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCBsYXN0Tm9kZTogSFRNTEVsZW1lbnQgfCB1bmRlZmluZWQsIHN0YXRlOiBJU3RhdGUpIHtcbiAgICBzd2l0Y2ggKG4ubm9kZU5hbWUpIHtcbiAgICAgICAgY2FzZSBcIkgxXCI6XG4gICAgICAgIGNhc2UgXCJIMlwiOlxuICAgICAgICBjYXNlIFwiSDNcIjpcbiAgICAgICAgY2FzZSBcIkg0XCI6XG4gICAgICAgIGNhc2UgXCJINVwiOlxuICAgICAgICBjYXNlIFwiSDZcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUhlYWRlcihuLCBwYXJ0Q3JlYXRvcik7XG4gICAgICAgIGNhc2UgXCJBXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFyc2VMaW5rKDxIVE1MQW5jaG9yRWxlbWVudD5uLCBwYXJ0Q3JlYXRvcik7XG4gICAgICAgIGNhc2UgXCJCUlwiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLm5ld2xpbmUoKTtcbiAgICAgICAgY2FzZSBcIkVNXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYF8ke24udGV4dENvbnRlbnR9X2ApO1xuICAgICAgICBjYXNlIFwiU1RST05HXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYCoqJHtuLnRleHRDb250ZW50fSoqYCk7XG4gICAgICAgIGNhc2UgXCJQUkVcIjpcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUNvZGVCbG9jayhuLCBwYXJ0Q3JlYXRvcik7XG4gICAgICAgIGNhc2UgXCJDT0RFXCI6XG4gICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYFxcYCR7bi50ZXh0Q29udGVudH1cXGBgKTtcbiAgICAgICAgY2FzZSBcIkRFTFwiOlxuICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGA8ZGVsPiR7bi50ZXh0Q29udGVudH08L2RlbD5gKTtcbiAgICAgICAgY2FzZSBcIkxJXCI6IHtcbiAgICAgICAgICAgIGNvbnN0IGluZGVudCA9IFwiICBcIi5yZXBlYXQoc3RhdGUubGlzdERlcHRoIC0gMSk7XG4gICAgICAgICAgICBpZiAobi5wYXJlbnRFbGVtZW50Lm5vZGVOYW1lID09PSBcIk9MXCIpIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgbWFya2Rvd24gcGFyc2VyIGRvZXNuJ3QgZG8gbmVzdGVkIGluZGV4ZWQgbGlzdHMgYXQgYWxsLCBidXQgdGhpcyBzdXBwb3J0cyBpdCBhbnl3YXkuXG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5saXN0SW5kZXhbc3RhdGUubGlzdEluZGV4Lmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgICAgIHN0YXRlLmxpc3RJbmRleFtzdGF0ZS5saXN0SW5kZXgubGVuZ3RoIC0gMV0gKz0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4oYCR7aW5kZW50fSR7aW5kZXh9LiBgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRDcmVhdG9yLnBsYWluKGAke2luZGVudH0tIGApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJQXCI6IHtcbiAgICAgICAgICAgIGlmIChsYXN0Tm9kZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0Q3JlYXRvci5uZXdsaW5lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiT0xcIjpcbiAgICAgICAgICAgIHN0YXRlLmxpc3RJbmRleC5wdXNoKCg8SFRNTE9MaXN0RWxlbWVudD5uKS5zdGFydCB8fCAxKTtcbiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi9cbiAgICAgICAgY2FzZSBcIlVMXCI6XG4gICAgICAgICAgICBzdGF0ZS5saXN0RGVwdGggPSAoc3RhdGUubGlzdERlcHRoIHx8IDApICsgMTtcbiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi9cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIC8vIGRvbid0IHRleHRpZnkgYmxvY2sgbm9kZXMgd2UnbGwgZGVzY2VuZCBpbnRvXG4gICAgICAgICAgICBpZiAoIWNoZWNrRGVzY2VuZEludG8obikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFydENyZWF0b3IucGxhaW4obi50ZXh0Q29udGVudCk7XG4gICAgICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjaGVja0Rlc2NlbmRJbnRvKG5vZGUpIHtcbiAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHtcbiAgICAgICAgY2FzZSBcIlBSRVwiOlxuICAgICAgICAgICAgLy8gYSBjb2RlIGJsb2NrIGlzIHRleHRpZmllZCBpbiBwYXJzZUNvZGVCbG9ja1xuICAgICAgICAgICAgLy8gYXMgd2UgZG9uJ3Qgd2FudCB0byBwcmVzZXJ2ZSBtYXJrdXAgaW4gaXQsXG4gICAgICAgICAgICAvLyBzbyBubyBuZWVkIHRvIGRlc2NlbmQgaW50byBpdFxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIGNoZWNrQmxvY2tOb2RlKG5vZGUpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gY2hlY2tJZ25vcmVkKG4pIHtcbiAgICBpZiAobi5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHtcbiAgICAgICAgLy8gcmlvdCBhZGRzIFxcbiB0ZXh0IG5vZGVzIGluIGEgbG90IG9mIHBsYWNlcyxcbiAgICAgICAgLy8gd2hpY2ggc2hvdWxkIGJlIGlnbm9yZWRcbiAgICAgICAgcmV0dXJuIG4ubm9kZVZhbHVlID09PSBcIlxcblwiO1xuICAgIH0gZWxzZSBpZiAobi5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHtcbiAgICAgICAgcmV0dXJuIG4ubm9kZU5hbWUgPT09IFwiTVgtUkVQTFlcIjtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmNvbnN0IFFVT1RFX0xJTkVfUFJFRklYID0gXCI+IFwiO1xuZnVuY3Rpb24gcHJlZml4UXVvdGVMaW5lcyhpc0ZpcnN0Tm9kZSwgcGFydHMsIHBhcnRDcmVhdG9yKSB7XG4gICAgLy8gYSBuZXdsaW5lICh0byBhcHBlbmQgYSA+IHRvKSB3b3VsZG4ndCBiZSBhZGRlZCB0byBwYXJ0cyBmb3IgdGhlIGZpcnN0IGxpbmVcbiAgICAvLyBpZiB0aGVyZSB3YXMgbm8gY29udGVudCBiZWZvcmUgdGhlIEJMT0NLUVVPVEUsIHNvIGhhbmRsZSB0aGF0XG4gICAgaWYgKGlzRmlyc3ROb2RlKSB7XG4gICAgICAgIHBhcnRzLnNwbGljZSgwLCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihRVU9URV9MSU5FX1BSRUZJWCkpO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmIChwYXJ0c1tpXS50eXBlID09PSBcIm5ld2xpbmVcIikge1xuICAgICAgICAgICAgcGFydHMuc3BsaWNlKGkgKyAxLCAwLCBwYXJ0Q3JlYXRvci5wbGFpbihRVU9URV9MSU5FX1BSRUZJWCkpO1xuICAgICAgICAgICAgaSArPSAxO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUh0bWxNZXNzYWdlKGh0bWw6IHN0cmluZywgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2U6IGJvb2xlYW4pIHtcbiAgICAvLyBubyBub2RlcyBmcm9tIHBhcnNpbmcgaGVyZSBzaG91bGQgYmUgaW5zZXJ0ZWQgaW4gdGhlIGRvY3VtZW50LFxuICAgIC8vIGFzIHNjcmlwdHMgaW4gZXZlbnQgaGFuZGxlcnMsIGV0YyB3b3VsZCBiZSBleGVjdXRlZCB0aGVuLlxuICAgIC8vIHdlJ3JlIG9ubHkgdGFraW5nIHRleHQsIHNvIHRoYXQgaXMgZmluZVxuICAgIGNvbnN0IHJvb3ROb2RlID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhodG1sLCBcInRleHQvaHRtbFwiKS5ib2R5O1xuICAgIGNvbnN0IHBhcnRzID0gW107XG4gICAgbGV0IGxhc3ROb2RlO1xuICAgIGxldCBpblF1b3RlID0gaXNRdW90ZWRNZXNzYWdlO1xuICAgIGNvbnN0IHN0YXRlOiBJU3RhdGUgPSB7XG4gICAgICAgIGxpc3RJbmRleDogW10sXG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIG9uTm9kZUVudGVyKG4pIHtcbiAgICAgICAgaWYgKGNoZWNrSWdub3JlZChuKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChuLm5vZGVOYW1lID09PSBcIkJMT0NLUVVPVEVcIikge1xuICAgICAgICAgICAgaW5RdW90ZSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXdQYXJ0cyA9IFtdO1xuICAgICAgICBpZiAobGFzdE5vZGUgJiYgKGNoZWNrQmxvY2tOb2RlKGxhc3ROb2RlKSB8fCBjaGVja0Jsb2NrTm9kZShuKSkpIHtcbiAgICAgICAgICAgIG5ld1BhcnRzLnB1c2gocGFydENyZWF0b3IubmV3bGluZSgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgICAgICAgICAgbmV3UGFydHMucHVzaCguLi5wYXJzZUF0Um9vbU1lbnRpb25zKG4ubm9kZVZhbHVlLCBwYXJ0Q3JlYXRvcikpO1xuICAgICAgICB9IGVsc2UgaWYgKG4ubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJzZVJlc3VsdCA9IHBhcnNlRWxlbWVudChuLCBwYXJ0Q3JlYXRvciwgbGFzdE5vZGUsIHN0YXRlKTtcbiAgICAgICAgICAgIGlmIChwYXJzZVJlc3VsdCkge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhcnNlUmVzdWx0KSkge1xuICAgICAgICAgICAgICAgICAgICBuZXdQYXJ0cy5wdXNoKC4uLnBhcnNlUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdQYXJ0cy5wdXNoKHBhcnNlUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobmV3UGFydHMubGVuZ3RoICYmIGluUXVvdGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGlzRmlyc3RQYXJ0ID0gcGFydHMubGVuZ3RoID09PSAwO1xuICAgICAgICAgICAgcHJlZml4UXVvdGVMaW5lcyhpc0ZpcnN0UGFydCwgbmV3UGFydHMsIHBhcnRDcmVhdG9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhcnRzLnB1c2goLi4ubmV3UGFydHMpO1xuXG4gICAgICAgIGNvbnN0IGRlc2NlbmQgPSBjaGVja0Rlc2NlbmRJbnRvKG4pO1xuICAgICAgICAvLyB3aGVuIG5vdCBkZXNjZW5kaW5nIChsaWtlIGZvciBQUkUpLCBvbk5vZGVMZWF2ZSB3b24ndCBiZSBjYWxsZWQgdG8gc2V0IGxhc3ROb2RlXG4gICAgICAgIC8vIHNvIGRvIHRoYXQgaGVyZS5cbiAgICAgICAgbGFzdE5vZGUgPSBkZXNjZW5kID8gbnVsbCA6IG47XG4gICAgICAgIHJldHVybiBkZXNjZW5kO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIG9uTm9kZUxlYXZlKG4pIHtcbiAgICAgICAgaWYgKGNoZWNrSWdub3JlZChuKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHN3aXRjaCAobi5ub2RlTmFtZSkge1xuICAgICAgICAgICAgY2FzZSBcIkJMT0NLUVVPVEVcIjpcbiAgICAgICAgICAgICAgICBpblF1b3RlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiT0xcIjpcbiAgICAgICAgICAgICAgICBzdGF0ZS5saXN0SW5kZXgucG9wKCk7XG4gICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqL1xuICAgICAgICAgICAgY2FzZSBcIlVMXCI6XG4gICAgICAgICAgICAgICAgc3RhdGUubGlzdERlcHRoIC09IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgbGFzdE5vZGUgPSBuO1xuICAgIH1cblxuICAgIHdhbGtET01EZXB0aEZpcnN0KHJvb3ROb2RlLCBvbk5vZGVFbnRlciwgb25Ob2RlTGVhdmUpO1xuXG4gICAgcmV0dXJuIHBhcnRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VQbGFpblRleHRNZXNzYWdlKGJvZHk6IHN0cmluZywgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2U6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsaW5lcyA9IGJvZHkuc3BsaXQoL1xcclxcbnxcXHJ8XFxuL2cpOyAvLyBzcGxpdCBvbiBhbnkgbmV3LWxpbmUgY29tYmluYXRpb24gbm90IGp1c3QgXFxuLCBjb2xsYXBzZXMgXFxyXFxuXG4gICAgcmV0dXJuIGxpbmVzLnJlZHVjZSgocGFydHMsIGxpbmUsIGkpID0+IHtcbiAgICAgICAgaWYgKGlzUXVvdGVkTWVzc2FnZSkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5wbGFpbihRVU9URV9MSU5FX1BSRUZJWCkpO1xuICAgICAgICB9XG4gICAgICAgIHBhcnRzLnB1c2goLi4ucGFyc2VBdFJvb21NZW50aW9ucyhsaW5lLCBwYXJ0Q3JlYXRvcikpO1xuICAgICAgICBjb25zdCBpc0xhc3QgPSBpID09PSBsaW5lcy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAoIWlzTGFzdCkge1xuICAgICAgICAgICAgcGFydHMucHVzaChwYXJ0Q3JlYXRvci5uZXdsaW5lKCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJ0cztcbiAgICB9LCBbXSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUV2ZW50KGV2ZW50OiBNYXRyaXhFdmVudCwgcGFydENyZWF0b3I6IFBhcnRDcmVhdG9yLCB7aXNRdW90ZWRNZXNzYWdlID0gZmFsc2V9ID0ge30pIHtcbiAgICBjb25zdCBjb250ZW50ID0gZXZlbnQuZ2V0Q29udGVudCgpO1xuICAgIGxldCBwYXJ0cztcbiAgICBpZiAoY29udGVudC5mb3JtYXQgPT09IFwib3JnLm1hdHJpeC5jdXN0b20uaHRtbFwiKSB7XG4gICAgICAgIHBhcnRzID0gcGFyc2VIdG1sTWVzc2FnZShjb250ZW50LmZvcm1hdHRlZF9ib2R5IHx8IFwiXCIsIHBhcnRDcmVhdG9yLCBpc1F1b3RlZE1lc3NhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcnRzID0gcGFyc2VQbGFpblRleHRNZXNzYWdlKGNvbnRlbnQuYm9keSB8fCBcIlwiLCBwYXJ0Q3JlYXRvciwgaXNRdW90ZWRNZXNzYWdlKTtcbiAgICB9XG4gICAgaWYgKGNvbnRlbnQubXNndHlwZSA9PT0gXCJtLmVtb3RlXCIpIHtcbiAgICAgICAgcGFydHMudW5zaGlmdChwYXJ0Q3JlYXRvci5wbGFpbihcIi9tZSBcIikpO1xuICAgIH1cbiAgICByZXR1cm4gcGFydHM7XG59XG4iXX0=