"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.needsCaretNodeBefore = needsCaretNodeBefore;
exports.needsCaretNodeAfter = needsCaretNodeAfter;
exports.isCaretNode = isCaretNode;
exports.renderModel = renderModel;
exports.CARET_NODE_CHAR = void 0;

/*
Copyright 2019 New Vector Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function needsCaretNodeBefore(part, prevPart) {
  const isFirst = !prevPart || prevPart.type === "newline";
  return !part.canEdit && (isFirst || !prevPart.canEdit);
}

function needsCaretNodeAfter(part, isLastOfLine) {
  return !part.canEdit && isLastOfLine;
}

function insertAfter(node, nodeToInsert) {
  const next = node.nextSibling;

  if (next) {
    node.parentElement.insertBefore(nodeToInsert, next);
  } else {
    node.parentElement.appendChild(nodeToInsert);
  }
} // Use a BOM marker for caret nodes.
// On a first test, they seem to be filtered out when copying text out of the editor,
// but this could be platform dependent.
// As a precautionary measure, I chose the character that slate also uses.


const CARET_NODE_CHAR = "\ufeff"; // a caret node is a node that allows the caret to be placed
// where otherwise it wouldn't be possible
// (e.g. next to a pill span without adjacent text node)

exports.CARET_NODE_CHAR = CARET_NODE_CHAR;

function createCaretNode() {
  const span = document.createElement("span");
  span.className = "caretNode";
  span.appendChild(document.createTextNode(CARET_NODE_CHAR));
  return span;
}

function updateCaretNode(node) {
  // ensure the caret node contains only a zero-width space
  if (node.textContent !== CARET_NODE_CHAR) {
    node.textContent = CARET_NODE_CHAR;
  }
}

function isCaretNode(node) {
  return node && node.tagName === "SPAN" && node.className === "caretNode";
}

function removeNextSiblings(node) {
  if (!node) {
    return;
  }

  node = node.nextSibling;

  while (node) {
    const removeNode = node;
    node = node.nextSibling;
    removeNode.remove();
  }
}

function removeChildren(parent) {
  const firstChild = parent.firstChild;

  if (firstChild) {
    removeNextSiblings(firstChild);
    firstChild.remove();
  }
}

function reconcileLine(lineContainer, parts) {
  let currentNode;
  let prevPart;
  const lastPart = parts[parts.length - 1];

  for (const part of parts) {
    const isFirst = !prevPart;
    currentNode = isFirst ? lineContainer.firstChild : currentNode.nextSibling;

    if (needsCaretNodeBefore(part, prevPart)) {
      if (isCaretNode(currentNode)) {
        updateCaretNode(currentNode);
        currentNode = currentNode.nextSibling;
      } else {
        lineContainer.insertBefore(createCaretNode(), currentNode);
      }
    } // remove nodes until matching current part


    while (currentNode && !part.canUpdateDOMNode(currentNode)) {
      const nextNode = currentNode.nextSibling;
      lineContainer.removeChild(currentNode);
      currentNode = nextNode;
    } // update or insert node for current part


    if (currentNode && part) {
      part.updateDOMNode(currentNode);
    } else if (part) {
      currentNode = part.toDOMNode(); // hooks up nextSibling for next iteration

      lineContainer.appendChild(currentNode);
    }

    if (needsCaretNodeAfter(part, part === lastPart)) {
      if (isCaretNode(currentNode.nextSibling)) {
        currentNode = currentNode.nextSibling;
        updateCaretNode(currentNode);
      } else {
        const caretNode = createCaretNode();
        insertAfter(currentNode, caretNode);
        currentNode = caretNode;
      }
    }

    prevPart = part;
  }

  removeNextSiblings(currentNode);
}

function reconcileEmptyLine(lineContainer) {
  // empty div needs to have a BR in it to give it height
  let foundBR = false;
  let partNode = lineContainer.firstChild;

  while (partNode) {
    const nextNode = partNode.nextSibling;

    if (!foundBR && partNode.tagName === "BR") {
      foundBR = true;
    } else {
      partNode.remove();
    }

    partNode = nextNode;
  }

  if (!foundBR) {
    lineContainer.appendChild(document.createElement("br"));
  }
}

function renderModel(editor, model) {
  const lines = model.parts.reduce((lines, part) => {
    if (part.type === "newline") {
      lines.push([]);
    } else {
      const lastLine = lines[lines.length - 1];
      lastLine.push(part);
    }

    return lines;
  }, [[]]);
  lines.forEach((parts, i) => {
    // find first (and remove anything else) div without className
    // (as browsers insert these in contenteditable) line container
    let lineContainer = editor.childNodes[i];

    while (lineContainer && (lineContainer.tagName !== "DIV" || !!lineContainer.className)) {
      editor.removeChild(lineContainer);
      lineContainer = editor.childNodes[i];
    }

    if (!lineContainer) {
      lineContainer = document.createElement("div");
      editor.appendChild(lineContainer);
    }

    if (parts.length) {
      reconcileLine(lineContainer, parts);
    } else {
      reconcileEmptyLine(lineContainer);
    }
  });

  if (lines.length) {
    removeNextSiblings(editor.children[lines.length - 1]);
  } else {
    removeChildren(editor);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3IvcmVuZGVyLmpzIl0sIm5hbWVzIjpbIm5lZWRzQ2FyZXROb2RlQmVmb3JlIiwicGFydCIsInByZXZQYXJ0IiwiaXNGaXJzdCIsInR5cGUiLCJjYW5FZGl0IiwibmVlZHNDYXJldE5vZGVBZnRlciIsImlzTGFzdE9mTGluZSIsImluc2VydEFmdGVyIiwibm9kZSIsIm5vZGVUb0luc2VydCIsIm5leHQiLCJuZXh0U2libGluZyIsInBhcmVudEVsZW1lbnQiLCJpbnNlcnRCZWZvcmUiLCJhcHBlbmRDaGlsZCIsIkNBUkVUX05PREVfQ0hBUiIsImNyZWF0ZUNhcmV0Tm9kZSIsInNwYW4iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc05hbWUiLCJjcmVhdGVUZXh0Tm9kZSIsInVwZGF0ZUNhcmV0Tm9kZSIsInRleHRDb250ZW50IiwiaXNDYXJldE5vZGUiLCJ0YWdOYW1lIiwicmVtb3ZlTmV4dFNpYmxpbmdzIiwicmVtb3ZlTm9kZSIsInJlbW92ZSIsInJlbW92ZUNoaWxkcmVuIiwicGFyZW50IiwiZmlyc3RDaGlsZCIsInJlY29uY2lsZUxpbmUiLCJsaW5lQ29udGFpbmVyIiwicGFydHMiLCJjdXJyZW50Tm9kZSIsImxhc3RQYXJ0IiwibGVuZ3RoIiwiY2FuVXBkYXRlRE9NTm9kZSIsIm5leHROb2RlIiwicmVtb3ZlQ2hpbGQiLCJ1cGRhdGVET01Ob2RlIiwidG9ET01Ob2RlIiwiY2FyZXROb2RlIiwicmVjb25jaWxlRW1wdHlMaW5lIiwiZm91bmRCUiIsInBhcnROb2RlIiwicmVuZGVyTW9kZWwiLCJlZGl0b3IiLCJtb2RlbCIsImxpbmVzIiwicmVkdWNlIiwicHVzaCIsImxhc3RMaW5lIiwiZm9yRWFjaCIsImkiLCJjaGlsZE5vZGVzIiwiY2hpbGRyZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQk8sU0FBU0Esb0JBQVQsQ0FBOEJDLElBQTlCLEVBQW9DQyxRQUFwQyxF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QUEsY0FBYyxDQUFDbUIsTUFBRCxDQUFkO0FBQ0g7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5leHBvcnQgZnVuY3Rpb24gbmVlZHNDYXJldE5vZGVCZWZvcmUocGFydCwgcHJldlBhcnQpIHtcbiAgICBjb25zdCBpc0ZpcnN0ID0gIXByZXZQYXJ0IHx8IHByZXZQYXJ0LnR5cGUgPT09IFwibmV3bGluZVwiO1xuICAgIHJldHVybiAhcGFydC5jYW5FZGl0ICYmIChpc0ZpcnN0IHx8ICFwcmV2UGFydC5jYW5FZGl0KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5lZWRzQ2FyZXROb2RlQWZ0ZXIocGFydCwgaXNMYXN0T2ZMaW5lKSB7XG4gICAgcmV0dXJuICFwYXJ0LmNhbkVkaXQgJiYgaXNMYXN0T2ZMaW5lO1xufVxuXG5mdW5jdGlvbiBpbnNlcnRBZnRlcihub2RlLCBub2RlVG9JbnNlcnQpIHtcbiAgICBjb25zdCBuZXh0ID0gbm9kZS5uZXh0U2libGluZztcbiAgICBpZiAobmV4dCkge1xuICAgICAgICBub2RlLnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgbmV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZS5wYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKG5vZGVUb0luc2VydCk7XG4gICAgfVxufVxuXG4vLyBVc2UgYSBCT00gbWFya2VyIGZvciBjYXJldCBub2Rlcy5cbi8vIE9uIGEgZmlyc3QgdGVzdCwgdGhleSBzZWVtIHRvIGJlIGZpbHRlcmVkIG91dCB3aGVuIGNvcHlpbmcgdGV4dCBvdXQgb2YgdGhlIGVkaXRvcixcbi8vIGJ1dCB0aGlzIGNvdWxkIGJlIHBsYXRmb3JtIGRlcGVuZGVudC5cbi8vIEFzIGEgcHJlY2F1dGlvbmFyeSBtZWFzdXJlLCBJIGNob3NlIHRoZSBjaGFyYWN0ZXIgdGhhdCBzbGF0ZSBhbHNvIHVzZXMuXG5leHBvcnQgY29uc3QgQ0FSRVRfTk9ERV9DSEFSID0gXCJcXHVmZWZmXCI7XG4vLyBhIGNhcmV0IG5vZGUgaXMgYSBub2RlIHRoYXQgYWxsb3dzIHRoZSBjYXJldCB0byBiZSBwbGFjZWRcbi8vIHdoZXJlIG90aGVyd2lzZSBpdCB3b3VsZG4ndCBiZSBwb3NzaWJsZVxuLy8gKGUuZy4gbmV4dCB0byBhIHBpbGwgc3BhbiB3aXRob3V0IGFkamFjZW50IHRleHQgbm9kZSlcbmZ1bmN0aW9uIGNyZWF0ZUNhcmV0Tm9kZSgpIHtcbiAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG4gICAgc3Bhbi5jbGFzc05hbWUgPSBcImNhcmV0Tm9kZVwiO1xuICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoQ0FSRVRfTk9ERV9DSEFSKSk7XG4gICAgcmV0dXJuIHNwYW47XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUNhcmV0Tm9kZShub2RlKSB7XG4gICAgLy8gZW5zdXJlIHRoZSBjYXJldCBub2RlIGNvbnRhaW5zIG9ubHkgYSB6ZXJvLXdpZHRoIHNwYWNlXG4gICAgaWYgKG5vZGUudGV4dENvbnRlbnQgIT09IENBUkVUX05PREVfQ0hBUikge1xuICAgICAgICBub2RlLnRleHRDb250ZW50ID0gQ0FSRVRfTk9ERV9DSEFSO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ2FyZXROb2RlKG5vZGUpIHtcbiAgICByZXR1cm4gbm9kZSAmJiBub2RlLnRhZ05hbWUgPT09IFwiU1BBTlwiICYmIG5vZGUuY2xhc3NOYW1lID09PSBcImNhcmV0Tm9kZVwiO1xufVxuXG5mdW5jdGlvbiByZW1vdmVOZXh0U2libGluZ3Mobm9kZSkge1xuICAgIGlmICghbm9kZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICAgIGNvbnN0IHJlbW92ZU5vZGUgPSBub2RlO1xuICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgICAgICAgcmVtb3ZlTm9kZS5yZW1vdmUoKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUNoaWxkcmVuKHBhcmVudCkge1xuICAgIGNvbnN0IGZpcnN0Q2hpbGQgPSBwYXJlbnQuZmlyc3RDaGlsZDtcbiAgICBpZiAoZmlyc3RDaGlsZCkge1xuICAgICAgICByZW1vdmVOZXh0U2libGluZ3MoZmlyc3RDaGlsZCk7XG4gICAgICAgIGZpcnN0Q2hpbGQucmVtb3ZlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZWNvbmNpbGVMaW5lKGxpbmVDb250YWluZXIsIHBhcnRzKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlO1xuICAgIGxldCBwcmV2UGFydDtcbiAgICBjb25zdCBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdO1xuXG4gICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRzKSB7XG4gICAgICAgIGNvbnN0IGlzRmlyc3QgPSAhcHJldlBhcnQ7XG4gICAgICAgIGN1cnJlbnROb2RlID0gaXNGaXJzdCA/IGxpbmVDb250YWluZXIuZmlyc3RDaGlsZCA6IGN1cnJlbnROb2RlLm5leHRTaWJsaW5nO1xuXG4gICAgICAgIGlmIChuZWVkc0NhcmV0Tm9kZUJlZm9yZShwYXJ0LCBwcmV2UGFydCkpIHtcbiAgICAgICAgICAgIGlmIChpc0NhcmV0Tm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVDYXJldE5vZGUoY3VycmVudE5vZGUpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxpbmVDb250YWluZXIuaW5zZXJ0QmVmb3JlKGNyZWF0ZUNhcmV0Tm9kZSgpLCBjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gcmVtb3ZlIG5vZGVzIHVudGlsIG1hdGNoaW5nIGN1cnJlbnQgcGFydFxuICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgJiYgIXBhcnQuY2FuVXBkYXRlRE9NTm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICBsaW5lQ29udGFpbmVyLnJlbW92ZUNoaWxkKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIGN1cnJlbnROb2RlID0gbmV4dE5vZGU7XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXBkYXRlIG9yIGluc2VydCBub2RlIGZvciBjdXJyZW50IHBhcnRcbiAgICAgICAgaWYgKGN1cnJlbnROb2RlICYmIHBhcnQpIHtcbiAgICAgICAgICAgIHBhcnQudXBkYXRlRE9NTm9kZShjdXJyZW50Tm9kZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocGFydCkge1xuICAgICAgICAgICAgY3VycmVudE5vZGUgPSBwYXJ0LnRvRE9NTm9kZSgpO1xuICAgICAgICAgICAgLy8gaG9va3MgdXAgbmV4dFNpYmxpbmcgZm9yIG5leHQgaXRlcmF0aW9uXG4gICAgICAgICAgICBsaW5lQ29udGFpbmVyLmFwcGVuZENoaWxkKGN1cnJlbnROb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuZWVkc0NhcmV0Tm9kZUFmdGVyKHBhcnQsIHBhcnQgPT09IGxhc3RQYXJ0KSkge1xuICAgICAgICAgICAgaWYgKGlzQ2FyZXROb2RlKGN1cnJlbnROb2RlLm5leHRTaWJsaW5nKSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICAgICAgdXBkYXRlQ2FyZXROb2RlKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FyZXROb2RlID0gY3JlYXRlQ2FyZXROb2RlKCk7XG4gICAgICAgICAgICAgICAgaW5zZXJ0QWZ0ZXIoY3VycmVudE5vZGUsIGNhcmV0Tm9kZSk7XG4gICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjYXJldE5vZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBwcmV2UGFydCA9IHBhcnQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlTmV4dFNpYmxpbmdzKGN1cnJlbnROb2RlKTtcbn1cblxuZnVuY3Rpb24gcmVjb25jaWxlRW1wdHlMaW5lKGxpbmVDb250YWluZXIpIHtcbiAgICAvLyBlbXB0eSBkaXYgbmVlZHMgdG8gaGF2ZSBhIEJSIGluIGl0IHRvIGdpdmUgaXQgaGVpZ2h0XG4gICAgbGV0IGZvdW5kQlIgPSBmYWxzZTtcbiAgICBsZXQgcGFydE5vZGUgPSBsaW5lQ29udGFpbmVyLmZpcnN0Q2hpbGQ7XG4gICAgd2hpbGUgKHBhcnROb2RlKSB7XG4gICAgICAgIGNvbnN0IG5leHROb2RlID0gcGFydE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgIGlmICghZm91bmRCUiAmJiBwYXJ0Tm9kZS50YWdOYW1lID09PSBcIkJSXCIpIHtcbiAgICAgICAgICAgIGZvdW5kQlIgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFydE5vZGUucmVtb3ZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcGFydE5vZGUgPSBuZXh0Tm9kZTtcbiAgICB9XG4gICAgaWYgKCFmb3VuZEJSKSB7XG4gICAgICAgIGxpbmVDb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJyXCIpKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJNb2RlbChlZGl0b3IsIG1vZGVsKSB7XG4gICAgY29uc3QgbGluZXMgPSBtb2RlbC5wYXJ0cy5yZWR1Y2UoKGxpbmVzLCBwYXJ0KSA9PiB7XG4gICAgICAgIGlmIChwYXJ0LnR5cGUgPT09IFwibmV3bGluZVwiKSB7XG4gICAgICAgICAgICBsaW5lcy5wdXNoKFtdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RMaW5lID0gbGluZXNbbGluZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBsYXN0TGluZS5wdXNoKHBhcnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsaW5lcztcbiAgICB9LCBbW11dKTtcbiAgICBsaW5lcy5mb3JFYWNoKChwYXJ0cywgaSkgPT4ge1xuICAgICAgICAvLyBmaW5kIGZpcnN0IChhbmQgcmVtb3ZlIGFueXRoaW5nIGVsc2UpIGRpdiB3aXRob3V0IGNsYXNzTmFtZVxuICAgICAgICAvLyAoYXMgYnJvd3NlcnMgaW5zZXJ0IHRoZXNlIGluIGNvbnRlbnRlZGl0YWJsZSkgbGluZSBjb250YWluZXJcbiAgICAgICAgbGV0IGxpbmVDb250YWluZXIgPSBlZGl0b3IuY2hpbGROb2Rlc1tpXTtcbiAgICAgICAgd2hpbGUgKGxpbmVDb250YWluZXIgJiYgKGxpbmVDb250YWluZXIudGFnTmFtZSAhPT0gXCJESVZcIiB8fCAhIWxpbmVDb250YWluZXIuY2xhc3NOYW1lKSkge1xuICAgICAgICAgICAgZWRpdG9yLnJlbW92ZUNoaWxkKGxpbmVDb250YWluZXIpO1xuICAgICAgICAgICAgbGluZUNvbnRhaW5lciA9IGVkaXRvci5jaGlsZE5vZGVzW2ldO1xuICAgICAgICB9XG4gICAgICAgIGlmICghbGluZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgbGluZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgICAgICBlZGl0b3IuYXBwZW5kQ2hpbGQobGluZUNvbnRhaW5lcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFydHMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZWNvbmNpbGVMaW5lKGxpbmVDb250YWluZXIsIHBhcnRzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29uY2lsZUVtcHR5TGluZShsaW5lQ29udGFpbmVyKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChsaW5lcy5sZW5ndGgpIHtcbiAgICAgICAgcmVtb3ZlTmV4dFNpYmxpbmdzKGVkaXRvci5jaGlsZHJlbltsaW5lcy5sZW5ndGggLSAxXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmVtb3ZlQ2hpbGRyZW4oZWRpdG9yKTtcbiAgICB9XG59XG4iXX0=