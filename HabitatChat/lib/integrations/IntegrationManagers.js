"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.IntegrationManagers = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var sdk = _interopRequireWildcard(require("../index"));

var _Modal = _interopRequireDefault(require("../Modal"));

var _IntegrationManagerInstance = require("./IntegrationManagerInstance");

var _WidgetUtils = _interopRequireDefault(require("../utils/WidgetUtils"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _matrixJsSdk = require("matrix-js-sdk");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const HS_MANAGERS_REFRESH_INTERVAL = 8 * 60 * 60 * 1000; // 8 hours

const KIND_PREFERENCE = [// Ordered: first is most preferred, last is least preferred.
_IntegrationManagerInstance.KIND_ACCOUNT, _IntegrationManagerInstance.KIND_HOMESERVER, _IntegrationManagerInstance.KIND_CONFIG];

class IntegrationManagers {
  static sharedInstance()
  /*: IntegrationManagers*/
  {
    if (!IntegrationManagers._instance) {
      IntegrationManagers._instance = new IntegrationManagers();
    }

    return IntegrationManagers._instance;
  }

  constructor() {
    (0, _defineProperty2.default)(this, "_managers", []);
    (0, _defineProperty2.default)(this, "_client", void 0);
    (0, _defineProperty2.default)(this, "_wellknownRefreshTimerId", null);
    (0, _defineProperty2.default)(this, "_primaryManager", void 0);
    (0, _defineProperty2.default)(this, "_onAccountData", (ev
    /*: MatrixEvent*/
    ) =>
    /*: void*/
    {
      if (ev.getType() === 'm.widgets') {
        this._compileManagers();
      }
    });

    this._compileManagers();
  }

  startWatching()
  /*: void*/
  {
    this.stopWatching();
    this._client = _MatrixClientPeg.MatrixClientPeg.get();

    this._client.on("accountData", this._onAccountData);

    this._compileManagers();

    setInterval(() => this._setupHomeserverManagers(), HS_MANAGERS_REFRESH_INTERVAL);
  }

  stopWatching()
  /*: void*/
  {
    if (!this._client) return;

    this._client.removeListener("accountData", this._onAccountData);

    if (this._wellknownRefreshTimerId !== null) clearInterval(this._wellknownRefreshTimerId);
  }

  _compileManagers() {
    this._managers = [];

    this._setupConfiguredManager();

    this._setupHomeserverManagers();

    this._setupAccountManagers();
  }

  _setupConfiguredManager() {
    const apiUrl = _SdkConfig.default.get()['integrations_rest_url'];

    const uiUrl = _SdkConfig.default.get()['integrations_ui_url'];

    if (apiUrl && uiUrl) {
      this._managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.KIND_CONFIG, apiUrl, uiUrl));

      this._primaryManager = null; // reset primary
    }
  }

  async _setupHomeserverManagers() {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;

    try {
      console.log("Updating homeserver-configured integration managers...");

      const homeserverDomain = _MatrixClientPeg.MatrixClientPeg.getHomeserverName();

      const discoveryResponse = await _matrixJsSdk.AutoDiscovery.getRawClientConfig(homeserverDomain);

      if (discoveryResponse && discoveryResponse['m.integrations']) {
        let managers = discoveryResponse['m.integrations']['managers'];
        if (!Array.isArray(managers)) managers = []; // make it an array so we can wipe the HS managers

        console.log("Homeserver has ".concat(managers.length, " integration managers")); // Clear out any known managers for the homeserver
        // TODO: Log out of the scalar clients

        this._managers = this._managers.filter(m => m.kind !== _IntegrationManagerInstance.KIND_HOMESERVER); // Now add all the managers the homeserver wants us to have

        for (const hsManager of managers) {
          if (!hsManager["api_url"]) continue;

          this._managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.KIND_HOMESERVER, hsManager["api_url"], hsManager["ui_url"]));
        }

        this._primaryManager = null; // reset primary
      } else {
        console.log("Homeserver has no integration managers");
      }
    } catch (e) {
      console.error(e); // Errors during discovery are non-fatal
    }
  }

  _setupAccountManagers() {
    if (!this._client || !this._client.getUserId()) return; // not logged in

    const widgets = _WidgetUtils.default.getIntegrationManagerWidgets();

    widgets.forEach(w => {
      const data = w.content['data'];
      if (!data) return;
      const uiUrl = w.content['url'];
      const apiUrl = data['api_url'];
      if (!apiUrl || !uiUrl) return;
      const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.KIND_ACCOUNT, apiUrl, uiUrl);
      manager.id = w['id'] || w['state_key'] || '';

      this._managers.push(manager);
    });
    this._primaryManager = null; // reset primary
  }

  hasManager()
  /*: boolean*/
  {
    return this._managers.length > 0;
  }

  getOrderedManagers()
  /*: IntegrationManagerInstance[]*/
  {
    const ordered = [];

    for (const kind of KIND_PREFERENCE) {
      const managers = this._managers.filter(m => m.kind === kind);

      if (!managers || !managers.length) continue;

      if (kind === _IntegrationManagerInstance.KIND_ACCOUNT) {
        // Order by state_keys (IDs)
        managers.sort((a, b) => a.id.localeCompare(b.id));
      }

      ordered.push(...managers);
    }

    return ordered;
  }

  getPrimaryManager()
  /*: IntegrationManagerInstance*/
  {
    if (this.hasManager()) {
      if (this._primaryManager) return this._primaryManager;
      this._primaryManager = this.getOrderedManagers()[0];
      return this._primaryManager;
    } else {
      return null;
    }
  }

  openNoManagerDialog()
  /*: void*/
  {
    const IntegrationsImpossibleDialog = sdk.getComponent("dialogs.IntegrationsImpossibleDialog");

    _Modal.default.createTrackedDialog('Integrations impossible', '', IntegrationsImpossibleDialog);
  }

  openAll(room
  /*: Room*/
  = null, screen
  /*: string*/
  = null, integrationId
  /*: string*/
  = null)
  /*: void*/
  {
    if (!_SettingsStore.default.getValue("integrationProvisioning")) {
      return this.showDisabledDialog();
    }

    if (this._managers.length === 0) {
      return this.openNoManagerDialog();
    }

    const TabbedIntegrationManagerDialog = sdk.getComponent("views.dialogs.TabbedIntegrationManagerDialog");

    _Modal.default.createTrackedDialog('Tabbed Integration Manager', '', TabbedIntegrationManagerDialog, {
      room,
      screen,
      integrationId
    }, 'mx_TabbedIntegrationManagerDialog');
  }

  showDisabledDialog()
  /*: void*/
  {
    const IntegrationsDisabledDialog = sdk.getComponent("dialogs.IntegrationsDisabledDialog");

    _Modal.default.createTrackedDialog('Integrations disabled', '', IntegrationsDisabledDialog);
  }

  async overwriteManagerOnAccount(manager
  /*: IntegrationManagerInstance*/
  ) {
    // TODO: TravisR - We should be logging out of scalar clients.
    await _WidgetUtils.default.removeIntegrationManagerWidgets(); // TODO: TravisR - We should actually be carrying over the discovery response verbatim.

    await _WidgetUtils.default.addIntegrationManagerWidget(manager.name, manager.uiUrl, manager.apiUrl);
  }
  /**
   * Attempts to discover an integration manager using only its name. This will not validate that
   * the integration manager is functional - that is the caller's responsibility.
   * @param {string} domainName The domain name to look up.
   * @returns {Promise<IntegrationManagerInstance>} Resolves to an integration manager instance,
   * or null if none was found.
   */


  async tryDiscoverManager(domainName
  /*: string*/
  )
  /*: IntegrationManagerInstance*/
  {
    console.log("Looking up integration manager via .well-known");

    if (domainName.startsWith("http:") || domainName.startsWith("https:")) {
      // trim off the scheme and just use the domain
      const url = url.parse(domainName);
      domainName = url.host;
    }

    let wkConfig;

    try {
      const result = await fetch("https://".concat(domainName, "/.well-known/matrix/integrations"));
      wkConfig = await result.json();
    } catch (e) {
      console.error(e);
      console.warn("Failed to locate integration manager");
      return null;
    }

    if (!wkConfig || !wkConfig["m.integrations_widget"]) {
      console.warn("Missing integrations widget on .well-known response");
      return null;
    }

    const widget = wkConfig["m.integrations_widget"];

    if (!widget["url"] || !widget["data"] || !widget["data"]["api_url"]) {
      console.warn("Malformed .well-known response for integrations widget");
      return null;
    } // All discovered managers are per-user managers


    const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.KIND_ACCOUNT, widget["data"]["api_url"], widget["url"]);
    console.log("Got an integration manager (untested)"); // We don't test the manager because the caller may need to do extra
    // checks or similar with it. For instance, they may need to deal with
    // terms of service or want to call something particular.

    return manager;
  }

} // For debugging


exports.IntegrationManagers = IntegrationManagers;
(0, _defineProperty2.default)(IntegrationManagers, "_instance", void 0);
global.mxIntegrationManagers = IntegrationManagers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2Vycy5qcyJdLCJuYW1lcyI6WyJIU19NQU5BR0VSU19SRUZSRVNIX0lOVEVSVkFMIiwiS0lORF9QUkVGRVJFTkNFIiwiS0lORF9BQ0NPVU5UIiwiS0lORF9IT01FU0VSVkVSIiwiS0lORF9DT05GSUciLCJJbnRlZ3JhdGlvbk1hbmFnZXJzIiwic2hhcmVkSW5zdGFuY2UiLCJfaW5zdGFuY2UiLCJjb25zdHJ1Y3RvciIsImV2IiwiZ2V0VHlwZSIsIl9jb21waWxlTWFuYWdlcnMiLCJzdGFydFdhdGNoaW5nIiwic3RvcFdhdGNoaW5nIiwiX2NsaWVudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsIm9uIiwiX29uQWNjb3VudERhdGEiLCJzZXRJbnRlcnZhbCIsIl9zZXR1cEhvbWVzZXJ2ZXJNYW5hZ2VycyIsInJlbW92ZUxpc3RlbmVyIiwiX3dlbGxrbm93blJlZnJlc2hUaW1lcklkIiwiY2xlYXJJbnRlcnZhbCIsIl9tYW5hZ2VycyIsIl9zZXR1cENvbmZpZ3VyZWRNYW5hZ2VyIiwiX3NldHVwQWNjb3VudE1hbmFnZXJzIiwiYXBpVXJsIiwiU2RrQ29uZmlnIiwidWlVcmwiLCJwdXNoIiwiSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UiLCJfcHJpbWFyeU1hbmFnZXIiLCJjb25zb2xlIiwibG9nIiwiaG9tZXNlcnZlckRvbWFpbiIsImdldEhvbWVzZXJ2ZXJOYW1lIiwiZGlzY292ZXJ5UmVzcG9uc2UiLCJBdXRvRGlzY292ZXJ5IiwiZ2V0UmF3Q2xpZW50Q29uZmlnIiwibWFuYWdlcnMiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJmaWx0ZXIiLCJtIiwia2luZCIsImhzTWFuYWdlciIsImUiLCJlcnJvciIsImdldFVzZXJJZCIsIndpZGdldHMiLCJXaWRnZXRVdGlscyIsImdldEludGVncmF0aW9uTWFuYWdlcldpZGdldHMiLCJmb3JFYWNoIiwidyIsImRhdGEiLCJjb250ZW50IiwibWFuYWdlciIsImlkIiwiaGFzTWFuYWdlciIsImdldE9yZGVyZWRNYW5hZ2VycyIsIm9yZGVyZWQiLCJzb3J0IiwiYSIsImIiLCJsb2NhbGVDb21wYXJlIiwiZ2V0UHJpbWFyeU1hbmFnZXIiLCJvcGVuTm9NYW5hZ2VyRGlhbG9nIiwiSW50ZWdyYXRpb25zSW1wb3NzaWJsZURpYWxvZyIsInNkayIsImdldENvbXBvbmVudCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsIm9wZW5BbGwiLCJyb29tIiwic2NyZWVuIiwiaW50ZWdyYXRpb25JZCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInNob3dEaXNhYmxlZERpYWxvZyIsIlRhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZyIsIkludGVncmF0aW9uc0Rpc2FibGVkRGlhbG9nIiwib3ZlcndyaXRlTWFuYWdlck9uQWNjb3VudCIsInJlbW92ZUludGVncmF0aW9uTWFuYWdlcldpZGdldHMiLCJhZGRJbnRlZ3JhdGlvbk1hbmFnZXJXaWRnZXQiLCJuYW1lIiwidHJ5RGlzY292ZXJNYW5hZ2VyIiwiZG9tYWluTmFtZSIsInN0YXJ0c1dpdGgiLCJ1cmwiLCJwYXJzZSIsImhvc3QiLCJ3a0NvbmZpZyIsInJlc3VsdCIsImZldGNoIiwianNvbiIsIndhcm4iLCJ3aWRnZXQiLCJnbG9iYWwiLCJteEludGVncmF0aW9uTWFuYWdlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBeEJBOzs7Ozs7Ozs7Ozs7Ozs7QUEwQkEsTUFBTUEsNEJBQTRCLEdBQUcsSUFBSSxFQUFKLEdBQVMsRUFBVCxHQUFjLElBQW5ELEMsQ0FBeUQ7O0FBQ3pELE1BQU1DLGVBQWUsR0FBRyxDQUNwQjtBQUNBQyx3Q0FGb0IsRUFHcEJDLDJDQUhvQixFQUlwQkMsdUNBSm9CLENBQXhCOztBQU9PLE1BQU1DLG1CQUFOLENBQTBCO0FBRzdCLFNBQU9DLGNBQVA7QUFBQTtB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QU8sSUFBUDtBQUNIOztBQUVELFVBQU1DLE1BQU0sR0FBR0wsUUFBUSxDQUFDLHVCQUFELENBQXZCOztBQUNBLFFBQUksQ0FBQ0ssTUFBTSxDQUFDLEtBQUQsQ0FBUCxJQUFrQixDQUFDQSxNQUFNLENBQUMsTUFBRCxDQUF6QixJQUFxQyxDQUFDQSxNQUFNLENBQUMsTUFBRCxDQUFOLENBQWUsU0FBZixDQUExQyxFQUFxRTtBQUNqRWpFLE1BQUFBLE9BQU8sQ0FBQ2dFLElBQVIsQ0FBYSx3REFBYjtBQUNBLGFBQU8sSUFBUDtBQUNILEtBM0JvRSxDQTZCckU7OztBQUNBLFVBQU12QyxPQUFPLEdBQUcsSUFBSTNCLHNEQUFKLENBQStCN0Isd0NBQS9CLEVBQTZDZ0csTUFBTSxDQUFDLE1BQUQsQ0FBTixDQUFlLFNBQWYsQ0FBN0MsRUFBd0VBLE1BQU0sQ0FBQyxLQUFELENBQTlFLENBQWhCO0FBQ0FqRSxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSx1Q0FBWixFQS9CcUUsQ0FpQ3JFO0FBQ0E7QUFDQTs7QUFFQSxXQUFPd0IsT0FBUDtBQUNIOztBQTVONEIsQyxDQStOakM7Ozs7OEJBL05hckQsbUI7QUFnT2I4RixNQUFNLENBQUNDLHFCQUFQLEdBQStCL0YsbUJBQS9CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFNka0NvbmZpZyBmcm9tICcuLi9TZGtDb25maWcnO1xuaW1wb3J0ICogYXMgc2RrIGZyb20gXCIuLi9pbmRleFwiO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uL01vZGFsJztcbmltcG9ydCB7SW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UsIEtJTkRfQUNDT1VOVCwgS0lORF9DT05GSUcsIEtJTkRfSE9NRVNFUlZFUn0gZnJvbSBcIi4vSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VcIjtcbmltcG9ydCB0eXBlIHtNYXRyaXhDbGllbnQsIE1hdHJpeEV2ZW50LCBSb29tfSBmcm9tIFwibWF0cml4LWpzLXNka1wiO1xuaW1wb3J0IFdpZGdldFV0aWxzIGZyb20gXCIuLi91dGlscy9XaWRnZXRVdGlsc1wiO1xuaW1wb3J0IHtNYXRyaXhDbGllbnRQZWd9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7QXV0b0Rpc2NvdmVyeX0gZnJvbSBcIm1hdHJpeC1qcy1zZGtcIjtcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5cbmNvbnN0IEhTX01BTkFHRVJTX1JFRlJFU0hfSU5URVJWQUwgPSA4ICogNjAgKiA2MCAqIDEwMDA7IC8vIDggaG91cnNcbmNvbnN0IEtJTkRfUFJFRkVSRU5DRSA9IFtcbiAgICAvLyBPcmRlcmVkOiBmaXJzdCBpcyBtb3N0IHByZWZlcnJlZCwgbGFzdCBpcyBsZWFzdCBwcmVmZXJyZWQuXG4gICAgS0lORF9BQ0NPVU5ULFxuICAgIEtJTkRfSE9NRVNFUlZFUixcbiAgICBLSU5EX0NPTkZJRyxcbl07XG5cbmV4cG9ydCBjbGFzcyBJbnRlZ3JhdGlvbk1hbmFnZXJzIHtcbiAgICBzdGF0aWMgX2luc3RhbmNlO1xuXG4gICAgc3RhdGljIHNoYXJlZEluc3RhbmNlKCk6IEludGVncmF0aW9uTWFuYWdlcnMge1xuICAgICAgICBpZiAoIUludGVncmF0aW9uTWFuYWdlcnMuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICBJbnRlZ3JhdGlvbk1hbmFnZXJzLl9pbnN0YW5jZSA9IG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJzKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEludGVncmF0aW9uTWFuYWdlcnMuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIF9tYW5hZ2VyczogSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VbXSA9IFtdO1xuICAgIF9jbGllbnQ6IE1hdHJpeENsaWVudDtcbiAgICBfd2VsbGtub3duUmVmcmVzaFRpbWVySWQ6IG51bWJlciA9IG51bGw7XG4gICAgX3ByaW1hcnlNYW5hZ2VyOiBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLl9jb21waWxlTWFuYWdlcnMoKTtcbiAgICB9XG5cbiAgICBzdGFydFdhdGNoaW5nKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0b3BXYXRjaGluZygpO1xuICAgICAgICB0aGlzLl9jbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHRoaXMuX2NsaWVudC5vbihcImFjY291bnREYXRhXCIsIHRoaXMuX29uQWNjb3VudERhdGEpO1xuICAgICAgICB0aGlzLl9jb21waWxlTWFuYWdlcnMoKTtcbiAgICAgICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fc2V0dXBIb21lc2VydmVyTWFuYWdlcnMoKSwgSFNfTUFOQUdFUlNfUkVGUkVTSF9JTlRFUlZBTCk7XG4gICAgfVxuXG4gICAgc3RvcFdhdGNoaW5nKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuX2NsaWVudCkgcmV0dXJuO1xuICAgICAgICB0aGlzLl9jbGllbnQucmVtb3ZlTGlzdGVuZXIoXCJhY2NvdW50RGF0YVwiLCB0aGlzLl9vbkFjY291bnREYXRhKTtcbiAgICAgICAgaWYgKHRoaXMuX3dlbGxrbm93blJlZnJlc2hUaW1lcklkICE9PSBudWxsKSBjbGVhckludGVydmFsKHRoaXMuX3dlbGxrbm93blJlZnJlc2hUaW1lcklkKTtcbiAgICB9XG5cbiAgICBfY29tcGlsZU1hbmFnZXJzKCkge1xuICAgICAgICB0aGlzLl9tYW5hZ2VycyA9IFtdO1xuICAgICAgICB0aGlzLl9zZXR1cENvbmZpZ3VyZWRNYW5hZ2VyKCk7XG4gICAgICAgIHRoaXMuX3NldHVwSG9tZXNlcnZlck1hbmFnZXJzKCk7XG4gICAgICAgIHRoaXMuX3NldHVwQWNjb3VudE1hbmFnZXJzKCk7XG4gICAgfVxuXG4gICAgX3NldHVwQ29uZmlndXJlZE1hbmFnZXIoKSB7XG4gICAgICAgIGNvbnN0IGFwaVVybCA9IFNka0NvbmZpZy5nZXQoKVsnaW50ZWdyYXRpb25zX3Jlc3RfdXJsJ107XG4gICAgICAgIGNvbnN0IHVpVXJsID0gU2RrQ29uZmlnLmdldCgpWydpbnRlZ3JhdGlvbnNfdWlfdXJsJ107XG5cbiAgICAgICAgaWYgKGFwaVVybCAmJiB1aVVybCkge1xuICAgICAgICAgICAgdGhpcy5fbWFuYWdlcnMucHVzaChuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoS0lORF9DT05GSUcsIGFwaVVybCwgdWlVcmwpKTtcbiAgICAgICAgICAgIHRoaXMuX3ByaW1hcnlNYW5hZ2VyID0gbnVsbDsgLy8gcmVzZXQgcHJpbWFyeVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX3NldHVwSG9tZXNlcnZlck1hbmFnZXJzKCkge1xuICAgICAgICBpZiAoIU1hdHJpeENsaWVudFBlZy5nZXQoKSkgcmV0dXJuO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJVcGRhdGluZyBob21lc2VydmVyLWNvbmZpZ3VyZWQgaW50ZWdyYXRpb24gbWFuYWdlcnMuLi5cIik7XG4gICAgICAgICAgICBjb25zdCBob21lc2VydmVyRG9tYWluID0gTWF0cml4Q2xpZW50UGVnLmdldEhvbWVzZXJ2ZXJOYW1lKCk7XG4gICAgICAgICAgICBjb25zdCBkaXNjb3ZlcnlSZXNwb25zZSA9IGF3YWl0IEF1dG9EaXNjb3ZlcnkuZ2V0UmF3Q2xpZW50Q29uZmlnKGhvbWVzZXJ2ZXJEb21haW4pO1xuICAgICAgICAgICAgaWYgKGRpc2NvdmVyeVJlc3BvbnNlICYmIGRpc2NvdmVyeVJlc3BvbnNlWydtLmludGVncmF0aW9ucyddKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1hbmFnZXJzID0gZGlzY292ZXJ5UmVzcG9uc2VbJ20uaW50ZWdyYXRpb25zJ11bJ21hbmFnZXJzJ107XG4gICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1hbmFnZXJzKSkgbWFuYWdlcnMgPSBbXTsgLy8gbWFrZSBpdCBhbiBhcnJheSBzbyB3ZSBjYW4gd2lwZSB0aGUgSFMgbWFuYWdlcnNcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBIb21lc2VydmVyIGhhcyAke21hbmFnZXJzLmxlbmd0aH0gaW50ZWdyYXRpb24gbWFuYWdlcnNgKTtcblxuICAgICAgICAgICAgICAgIC8vIENsZWFyIG91dCBhbnkga25vd24gbWFuYWdlcnMgZm9yIHRoZSBob21lc2VydmVyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogTG9nIG91dCBvZiB0aGUgc2NhbGFyIGNsaWVudHNcbiAgICAgICAgICAgICAgICB0aGlzLl9tYW5hZ2VycyA9IHRoaXMuX21hbmFnZXJzLmZpbHRlcihtID0+IG0ua2luZCAhPT0gS0lORF9IT01FU0VSVkVSKTtcblxuICAgICAgICAgICAgICAgIC8vIE5vdyBhZGQgYWxsIHRoZSBtYW5hZ2VycyB0aGUgaG9tZXNlcnZlciB3YW50cyB1cyB0byBoYXZlXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBoc01hbmFnZXIgb2YgbWFuYWdlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFoc01hbmFnZXJbXCJhcGlfdXJsXCJdKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFuYWdlcnMucHVzaChuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoXG4gICAgICAgICAgICAgICAgICAgICAgICBLSU5EX0hPTUVTRVJWRVIsXG4gICAgICAgICAgICAgICAgICAgICAgICBoc01hbmFnZXJbXCJhcGlfdXJsXCJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgaHNNYW5hZ2VyW1widWlfdXJsXCJdLCAvLyBvcHRpb25hbFxuICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9wcmltYXJ5TWFuYWdlciA9IG51bGw7IC8vIHJlc2V0IHByaW1hcnlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJIb21lc2VydmVyIGhhcyBubyBpbnRlZ3JhdGlvbiBtYW5hZ2Vyc1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIC8vIEVycm9ycyBkdXJpbmcgZGlzY292ZXJ5IGFyZSBub24tZmF0YWxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9zZXR1cEFjY291bnRNYW5hZ2VycygpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9jbGllbnQgfHwgIXRoaXMuX2NsaWVudC5nZXRVc2VySWQoKSkgcmV0dXJuOyAvLyBub3QgbG9nZ2VkIGluXG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSBXaWRnZXRVdGlscy5nZXRJbnRlZ3JhdGlvbk1hbmFnZXJXaWRnZXRzKCk7XG4gICAgICAgIHdpZGdldHMuZm9yRWFjaCh3ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB3LmNvbnRlbnRbJ2RhdGEnXTtcbiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuO1xuXG4gICAgICAgICAgICBjb25zdCB1aVVybCA9IHcuY29udGVudFsndXJsJ107XG4gICAgICAgICAgICBjb25zdCBhcGlVcmwgPSBkYXRhWydhcGlfdXJsJ107XG4gICAgICAgICAgICBpZiAoIWFwaVVybCB8fCAhdWlVcmwpIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgbWFuYWdlciA9IG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZShLSU5EX0FDQ09VTlQsIGFwaVVybCwgdWlVcmwpO1xuICAgICAgICAgICAgbWFuYWdlci5pZCA9IHdbJ2lkJ10gfHwgd1snc3RhdGVfa2V5J10gfHwgJyc7XG4gICAgICAgICAgICB0aGlzLl9tYW5hZ2Vycy5wdXNoKG1hbmFnZXIpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fcHJpbWFyeU1hbmFnZXIgPSBudWxsOyAvLyByZXNldCBwcmltYXJ5XG4gICAgfVxuXG4gICAgX29uQWNjb3VudERhdGEgPSAoZXY6IE1hdHJpeEV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGlmIChldi5nZXRUeXBlKCkgPT09ICdtLndpZGdldHMnKSB7XG4gICAgICAgICAgICB0aGlzLl9jb21waWxlTWFuYWdlcnMoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBoYXNNYW5hZ2VyKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWFuYWdlcnMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBnZXRPcmRlcmVkTWFuYWdlcnMoKTogSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VbXSB7XG4gICAgICAgIGNvbnN0IG9yZGVyZWQgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBraW5kIG9mIEtJTkRfUFJFRkVSRU5DRSkge1xuICAgICAgICAgICAgY29uc3QgbWFuYWdlcnMgPSB0aGlzLl9tYW5hZ2Vycy5maWx0ZXIobSA9PiBtLmtpbmQgPT09IGtpbmQpO1xuICAgICAgICAgICAgaWYgKCFtYW5hZ2VycyB8fCAhbWFuYWdlcnMubGVuZ3RoKSBjb250aW51ZTtcblxuICAgICAgICAgICAgaWYgKGtpbmQgPT09IEtJTkRfQUNDT1VOVCkge1xuICAgICAgICAgICAgICAgIC8vIE9yZGVyIGJ5IHN0YXRlX2tleXMgKElEcylcbiAgICAgICAgICAgICAgICBtYW5hZ2Vycy5zb3J0KChhLCBiKSA9PiBhLmlkLmxvY2FsZUNvbXBhcmUoYi5pZCkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvcmRlcmVkLnB1c2goLi4ubWFuYWdlcnMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcmRlcmVkO1xuICAgIH1cblxuICAgIGdldFByaW1hcnlNYW5hZ2VyKCk6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzTWFuYWdlcigpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcHJpbWFyeU1hbmFnZXIpIHJldHVybiB0aGlzLl9wcmltYXJ5TWFuYWdlcjtcblxuICAgICAgICAgICAgdGhpcy5fcHJpbWFyeU1hbmFnZXIgPSB0aGlzLmdldE9yZGVyZWRNYW5hZ2VycygpWzBdO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ByaW1hcnlNYW5hZ2VyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvcGVuTm9NYW5hZ2VyRGlhbG9nKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBJbnRlZ3JhdGlvbnNJbXBvc3NpYmxlRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuSW50ZWdyYXRpb25zSW1wb3NzaWJsZURpYWxvZ1wiKTtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZygnSW50ZWdyYXRpb25zIGltcG9zc2libGUnLCAnJywgSW50ZWdyYXRpb25zSW1wb3NzaWJsZURpYWxvZyk7XG4gICAgfVxuXG4gICAgb3BlbkFsbChyb29tOiBSb29tID0gbnVsbCwgc2NyZWVuOiBzdHJpbmcgPSBudWxsLCBpbnRlZ3JhdGlvbklkOiBzdHJpbmcgPSBudWxsKTogdm9pZCB7XG4gICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImludGVncmF0aW9uUHJvdmlzaW9uaW5nXCIpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zaG93RGlzYWJsZWREaWFsb2coKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9tYW5hZ2Vycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5Ob01hbmFnZXJEaWFsb2coKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IFRhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLlRhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZ1wiKTtcbiAgICAgICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcbiAgICAgICAgICAgICdUYWJiZWQgSW50ZWdyYXRpb24gTWFuYWdlcicsICcnLCBUYWJiZWRJbnRlZ3JhdGlvbk1hbmFnZXJEaWFsb2csXG4gICAgICAgICAgICB7cm9vbSwgc2NyZWVuLCBpbnRlZ3JhdGlvbklkfSwgJ214X1RhYmJlZEludGVncmF0aW9uTWFuYWdlckRpYWxvZycsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgc2hvd0Rpc2FibGVkRGlhbG9nKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBJbnRlZ3JhdGlvbnNEaXNhYmxlZERpYWxvZyA9IHNkay5nZXRDb21wb25lbnQoXCJkaWFsb2dzLkludGVncmF0aW9uc0Rpc2FibGVkRGlhbG9nXCIpO1xuICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKCdJbnRlZ3JhdGlvbnMgZGlzYWJsZWQnLCAnJywgSW50ZWdyYXRpb25zRGlzYWJsZWREaWFsb2cpO1xuICAgIH1cblxuICAgIGFzeW5jIG92ZXJ3cml0ZU1hbmFnZXJPbkFjY291bnQobWFuYWdlcjogSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UpIHtcbiAgICAgICAgLy8gVE9ETzogVHJhdmlzUiAtIFdlIHNob3VsZCBiZSBsb2dnaW5nIG91dCBvZiBzY2FsYXIgY2xpZW50cy5cbiAgICAgICAgYXdhaXQgV2lkZ2V0VXRpbHMucmVtb3ZlSW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0cygpO1xuXG4gICAgICAgIC8vIFRPRE86IFRyYXZpc1IgLSBXZSBzaG91bGQgYWN0dWFsbHkgYmUgY2Fycnlpbmcgb3ZlciB0aGUgZGlzY292ZXJ5IHJlc3BvbnNlIHZlcmJhdGltLlxuICAgICAgICBhd2FpdCBXaWRnZXRVdGlscy5hZGRJbnRlZ3JhdGlvbk1hbmFnZXJXaWRnZXQobWFuYWdlci5uYW1lLCBtYW5hZ2VyLnVpVXJsLCBtYW5hZ2VyLmFwaVVybCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXR0ZW1wdHMgdG8gZGlzY292ZXIgYW4gaW50ZWdyYXRpb24gbWFuYWdlciB1c2luZyBvbmx5IGl0cyBuYW1lLiBUaGlzIHdpbGwgbm90IHZhbGlkYXRlIHRoYXRcbiAgICAgKiB0aGUgaW50ZWdyYXRpb24gbWFuYWdlciBpcyBmdW5jdGlvbmFsIC0gdGhhdCBpcyB0aGUgY2FsbGVyJ3MgcmVzcG9uc2liaWxpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGRvbWFpbk5hbWUgVGhlIGRvbWFpbiBuYW1lIHRvIGxvb2sgdXAuXG4gICAgICogQHJldHVybnMge1Byb21pc2U8SW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2U+fSBSZXNvbHZlcyB0byBhbiBpbnRlZ3JhdGlvbiBtYW5hZ2VyIGluc3RhbmNlLFxuICAgICAqIG9yIG51bGwgaWYgbm9uZSB3YXMgZm91bmQuXG4gICAgICovXG4gICAgYXN5bmMgdHJ5RGlzY292ZXJNYW5hZ2VyKGRvbWFpbk5hbWU6IHN0cmluZyk6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJMb29raW5nIHVwIGludGVncmF0aW9uIG1hbmFnZXIgdmlhIC53ZWxsLWtub3duXCIpO1xuICAgICAgICBpZiAoZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cDpcIikgfHwgZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cHM6XCIpKSB7XG4gICAgICAgICAgICAvLyB0cmltIG9mZiB0aGUgc2NoZW1lIGFuZCBqdXN0IHVzZSB0aGUgZG9tYWluXG4gICAgICAgICAgICBjb25zdCB1cmwgPSB1cmwucGFyc2UoZG9tYWluTmFtZSk7XG4gICAgICAgICAgICBkb21haW5OYW1lID0gdXJsLmhvc3Q7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd2tDb25maWc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly8ke2RvbWFpbk5hbWV9Ly53ZWxsLWtub3duL21hdHJpeC9pbnRlZ3JhdGlvbnNgKTtcbiAgICAgICAgICAgIHdrQ29uZmlnID0gYXdhaXQgcmVzdWx0Lmpzb24oKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBsb2NhdGUgaW50ZWdyYXRpb24gbWFuYWdlclwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF3a0NvbmZpZyB8fCAhd2tDb25maWdbXCJtLmludGVncmF0aW9uc193aWRnZXRcIl0pIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIk1pc3NpbmcgaW50ZWdyYXRpb25zIHdpZGdldCBvbiAud2VsbC1rbm93biByZXNwb25zZVwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgd2lkZ2V0ID0gd2tDb25maWdbXCJtLmludGVncmF0aW9uc193aWRnZXRcIl07XG4gICAgICAgIGlmICghd2lkZ2V0W1widXJsXCJdIHx8ICF3aWRnZXRbXCJkYXRhXCJdIHx8ICF3aWRnZXRbXCJkYXRhXCJdW1wiYXBpX3VybFwiXSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiTWFsZm9ybWVkIC53ZWxsLWtub3duIHJlc3BvbnNlIGZvciBpbnRlZ3JhdGlvbnMgd2lkZ2V0XCIpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBbGwgZGlzY292ZXJlZCBtYW5hZ2VycyBhcmUgcGVyLXVzZXIgbWFuYWdlcnNcbiAgICAgICAgY29uc3QgbWFuYWdlciA9IG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZShLSU5EX0FDQ09VTlQsIHdpZGdldFtcImRhdGFcIl1bXCJhcGlfdXJsXCJdLCB3aWRnZXRbXCJ1cmxcIl0pO1xuICAgICAgICBjb25zb2xlLmxvZyhcIkdvdCBhbiBpbnRlZ3JhdGlvbiBtYW5hZ2VyICh1bnRlc3RlZClcIik7XG5cbiAgICAgICAgLy8gV2UgZG9uJ3QgdGVzdCB0aGUgbWFuYWdlciBiZWNhdXNlIHRoZSBjYWxsZXIgbWF5IG5lZWQgdG8gZG8gZXh0cmFcbiAgICAgICAgLy8gY2hlY2tzIG9yIHNpbWlsYXIgd2l0aCBpdC4gRm9yIGluc3RhbmNlLCB0aGV5IG1heSBuZWVkIHRvIGRlYWwgd2l0aFxuICAgICAgICAvLyB0ZXJtcyBvZiBzZXJ2aWNlIG9yIHdhbnQgdG8gY2FsbCBzb21ldGhpbmcgcGFydGljdWxhci5cblxuICAgICAgICByZXR1cm4gbWFuYWdlcjtcbiAgICB9XG59XG5cbi8vIEZvciBkZWJ1Z2dpbmdcbmdsb2JhbC5teEludGVncmF0aW9uTWFuYWdlcnMgPSBJbnRlZ3JhdGlvbk1hbmFnZXJzO1xuIl19