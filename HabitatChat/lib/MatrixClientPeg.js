"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.MatrixClientPeg = void 0;

var _matrixJsSdk = require("matrix-js-sdk");

var utils = _interopRequireWildcard(require("matrix-js-sdk/src/utils"));

var _eventTimeline = require("matrix-js-sdk/src/models/event-timeline");

var _eventTimelineSet = require("matrix-js-sdk/src/models/event-timeline-set");

var sdk = _interopRequireWildcard(require("./index"));

var _createMatrixClient = _interopRequireDefault(require("./utils/createMatrixClient"));

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _MatrixActionCreators = _interopRequireDefault(require("./actions/MatrixActionCreators"));

var _Modal = _interopRequireDefault(require("./Modal"));

var _crypto = require("matrix-js-sdk/src/crypto");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./settings/handlers/MatrixClientBackedSettingsHandler"));

var StorageManager = _interopRequireWildcard(require("./utils/StorageManager"));

var _IdentityAuthClient = _interopRequireDefault(require("./IdentityAuthClient"));

var _CrossSigningManager = require("./CrossSigningManager");

var _QRCode = require("matrix-js-sdk/src/crypto/verification/QRCode");

/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2017 Vector Creations Ltd.
Copyright 2017, 2018, 2019 New Vector Ltd
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Wrapper object for handling the js-sdk Matrix Client object in the react-sdk
 * Handles the creation/initialisation of client objects.
 * This module provides a singleton instance of this class so the 'current'
 * Matrix Client object is available easily.
 */
class _MatrixClientPeg {
  constructor() {
    this.matrixClient = null;
    this._justRegisteredUserId = null; // These are the default options used when when the
    // client is started in 'start'. These can be altered
    // at any time up to after the 'will_start_client'
    // event is finished processing.

    this.opts = {
      initialSyncLimit: 20
    }; // the credentials used to init the current client object.
    // used if we tear it down & recreate it with a different store

    this._currentClientCreds = null;
  }
  /**
   * Sets the script href passed to the IndexedDB web worker
   * If set, a separate web worker will be started to run the IndexedDB
   * queries on.
   *
   * @param {string} script href to the script to be passed to the web worker
   */


  setIndexedDbWorkerScript(script) {
    _createMatrixClient.default.indexedDbWorkerScript = script;
  }

  get()
  /*: MatrixClient*/
  {
    return this.matrixClient;
  }

  unset() {
    this.matrixClient = null;

    _MatrixActionCreators.default.stop();
  }
  /**
   * If we've registered a user ID we set this to the ID of the
   * user we've just registered. If they then go & log in, we
   * can send them to the welcome user (obviously this doesn't
   * guarentee they'll get a chat with the welcome user).
   *
   * @param {string} uid The user ID of the user we've just registered
   */


  setJustRegisteredUserId(uid) {
    this._justRegisteredUserId = uid;
  }
  /**
   * Returns true if the current user has just been registered by this
   * client as determined by setJustRegisteredUserId()
   *
   * @returns {bool} True if user has just been registered
   */


  currentUserIsJustRegistered() {
    return this.matrixClient && this.matrixClient.credentials.userId === this._justRegisteredUserId;
  }
  /*
   * Replace this MatrixClientPeg's client with a client instance that has
   * homeserver / identity server URLs and active credentials
   */


  replaceUsingCreds(creds
  /*: MatrixClientCreds*/
  ) {
    this._currentClientCreds = creds;

    this._createClient(creds);
  }

  async assign() {
    for (const dbType of ['indexeddb', 'memory']) {
      try {
        const promise = this.matrixClient.store.startup();
        console.log("MatrixClientPeg: waiting for MatrixClient store to initialise");
        await promise;
        break;
      } catch (err) {
        if (dbType === 'indexeddb') {
          console.error('Error starting matrixclient store - falling back to memory store', err);
          this.matrixClient.store = new _matrixJsSdk.MemoryStore({
            localStorage: global.localStorage
          });
        } else {
          console.error('Failed to start memory store!', err);
          throw err;
        }
      }
    }

    StorageManager.trackStores(this.matrixClient); // try to initialise e2e on the new client

    try {
      // check that we have a version of the js-sdk which includes initCrypto
      if (!_SettingsStore.default.getValue("lowBandwidth") && this.matrixClient.initCrypto) {
        await this.matrixClient.initCrypto();
        this.matrixClient.setCryptoTrustCrossSignedDevices(!_SettingsStore.default.getValue('e2ee.manuallyVerifyAllSessions'));
        StorageManager.setCryptoInitialised(true);
      }
    } catch (e) {
      if (e && e.name === 'InvalidCryptoStoreError') {
        // The js-sdk found a crypto DB too new for it to use
        const CryptoStoreTooNewDialog = sdk.getComponent("views.dialogs.CryptoStoreTooNewDialog");

        _Modal.default.createDialog(CryptoStoreTooNewDialog, {
          host: window.location.host
        });
      } // this can happen for a number of reasons, the most likely being
      // that the olm library was missing. It's not fatal.


      console.warn("Unable to initialise e2e", e);
    }

    const opts = utils.deepCopy(this.opts); // the react sdk doesn't work without this, so don't allow

    opts.pendingEventOrdering = "detached";
    opts.lazyLoadMembers = true; // Connect the matrix client to the dispatcher and setting handlers

    _MatrixActionCreators.default.start(this.matrixClient);

    _MatrixClientBackedSettingsHandler.default.matrixClient = this.matrixClient;
    return opts;
  }

  async start() {
    const opts = await this.assign();
    console.log("MatrixClientPeg: really starting MatrixClient");
    await this.get().startClient(opts);
    console.log("MatrixClientPeg: MatrixClient started");
  }

  getCredentials()
  /*: MatrixClientCreds*/
  {
    return {
      homeserverUrl: this.matrixClient.baseUrl,
      identityServerUrl: this.matrixClient.idBaseUrl,
      userId: this.matrixClient.credentials.userId,
      deviceId: this.matrixClient.getDeviceId(),
      accessToken: this.matrixClient.getAccessToken(),
      guest: this.matrixClient.isGuest()
    };
  }
  /*
   * Return the server name of the user's homeserver
   * Throws an error if unable to deduce the homeserver name
   * (eg. if the user is not logged in)
   */


  getHomeserverName() {
    const matches = /^@.+:(.+)$/.exec(this.matrixClient.credentials.userId);

    if (matches === null || matches.length < 1) {
      throw new Error("Failed to derive homeserver name from user ID!");
    }

    return matches[1];
  }

  _createClient(creds
  /*: MatrixClientCreds*/
  ) {
    const opts = {
      baseUrl: creds.homeserverUrl,
      idBaseUrl: creds.identityServerUrl,
      accessToken: creds.accessToken,
      userId: creds.userId,
      deviceId: creds.deviceId,
      timelineSupport: true,
      forceTURN: !_SettingsStore.default.getValue('webRtcAllowPeerToPeer', false),
      fallbackICEServerAllowed: !!_SettingsStore.default.getValue('fallbackICEServerAllowed'),
      verificationMethods: [_crypto.verificationMethods.SAS, _QRCode.SHOW_QR_CODE_METHOD, _crypto.verificationMethods.RECIPROCATE_QR_CODE],
      unstableClientRelationAggregation: true,
      identityServer: new _IdentityAuthClient.default()
    };
    opts.cryptoCallbacks = {}; // These are always installed regardless of the labs flag so that
    // cross-signing features can toggle on without reloading and also be
    // accessed immediately after login.

    Object.assign(opts.cryptoCallbacks, _CrossSigningManager.crossSigningCallbacks);
    this.matrixClient = (0, _createMatrixClient.default)(opts); // we're going to add eventlisteners for each matrix event tile, so the
    // potential number of event listeners is quite high.

    this.matrixClient.setMaxListeners(500);
    this.matrixClient.setGuest(Boolean(creds.guest));
    const notifTimelineSet = new _eventTimelineSet.EventTimelineSet(null, {
      timelineSupport: true
    }); // XXX: what is our initial pagination token?! it somehow needs to be synchronised with /sync.

    notifTimelineSet.getLiveTimeline().setPaginationToken("", _eventTimeline.EventTimeline.BACKWARDS);
    this.matrixClient.setNotifTimelineSet(notifTimelineSet);
  }

}

if (!global.mxMatrixClientPeg) {
  global.mxMatrixClientPeg = new _MatrixClientPeg();
}

const MatrixClientPeg = global.mxMatrixClientPeg;
exports.MatrixClientPeg = MatrixClientPeg;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NYXRyaXhDbGllbnRQZWcuanMiXSwibmFtZXMiOlsiX01hdHJpeENsaWVudFBlZyIsImNvbnN0cnVjdG9yIiwibWF0cml4Q2xpZW50IiwiX2p1c3RSZWdpc3RlcmVkVXNlcklkIiwib3B0cyIsImluaXRpYWxTeW5jTGltaXQiLCJfY3VycmVudENsaWVudENyZWRzIiwic2V0SW5kZXhlZERiV29ya2VyU2NyaXB0Iiwic2NyaXB0IiwiY3JlYXRlTWF0cml4Q2xpZW50IiwiaW5kZXhlZERiV29ya2VyU2NyaXB0IiwiZ2V0IiwidW5zZXQiLCJNYXRyaXhBY3Rpb25DcmVhdG9ycyIsInN0b3AiLCJzZXRKdXN0UmVnaXN0ZXJlZFVzZXJJZCIsInVpZCIsImN1cnJlbnRVc2VySXNKdXN0UmVnaXN0ZXJlZCIsImNyZWRlbnRpYWxzIiwidXNlcklkIiwicmVwbGFjZVVzaW5nQ3JlZHMiLCJjcmVkcyIsIl9jcmVhdGVDbGllbnQiLCJhc3NpZ24iLCJkYlR5cGUiLCJwcm9taXNlIiwic3RvcmUiLCJzdGFydHVwIiwiY29uc29sZSIsImxvZyIsImVyciIsImVycm9yIiwiTWVtb3J5U3RvcmUiLCJsb2NhbFN0b3JhZ2UiLCJnbG9iYWwiLCJTdG9yYWdlTWFuYWdlciIsInRyYWNrU3RvcmVzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiaW5pdENyeXB0byIsInNldENyeXB0b1RydXN0Q3Jvc3NTaWduZWREZXZpY2VzIiwic2V0Q3J5cHRvSW5pdGlhbGlzZWQiLCJlIiwibmFtZSIsIkNyeXB0b1N0b3JlVG9vTmV3RGlhbG9nIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJob3N0Iiwid2luZG93IiwibG9jYXRpb24iLCJ3YXJuIiwidXRpbHMiLCJkZWVwQ29weSIsInBlbmRpbmdFdmVudE9yZGVyaW5nIiwibGF6eUxvYWRNZW1iZXJzIiwic3RhcnQiLCJNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIiLCJzdGFydENsaWVudCIsImdldENyZWRlbnRpYWxzIiwiaG9tZXNlcnZlclVybCIsImJhc2VVcmwiLCJpZGVudGl0eVNlcnZlclVybCIsImlkQmFzZVVybCIsImRldmljZUlkIiwiZ2V0RGV2aWNlSWQiLCJhY2Nlc3NUb2tlbiIsImdldEFjY2Vzc1Rva2VuIiwiZ3Vlc3QiLCJpc0d1ZXN0IiwiZ2V0SG9tZXNlcnZlck5hbWUiLCJtYXRjaGVzIiwiZXhlYyIsImxlbmd0aCIsIkVycm9yIiwidGltZWxpbmVTdXBwb3J0IiwiZm9yY2VUVVJOIiwiZmFsbGJhY2tJQ0VTZXJ2ZXJBbGxvd2VkIiwidmVyaWZpY2F0aW9uTWV0aG9kcyIsIlNBUyIsIlNIT1dfUVJfQ09ERV9NRVRIT0QiLCJSRUNJUFJPQ0FURV9RUl9DT0RFIiwidW5zdGFibGVDbGllbnRSZWxhdGlvbkFnZ3JlZ2F0aW9uIiwiaWRlbnRpdHlTZXJ2ZXIiLCJJZGVudGl0eUF1dGhDbGllbnQiLCJjcnlwdG9DYWxsYmFja3MiLCJPYmplY3QiLCJjcm9zc1NpZ25pbmdDYWxsYmFja3MiLCJzZXRNYXhMaXN0ZW5lcnMiLCJzZXRHdWVzdCIsIkJvb2xlYW4iLCJub3RpZlRpbWVsaW5lU2V0IiwiRXZlbnRUaW1lbGluZVNldCIsImdldExpdmVUaW1lbGluZSIsInNldFBhZ2luYXRpb25Ub2tlbiIsIkV2ZW50VGltZWxpbmUiLCJCQUNLV0FSRFMiLCJzZXROb3RpZlRpbWVsaW5lU2V0IiwibXhNYXRyaXhDbGllbnRQZWciLCJNYXRyaXhDbGllbnRQZWciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBbUJBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQWxDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTZDQTs7Ozs7O0FBTUEsTUFBTUEsZ0JBQU4sQ0FBdUI7QUFDbkJDLEVBQUFBLFdBQVcsR0FBRztBQUNWLFNBQUtDLFlBQUwsR0FBb0IsSUFBcEI7QUFD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akYsSUFBQUEsSUFBSSxDQUFDa0YsZUFBTCxHQUF1QixFQUF2QixDQW5Cb0MsQ0FvQnBDO0FBQ0E7QUFDQTs7QUFDQUMsSUFBQUEsTUFBTSxDQUFDaEUsTUFBUCxDQUFjbkIsSUFBSSxDQUFDa0YsZUFBbkIsRUFBb0NFLDBDQUFwQztBQUVBLFNBQUt0RixZQUFMLEdBQW9CLGlDQUFtQkUsSUFBbkIsQ0FBcEIsQ0F6Qm9DLENBMkJwQztBQUNBOztBQUNBLFNBQUtGLFlBQUwsQ0FBa0J1RixlQUFsQixDQUFrQyxHQUFsQztBQUVBLFNBQUt2RixZQUFMLENBQWtCd0YsUUFBbEIsQ0FBMkJDLE9BQU8sQ0FBQ3RFLEtBQUssQ0FBQ2dELEtBQVAsQ0FBbEM7QUFFQSxVQUFNdUIsZ0JBQWdCLEdBQUcsSUFBSUMsa0NBQUosQ0FBcUIsSUFBckIsRUFBMkI7QUFDaERqQixNQUFBQSxlQUFlLEVBQUU7QUFEK0IsS0FBM0IsQ0FBekIsQ0FqQ29DLENBb0NwQzs7QUFDQWdCLElBQUFBLGdCQUFnQixDQUFDRSxlQUFqQixHQUFtQ0Msa0JBQW5DLENBQXNELEVBQXRELEVBQTBEQyw2QkFBY0MsU0FBeEU7QUFDQSxTQUFLL0YsWUFBTCxDQUFrQmdHLG1CQUFsQixDQUFzQ04sZ0JBQXRDO0FBQ0g7O0FBek1rQjs7QUE0TXZCLElBQUksQ0FBQzFELE1BQU0sQ0FBQ2lFLGlCQUFaLEVBQStCO0FBQzNCakUsRUFBQUEsTUFBTSxDQUFDaUUsaUJBQVAsR0FBMkIsSUFBSW5HLGdCQUFKLEVBQTNCO0FBQ0g7O0FBRU0sTUFBTW9HLGVBQWUsR0FBR2xFLE1BQU0sQ0FBQ2lFLGlCQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuQ29weXJpZ2h0IDIwMTcgVmVjdG9yIENyZWF0aW9ucyBMdGQuXG5Db3B5cmlnaHQgMjAxNywgMjAxOCwgMjAxOSBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQge01hdHJpeENsaWVudCwgTWVtb3J5U3RvcmV9IGZyb20gJ21hdHJpeC1qcy1zZGsnO1xuXG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy91dGlscyc7XG5pbXBvcnQge0V2ZW50VGltZWxpbmV9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudC10aW1lbGluZSc7XG5pbXBvcnQge0V2ZW50VGltZWxpbmVTZXR9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudC10aW1lbGluZS1zZXQnO1xuaW1wb3J0ICogYXMgc2RrIGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IGNyZWF0ZU1hdHJpeENsaWVudCBmcm9tICcuL3V0aWxzL2NyZWF0ZU1hdHJpeENsaWVudCc7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tICcuL3NldHRpbmdzL1NldHRpbmdzU3RvcmUnO1xuaW1wb3J0IE1hdHJpeEFjdGlvbkNyZWF0b3JzIGZyb20gJy4vYWN0aW9ucy9NYXRyaXhBY3Rpb25DcmVhdG9ycyc7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi9Nb2RhbCc7XG5pbXBvcnQge3ZlcmlmaWNhdGlvbk1ldGhvZHN9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL2NyeXB0byc7XG5pbXBvcnQgTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIGZyb20gXCIuL3NldHRpbmdzL2hhbmRsZXJzL01hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlclwiO1xuaW1wb3J0ICogYXMgU3RvcmFnZU1hbmFnZXIgZnJvbSAnLi91dGlscy9TdG9yYWdlTWFuYWdlcic7XG5pbXBvcnQgSWRlbnRpdHlBdXRoQ2xpZW50IGZyb20gJy4vSWRlbnRpdHlBdXRoQ2xpZW50JztcbmltcG9ydCB7IGNyb3NzU2lnbmluZ0NhbGxiYWNrcyB9IGZyb20gJy4vQ3Jvc3NTaWduaW5nTWFuYWdlcic7XG5pbXBvcnQge1NIT1dfUVJfQ09ERV9NRVRIT0R9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vdmVyaWZpY2F0aW9uL1FSQ29kZVwiO1xuXG5pbnRlcmZhY2UgTWF0cml4Q2xpZW50Q3JlZHMge1xuICAgIGhvbWVzZXJ2ZXJVcmw6IHN0cmluZyxcbiAgICBpZGVudGl0eVNlcnZlclVybDogc3RyaW5nLFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGRldmljZUlkOiBzdHJpbmcsXG4gICAgYWNjZXNzVG9rZW46IHN0cmluZyxcbiAgICBndWVzdDogYm9vbGVhbixcbn1cblxuLyoqXG4gKiBXcmFwcGVyIG9iamVjdCBmb3IgaGFuZGxpbmcgdGhlIGpzLXNkayBNYXRyaXggQ2xpZW50IG9iamVjdCBpbiB0aGUgcmVhY3Qtc2RrXG4gKiBIYW5kbGVzIHRoZSBjcmVhdGlvbi9pbml0aWFsaXNhdGlvbiBvZiBjbGllbnQgb2JqZWN0cy5cbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIGEgc2luZ2xldG9uIGluc3RhbmNlIG9mIHRoaXMgY2xhc3Mgc28gdGhlICdjdXJyZW50J1xuICogTWF0cml4IENsaWVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGVhc2lseS5cbiAqL1xuY2xhc3MgX01hdHJpeENsaWVudFBlZyB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMubWF0cml4Q2xpZW50ID0gbnVsbDtcbiAgICAgICAgdGhpcy5fanVzdFJlZ2lzdGVyZWRVc2VySWQgPSBudWxsO1xuXG4gICAgICAgIC8vIFRoZXNlIGFyZSB0aGUgZGVmYXVsdCBvcHRpb25zIHVzZWQgd2hlbiB3aGVuIHRoZVxuICAgICAgICAvLyBjbGllbnQgaXMgc3RhcnRlZCBpbiAnc3RhcnQnLiBUaGVzZSBjYW4gYmUgYWx0ZXJlZFxuICAgICAgICAvLyBhdCBhbnkgdGltZSB1cCB0byBhZnRlciB0aGUgJ3dpbGxfc3RhcnRfY2xpZW50J1xuICAgICAgICAvLyBldmVudCBpcyBmaW5pc2hlZCBwcm9jZXNzaW5nLlxuICAgICAgICB0aGlzLm9wdHMgPSB7XG4gICAgICAgICAgICBpbml0aWFsU3luY0xpbWl0OiAyMCxcbiAgICAgICAgfTtcbiAgICAgICAgLy8gdGhlIGNyZWRlbnRpYWxzIHVzZWQgdG8gaW5pdCB0aGUgY3VycmVudCBjbGllbnQgb2JqZWN0LlxuICAgICAgICAvLyB1c2VkIGlmIHdlIHRlYXIgaXQgZG93biAmIHJlY3JlYXRlIGl0IHdpdGggYSBkaWZmZXJlbnQgc3RvcmVcbiAgICAgICAgdGhpcy5fY3VycmVudENsaWVudENyZWRzID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXRzIHRoZSBzY3JpcHQgaHJlZiBwYXNzZWQgdG8gdGhlIEluZGV4ZWREQiB3ZWIgd29ya2VyXG4gICAgICogSWYgc2V0LCBhIHNlcGFyYXRlIHdlYiB3b3JrZXIgd2lsbCBiZSBzdGFydGVkIHRvIHJ1biB0aGUgSW5kZXhlZERCXG4gICAgICogcXVlcmllcyBvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzY3JpcHQgaHJlZiB0byB0aGUgc2NyaXB0IHRvIGJlIHBhc3NlZCB0byB0aGUgd2ViIHdvcmtlclxuICAgICAqL1xuICAgIHNldEluZGV4ZWREYldvcmtlclNjcmlwdChzY3JpcHQpIHtcbiAgICAgICAgY3JlYXRlTWF0cml4Q2xpZW50LmluZGV4ZWREYldvcmtlclNjcmlwdCA9IHNjcmlwdDtcbiAgICB9XG5cbiAgICBnZXQoKTogTWF0cml4Q2xpZW50IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF0cml4Q2xpZW50O1xuICAgIH1cblxuICAgIHVuc2V0KCkge1xuICAgICAgICB0aGlzLm1hdHJpeENsaWVudCA9IG51bGw7XG5cbiAgICAgICAgTWF0cml4QWN0aW9uQ3JlYXRvcnMuc3RvcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElmIHdlJ3ZlIHJlZ2lzdGVyZWQgYSB1c2VyIElEIHdlIHNldCB0aGlzIHRvIHRoZSBJRCBvZiB0aGVcbiAgICAgKiB1c2VyIHdlJ3ZlIGp1c3QgcmVnaXN0ZXJlZC4gSWYgdGhleSB0aGVuIGdvICYgbG9nIGluLCB3ZVxuICAgICAqIGNhbiBzZW5kIHRoZW0gdG8gdGhlIHdlbGNvbWUgdXNlciAob2J2aW91c2x5IHRoaXMgZG9lc24ndFxuICAgICAqIGd1YXJlbnRlZSB0aGV5J2xsIGdldCBhIGNoYXQgd2l0aCB0aGUgd2VsY29tZSB1c2VyKS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1aWQgVGhlIHVzZXIgSUQgb2YgdGhlIHVzZXIgd2UndmUganVzdCByZWdpc3RlcmVkXG4gICAgICovXG4gICAgc2V0SnVzdFJlZ2lzdGVyZWRVc2VySWQodWlkKSB7XG4gICAgICAgIHRoaXMuX2p1c3RSZWdpc3RlcmVkVXNlcklkID0gdWlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgY3VycmVudCB1c2VyIGhhcyBqdXN0IGJlZW4gcmVnaXN0ZXJlZCBieSB0aGlzXG4gICAgICogY2xpZW50IGFzIGRldGVybWluZWQgYnkgc2V0SnVzdFJlZ2lzdGVyZWRVc2VySWQoKVxuICAgICAqXG4gICAgICogQHJldHVybnMge2Jvb2x9IFRydWUgaWYgdXNlciBoYXMganVzdCBiZWVuIHJlZ2lzdGVyZWRcbiAgICAgKi9cbiAgICBjdXJyZW50VXNlcklzSnVzdFJlZ2lzdGVyZWQoKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLm1hdHJpeENsaWVudCAmJlxuICAgICAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQuY3JlZGVudGlhbHMudXNlcklkID09PSB0aGlzLl9qdXN0UmVnaXN0ZXJlZFVzZXJJZFxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogUmVwbGFjZSB0aGlzIE1hdHJpeENsaWVudFBlZydzIGNsaWVudCB3aXRoIGEgY2xpZW50IGluc3RhbmNlIHRoYXQgaGFzXG4gICAgICogaG9tZXNlcnZlciAvIGlkZW50aXR5IHNlcnZlciBVUkxzIGFuZCBhY3RpdmUgY3JlZGVudGlhbHNcbiAgICAgKi9cbiAgICByZXBsYWNlVXNpbmdDcmVkcyhjcmVkczogTWF0cml4Q2xpZW50Q3JlZHMpIHtcbiAgICAgICAgdGhpcy5fY3VycmVudENsaWVudENyZWRzID0gY3JlZHM7XG4gICAgICAgIHRoaXMuX2NyZWF0ZUNsaWVudChjcmVkcyk7XG4gICAgfVxuXG4gICAgYXN5bmMgYXNzaWduKCkge1xuICAgICAgICBmb3IgKGNvbnN0IGRiVHlwZSBvZiBbJ2luZGV4ZWRkYicsICdtZW1vcnknXSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5tYXRyaXhDbGllbnQuc3RvcmUuc3RhcnR1cCgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWF0cml4Q2xpZW50UGVnOiB3YWl0aW5nIGZvciBNYXRyaXhDbGllbnQgc3RvcmUgdG8gaW5pdGlhbGlzZVwiKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBwcm9taXNlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRiVHlwZSA9PT0gJ2luZGV4ZWRkYicpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc3RhcnRpbmcgbWF0cml4Y2xpZW50IHN0b3JlIC0gZmFsbGluZyBiYWNrIHRvIG1lbW9yeSBzdG9yZScsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnN0b3JlID0gbmV3IE1lbW9yeVN0b3JlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZTogZ2xvYmFsLmxvY2FsU3RvcmFnZSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHN0YXJ0IG1lbW9yeSBzdG9yZSEnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgU3RvcmFnZU1hbmFnZXIudHJhY2tTdG9yZXModGhpcy5tYXRyaXhDbGllbnQpO1xuXG4gICAgICAgIC8vIHRyeSB0byBpbml0aWFsaXNlIGUyZSBvbiB0aGUgbmV3IGNsaWVudFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gY2hlY2sgdGhhdCB3ZSBoYXZlIGEgdmVyc2lvbiBvZiB0aGUganMtc2RrIHdoaWNoIGluY2x1ZGVzIGluaXRDcnlwdG9cbiAgICAgICAgICAgIGlmICghU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImxvd0JhbmR3aWR0aFwiKSAmJiB0aGlzLm1hdHJpeENsaWVudC5pbml0Q3J5cHRvKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5tYXRyaXhDbGllbnQuaW5pdENyeXB0bygpO1xuICAgICAgICAgICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnNldENyeXB0b1RydXN0Q3Jvc3NTaWduZWREZXZpY2VzKFxuICAgICAgICAgICAgICAgICAgICAhU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZSgnZTJlZS5tYW51YWxseVZlcmlmeUFsbFNlc3Npb25zJyksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBTdG9yYWdlTWFuYWdlci5zZXRDcnlwdG9Jbml0aWFsaXNlZCh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKGUgJiYgZS5uYW1lID09PSAnSW52YWxpZENyeXB0b1N0b3JlRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGpzLXNkayBmb3VuZCBhIGNyeXB0byBEQiB0b28gbmV3IGZvciBpdCB0byB1c2VcbiAgICAgICAgICAgICAgICBjb25zdCBDcnlwdG9TdG9yZVRvb05ld0RpYWxvZyA9XG4gICAgICAgICAgICAgICAgICAgIHNkay5nZXRDb21wb25lbnQoXCJ2aWV3cy5kaWFsb2dzLkNyeXB0b1N0b3JlVG9vTmV3RGlhbG9nXCIpO1xuICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhDcnlwdG9TdG9yZVRvb05ld0RpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICBob3N0OiB3aW5kb3cubG9jYXRpb24uaG9zdCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIHRoaXMgY2FuIGhhcHBlbiBmb3IgYSBudW1iZXIgb2YgcmVhc29ucywgdGhlIG1vc3QgbGlrZWx5IGJlaW5nXG4gICAgICAgICAgICAvLyB0aGF0IHRoZSBvbG0gbGlicmFyeSB3YXMgbWlzc2luZy4gSXQncyBub3QgZmF0YWwuXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJVbmFibGUgdG8gaW5pdGlhbGlzZSBlMmVcIiwgZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvcHRzID0gdXRpbHMuZGVlcENvcHkodGhpcy5vcHRzKTtcbiAgICAgICAgLy8gdGhlIHJlYWN0IHNkayBkb2Vzbid0IHdvcmsgd2l0aG91dCB0aGlzLCBzbyBkb24ndCBhbGxvd1xuICAgICAgICBvcHRzLnBlbmRpbmdFdmVudE9yZGVyaW5nID0gXCJkZXRhY2hlZFwiO1xuICAgICAgICBvcHRzLmxhenlMb2FkTWVtYmVycyA9IHRydWU7XG5cbiAgICAgICAgLy8gQ29ubmVjdCB0aGUgbWF0cml4IGNsaWVudCB0byB0aGUgZGlzcGF0Y2hlciBhbmQgc2V0dGluZyBoYW5kbGVyc1xuICAgICAgICBNYXRyaXhBY3Rpb25DcmVhdG9ycy5zdGFydCh0aGlzLm1hdHJpeENsaWVudCk7XG4gICAgICAgIE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlci5tYXRyaXhDbGllbnQgPSB0aGlzLm1hdHJpeENsaWVudDtcblxuICAgICAgICByZXR1cm4gb3B0cztcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IGF3YWl0IHRoaXMuYXNzaWduKCk7XG5cbiAgICAgICAgY29uc29sZS5sb2coYE1hdHJpeENsaWVudFBlZzogcmVhbGx5IHN0YXJ0aW5nIE1hdHJpeENsaWVudGApO1xuICAgICAgICBhd2FpdCB0aGlzLmdldCgpLnN0YXJ0Q2xpZW50KG9wdHMpO1xuICAgICAgICBjb25zb2xlLmxvZyhgTWF0cml4Q2xpZW50UGVnOiBNYXRyaXhDbGllbnQgc3RhcnRlZGApO1xuICAgIH1cblxuICAgIGdldENyZWRlbnRpYWxzKCk6IE1hdHJpeENsaWVudENyZWRzIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGhvbWVzZXJ2ZXJVcmw6IHRoaXMubWF0cml4Q2xpZW50LmJhc2VVcmwsXG4gICAgICAgICAgICBpZGVudGl0eVNlcnZlclVybDogdGhpcy5tYXRyaXhDbGllbnQuaWRCYXNlVXJsLFxuICAgICAgICAgICAgdXNlcklkOiB0aGlzLm1hdHJpeENsaWVudC5jcmVkZW50aWFscy51c2VySWQsXG4gICAgICAgICAgICBkZXZpY2VJZDogdGhpcy5tYXRyaXhDbGllbnQuZ2V0RGV2aWNlSWQoKSxcbiAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiB0aGlzLm1hdHJpeENsaWVudC5nZXRBY2Nlc3NUb2tlbigpLFxuICAgICAgICAgICAgZ3Vlc3Q6IHRoaXMubWF0cml4Q2xpZW50LmlzR3Vlc3QoKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIFJldHVybiB0aGUgc2VydmVyIG5hbWUgb2YgdGhlIHVzZXIncyBob21lc2VydmVyXG4gICAgICogVGhyb3dzIGFuIGVycm9yIGlmIHVuYWJsZSB0byBkZWR1Y2UgdGhlIGhvbWVzZXJ2ZXIgbmFtZVxuICAgICAqIChlZy4gaWYgdGhlIHVzZXIgaXMgbm90IGxvZ2dlZCBpbilcbiAgICAgKi9cbiAgICBnZXRIb21lc2VydmVyTmFtZSgpIHtcbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IC9eQC4rOiguKykkLy5leGVjKHRoaXMubWF0cml4Q2xpZW50LmNyZWRlbnRpYWxzLnVzZXJJZCk7XG4gICAgICAgIGlmIChtYXRjaGVzID09PSBudWxsIHx8IG1hdGNoZXMubGVuZ3RoIDwgMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGRlcml2ZSBob21lc2VydmVyIG5hbWUgZnJvbSB1c2VyIElEIVwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWF0Y2hlc1sxXTtcbiAgICB9XG5cbiAgICBfY3JlYXRlQ2xpZW50KGNyZWRzOiBNYXRyaXhDbGllbnRDcmVkcykge1xuICAgICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICAgICAgYmFzZVVybDogY3JlZHMuaG9tZXNlcnZlclVybCxcbiAgICAgICAgICAgIGlkQmFzZVVybDogY3JlZHMuaWRlbnRpdHlTZXJ2ZXJVcmwsXG4gICAgICAgICAgICBhY2Nlc3NUb2tlbjogY3JlZHMuYWNjZXNzVG9rZW4sXG4gICAgICAgICAgICB1c2VySWQ6IGNyZWRzLnVzZXJJZCxcbiAgICAgICAgICAgIGRldmljZUlkOiBjcmVkcy5kZXZpY2VJZCxcbiAgICAgICAgICAgIHRpbWVsaW5lU3VwcG9ydDogdHJ1ZSxcbiAgICAgICAgICAgIGZvcmNlVFVSTjogIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoJ3dlYlJ0Y0FsbG93UGVlclRvUGVlcicsIGZhbHNlKSxcbiAgICAgICAgICAgIGZhbGxiYWNrSUNFU2VydmVyQWxsb3dlZDogISFTZXR0aW5nc1N0b3JlLmdldFZhbHVlKCdmYWxsYmFja0lDRVNlcnZlckFsbG93ZWQnKSxcbiAgICAgICAgICAgIHZlcmlmaWNhdGlvbk1ldGhvZHM6IFtcbiAgICAgICAgICAgICAgICB2ZXJpZmljYXRpb25NZXRob2RzLlNBUyxcbiAgICAgICAgICAgICAgICBTSE9XX1FSX0NPREVfTUVUSE9ELFxuICAgICAgICAgICAgICAgIHZlcmlmaWNhdGlvbk1ldGhvZHMuUkVDSVBST0NBVEVfUVJfQ09ERSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB1bnN0YWJsZUNsaWVudFJlbGF0aW9uQWdncmVnYXRpb246IHRydWUsXG4gICAgICAgICAgICBpZGVudGl0eVNlcnZlcjogbmV3IElkZW50aXR5QXV0aENsaWVudCgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIG9wdHMuY3J5cHRvQ2FsbGJhY2tzID0ge307XG4gICAgICAgIC8vIFRoZXNlIGFyZSBhbHdheXMgaW5zdGFsbGVkIHJlZ2FyZGxlc3Mgb2YgdGhlIGxhYnMgZmxhZyBzbyB0aGF0XG4gICAgICAgIC8vIGNyb3NzLXNpZ25pbmcgZmVhdHVyZXMgY2FuIHRvZ2dsZSBvbiB3aXRob3V0IHJlbG9hZGluZyBhbmQgYWxzbyBiZVxuICAgICAgICAvLyBhY2Nlc3NlZCBpbW1lZGlhdGVseSBhZnRlciBsb2dpbi5cbiAgICAgICAgT2JqZWN0LmFzc2lnbihvcHRzLmNyeXB0b0NhbGxiYWNrcywgY3Jvc3NTaWduaW5nQ2FsbGJhY2tzKTtcblxuICAgICAgICB0aGlzLm1hdHJpeENsaWVudCA9IGNyZWF0ZU1hdHJpeENsaWVudChvcHRzKTtcblxuICAgICAgICAvLyB3ZSdyZSBnb2luZyB0byBhZGQgZXZlbnRsaXN0ZW5lcnMgZm9yIGVhY2ggbWF0cml4IGV2ZW50IHRpbGUsIHNvIHRoZVxuICAgICAgICAvLyBwb3RlbnRpYWwgbnVtYmVyIG9mIGV2ZW50IGxpc3RlbmVycyBpcyBxdWl0ZSBoaWdoLlxuICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5zZXRNYXhMaXN0ZW5lcnMoNTAwKTtcblxuICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5zZXRHdWVzdChCb29sZWFuKGNyZWRzLmd1ZXN0KSk7XG5cbiAgICAgICAgY29uc3Qgbm90aWZUaW1lbGluZVNldCA9IG5ldyBFdmVudFRpbWVsaW5lU2V0KG51bGwsIHtcbiAgICAgICAgICAgIHRpbWVsaW5lU3VwcG9ydDogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFhYWDogd2hhdCBpcyBvdXIgaW5pdGlhbCBwYWdpbmF0aW9uIHRva2VuPyEgaXQgc29tZWhvdyBuZWVkcyB0byBiZSBzeW5jaHJvbmlzZWQgd2l0aCAvc3luYy5cbiAgICAgICAgbm90aWZUaW1lbGluZVNldC5nZXRMaXZlVGltZWxpbmUoKS5zZXRQYWdpbmF0aW9uVG9rZW4oXCJcIiwgRXZlbnRUaW1lbGluZS5CQUNLV0FSRFMpO1xuICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5zZXROb3RpZlRpbWVsaW5lU2V0KG5vdGlmVGltZWxpbmVTZXQpO1xuICAgIH1cbn1cblxuaWYgKCFnbG9iYWwubXhNYXRyaXhDbGllbnRQZWcpIHtcbiAgICBnbG9iYWwubXhNYXRyaXhDbGllbnRQZWcgPSBuZXcgX01hdHJpeENsaWVudFBlZygpO1xufVxuXG5leHBvcnQgY29uc3QgTWF0cml4Q2xpZW50UGVnID0gZ2xvYmFsLm14TWF0cml4Q2xpZW50UGVnO1xuIl19