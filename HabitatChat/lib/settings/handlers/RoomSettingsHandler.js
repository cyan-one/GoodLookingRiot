"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _SettingsStore = require("../SettingsStore");

/*
Copyright 2017 Travis Ralston
Copyright 2019 New Vector Ltd.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Gets and sets settings at the "room" level.
 */
class RoomSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchManager) {
    super();
    this._watchers = watchManager;
    this._onEvent = this._onEvent.bind(this);
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener("RoomState.events", this._onEvent);
    }

    newClient.on("RoomState.events", this._onEvent);
  }

  _onEvent(event) {
    const roomId = event.getRoomId();

    if (event.getType() === "org.matrix.room.preview_urls") {
      let val = event.getContent()['disable'];

      if (typeof val !== "boolean") {
        val = null;
      } else {
        val = !val;
      }

      this._watchers.notifyUpdate("urlPreviewsEnabled", roomId, _SettingsStore.SettingLevel.ROOM, val);
    } else if (event.getType() === "im.vector.web.settings") {
      // We can't really discern what changed, so trigger updates for everything
      for (const settingName of Object.keys(event.getContent())) {
        this._watchers.notifyUpdate(settingName, roomId, _SettingsStore.SettingLevel.ROOM, event.getContent()[settingName]);
      }
    }
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings(roomId, "org.matrix.room.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    }

    const settings = this._getSettings(roomId) || {};
    return settings[settingName];
  }

  setValue(settingName, roomId, newValue) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings(roomId, "org.matrix.room.preview_urls") || {};
      content['disable'] = !newValue;
      return _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(roomId, "org.matrix.room.preview_urls", content);
    }

    const content = this._getSettings(roomId) || {};
    content[settingName] = newValue;
    return _MatrixClientPeg.MatrixClientPeg.get().sendStateEvent(roomId, "im.vector.web.settings", content, "");
  }

  canSetValue(settingName, roomId) {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const room = cli.getRoom(roomId);
    let eventType = "im.vector.web.settings";
    if (settingName === "urlPreviewsEnabled") eventType = "org.matrix.room.preview_urls";
    if (!room) return false;
    return room.currentState.maySendStateEvent(eventType, cli.getUserId());
  }

  isSupported() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    return cli !== undefined && cli !== null;
  }

  _getSettings(roomId, eventType = "im.vector.web.settings") {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    if (!room) return null;
    const event = room.currentState.getStateEvents(eventType, "");
    if (!event || !event.getContent()) return null;
    return event.getContent();
  }

}

exports.default = RoomSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9Sb29tU2V0dGluZ3NIYW5kbGVyLmpzIl0sIm5hbWVzIjpbIlJvb21TZXR0aW5nc0hhbmRsZXIiLCJNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIiLCJjb25zdHJ1Y3RvciIsIndhdGNoTWFuYWdlciIsIl93YXRjaGVycyIsIl9vbkV2ZW50IiwiYmluZCIsImluaXRNYXRyaXhDbGllbnQiLCJvbGRDbGllbnQiLCJuZXdDbGllbnQiLCJyZW1vdmVMaXN0ZW5lciIsIm9uIiwiZXZlbnQiLCJyb29tSWQiLCJnZXRSb29tSWQiLCJnZXRUeXBlIiwidmFsIiwiZ2V0Q29udGVudCIsIm5vdGlmeVVwZGF0ZSIsIlNldHRpbmdMZXZlbCIsIlJPT00iLCJzZXR0aW5nTmFtZSIsIk9iamVjdCIsImtleXMiLCJnZXRWYWx1ZSIsImNvbnRlbnQiLCJfZ2V0U2V0dGluZ3MiLCJzZXR0aW5ncyIsInNldFZhbHVlIiwibmV3VmFsdWUiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJzZW5kU3RhdGVFdmVudCIsImNhblNldFZhbHVlIiwiY2xpIiwicm9vbSIsImdldFJvb20iLCJldmVudFR5cGUiLCJjdXJyZW50U3RhdGUiLCJtYXlTZW5kU3RhdGVFdmVudCIsImdldFVzZXJJZCIsImlzU3VwcG9ydGVkIiwidW5kZWZpbmVkIiwiZ2V0U3RhdGVFdmVudHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFuQkE7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBOzs7QUFHZSxNQUFNQSxtQkFBTixTQUFrQ0MsMENBQWxDLENBQW9FO0FBQy9FQyxFQUFBQSxXQUFXLENBQUNDLFlBQUQsRUFBZTtBQUN0QjtBQUVBLFNBQUtDLFNBQUwsR0FBaUJELFlBQWpCO0FBQ0EsU0FBS0UsUUFBTCxHQUFnQixLQUFLQSxRQUFMLENBQWNDLElBQWQsQ0FBbUIsSUFBbkIsQ0FBaEI7QUFDSDs7QUFFREMsRUFB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QUFHSixpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0EsVUFBTUksSUFBSSxHQUFHRCxHQUFHLENBQUNFLE9BQUosQ0FBWXZCLE1BQVosQ0FBYjtBQUVBLFFBQUl3QixTQUFTLEdBQUcsd0JBQWhCO0FBQ0EsUUFBSWhCLFdBQVcsS0FBSyxvQkFBcEIsRUFBMENnQixTQUFTLEdBQUcsOEJBQVo7QUFFMUMsUUFBSSxDQUFDRixJQUFMLEVBQVcsT0FBTyxLQUFQO0FBQ1gsV0FBT0EsSUFBSSxDQUFDRyxZQUFMLENBQWtCQyxpQkFBbEIsQ0FBb0NGLFNBQXBDLEVBQStDSCxHQUFHLENBQUNNLFNBQUosRUFBL0MsQ0FBUDtBQUNIOztBQUVEQyxFQUFBQSxXQUFXLEdBQUc7QUFDVixVQUFNUCxHQUFHLEdBQUdKLGlDQUFnQkMsR0FBaEIsRUFBWjs7QUFDQSxXQUFPRyxHQUFHLEtBQUtRLFNBQVIsSUFBcUJSLEdBQUcsS0FBSyxJQUFwQztBQUNIOztBQUVEUixFQUFBQSxZQUFZLENBQUNiLE1BQUQsRUFBU3dCLFNBQVMsR0FBRyx3QkFBckIsRUFBK0M7QUFDdkQsVUFBTUYsSUFBSSxHQUFHTCxpQ0FBZ0JDLEdBQWhCLEdBQXNCSyxPQUF0QixDQUE4QnZCLE1BQTlCLENBQWI7O0FBQ0EsUUFBSSxDQUFDc0IsSUFBTCxFQUFXLE9BQU8sSUFBUDtBQUVYLFVBQU12QixLQUFLLEdBQUd1QixJQUFJLENBQUNHLFlBQUwsQ0FBa0JLLGNBQWxCLENBQWlDTixTQUFqQyxFQUE0QyxFQUE1QyxDQUFkO0FBQ0EsUUFBSSxDQUFDekIsS0FBRCxJQUFVLENBQUNBLEtBQUssQ0FBQ0ssVUFBTixFQUFmLEVBQW1DLE9BQU8sSUFBUDtBQUNuQyxXQUFPTCxLQUFLLENBQUNLLFVBQU4sRUFBUDtBQUNIOztBQXRGOEUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcgVHJhdmlzIFJhbHN0b25cbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7TWF0cml4Q2xpZW50UGVnfSBmcm9tICcuLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlciBmcm9tIFwiLi9NYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXJcIjtcbmltcG9ydCB7U2V0dGluZ0xldmVsfSBmcm9tIFwiLi4vU2V0dGluZ3NTdG9yZVwiO1xuXG4vKipcbiAqIEdldHMgYW5kIHNldHMgc2V0dGluZ3MgYXQgdGhlIFwicm9vbVwiIGxldmVsLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tU2V0dGluZ3NIYW5kbGVyIGV4dGVuZHMgTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIHtcbiAgICBjb25zdHJ1Y3Rvcih3YXRjaE1hbmFnZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl93YXRjaGVycyA9IHdhdGNoTWFuYWdlcjtcbiAgICAgICAgdGhpcy5fb25FdmVudCA9IHRoaXMuX29uRXZlbnQuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBpbml0TWF0cml4Q2xpZW50KG9sZENsaWVudCwgbmV3Q2xpZW50KSB7XG4gICAgICAgIGlmIChvbGRDbGllbnQpIHtcbiAgICAgICAgICAgIG9sZENsaWVudC5yZW1vdmVMaXN0ZW5lcihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5fb25FdmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdDbGllbnQub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMuX29uRXZlbnQpO1xuICAgIH1cblxuICAgIF9vbkV2ZW50KGV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHJvb21JZCA9IGV2ZW50LmdldFJvb21JZCgpO1xuXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiKSB7XG4gICAgICAgICAgICBsZXQgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydkaXNhYmxlJ107XG4gICAgICAgICAgICBpZiAodHlwZW9mICh2YWwpICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgICAgICAgIHZhbCA9IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbCA9ICF2YWw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX3dhdGNoZXJzLm5vdGlmeVVwZGF0ZShcInVybFByZXZpZXdzRW5hYmxlZFwiLCByb29tSWQsIFNldHRpbmdMZXZlbC5ST09NLCB2YWwpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIpIHtcbiAgICAgICAgICAgIC8vIFdlIGNhbid0IHJlYWxseSBkaXNjZXJuIHdoYXQgY2hhbmdlZCwgc28gdHJpZ2dlciB1cGRhdGVzIGZvciBldmVyeXRoaW5nXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNldHRpbmdOYW1lIG9mIE9iamVjdC5rZXlzKGV2ZW50LmdldENvbnRlbnQoKSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl93YXRjaGVycy5ub3RpZnlVcGRhdGUoc2V0dGluZ05hbWUsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT00sIGV2ZW50LmdldENvbnRlbnQoKVtzZXR0aW5nTmFtZV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0VmFsdWUoc2V0dGluZ05hbWUsIHJvb21JZCkge1xuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgVVJMIHByZXZpZXdzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuX2dldFNldHRpbmdzKHJvb21JZCwgXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCIpIHx8IHt9O1xuXG4gICAgICAgICAgICAvLyBDaGVjayB0byBtYWtlIHN1cmUgdGhhdCB3ZSBhY3R1YWxseSBnb3QgYSBib29sZWFuXG4gICAgICAgICAgICBpZiAodHlwZW9mKGNvbnRlbnRbJ2Rpc2FibGUnXSkgIT09IFwiYm9vbGVhblwiKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiAhY29udGVudFsnZGlzYWJsZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLl9nZXRTZXR0aW5ncyhyb29tSWQpIHx8IHt9O1xuICAgICAgICByZXR1cm4gc2V0dGluZ3Nbc2V0dGluZ05hbWVdO1xuICAgIH1cblxuICAgIHNldFZhbHVlKHNldHRpbmdOYW1lLCByb29tSWQsIG5ld1ZhbHVlKSB7XG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBVUkwgcHJldmlld3NcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG4gICAgICAgICAgICBjb250ZW50WydkaXNhYmxlJ10gPSAhbmV3VmFsdWU7XG4gICAgICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnNlbmRTdGF0ZUV2ZW50KHJvb21JZCwgXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCIsIGNvbnRlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuX2dldFNldHRpbmdzKHJvb21JZCkgfHwge307XG4gICAgICAgIGNvbnRlbnRbc2V0dGluZ05hbWVdID0gbmV3VmFsdWU7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2VuZFN0YXRlRXZlbnQocm9vbUlkLCBcImltLnZlY3Rvci53ZWIuc2V0dGluZ3NcIiwgY29udGVudCwgXCJcIik7XG4gICAgfVxuXG4gICAgY2FuU2V0VmFsdWUoc2V0dGluZ05hbWUsIHJvb21JZCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHJvb20gPSBjbGkuZ2V0Um9vbShyb29tSWQpO1xuXG4gICAgICAgIGxldCBldmVudFR5cGUgPSBcImltLnZlY3Rvci53ZWIuc2V0dGluZ3NcIjtcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSBldmVudFR5cGUgPSBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIjtcblxuICAgICAgICBpZiAoIXJvb20pIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHJvb20uY3VycmVudFN0YXRlLm1heVNlbmRTdGF0ZUV2ZW50KGV2ZW50VHlwZSwgY2xpLmdldFVzZXJJZCgpKTtcbiAgICB9XG5cbiAgICBpc1N1cHBvcnRlZCgpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICByZXR1cm4gY2xpICE9PSB1bmRlZmluZWQgJiYgY2xpICE9PSBudWxsO1xuICAgIH1cblxuICAgIF9nZXRTZXR0aW5ncyhyb29tSWQsIGV2ZW50VHlwZSA9IFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiKSB7XG4gICAgICAgIGNvbnN0IHJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShyb29tSWQpO1xuICAgICAgICBpZiAoIXJvb20pIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0gcm9vbS5jdXJyZW50U3RhdGUuZ2V0U3RhdGVFdmVudHMoZXZlbnRUeXBlLCBcIlwiKTtcbiAgICAgICAgaWYgKCFldmVudCB8fCAhZXZlbnQuZ2V0Q29udGVudCgpKSByZXR1cm4gbnVsbDtcbiAgICAgICAgcmV0dXJuIGV2ZW50LmdldENvbnRlbnQoKTtcbiAgICB9XG59XG4iXX0=