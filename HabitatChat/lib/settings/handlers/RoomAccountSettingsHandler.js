"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _SettingsStore = require("../SettingsStore");

/*
Copyright 2017 Travis Ralston
Copyright 2019 New Vector Ltd.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ALLOWED_WIDGETS_EVENT_TYPE = "im.vector.setting.allowed_widgets";
/**
 * Gets and sets settings at the "room-account" level for the current user.
 */

class RoomAccountSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchManager) {
    super();
    this._watchers = watchManager;
    this._onAccountData = this._onAccountData.bind(this);
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener("Room.accountData", this._onAccountData);
    }

    newClient.on("Room.accountData", this._onAccountData);
  }

  _onAccountData(event, room) {
    const roomId = room.roomId;

    if (event.getType() === "org.matrix.room.preview_urls") {
      let val = event.getContent()['disable'];

      if (typeof val !== "boolean") {
        val = null;
      } else {
        val = !val;
      }

      this._watchers.notifyUpdate("urlPreviewsEnabled", roomId, _SettingsStore.SettingLevel.ROOM_ACCOUNT, val);
    } else if (event.getType() === "org.matrix.room.color_scheme") {
      this._watchers.notifyUpdate("roomColor", roomId, _SettingsStore.SettingLevel.ROOM_ACCOUNT, event.getContent());
    } else if (event.getType() === "im.vector.web.settings") {
      // We can't really discern what changed, so trigger updates for everything
      for (const settingName of Object.keys(event.getContent())) {
        const val = event.getContent()[settingName];

        this._watchers.notifyUpdate(settingName, roomId, _SettingsStore.SettingLevel.ROOM_ACCOUNT, val);
      }
    } else if (event.getType() === ALLOWED_WIDGETS_EVENT_TYPE) {
      this._watchers.notifyUpdate("allowedWidgets", roomId, _SettingsStore.SettingLevel.ROOM_ACCOUNT, event.getContent());
    }
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings(roomId, "org.matrix.room.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    } // Special case room color


    if (settingName === "roomColor") {
      // The event content should already be in an appropriate format, we just need
      // to get the right value.
      // don't fallback to {} because thats truthy and would imply there is an event specifying tint
      return this._getSettings(roomId, "org.matrix.room.color_scheme");
    } // Special case allowed widgets


    if (settingName === "allowedWidgets") {
      return this._getSettings(roomId, ALLOWED_WIDGETS_EVENT_TYPE);
    }

    const settings = this._getSettings(roomId) || {};
    return settings[settingName];
  }

  setValue(settingName, roomId, newValue) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings(roomId, "org.matrix.room.preview_urls") || {};
      content['disable'] = !newValue;
      return _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, "org.matrix.room.preview_urls", content);
    } // Special case room color


    if (settingName === "roomColor") {
      // The new value should match our requirements, we just need to store it in the right place.
      return _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, "org.matrix.room.color_scheme", newValue);
    } // Special case allowed widgets


    if (settingName === "allowedWidgets") {
      return _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, ALLOWED_WIDGETS_EVENT_TYPE, newValue);
    }

    const content = this._getSettings(roomId) || {};
    content[settingName] = newValue;
    return _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(roomId, "im.vector.web.settings", content);
  }

  canSetValue(settingName, roomId) {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId); // If they have the room, they can set their own account data


    return room !== undefined && room !== null;
  }

  isSupported() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    return cli !== undefined && cli !== null;
  }

  _getSettings(roomId, eventType = "im.vector.web.settings") {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    if (!room) return null;
    const event = room.getAccountData(eventType);
    if (!event || !event.getContent()) return null;
    return event.getContent();
  }

}

exports.default = RoomAccountSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9Sb29tQWNjb3VudFNldHRpbmdzSGFuZGxlci5qcyJdLCJuYW1lcyI6WyJBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSIsIlJvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyIiwiTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJ3YXRjaE1hbmFnZXIiLCJfd2F0Y2hlcnMiLCJfb25BY2NvdW50RGF0YSIsImJpbmQiLCJpbml0TWF0cml4Q2xpZW50Iiwib2xkQ2xpZW50IiwibmV3Q2xpZW50IiwicmVtb3ZlTGlzdGVuZXIiLCJvbiIsImV2ZW50Iiwicm9vbSIsInJvb21JZCIsImdldFR5cGUiLCJ2YWwiLCJnZXRDb250ZW50Iiwibm90aWZ5VXBkYXRlIiwiU2V0dGluZ0xldmVsIiwiUk9PTV9BQ0NPVU5UIiwic2V0dGluZ05hbWUiLCJPYmplY3QiLCJrZXlzIiwiZ2V0VmFsdWUiLCJjb250ZW50IiwiX2dldFNldHRpbmdzIiwic2V0dGluZ3MiLCJzZXRWYWx1ZSIsIm5ld1ZhbHVlIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2V0Um9vbUFjY291bnREYXRhIiwiY2FuU2V0VmFsdWUiLCJnZXRSb29tIiwidW5kZWZpbmVkIiwiaXNTdXBwb3J0ZWQiLCJjbGkiLCJldmVudFR5cGUiLCJnZXRBY2NvdW50RGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQW5CQTs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQSxNQUFNQSwwQkFBMEIsR0FBRyxtQ0FBbkM7QUFFQTs7OztBQUdlLE1BQU1DLDBCQUFOLFNBQXlDQywwQ0FBekMsQ0FBMkU7QUFDdEZDLEVBQUFBLFdBQVcsQ0FBQ0MsWUFBRCxFQUFlO0FBQ3RCO0FBRUEsU0FBS0MsU0FBTCxHQUFpQkQsWUFBakI7QUFDQSxTQUFLRSxjQUFMLEdBQXNCLEtBQUtBLGNBQUwsQ0FBb0JDLElBQXBC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Z0JDLEdBQWhCLEdBQXNCRyxPQUF0QixDQUE4QnBCLE1BQTlCLENBQWIsQ0FENkIsQ0FHN0I7OztBQUNBLFdBQU9ELElBQUksS0FBS3NCLFNBQVQsSUFBc0J0QixJQUFJLEtBQUssSUFBdEM7QUFDSDs7QUFFRHVCLEVBQUFBLFdBQVcsR0FBRztBQUNWLFVBQU1DLEdBQUcsR0FBR1AsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLFdBQU9NLEdBQUcsS0FBS0YsU0FBUixJQUFxQkUsR0FBRyxLQUFLLElBQXBDO0FBQ0g7O0FBRURYLEVBQUFBLFlBQVksQ0FBQ1osTUFBRCxFQUFTd0IsU0FBUyxHQUFHLHdCQUFyQixFQUErQztBQUN2RCxVQUFNekIsSUFBSSxHQUFHaUIsaUNBQWdCQyxHQUFoQixHQUFzQkcsT0FBdEIsQ0FBOEJwQixNQUE5QixDQUFiOztBQUNBLFFBQUksQ0FBQ0QsSUFBTCxFQUFXLE9BQU8sSUFBUDtBQUVYLFVBQU1ELEtBQUssR0FBR0MsSUFBSSxDQUFDMEIsY0FBTCxDQUFvQkQsU0FBcEIsQ0FBZDtBQUNBLFFBQUksQ0FBQzFCLEtBQUQsSUFBVSxDQUFDQSxLQUFLLENBQUNLLFVBQU4sRUFBZixFQUFtQyxPQUFPLElBQVA7QUFDbkMsV0FBT0wsS0FBSyxDQUFDSyxVQUFOLEVBQVA7QUFDSDs7QUEvR3FGIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFRyYXZpcyBSYWxzdG9uXG5Db3B5cmlnaHQgMjAxOSBOZXcgVmVjdG9yIEx0ZC5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSAnLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIgZnJvbSBcIi4vTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyXCI7XG5pbXBvcnQge1NldHRpbmdMZXZlbH0gZnJvbSBcIi4uL1NldHRpbmdzU3RvcmVcIjtcblxuY29uc3QgQUxMT1dFRF9XSURHRVRTX0VWRU5UX1RZUEUgPSBcImltLnZlY3Rvci5zZXR0aW5nLmFsbG93ZWRfd2lkZ2V0c1wiO1xuXG4vKipcbiAqIEdldHMgYW5kIHNldHMgc2V0dGluZ3MgYXQgdGhlIFwicm9vbS1hY2NvdW50XCIgbGV2ZWwgZm9yIHRoZSBjdXJyZW50IHVzZXIuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyIGV4dGVuZHMgTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIHtcbiAgICBjb25zdHJ1Y3Rvcih3YXRjaE1hbmFnZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl93YXRjaGVycyA9IHdhdGNoTWFuYWdlcjtcbiAgICAgICAgdGhpcy5fb25BY2NvdW50RGF0YSA9IHRoaXMuX29uQWNjb3VudERhdGEuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBpbml0TWF0cml4Q2xpZW50KG9sZENsaWVudCwgbmV3Q2xpZW50KSB7XG4gICAgICAgIGlmIChvbGRDbGllbnQpIHtcbiAgICAgICAgICAgIG9sZENsaWVudC5yZW1vdmVMaXN0ZW5lcihcIlJvb20uYWNjb3VudERhdGFcIiwgdGhpcy5fb25BY2NvdW50RGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdDbGllbnQub24oXCJSb29tLmFjY291bnREYXRhXCIsIHRoaXMuX29uQWNjb3VudERhdGEpO1xuICAgIH1cblxuICAgIF9vbkFjY291bnREYXRhKGV2ZW50LCByb29tKSB7XG4gICAgICAgIGNvbnN0IHJvb21JZCA9IHJvb20ucm9vbUlkO1xuXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiKSB7XG4gICAgICAgICAgICBsZXQgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydkaXNhYmxlJ107XG4gICAgICAgICAgICBpZiAodHlwZW9mICh2YWwpICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgICAgICAgIHZhbCA9IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbCA9ICF2YWw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX3dhdGNoZXJzLm5vdGlmeVVwZGF0ZShcInVybFByZXZpZXdzRW5hYmxlZFwiLCByb29tSWQsIFNldHRpbmdMZXZlbC5ST09NX0FDQ09VTlQsIHZhbCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZ2V0VHlwZSgpID09PSBcIm9yZy5tYXRyaXgucm9vbS5jb2xvcl9zY2hlbWVcIikge1xuICAgICAgICAgICAgdGhpcy5fd2F0Y2hlcnMubm90aWZ5VXBkYXRlKFwicm9vbUNvbG9yXCIsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgZXZlbnQuZ2V0Q29udGVudCgpKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiKSB7XG4gICAgICAgICAgICAvLyBXZSBjYW4ndCByZWFsbHkgZGlzY2VybiB3aGF0IGNoYW5nZWQsIHNvIHRyaWdnZXIgdXBkYXRlcyBmb3IgZXZlcnl0aGluZ1xuICAgICAgICAgICAgZm9yIChjb25zdCBzZXR0aW5nTmFtZSBvZiBPYmplY3Qua2V5cyhldmVudC5nZXRDb250ZW50KCkpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpW3NldHRpbmdOYW1lXTtcbiAgICAgICAgICAgICAgICB0aGlzLl93YXRjaGVycy5ub3RpZnlVcGRhdGUoc2V0dGluZ05hbWUsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgdmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IEFMTE9XRURfV0lER0VUU19FVkVOVF9UWVBFKSB7XG4gICAgICAgICAgICB0aGlzLl93YXRjaGVycy5ub3RpZnlVcGRhdGUoXCJhbGxvd2VkV2lkZ2V0c1wiLCByb29tSWQsIFNldHRpbmdMZXZlbC5ST09NX0FDQ09VTlQsIGV2ZW50LmdldENvbnRlbnQoKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRWYWx1ZShzZXR0aW5nTmFtZSwgcm9vbUlkKSB7XG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBVUkwgcHJldmlld3NcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG5cbiAgICAgICAgICAgIC8vIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGF0IHdlIGFjdHVhbGx5IGdvdCBhIGJvb2xlYW5cbiAgICAgICAgICAgIGlmICh0eXBlb2YoY29udGVudFsnZGlzYWJsZSddKSAhPT0gXCJib29sZWFuXCIpIHJldHVybiBudWxsO1xuICAgICAgICAgICAgcmV0dXJuICFjb250ZW50WydkaXNhYmxlJ107XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTcGVjaWFsIGNhc2Ugcm9vbSBjb2xvclxuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwicm9vbUNvbG9yXCIpIHtcbiAgICAgICAgICAgIC8vIFRoZSBldmVudCBjb250ZW50IHNob3VsZCBhbHJlYWR5IGJlIGluIGFuIGFwcHJvcHJpYXRlIGZvcm1hdCwgd2UganVzdCBuZWVkXG4gICAgICAgICAgICAvLyB0byBnZXQgdGhlIHJpZ2h0IHZhbHVlLlxuICAgICAgICAgICAgLy8gZG9uJ3QgZmFsbGJhY2sgdG8ge30gYmVjYXVzZSB0aGF0cyB0cnV0aHkgYW5kIHdvdWxkIGltcGx5IHRoZXJlIGlzIGFuIGV2ZW50IHNwZWNpZnlpbmcgdGludFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFNldHRpbmdzKHJvb21JZCwgXCJvcmcubWF0cml4LnJvb20uY29sb3Jfc2NoZW1lXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGFsbG93ZWQgd2lkZ2V0c1xuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwiYWxsb3dlZFdpZGdldHNcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFNldHRpbmdzKHJvb21JZCwgQUxMT1dFRF9XSURHRVRTX0VWRU5UX1RZUEUpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLl9nZXRTZXR0aW5ncyhyb29tSWQpIHx8IHt9O1xuICAgICAgICByZXR1cm4gc2V0dGluZ3Nbc2V0dGluZ05hbWVdO1xuICAgIH1cblxuICAgIHNldFZhbHVlKHNldHRpbmdOYW1lLCByb29tSWQsIG5ld1ZhbHVlKSB7XG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBVUkwgcHJldmlld3NcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG4gICAgICAgICAgICBjb250ZW50WydkaXNhYmxlJ10gPSAhbmV3VmFsdWU7XG4gICAgICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiLCBjb250ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSByb29tIGNvbG9yXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJyb29tQ29sb3JcIikge1xuICAgICAgICAgICAgLy8gVGhlIG5ldyB2YWx1ZSBzaG91bGQgbWF0Y2ggb3VyIHJlcXVpcmVtZW50cywgd2UganVzdCBuZWVkIHRvIHN0b3JlIGl0IGluIHRoZSByaWdodCBwbGFjZS5cbiAgICAgICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0Um9vbUFjY291bnREYXRhKHJvb21JZCwgXCJvcmcubWF0cml4LnJvb20uY29sb3Jfc2NoZW1lXCIsIG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBhbGxvd2VkIHdpZGdldHNcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcImFsbG93ZWRXaWRnZXRzXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0Um9vbUFjY291bnREYXRhKHJvb21JZCwgQUxMT1dFRF9XSURHRVRTX0VWRU5UX1RZUEUsIG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLl9nZXRTZXR0aW5ncyhyb29tSWQpIHx8IHt9O1xuICAgICAgICBjb250ZW50W3NldHRpbmdOYW1lXSA9IG5ld1ZhbHVlO1xuICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiLCBjb250ZW50KTtcbiAgICB9XG5cbiAgICBjYW5TZXRWYWx1ZShzZXR0aW5nTmFtZSwgcm9vbUlkKSB7XG4gICAgICAgIGNvbnN0IHJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShyb29tSWQpO1xuXG4gICAgICAgIC8vIElmIHRoZXkgaGF2ZSB0aGUgcm9vbSwgdGhleSBjYW4gc2V0IHRoZWlyIG93biBhY2NvdW50IGRhdGFcbiAgICAgICAgcmV0dXJuIHJvb20gIT09IHVuZGVmaW5lZCAmJiByb29tICE9PSBudWxsO1xuICAgIH1cblxuICAgIGlzU3VwcG9ydGVkKCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHJldHVybiBjbGkgIT09IHVuZGVmaW5lZCAmJiBjbGkgIT09IG51bGw7XG4gICAgfVxuXG4gICAgX2dldFNldHRpbmdzKHJvb21JZCwgZXZlbnRUeXBlID0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIpIHtcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHJvb21JZCk7XG4gICAgICAgIGlmICghcm9vbSkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3QgZXZlbnQgPSByb29tLmdldEFjY291bnREYXRhKGV2ZW50VHlwZSk7XG4gICAgICAgIGlmICghZXZlbnQgfHwgIWV2ZW50LmdldENvbnRlbnQoKSkgcmV0dXJuIG51bGw7XG4gICAgICAgIHJldHVybiBldmVudC5nZXRDb250ZW50KCk7XG4gICAgfVxufVxuIl19