"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _SettingsStore = require("../SettingsStore");

/*
Copyright 2017 Travis Ralston
Copyright 2019 New Vector Ltd.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const BREADCRUMBS_LEGACY_EVENT_TYPE = "im.vector.riot.breadcrumb_rooms";
const BREADCRUMBS_EVENT_TYPE = "im.vector.setting.breadcrumbs";
const BREADCRUMBS_EVENT_TYPES = [BREADCRUMBS_LEGACY_EVENT_TYPE, BREADCRUMBS_EVENT_TYPE];
const INTEG_PROVISIONING_EVENT_TYPE = "im.vector.setting.integration_provisioning";
/**
 * Gets and sets settings at the "account" level for the current user.
 * This handler does not make use of the roomId parameter.
 */

class AccountSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchManager) {
    super();
    this._watchers = watchManager;
    this._onAccountData = this._onAccountData.bind(this);
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener("accountData", this._onAccountData);
    }

    newClient.on("accountData", this._onAccountData);
  }

  _onAccountData(event) {
    if (event.getType() === "org.matrix.preview_urls") {
      let val = event.getContent()['disable'];

      if (typeof val !== "boolean") {
        val = null;
      } else {
        val = !val;
      }

      this._watchers.notifyUpdate("urlPreviewsEnabled", null, _SettingsStore.SettingLevel.ACCOUNT, val);
    } else if (event.getType() === "im.vector.web.settings") {
      // We can't really discern what changed, so trigger updates for everything
      for (const settingName of Object.keys(event.getContent())) {
        const val = event.getContent()[settingName];

        this._watchers.notifyUpdate(settingName, null, _SettingsStore.SettingLevel.ACCOUNT, val);
      }
    } else if (BREADCRUMBS_EVENT_TYPES.includes(event.getType())) {
      this._notifyBreadcrumbsUpdate(event);
    } else if (event.getType() === INTEG_PROVISIONING_EVENT_TYPE) {
      const val = event.getContent()['enabled'];

      this._watchers.notifyUpdate("integrationProvisioning", null, _SettingsStore.SettingLevel.ACCOUNT, val);
    }
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings("org.matrix.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    } // Special case for breadcrumbs


    if (settingName === "breadcrumb_rooms") {
      let content = this._getSettings(BREADCRUMBS_EVENT_TYPE);

      if (!content || !content['recent_rooms']) {
        content = this._getSettings(BREADCRUMBS_LEGACY_EVENT_TYPE); // This is a bit of a hack, but it makes things slightly easier

        if (content) content['recent_rooms'] = content['rooms'];
      }

      return content && content['recent_rooms'] ? content['recent_rooms'] : [];
    } // Special case integration manager provisioning


    if (settingName === "integrationProvisioning") {
      const content = this._getSettings(INTEG_PROVISIONING_EVENT_TYPE);

      return content ? content['enabled'] : null;
    }

    const settings = this._getSettings() || {};
    let preferredValue = settings[settingName];

    if (preferredValue === null || preferredValue === undefined) {
      // Honour the old setting on read only
      if (settingName === "hideAvatarChanges" || settingName === "hideDisplaynameChanges") {
        preferredValue = settings["hideAvatarDisplaynameChanges"];
      }
    }

    return preferredValue;
  }

  setValue(settingName, roomId, newValue) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this._getSettings("org.matrix.preview_urls") || {};
      content['disable'] = !newValue;
      return _MatrixClientPeg.MatrixClientPeg.get().setAccountData("org.matrix.preview_urls", content);
    } // Special case for breadcrumbs


    if (settingName === "breadcrumb_rooms") {
      // We read the value first just to make sure we preserve whatever random keys might be present.
      let content = this._getSettings(BREADCRUMBS_EVENT_TYPE);

      if (!content || !content['recent_rooms']) {
        content = this._getSettings(BREADCRUMBS_LEGACY_EVENT_TYPE);
      }

      if (!content) content = {}; // If we still don't have content, make some

      content['recent_rooms'] = newValue;
      return _MatrixClientPeg.MatrixClientPeg.get().setAccountData(BREADCRUMBS_EVENT_TYPE, content);
    } // Special case integration manager provisioning


    if (settingName === "integrationProvisioning") {
      const content = this._getSettings(INTEG_PROVISIONING_EVENT_TYPE) || {};
      content['enabled'] = newValue;
      return _MatrixClientPeg.MatrixClientPeg.get().setAccountData(INTEG_PROVISIONING_EVENT_TYPE, content);
    }

    const content = this._getSettings() || {};
    content[settingName] = newValue;
    return _MatrixClientPeg.MatrixClientPeg.get().setAccountData("im.vector.web.settings", content);
  }

  canSetValue(settingName, roomId) {
    return true; // It's their account, so they should be able to
  }

  isSupported() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    return cli !== undefined && cli !== null;
  }

  _getSettings(eventType = "im.vector.web.settings") {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (!cli) return null;
    const event = cli.getAccountData(eventType);
    if (!event || !event.getContent()) return null;
    return event.getContent();
  }

  _notifyBreadcrumbsUpdate(event) {
    let val = [];

    if (event.getType() === BREADCRUMBS_LEGACY_EVENT_TYPE) {
      // This seems fishy - try and get the event for the new rooms
      const newType = this._getSettings(BREADCRUMBS_EVENT_TYPE);

      if (newType) val = newType['recent_rooms'];else val = event.getContent()['rooms'];
    } else if (event.getType() === BREADCRUMBS_EVENT_TYPE) {
      val = event.getContent()['recent_rooms'];
    } else {
      return; // for sanity, not because we expect to be here.
    }

    this._watchers.notifyUpdate("breadcrumb_rooms", null, _SettingsStore.SettingLevel.ACCOUNT, val || []);
  }

}

exports.default = AccountSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9oYW5kbGVycy9BY2NvdW50U2V0dGluZ3NIYW5kbGVyLmpzIl0sIm5hbWVzIjpbIkJSRUFEQ1JVTUJTX0xFR0FDWV9FVkVOVF9UWVBFIiwiQlJFQURDUlVNQlNfRVZFTlRfVFlQRSIsIkJSRUFEQ1JVTUJTX0VWRU5UX1RZUEVTIiwiSU5URUdfUFJPVklTSU9OSU5HX0VWRU5UX1RZUEUiLCJBY2NvdW50U2V0dGluZ3NIYW5kbGVyIiwiTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJ3YXRjaE1hbmFnZXIiLCJfd2F0Y2hlcnMiLCJfb25BY2NvdW50RGF0YSIsImJpbmQiLCJpbml0TWF0cml4Q2xpZW50Iiwib2xkQ2xpZW50IiwibmV3Q2xpZW50IiwicmVtb3ZlTGlzdGVuZXIiLCJvbiIsImV2ZW50IiwiZ2V0VHlwZSIsInZhbCIsImdldENvbnRlbnQiLCJub3RpZnlVcGRhdGUiLCJTZXR0aW5nTGV2ZWwiLCJBQ0NPVU5UIiwic2V0dGluZ05hbWUiLCJPYmplY3QiLCJrZXlzIiwiaW5jbHVkZXMiLCJfbm90aWZ5QnJlYWRjcnVtYnNVcGRhdGUiLCJnZXRWYWx1ZSIsInJvb21JZCIsImNvbnRlbnQiLCJfZ2V0U2V0dGluZ3MiLCJzZXR0aW5ncyIsInByZWZlcnJlZFZhbHVlIiwidW5kZWZpbmVkIiwic2V0VmFsdWUiLCJuZXdWYWx1ZSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsInNldEFjY291bnREYXRhIiwiY2FuU2V0VmFsdWUiLCJpc1N1cHBvcnRlZCIsImNsaSIsImV2ZW50VHlwZSIsImdldEFjY291bnREYXRhIiwibmV3VHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQW5CQTs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQSxNQUFNQSw2QkFBNkIsR0FBRyxpQ0FBdEM7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRywrQkFBL0I7QUFDQSxNQUFNQyx1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QUFDSCxLQUZNLE1BRUE7QUFDSCxhQURHLENBQ0s7QUFDWDs7QUFDRCxTQUFLWCxTQUFMLENBQWVZLFlBQWYsQ0FBNEIsa0JBQTVCLEVBQWdELElBQWhELEVBQXNEQyw0QkFBYUMsT0FBbkUsRUFBNEVKLEdBQUcsSUFBSSxFQUFuRjtBQUNIOztBQWxKaUYiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTcgVHJhdmlzIFJhbHN0b25cbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7TWF0cml4Q2xpZW50UGVnfSBmcm9tICcuLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlciBmcm9tIFwiLi9NYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXJcIjtcbmltcG9ydCB7U2V0dGluZ0xldmVsfSBmcm9tIFwiLi4vU2V0dGluZ3NTdG9yZVwiO1xuXG5jb25zdCBCUkVBRENSVU1CU19MRUdBQ1lfRVZFTlRfVFlQRSA9IFwiaW0udmVjdG9yLnJpb3QuYnJlYWRjcnVtYl9yb29tc1wiO1xuY29uc3QgQlJFQURDUlVNQlNfRVZFTlRfVFlQRSA9IFwiaW0udmVjdG9yLnNldHRpbmcuYnJlYWRjcnVtYnNcIjtcbmNvbnN0IEJSRUFEQ1JVTUJTX0VWRU5UX1RZUEVTID0gW0JSRUFEQ1JVTUJTX0xFR0FDWV9FVkVOVF9UWVBFLCBCUkVBRENSVU1CU19FVkVOVF9UWVBFXTtcblxuY29uc3QgSU5URUdfUFJPVklTSU9OSU5HX0VWRU5UX1RZUEUgPSBcImltLnZlY3Rvci5zZXR0aW5nLmludGVncmF0aW9uX3Byb3Zpc2lvbmluZ1wiO1xuXG4vKipcbiAqIEdldHMgYW5kIHNldHMgc2V0dGluZ3MgYXQgdGhlIFwiYWNjb3VudFwiIGxldmVsIGZvciB0aGUgY3VycmVudCB1c2VyLlxuICogVGhpcyBoYW5kbGVyIGRvZXMgbm90IG1ha2UgdXNlIG9mIHRoZSByb29tSWQgcGFyYW1ldGVyLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBY2NvdW50U2V0dGluZ3NIYW5kbGVyIGV4dGVuZHMgTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIHtcbiAgICBjb25zdHJ1Y3Rvcih3YXRjaE1hbmFnZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl93YXRjaGVycyA9IHdhdGNoTWFuYWdlcjtcbiAgICAgICAgdGhpcy5fb25BY2NvdW50RGF0YSA9IHRoaXMuX29uQWNjb3VudERhdGEuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBpbml0TWF0cml4Q2xpZW50KG9sZENsaWVudCwgbmV3Q2xpZW50KSB7XG4gICAgICAgIGlmIChvbGRDbGllbnQpIHtcbiAgICAgICAgICAgIG9sZENsaWVudC5yZW1vdmVMaXN0ZW5lcihcImFjY291bnREYXRhXCIsIHRoaXMuX29uQWNjb3VudERhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3Q2xpZW50Lm9uKFwiYWNjb3VudERhdGFcIiwgdGhpcy5fb25BY2NvdW50RGF0YSk7XG4gICAgfVxuXG4gICAgX29uQWNjb3VudERhdGEoZXZlbnQpIHtcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJvcmcubWF0cml4LnByZXZpZXdfdXJsc1wiKSB7XG4gICAgICAgICAgICBsZXQgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydkaXNhYmxlJ107XG4gICAgICAgICAgICBpZiAodHlwZW9mKHZhbCkgIT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgICAgICAgdmFsID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsID0gIXZhbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fd2F0Y2hlcnMubm90aWZ5VXBkYXRlKFwidXJsUHJldmlld3NFbmFibGVkXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCB2YWwpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIpIHtcbiAgICAgICAgICAgIC8vIFdlIGNhbid0IHJlYWxseSBkaXNjZXJuIHdoYXQgY2hhbmdlZCwgc28gdHJpZ2dlciB1cGRhdGVzIGZvciBldmVyeXRoaW5nXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNldHRpbmdOYW1lIG9mIE9iamVjdC5rZXlzKGV2ZW50LmdldENvbnRlbnQoKSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBldmVudC5nZXRDb250ZW50KClbc2V0dGluZ05hbWVdO1xuICAgICAgICAgICAgICAgIHRoaXMuX3dhdGNoZXJzLm5vdGlmeVVwZGF0ZShzZXR0aW5nTmFtZSwgbnVsbCwgU2V0dGluZ0xldmVsLkFDQ09VTlQsIHZhbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoQlJFQURDUlVNQlNfRVZFTlRfVFlQRVMuaW5jbHVkZXMoZXZlbnQuZ2V0VHlwZSgpKSkge1xuICAgICAgICAgICAgdGhpcy5fbm90aWZ5QnJlYWRjcnVtYnNVcGRhdGUoZXZlbnQpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gSU5URUdfUFJPVklTSU9OSU5HX0VWRU5UX1RZUEUpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2ZW50LmdldENvbnRlbnQoKVsnZW5hYmxlZCddO1xuICAgICAgICAgICAgdGhpcy5fd2F0Y2hlcnMubm90aWZ5VXBkYXRlKFwiaW50ZWdyYXRpb25Qcm92aXNpb25pbmdcIiwgbnVsbCwgU2V0dGluZ0xldmVsLkFDQ09VTlQsIHZhbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRWYWx1ZShzZXR0aW5nTmFtZSwgcm9vbUlkKSB7XG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBVUkwgcHJldmlld3NcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcInVybFByZXZpZXdzRW5hYmxlZFwiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3MoXCJvcmcubWF0cml4LnByZXZpZXdfdXJsc1wiKSB8fCB7fTtcblxuICAgICAgICAgICAgLy8gQ2hlY2sgdG8gbWFrZSBzdXJlIHRoYXQgd2UgYWN0dWFsbHkgZ290IGEgYm9vbGVhblxuICAgICAgICAgICAgaWYgKHR5cGVvZihjb250ZW50WydkaXNhYmxlJ10pICE9PSBcImJvb2xlYW5cIikgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICByZXR1cm4gIWNvbnRlbnRbJ2Rpc2FibGUnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNwZWNpYWwgY2FzZSBmb3IgYnJlYWRjcnVtYnNcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcImJyZWFkY3J1bWJfcm9vbXNcIikge1xuICAgICAgICAgICAgbGV0IGNvbnRlbnQgPSB0aGlzLl9nZXRTZXR0aW5ncyhCUkVBRENSVU1CU19FVkVOVF9UWVBFKTtcbiAgICAgICAgICAgIGlmICghY29udGVudCB8fCAhY29udGVudFsncmVjZW50X3Jvb21zJ10pIHtcbiAgICAgICAgICAgICAgICBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3MoQlJFQURDUlVNQlNfTEVHQUNZX0VWRU5UX1RZUEUpO1xuXG4gICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGJpdCBvZiBhIGhhY2ssIGJ1dCBpdCBtYWtlcyB0aGluZ3Mgc2xpZ2h0bHkgZWFzaWVyXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQpIGNvbnRlbnRbJ3JlY2VudF9yb29tcyddID0gY29udGVudFsncm9vbXMnXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQgJiYgY29udGVudFsncmVjZW50X3Jvb21zJ10gPyBjb250ZW50WydyZWNlbnRfcm9vbXMnXSA6IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGludGVncmF0aW9uIG1hbmFnZXIgcHJvdmlzaW9uaW5nXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJpbnRlZ3JhdGlvblByb3Zpc2lvbmluZ1wiKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5fZ2V0U2V0dGluZ3MoSU5URUdfUFJPVklTSU9OSU5HX0VWRU5UX1RZUEUpO1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQgPyBjb250ZW50WydlbmFibGVkJ10gOiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLl9nZXRTZXR0aW5ncygpIHx8IHt9O1xuICAgICAgICBsZXQgcHJlZmVycmVkVmFsdWUgPSBzZXR0aW5nc1tzZXR0aW5nTmFtZV07XG5cbiAgICAgICAgaWYgKHByZWZlcnJlZFZhbHVlID09PSBudWxsIHx8IHByZWZlcnJlZFZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIC8vIEhvbm91ciB0aGUgb2xkIHNldHRpbmcgb24gcmVhZCBvbmx5XG4gICAgICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwiaGlkZUF2YXRhckNoYW5nZXNcIiB8fCBzZXR0aW5nTmFtZSA9PT0gXCJoaWRlRGlzcGxheW5hbWVDaGFuZ2VzXCIpIHtcbiAgICAgICAgICAgICAgICBwcmVmZXJyZWRWYWx1ZSA9IHNldHRpbmdzW1wiaGlkZUF2YXRhckRpc3BsYXluYW1lQ2hhbmdlc1wiXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcmVmZXJyZWRWYWx1ZTtcbiAgICB9XG5cbiAgICBzZXRWYWx1ZShzZXR0aW5nTmFtZSwgcm9vbUlkLCBuZXdWYWx1ZSkge1xuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgVVJMIHByZXZpZXdzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuX2dldFNldHRpbmdzKFwib3JnLm1hdHJpeC5wcmV2aWV3X3VybHNcIikgfHwge307XG4gICAgICAgICAgICBjb250ZW50WydkaXNhYmxlJ10gPSAhbmV3VmFsdWU7XG4gICAgICAgICAgICByZXR1cm4gTWF0cml4Q2xpZW50UGVnLmdldCgpLnNldEFjY291bnREYXRhKFwib3JnLm1hdHJpeC5wcmV2aWV3X3VybHNcIiwgY29udGVudCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgZm9yIGJyZWFkY3J1bWJzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJicmVhZGNydW1iX3Jvb21zXCIpIHtcbiAgICAgICAgICAgIC8vIFdlIHJlYWQgdGhlIHZhbHVlIGZpcnN0IGp1c3QgdG8gbWFrZSBzdXJlIHdlIHByZXNlcnZlIHdoYXRldmVyIHJhbmRvbSBrZXlzIG1pZ2h0IGJlIHByZXNlbnQuXG4gICAgICAgICAgICBsZXQgY29udGVudCA9IHRoaXMuX2dldFNldHRpbmdzKEJSRUFEQ1JVTUJTX0VWRU5UX1RZUEUpO1xuICAgICAgICAgICAgaWYgKCFjb250ZW50IHx8ICFjb250ZW50WydyZWNlbnRfcm9vbXMnXSkge1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSB0aGlzLl9nZXRTZXR0aW5ncyhCUkVBRENSVU1CU19MRUdBQ1lfRVZFTlRfVFlQRSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWNvbnRlbnQpIGNvbnRlbnQgPSB7fTsgLy8gSWYgd2Ugc3RpbGwgZG9uJ3QgaGF2ZSBjb250ZW50LCBtYWtlIHNvbWVcblxuICAgICAgICAgICAgY29udGVudFsncmVjZW50X3Jvb21zJ10gPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0QWNjb3VudERhdGEoQlJFQURDUlVNQlNfRVZFTlRfVFlQRSwgY29udGVudCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgaW50ZWdyYXRpb24gbWFuYWdlciBwcm92aXNpb25pbmdcbiAgICAgICAgaWYgKHNldHRpbmdOYW1lID09PSBcImludGVncmF0aW9uUHJvdmlzaW9uaW5nXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLl9nZXRTZXR0aW5ncyhJTlRFR19QUk9WSVNJT05JTkdfRVZFTlRfVFlQRSkgfHwge307XG4gICAgICAgICAgICBjb250ZW50WydlbmFibGVkJ10gPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0QWNjb3VudERhdGEoSU5URUdfUFJPVklTSU9OSU5HX0VWRU5UX1RZUEUsIGNvbnRlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuX2dldFNldHRpbmdzKCkgfHwge307XG4gICAgICAgIGNvbnRlbnRbc2V0dGluZ05hbWVdID0gbmV3VmFsdWU7XG4gICAgICAgIHJldHVybiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0QWNjb3VudERhdGEoXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCIsIGNvbnRlbnQpO1xuICAgIH1cblxuICAgIGNhblNldFZhbHVlKHNldHRpbmdOYW1lLCByb29tSWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7IC8vIEl0J3MgdGhlaXIgYWNjb3VudCwgc28gdGhleSBzaG91bGQgYmUgYWJsZSB0b1xuICAgIH1cblxuICAgIGlzU3VwcG9ydGVkKCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHJldHVybiBjbGkgIT09IHVuZGVmaW5lZCAmJiBjbGkgIT09IG51bGw7XG4gICAgfVxuXG4gICAgX2dldFNldHRpbmdzKGV2ZW50VHlwZSA9IFwiaW0udmVjdG9yLndlYi5zZXR0aW5nc1wiKSB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgaWYgKCFjbGkpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0gY2xpLmdldEFjY291bnREYXRhKGV2ZW50VHlwZSk7XG4gICAgICAgIGlmICghZXZlbnQgfHwgIWV2ZW50LmdldENvbnRlbnQoKSkgcmV0dXJuIG51bGw7XG4gICAgICAgIHJldHVybiBldmVudC5nZXRDb250ZW50KCk7XG4gICAgfVxuXG4gICAgX25vdGlmeUJyZWFkY3J1bWJzVXBkYXRlKGV2ZW50KSB7XG4gICAgICAgIGxldCB2YWwgPSBbXTtcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gQlJFQURDUlVNQlNfTEVHQUNZX0VWRU5UX1RZUEUpIHtcbiAgICAgICAgICAgIC8vIFRoaXMgc2VlbXMgZmlzaHkgLSB0cnkgYW5kIGdldCB0aGUgZXZlbnQgZm9yIHRoZSBuZXcgcm9vbXNcbiAgICAgICAgICAgIGNvbnN0IG5ld1R5cGUgPSB0aGlzLl9nZXRTZXR0aW5ncyhCUkVBRENSVU1CU19FVkVOVF9UWVBFKTtcbiAgICAgICAgICAgIGlmIChuZXdUeXBlKSB2YWwgPSBuZXdUeXBlWydyZWNlbnRfcm9vbXMnXTtcbiAgICAgICAgICAgIGVsc2UgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydyb29tcyddO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gQlJFQURDUlVNQlNfRVZFTlRfVFlQRSkge1xuICAgICAgICAgICAgdmFsID0gZXZlbnQuZ2V0Q29udGVudCgpWydyZWNlbnRfcm9vbXMnXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybjsgLy8gZm9yIHNhbml0eSwgbm90IGJlY2F1c2Ugd2UgZXhwZWN0IHRvIGJlIGhlcmUuXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fd2F0Y2hlcnMubm90aWZ5VXBkYXRlKFwiYnJlYWRjcnVtYl9yb29tc1wiLCBudWxsLCBTZXR0aW5nTGV2ZWwuQUNDT1VOVCwgdmFsIHx8IFtdKTtcbiAgICB9XG59XG4iXX0=