"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _phonenumber = require("../../../phonenumber");

var _SdkConfig = _interopRequireDefault(require("../../../SdkConfig"));

var _languageHandler = require("../../../languageHandler");

/*
Copyright 2017 Vector Creations Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const COUNTRIES_BY_ISO2 = {};

for (const c of _phonenumber.COUNTRIES) {
  COUNTRIES_BY_ISO2[c.iso2] = c;
}

function countryMatchesSearchQuery(query, country) {
  // Remove '+' if present (when searching for a prefix)
  if (query[0] === '+') {
    query = query.slice(1);
  }

  if (country.name.toUpperCase().indexOf(query.toUpperCase()) == 0) return true;
  if (country.iso2 == query.toUpperCase()) return true;
  if (country.prefix.indexOf(query) !== -1) return true;
  return false;
}

class CountryDropdown extends _react.default.Component {
  constructor(props) {
    super(props);
    this._onSearchChange = this._onSearchChange.bind(this);
    this._onOptionChange = this._onOptionChange.bind(this);
    this._getShortOption = this._getShortOption.bind(this);
    let defaultCountry = _phonenumber.COUNTRIES[0];

    const defaultCountryCode = _SdkConfig.default.get()["defaultCountryCode"];

    if (defaultCountryCode) {
      const country = _phonenumber.COUNTRIES.find(c => c.iso2 === defaultCountryCode.toUpperCase());

      if (country) defaultCountry = country;
    }

    this.state = {
      searchQuery: '',
      defaultCountry
    };
  }

  componentDidMount() {
    if (!this.props.value) {
      // If no value is given, we start with the default
      // country selected, but our parent component
      // doesn't know this, therefore we do this.
      this.props.onOptionChange(this.state.defaultCountry);
    }
  }

  _onSearchChange(search) {
    this.setState({
      searchQuery: search
    });
  }

  _onOptionChange(iso2) {
    this.props.onOptionChange(COUNTRIES_BY_ISO2[iso2]);
  }

  _flagImgForIso2(iso2) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dropdown_option_emoji"
    }, (0, _phonenumber.getEmojiFlag)(iso2));
  }

  _getShortOption(iso2) {
    if (!this.props.isSmall) {
      return undefined;
    }

    let countryPrefix;

    if (this.props.showPrefix) {
      countryPrefix = '+' + COUNTRIES_BY_ISO2[iso2].prefix;
    }

    return /*#__PURE__*/_react.default.createElement("span", {
      className: "mx_CountryDropdown_shortOption"
    }, this._flagImgForIso2(iso2), countryPrefix);
  }

  render() {
    const Dropdown = sdk.getComponent('elements.Dropdown');
    let displayedCountries;

    if (this.state.searchQuery) {
      displayedCountries = _phonenumber.COUNTRIES.filter(countryMatchesSearchQuery.bind(this, this.state.searchQuery));

      if (this.state.searchQuery.length == 2 && COUNTRIES_BY_ISO2[this.state.searchQuery.toUpperCase()]) {
        // exact ISO2 country name match: make the first result the matches ISO2
        const matched = COUNTRIES_BY_ISO2[this.state.searchQuery.toUpperCase()];
        displayedCountries = displayedCountries.filter(c => {
          return c.iso2 != matched.iso2;
        });
        displayedCountries.unshift(matched);
      }
    } else {
      displayedCountries = _phonenumber.COUNTRIES;
    }

    const options = displayedCountries.map(country => {
      return /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CountryDropdown_option",
        key: country.iso2
      }, this._flagImgForIso2(country.iso2), country.name, " (+", country.prefix, ")");
    }); // default value here too, otherwise we need to handle null / undefined
    // values between mounting and the initial value propgating

    const value = this.props.value || this.state.defaultCountry.iso2;
    return /*#__PURE__*/_react.default.createElement(Dropdown, {
      id: "mx_CountryDropdown",
      className: this.props.className + " mx_CountryDropdown",
      onOptionChange: this._onOptionChange,
      onSearchChange: this._onSearchChange,
      menuWidth: 298,
      getShortOption: this._getShortOption,
      value: value,
      searchEnabled: true,
      disabled: this.props.disabled,
      label: (0, _languageHandler._t)("Country Dropdown")
    }, options);
  }

}

exports.default = CountryDropdown;
CountryDropdown.propTypes = {
  className: _propTypes.default.string,
  isSmall: _propTypes.default.bool,
  // if isSmall, show +44 in the selected value
  showPrefix: _propTypes.default.bool,
  onOptionChange: _propTypes.default.func.isRequired,
  value: _propTypes.default.string,
  disabled: _propTypes.default.bool
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2F1dGgvQ291bnRyeURyb3Bkb3duLmpzIl0sIm5hbWVzIjpbIkNPVU5UUklFU19CWV9JU08yIiwiYyIsIkNPVU5UUklFUyIsImlzbzIiLCJjb3VudHJ5TWF0Y2hlc1NlYXJjaFF1ZXJ5IiwicXVlcnkiLCJjb3VudHJ5Iiwic2xpY2UiLCJuYW1lIiwidG9VcHBlckNhc2UiLCJpbmRleE9mIiwicHJlZml4IiwiQ291bnRyeURyb3Bkb3duIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiX29uU2VhcmNoQ2hhbmdlIiwiYmluZCIsIl9vbk9wdGlvbkNoYW5nZSIsIl9nZXRTaG9ydE9wdGlvbiIsImRlZmF1bHRDb3VudHJ5IiwiZGVmYXVsdENvdW50cnlDb2RlIiwiU2RrQ29uZmlnIiwiZ2V0IiwiZmluZCIsInN0YXRlIiwic2VhcmNoUXVlcnkiLCJjb21wb25lbnREaWRNb3VudCIsInZhbHVlIiwib25PcHRpb25DaGFuZ2UiLCJzZWFyY2giLCJzZXRTdGF0ZSIsIl9mbGFnSW1nRm9ySXNvMiIsImlzU21hbGwiLCJ1bmRlZmluZWQiLCJjb3VudHJ5UHJlZml4Iiwic2hvd1ByZWZpeCIsInJlbmRlciIsIkRyb3Bkb3duIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiZGlzcGxheWVkQ291bnRyaWVzIiwiZmlsdGVyIiwibGVuZ3RoIiwibWF0Y2hlZCIsInVuc2hpZnQiLCJvcHRpb25zIiwibWFwIiwiY2xhc3NOYW1lIiwiZGlzYWJsZWQiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJib29sIiwiZnVuYyIsImlzUmVxdWlyZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQXZCQTs7Ozs7Ozs7Ozs7Ozs7O0FBeUJBLE1BQU1BLGlCQUFpQixHQUFHLEVBQTFCOztBQUNBLEtBQUssTUFBTUMsQ0FB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LElBQVYsQ0FBZUMsVUFMUDtBQU14QjNCLEVBQUFBLEtBQUssRUFBRXVCLG1CQUFVQyxNQU5PO0FBT3hCSCxFQUFBQSxRQUFRLEVBQUVFLG1CQUFVRTtBQVBJLENBQTVCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5cbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi8uLi8uLi9pbmRleCc7XG5cbmltcG9ydCB7Q09VTlRSSUVTLCBnZXRFbW9qaUZsYWd9IGZyb20gJy4uLy4uLy4uL3Bob25lbnVtYmVyJztcbmltcG9ydCBTZGtDb25maWcgZnJvbSBcIi4uLy4uLy4uL1Nka0NvbmZpZ1wiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5cbmNvbnN0IENPVU5UUklFU19CWV9JU08yID0ge307XG5mb3IgKGNvbnN0IGMgb2YgQ09VTlRSSUVTKSB7XG4gICAgQ09VTlRSSUVTX0JZX0lTTzJbYy5pc28yXSA9IGM7XG59XG5cbmZ1bmN0aW9uIGNvdW50cnlNYXRjaGVzU2VhcmNoUXVlcnkocXVlcnksIGNvdW50cnkpIHtcbiAgICAvLyBSZW1vdmUgJysnIGlmIHByZXNlbnQgKHdoZW4gc2VhcmNoaW5nIGZvciBhIHByZWZpeClcbiAgICBpZiAocXVlcnlbMF0gPT09ICcrJykge1xuICAgICAgICBxdWVyeSA9IHF1ZXJ5LnNsaWNlKDEpO1xuICAgIH1cblxuICAgIGlmIChjb3VudHJ5Lm5hbWUudG9VcHBlckNhc2UoKS5pbmRleE9mKHF1ZXJ5LnRvVXBwZXJDYXNlKCkpID09IDApIHJldHVybiB0cnVlO1xuICAgIGlmIChjb3VudHJ5LmlzbzIgPT0gcXVlcnkudG9VcHBlckNhc2UoKSkgcmV0dXJuIHRydWU7XG4gICAgaWYgKGNvdW50cnkucHJlZml4LmluZGV4T2YocXVlcnkpICE9PSAtMSkgcmV0dXJuIHRydWU7XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb3VudHJ5RHJvcGRvd24gZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5fb25TZWFyY2hDaGFuZ2UgPSB0aGlzLl9vblNlYXJjaENoYW5nZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLl9vbk9wdGlvbkNoYW5nZSA9IHRoaXMuX29uT3B0aW9uQ2hhbmdlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuX2dldFNob3J0T3B0aW9uID0gdGhpcy5fZ2V0U2hvcnRPcHRpb24uYmluZCh0aGlzKTtcblxuICAgICAgICBsZXQgZGVmYXVsdENvdW50cnkgPSBDT1VOVFJJRVNbMF07XG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb3VudHJ5Q29kZSA9IFNka0NvbmZpZy5nZXQoKVtcImRlZmF1bHRDb3VudHJ5Q29kZVwiXTtcbiAgICAgICAgaWYgKGRlZmF1bHRDb3VudHJ5Q29kZSkge1xuICAgICAgICAgICAgY29uc3QgY291bnRyeSA9IENPVU5UUklFUy5maW5kKGMgPT4gYy5pc28yID09PSBkZWZhdWx0Q291bnRyeUNvZGUudG9VcHBlckNhc2UoKSk7XG4gICAgICAgICAgICBpZiAoY291bnRyeSkgZGVmYXVsdENvdW50cnkgPSBjb3VudHJ5O1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNlYXJjaFF1ZXJ5OiAnJyxcbiAgICAgICAgICAgIGRlZmF1bHRDb3VudHJ5LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMudmFsdWUpIHtcbiAgICAgICAgICAgIC8vIElmIG5vIHZhbHVlIGlzIGdpdmVuLCB3ZSBzdGFydCB3aXRoIHRoZSBkZWZhdWx0XG4gICAgICAgICAgICAvLyBjb3VudHJ5IHNlbGVjdGVkLCBidXQgb3VyIHBhcmVudCBjb21wb25lbnRcbiAgICAgICAgICAgIC8vIGRvZXNuJ3Qga25vdyB0aGlzLCB0aGVyZWZvcmUgd2UgZG8gdGhpcy5cbiAgICAgICAgICAgIHRoaXMucHJvcHMub25PcHRpb25DaGFuZ2UodGhpcy5zdGF0ZS5kZWZhdWx0Q291bnRyeSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfb25TZWFyY2hDaGFuZ2Uoc2VhcmNoKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2VhcmNoUXVlcnk6IHNlYXJjaCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX29uT3B0aW9uQ2hhbmdlKGlzbzIpIHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbk9wdGlvbkNoYW5nZShDT1VOVFJJRVNfQllfSVNPMltpc28yXSk7XG4gICAgfVxuXG4gICAgX2ZsYWdJbWdGb3JJc28yKGlzbzIpIHtcbiAgICAgICAgcmV0dXJuIDxkaXYgY2xhc3NOYW1lPVwibXhfRHJvcGRvd25fb3B0aW9uX2Vtb2ppXCI+eyBnZXRFbW9qaUZsYWcoaXNvMikgfTwvZGl2PjtcbiAgICB9XG5cbiAgICBfZ2V0U2hvcnRPcHRpb24oaXNvMikge1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMuaXNTbWFsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgY291bnRyeVByZWZpeDtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuc2hvd1ByZWZpeCkge1xuICAgICAgICAgICAgY291bnRyeVByZWZpeCA9ICcrJyArIENPVU5UUklFU19CWV9JU08yW2lzbzJdLnByZWZpeDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gPHNwYW4gY2xhc3NOYW1lPVwibXhfQ291bnRyeURyb3Bkb3duX3Nob3J0T3B0aW9uXCI+XG4gICAgICAgICAgICB7IHRoaXMuX2ZsYWdJbWdGb3JJc28yKGlzbzIpIH1cbiAgICAgICAgICAgIHsgY291bnRyeVByZWZpeCB9XG4gICAgICAgIDwvc3Bhbj47XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBEcm9wZG93biA9IHNkay5nZXRDb21wb25lbnQoJ2VsZW1lbnRzLkRyb3Bkb3duJyk7XG5cbiAgICAgICAgbGV0IGRpc3BsYXllZENvdW50cmllcztcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2VhcmNoUXVlcnkpIHtcbiAgICAgICAgICAgIGRpc3BsYXllZENvdW50cmllcyA9IENPVU5UUklFUy5maWx0ZXIoXG4gICAgICAgICAgICAgICAgY291bnRyeU1hdGNoZXNTZWFyY2hRdWVyeS5iaW5kKHRoaXMsIHRoaXMuc3RhdGUuc2VhcmNoUXVlcnkpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlYXJjaFF1ZXJ5Lmxlbmd0aCA9PSAyICYmXG4gICAgICAgICAgICAgICAgQ09VTlRSSUVTX0JZX0lTTzJbdGhpcy5zdGF0ZS5zZWFyY2hRdWVyeS50b1VwcGVyQ2FzZSgpXVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgLy8gZXhhY3QgSVNPMiBjb3VudHJ5IG5hbWUgbWF0Y2g6IG1ha2UgdGhlIGZpcnN0IHJlc3VsdCB0aGUgbWF0Y2hlcyBJU08yXG4gICAgICAgICAgICAgICAgY29uc3QgbWF0Y2hlZCA9IENPVU5UUklFU19CWV9JU08yW3RoaXMuc3RhdGUuc2VhcmNoUXVlcnkudG9VcHBlckNhc2UoKV07XG4gICAgICAgICAgICAgICAgZGlzcGxheWVkQ291bnRyaWVzID0gZGlzcGxheWVkQ291bnRyaWVzLmZpbHRlcigoYykgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYy5pc28yICE9IG1hdGNoZWQuaXNvMjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBkaXNwbGF5ZWRDb3VudHJpZXMudW5zaGlmdChtYXRjaGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpc3BsYXllZENvdW50cmllcyA9IENPVU5UUklFUztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBkaXNwbGF5ZWRDb3VudHJpZXMubWFwKChjb3VudHJ5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9XCJteF9Db3VudHJ5RHJvcGRvd25fb3B0aW9uXCIga2V5PXtjb3VudHJ5LmlzbzJ9PlxuICAgICAgICAgICAgICAgIHsgdGhpcy5fZmxhZ0ltZ0ZvcklzbzIoY291bnRyeS5pc28yKSB9XG4gICAgICAgICAgICAgICAgeyBjb3VudHJ5Lm5hbWUgfSAoK3sgY291bnRyeS5wcmVmaXggfSlcbiAgICAgICAgICAgIDwvZGl2PjtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gZGVmYXVsdCB2YWx1ZSBoZXJlIHRvbywgb3RoZXJ3aXNlIHdlIG5lZWQgdG8gaGFuZGxlIG51bGwgLyB1bmRlZmluZWRcbiAgICAgICAgLy8gdmFsdWVzIGJldHdlZW4gbW91bnRpbmcgYW5kIHRoZSBpbml0aWFsIHZhbHVlIHByb3BnYXRpbmdcbiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnByb3BzLnZhbHVlIHx8IHRoaXMuc3RhdGUuZGVmYXVsdENvdW50cnkuaXNvMjtcblxuICAgICAgICByZXR1cm4gPERyb3Bkb3duXG4gICAgICAgICAgICBpZD1cIm14X0NvdW50cnlEcm9wZG93blwiXG4gICAgICAgICAgICBjbGFzc05hbWU9e3RoaXMucHJvcHMuY2xhc3NOYW1lICsgXCIgbXhfQ291bnRyeURyb3Bkb3duXCJ9XG4gICAgICAgICAgICBvbk9wdGlvbkNoYW5nZT17dGhpcy5fb25PcHRpb25DaGFuZ2V9XG4gICAgICAgICAgICBvblNlYXJjaENoYW5nZT17dGhpcy5fb25TZWFyY2hDaGFuZ2V9XG4gICAgICAgICAgICBtZW51V2lkdGg9ezI5OH1cbiAgICAgICAgICAgIGdldFNob3J0T3B0aW9uPXt0aGlzLl9nZXRTaG9ydE9wdGlvbn1cbiAgICAgICAgICAgIHZhbHVlPXt2YWx1ZX1cbiAgICAgICAgICAgIHNlYXJjaEVuYWJsZWQ9e3RydWV9XG4gICAgICAgICAgICBkaXNhYmxlZD17dGhpcy5wcm9wcy5kaXNhYmxlZH1cbiAgICAgICAgICAgIGxhYmVsPXtfdChcIkNvdW50cnkgRHJvcGRvd25cIil9XG4gICAgICAgID5cbiAgICAgICAgICAgIHsgb3B0aW9ucyB9XG4gICAgICAgIDwvRHJvcGRvd24+O1xuICAgIH1cbn1cblxuQ291bnRyeURyb3Bkb3duLnByb3BUeXBlcyA9IHtcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgaXNTbWFsbDogUHJvcFR5cGVzLmJvb2wsXG4gICAgLy8gaWYgaXNTbWFsbCwgc2hvdyArNDQgaW4gdGhlIHNlbGVjdGVkIHZhbHVlXG4gICAgc2hvd1ByZWZpeDogUHJvcFR5cGVzLmJvb2wsXG4gICAgb25PcHRpb25DaGFuZ2U6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgdmFsdWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxufTtcbiJdfQ==