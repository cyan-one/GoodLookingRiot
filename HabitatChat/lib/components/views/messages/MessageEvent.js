"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _Mjolnir = require("../../../mjolnir/Mjolnir");

var _RedactedBody = _interopRequireDefault(require("./RedactedBody"));

var _UnknownBody = _interopRequireDefault(require("./UnknownBody"));

/*
Copyright 2015, 2016 OpenMarket Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
var _default = (0, _createReactClass.default)({
  displayName: 'MessageEvent',
  propTypes: {
    /* the MatrixEvent to show */
    mxEvent: _propTypes.default.object.isRequired,

    /* a list of words to highlight */
    highlights: _propTypes.default.array,

    /* link URL for the highlights */
    highlightLink: _propTypes.default.string,

    /* should show URL previews for this event */
    showUrlPreview: _propTypes.default.bool,

    /* callback called when dynamic content in events are loaded */
    onHeightChanged: _propTypes.default.func,

    /* the shape of the tile, used */
    tileShape: _propTypes.default.string,

    /* the maximum image height to use, if the event is an image */
    maxImageHeight: _propTypes.default.number
  },
  // TODO: [REACT-WARNING] Replace component with real class, use constructor for refs
  UNSAFE_componentWillMount: function () {
    this._body = (0, _react.createRef)();
  },
  getEventTileOps: function () {
    return this._body.current && this._body.current.getEventTileOps ? this._body.current.getEventTileOps() : null;
  },
  onTileUpdate: function () {
    this.forceUpdate();
  },
  render: function () {
    const bodyTypes = {
      'm.text': sdk.getComponent('messages.TextualBody'),
      'm.notice': sdk.getComponent('messages.TextualBody'),
      'm.emote': sdk.getComponent('messages.TextualBody'),
      'm.image': sdk.getComponent('messages.MImageBody'),
      'm.file': sdk.getComponent('messages.MFileBody'),
      'm.audio': sdk.getComponent('messages.MAudioBody'),
      'm.video': sdk.getComponent('messages.MVideoBody')
    };
    const evTypes = {
      'm.sticker': sdk.getComponent('messages.MStickerBody')
    };
    const content = this.props.mxEvent.getContent();
    const type = this.props.mxEvent.getType();
    const msgtype = content.msgtype;
    let BodyType = _RedactedBody.default;

    if (!this.props.mxEvent.isRedacted()) {
      // only resolve BodyType if event is not redacted
      if (type && evTypes[type]) {
        BodyType = evTypes[type];
      } else if (msgtype && bodyTypes[msgtype]) {
        BodyType = bodyTypes[msgtype];
      } else if (content.url) {
        // Fallback to MFileBody if there's a content URL
        BodyType = bodyTypes['m.file'];
      } else {
        // Fallback to UnknownBody otherwise if not redacted
        BodyType = _UnknownBody.default;
      }
    }

    if (_SettingsStore.default.isFeatureEnabled("feature_mjolnir")) {
      const key = "mx_mjolnir_render_".concat(this.props.mxEvent.getRoomId(), "__").concat(this.props.mxEvent.getId());
      const allowRender = localStorage.getItem(key) === "true";

      if (!allowRender) {
        const userDomain = this.props.mxEvent.getSender().split(':').slice(1).join(':');

        const userBanned = _Mjolnir.Mjolnir.sharedInstance().isUserBanned(this.props.mxEvent.getSender());

        const serverBanned = _Mjolnir.Mjolnir.sharedInstance().isServerBanned(userDomain);

        if (userBanned || serverBanned) {
          BodyType = sdk.getComponent('messages.MjolnirBody');
        }
      }
    }

    return /*#__PURE__*/_react.default.createElement(BodyType, {
      ref: this._body,
      mxEvent: this.props.mxEvent,
      highlights: this.props.highlights,
      highlightLink: this.props.highlightLink,
      showUrlPreview: this.props.showUrlPreview,
      tileShape: this.props.tileShape,
      maxImageHeight: this.props.maxImageHeight,
      replacingEventId: this.props.replacingEventId,
      editState: this.props.editState,
      onHeightChanged: this.props.onHeightChanged,
      onMessageAllowed: this.onTileUpdate
    });
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01lc3NhZ2VFdmVudC5qcyJdLCJuYW1lcyI6WyJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsIm14RXZlbnQiLCJQcm9wVHlwZXMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwiaGlnaGxpZ2h0cyIsImFycmF5IiwiaGlnaGxpZ2h0TGluayIsInN0cmluZyIsInNob3dVcmxQcmV2aWV3IiwiYm9vbCIsIm9uSGVpZ2h0Q2hhbmdlZCIsImZ1bmMiLCJ0aWxlU2hhcGUiLCJtYXhJbWFnZUhlaWdodCIsIm51bWJlciIsIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiLCJfYm9keSIsImdldEV2ZW50VGlsZU9wcyIsImN1cnJlbnQiLCJvblRpbGVVcGRhdGUiLCJmb3JjZVVwZGF0ZSIsInJlbmRlciIsImJvZHlUeXBlcyIsInNkayIsImdldENvbXBvbmVudCIsImV2VHlwZXMiLCJjb250ZW50IiwicHJvcHMiLCJnZXRDb250ZW50IiwidHlwZSIsImdldFR5cGUiLCJtc2d0eXBlIiwiQm9keVR5cGUiLCJSZWRhY3RlZEJvZHkiLCJpc1JlZGFjdGVkIiwidXJsIiwiVW5rbm93bkJvZHkiLCJTZXR0aW5nc1N0b3JlIiwiaXNGZWF0dXJlRW5hYmxlZCIsImtleSIsImdldFJvb21JZCIsImdldElkIiwiYWxsb3dSZW5kZXIiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwidXNlckRvbWFpbiIsImdldFNlbmRlciIsInNwbGl0Iiwic2xpY2UiLCJqb2luIiwidXNlckJhbm5lZCIsIk1qb2xuaXIiLCJzaGFyZWRJbnN0YW5jZSIsImlzVXNlckJhbm5lZCIsInNlcnZlckJhbm5lZCIsImlzU2VydmVyQmFubmVkIiwicmVwbGFjaW5nRXZlbnRJZCIsImVkaXRTdGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBdkJBOzs7Ozs7Ozs7Ozs7Ozs7ZUF5QmUsK0JBQWlCO0FBQzVCQSxFQUFBQSxXQUFXLEVBQUUsY0FEZTtBQUc1QkMsRUFBQUEsU0FBUyxFQUFFO0FBQ1A7QUFDQUMsSUFBQUEsT0FBTyxFQUFFQyxtQkFBVUMsTUFBVixDQUFpQkMsVUFGbkI7O0FBSVA7QUFDQUMsSUFBQUEsVUFBVSxFQUFFSCxtQkFBVUksS0FMZjs7QUFPUDtBQUNBQyxJQUFBQSxhQUFhLEVBQUVMLG1CQUFVTSxNQVJsQjs7QUFVUDtBQUNBQyxJQUFBQSxjQUFjLEVBQUVQLG1CQUFVUSxJQVhuQjs7QUFhUDtBQUNBQyxJQUFBQSxlQUFlLEVBQUVULG1CQUFVVSxJQWRwQjs7QUFnQlA7QUFDQUMsSUFBQUEsU0FBUyxFQUFFWCxtQkFBVU0sTUFqQmQ7O0FBbUJQO0FBQ0FNLElBQUFBLGNBQWMsRUFBRVosbUJBQVVhO0FBcEJuQixHQUhpQjtBQTBCNUI7QUFDQUMsRUFBQUEseUJBQXlCLEVBQUUsWUFBVztBQUNsQyxTQUFLQyxLQUFMLEdBQWEsdUJBQWI7QUFDSCxHQTdCMkI7QUErQjVCQyxFQUFBQSxlQUFlLEVBQUUsWUFBVztBQUN4QixXQUFPLEtBQUtELEtBQUwsQ0FBV0UsT0FBWCxJQUFzQixLQUFLRixLQUFMLENBQVdFLE9BQVgsQ0FBbUJELGVBQXpDLEdBQTJELEtBQUtELEtBQUwsQ0FBV0UsT0FBWCxDQUFtQkQsZUFBbkIsRUFBM0QsR0FBa0csSUFBekc7QUFDSCxHQWpDMkI7QUFtQzVCRSxFQUFBQSxZQUFZLEVBQUUsWUFBVztBQUNyQixTQUFLQyxXQUFMO0FBQ0gsR0FyQzJCO0FBdUM1QkMsRUFBQUEsTUFBTSxFQUFFLFlBQVc7QUFDZixVQUFNQyxTQUFTLEdBQUc7QUFDZCxnQkFBVUMsR0FBRyxDQUFDQyxZQUFKLENBQWlCLHNCQUFqQixDQURJO0FBRWQsa0JBQVlELEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixzQkFBakIsQ0FGRTtBQUdkLGlCQUFXRCxHQUFHLENBQUNDLFlBQUosQ0FBaUIsc0JBQWpCLENBSEc7QUFJZCxpQkFBV0QsR0FBRyxDQUFDQyxZQUFKLENBQWlCLHFCQUFqQixDQUpHO0FBS2QsZ0JBQVVELEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixvQkFBakIsQ0FMSTtBQU1kLGlCQUFXRCxHQUFHLENBQUNDLFlBQUosQ0FBaUIscUJBQWpCLENBTkc7QUFPZCxpQkFBV0QsR0FBRyxDQUFDQyxZQUFKLENBQWlCLHFCQUFqQjtBQVBHLEtBQWxCO0FBU0EsVUFBTUMsT0FBTyxHQUFHO0FBQ1osbUJBQWFGLEdBQUcsQ0FBQ0MsWUFBSixDQUFpQix1QkFBakI7QUFERCxLQUFoQjtBQUlBLFVBQU1FLE9BQU8sR0FBRyxLQUFLQyxLQUFMLENBQVczQixPQUFYLENBQW1CNEIsVUFBbkIsRUFBaEI7QUFDQSxVQUFNQyxJQUFJLEdBQUcsS0FBS0YsS0FBTCxDQUFXM0IsT0FBWCxDQUFtQjhCLE9BQW5CLEVBQWI7QUFDQSxVQUFNQyxPQUFPLEdBQUdMLE9BQU8sQ0FBQ0ssT0FBeEI7QUFDQSxRQUFJQyxRQUFRLEdBQUdDLHFCQUFmOztBQUNBLFFBQUksQ0FBQyxLQUFLTixLQUFMLENBQVczQixPQUFYLENBQW1Ca0MsVUFBbkIsRUFBTCxFQUFzQztBQUNsQztBQUNBLFVBQUlMLElBQUksSUFBSUosT0FBTyxDQUFDSSxJQUFELENBQW5CLEVBQTJCO0FBQ3ZCRyxRQUFBQSxRQUFRLEdBQUdQLE9BQU8sQ0FBQ0ksSUFBRCxDQUFsQjtBQUNILE9BRkQsTUFFTyxJQUFJRSxPQUFPLElBQUlULFNBQVMsQ0FBQ1MsT0FBRCxDQUF4QixFQUFtQztBQUN0Q0MsUUFBQUEsUUFBUSxHQUFHVixTQUFTLENBQUNTLE9BQUQsQ0FBcEI7QUFDSCxPQUZNLE1BRUEsSUFBSUwsT0FBTyxDQUFDUyxHQUFaLEVBQWlCO0FBQ3BCO0FBQ0FILFFBQUFBLFFBQVEsR0FBR1YsU0FBUyxDQUFDLFFBQUQsQ0FBcEI7QUFDSCxPQUhNLE1BR0E7QUFDSDtBQUNBVSxRQUFBQSxRQUFRLEdBQUdJLG9CQUFYO0FBQ0g7QUFDSjs7QUFFRCxRQUFJQyx1QkFBY0MsZ0JBQWQsQ0FBK0IsaUJBQS9CLENBQUosRUFBdUQ7QUFDbkQsWUFBTUMsR0FBRywrQkFBd0IsS0FBS1osS0FBTCxDQUFXM0IsT0FBWCxDQUFtQndDLFNBQW5CLEVBQXhCLGVBQTJELEtBQUtiLEtBQUwsQ0FBVzNCLE9BQVgsQ0FBbUJ5QyxLQUFuQixFQUEzRCxDQUFUO0FBQ0EsWUFBTUMsV0FBVyxHQUFHQyxZQUFZLENBQUNDLE9BQWIsQ0FBcUJMLEdBQXJCLE1BQThCLE1BQWxEOztBQUVBLFVBQUksQ0FBQ0csV0FBTCxFQUFrQjtBQUNkLGNBQU1HLFVBQVUsR0FBRyxLQUFLbEIsS0FBTCxDQUFXM0IsT0FBWCxDQUFtQjhDLFNBQW5CLEdBQStCQyxLQUEvQixDQUFxQyxHQUFyQyxFQUEwQ0MsS0FBMUMsQ0FBZ0QsQ0FBaEQsRUFBbURDLElBQW5ELENBQXdELEdBQXhELENBQW5COztBQUNBLGNBQU1DLFVBQVUsR0FBR0MsaUJBQVFDLGNBQVIsR0FBeUJDLFlBQXpCLENBQXNDLEtBQUsxQixLQUFMLENBQVczQixPQUFYLENBQW1COEMsU0FBbkIsRUFBdEMsQ0FBbkI7O0FBQ0EsY0FBTVEsWUFBWSxHQUFHSCxpQkFBUUMsY0FBUixHQUF5QkcsY0FBekIsQ0FBd0NWLFVBQXhDLENBQXJCOztBQUVBLFlBQUlLLFVBQVUsSUFBSUksWUFBbEIsRUFBZ0M7QUFDNUJ0QixVQUFBQSxRQUFRLEdBQUdULEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixzQkFBakIsQ0FBWDtBQUNIO0FBQ0o7QUFDSjs7QUFFRCx3QkFBTyw2QkFBQyxRQUFEO0FBQ0gsTUFBQSxHQUFHLEVBQUUsS0FBS1IsS0FEUDtBQUVILE1BQUEsT0FBTyxFQUFFLEtBQUtXLEtBQUwsQ0FBVzNCLE9BRmpCO0FBR0gsTUFBQSxVQUFVLEVBQUUsS0FBSzJCLEtBQUwsQ0FBV3ZCLFVBSHBCO0FBSUgsTUFBQSxhQUFhLEVBQUUsS0FBS3VCLEtBQUwsQ0FBV3JCLGFBSnZCO0FBS0gsTUFBQSxjQUFjLEVBQUUsS0FBS3FCLEtBQUwsQ0FBV25CLGNBTHhCO0FBTUgsTUFBQSxTQUFTLEVBQUUsS0FBS21CLEtBQUwsQ0FBV2YsU0FObkI7QUFPSCxNQUFBLGNBQWMsRUFBRSxLQUFLZSxLQUFMLENBQVdkLGNBUHhCO0FBUUgsTUFBQSxnQkFBZ0IsRUFBRSxLQUFLYyxLQUFMLENBQVc2QixnQkFSMUI7QUFTSCxNQUFBLFNBQVMsRUFBRSxLQUFLN0IsS0FBTCxDQUFXOEIsU0FUbkI7QUFVSCxNQUFBLGVBQWUsRUFBRSxLQUFLOUIsS0FBTCxDQUFXakIsZUFWekI7QUFXSCxNQUFBLGdCQUFnQixFQUFFLEtBQUtTO0FBWHBCLE1BQVA7QUFhSDtBQXBHMkIsQ0FBakIsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNSwgMjAxNiBPcGVuTWFya2V0IEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwge2NyZWF0ZVJlZn0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vLi4vaW5kZXgnO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7TWpvbG5pcn0gZnJvbSBcIi4uLy4uLy4uL21qb2xuaXIvTWpvbG5pclwiO1xuaW1wb3J0IFJlZGFjdGVkQm9keSBmcm9tIFwiLi9SZWRhY3RlZEJvZHlcIjtcbmltcG9ydCBVbmtub3duQm9keSBmcm9tIFwiLi9Vbmtub3duQm9keVwiO1xuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVSZWFjdENsYXNzKHtcbiAgICBkaXNwbGF5TmFtZTogJ01lc3NhZ2VFdmVudCcsXG5cbiAgICBwcm9wVHlwZXM6IHtcbiAgICAgICAgLyogdGhlIE1hdHJpeEV2ZW50IHRvIHNob3cgKi9cbiAgICAgICAgbXhFdmVudDogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuXG4gICAgICAgIC8qIGEgbGlzdCBvZiB3b3JkcyB0byBoaWdobGlnaHQgKi9cbiAgICAgICAgaGlnaGxpZ2h0czogUHJvcFR5cGVzLmFycmF5LFxuXG4gICAgICAgIC8qIGxpbmsgVVJMIGZvciB0aGUgaGlnaGxpZ2h0cyAqL1xuICAgICAgICBoaWdobGlnaHRMaW5rOiBQcm9wVHlwZXMuc3RyaW5nLFxuXG4gICAgICAgIC8qIHNob3VsZCBzaG93IFVSTCBwcmV2aWV3cyBmb3IgdGhpcyBldmVudCAqL1xuICAgICAgICBzaG93VXJsUHJldmlldzogUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAgICAgLyogY2FsbGJhY2sgY2FsbGVkIHdoZW4gZHluYW1pYyBjb250ZW50IGluIGV2ZW50cyBhcmUgbG9hZGVkICovXG4gICAgICAgIG9uSGVpZ2h0Q2hhbmdlZDogUHJvcFR5cGVzLmZ1bmMsXG5cbiAgICAgICAgLyogdGhlIHNoYXBlIG9mIHRoZSB0aWxlLCB1c2VkICovXG4gICAgICAgIHRpbGVTaGFwZTogUHJvcFR5cGVzLnN0cmluZyxcblxuICAgICAgICAvKiB0aGUgbWF4aW11bSBpbWFnZSBoZWlnaHQgdG8gdXNlLCBpZiB0aGUgZXZlbnQgaXMgYW4gaW1hZ2UgKi9cbiAgICAgICAgbWF4SW1hZ2VIZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgfSxcblxuICAgIC8vIFRPRE86IFtSRUFDVC1XQVJOSU5HXSBSZXBsYWNlIGNvbXBvbmVudCB3aXRoIHJlYWwgY2xhc3MsIHVzZSBjb25zdHJ1Y3RvciBmb3IgcmVmc1xuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLl9ib2R5ID0gY3JlYXRlUmVmKCk7XG4gICAgfSxcblxuICAgIGdldEV2ZW50VGlsZU9wczogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ib2R5LmN1cnJlbnQgJiYgdGhpcy5fYm9keS5jdXJyZW50LmdldEV2ZW50VGlsZU9wcyA/IHRoaXMuX2JvZHkuY3VycmVudC5nZXRFdmVudFRpbGVPcHMoKSA6IG51bGw7XG4gICAgfSxcblxuICAgIG9uVGlsZVVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc3QgYm9keVR5cGVzID0ge1xuICAgICAgICAgICAgJ20udGV4dCc6IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLlRleHR1YWxCb2R5JyksXG4gICAgICAgICAgICAnbS5ub3RpY2UnOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5UZXh0dWFsQm9keScpLFxuICAgICAgICAgICAgJ20uZW1vdGUnOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5UZXh0dWFsQm9keScpLFxuICAgICAgICAgICAgJ20uaW1hZ2UnOiBzZGsuZ2V0Q29tcG9uZW50KCdtZXNzYWdlcy5NSW1hZ2VCb2R5JyksXG4gICAgICAgICAgICAnbS5maWxlJzogc2RrLmdldENvbXBvbmVudCgnbWVzc2FnZXMuTUZpbGVCb2R5JyksXG4gICAgICAgICAgICAnbS5hdWRpbyc6IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1BdWRpb0JvZHknKSxcbiAgICAgICAgICAgICdtLnZpZGVvJzogc2RrLmdldENvbXBvbmVudCgnbWVzc2FnZXMuTVZpZGVvQm9keScpLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBldlR5cGVzID0ge1xuICAgICAgICAgICAgJ20uc3RpY2tlcic6IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1TdGlja2VyQm9keScpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Q29udGVudCgpO1xuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5wcm9wcy5teEV2ZW50LmdldFR5cGUoKTtcbiAgICAgICAgY29uc3QgbXNndHlwZSA9IGNvbnRlbnQubXNndHlwZTtcbiAgICAgICAgbGV0IEJvZHlUeXBlID0gUmVkYWN0ZWRCb2R5O1xuICAgICAgICBpZiAoIXRoaXMucHJvcHMubXhFdmVudC5pc1JlZGFjdGVkKCkpIHtcbiAgICAgICAgICAgIC8vIG9ubHkgcmVzb2x2ZSBCb2R5VHlwZSBpZiBldmVudCBpcyBub3QgcmVkYWN0ZWRcbiAgICAgICAgICAgIGlmICh0eXBlICYmIGV2VHlwZXNbdHlwZV0pIHtcbiAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IGV2VHlwZXNbdHlwZV07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1zZ3R5cGUgJiYgYm9keVR5cGVzW21zZ3R5cGVdKSB7XG4gICAgICAgICAgICAgICAgQm9keVR5cGUgPSBib2R5VHlwZXNbbXNndHlwZV07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRlbnQudXJsKSB7XG4gICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gTUZpbGVCb2R5IGlmIHRoZXJlJ3MgYSBjb250ZW50IFVSTFxuICAgICAgICAgICAgICAgIEJvZHlUeXBlID0gYm9keVR5cGVzWydtLmZpbGUnXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gVW5rbm93bkJvZHkgb3RoZXJ3aXNlIGlmIG5vdCByZWRhY3RlZFxuICAgICAgICAgICAgICAgIEJvZHlUeXBlID0gVW5rbm93bkJvZHk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5pc0ZlYXR1cmVFbmFibGVkKFwiZmVhdHVyZV9tam9sbmlyXCIpKSB7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSBgbXhfbWpvbG5pcl9yZW5kZXJfJHt0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCl9X18ke3RoaXMucHJvcHMubXhFdmVudC5nZXRJZCgpfWA7XG4gICAgICAgICAgICBjb25zdCBhbGxvd1JlbmRlciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkgPT09IFwidHJ1ZVwiO1xuXG4gICAgICAgICAgICBpZiAoIWFsbG93UmVuZGVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlckRvbWFpbiA9IHRoaXMucHJvcHMubXhFdmVudC5nZXRTZW5kZXIoKS5zcGxpdCgnOicpLnNsaWNlKDEpLmpvaW4oJzonKTtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyQmFubmVkID0gTWpvbG5pci5zaGFyZWRJbnN0YW5jZSgpLmlzVXNlckJhbm5lZCh0aGlzLnByb3BzLm14RXZlbnQuZ2V0U2VuZGVyKCkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlcnZlckJhbm5lZCA9IE1qb2xuaXIuc2hhcmVkSW5zdGFuY2UoKS5pc1NlcnZlckJhbm5lZCh1c2VyRG9tYWluKTtcblxuICAgICAgICAgICAgICAgIGlmICh1c2VyQmFubmVkIHx8IHNlcnZlckJhbm5lZCkge1xuICAgICAgICAgICAgICAgICAgICBCb2R5VHlwZSA9IHNkay5nZXRDb21wb25lbnQoJ21lc3NhZ2VzLk1qb2xuaXJCb2R5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIDxCb2R5VHlwZVxuICAgICAgICAgICAgcmVmPXt0aGlzLl9ib2R5fVxuICAgICAgICAgICAgbXhFdmVudD17dGhpcy5wcm9wcy5teEV2ZW50fVxuICAgICAgICAgICAgaGlnaGxpZ2h0cz17dGhpcy5wcm9wcy5oaWdobGlnaHRzfVxuICAgICAgICAgICAgaGlnaGxpZ2h0TGluaz17dGhpcy5wcm9wcy5oaWdobGlnaHRMaW5rfVxuICAgICAgICAgICAgc2hvd1VybFByZXZpZXc9e3RoaXMucHJvcHMuc2hvd1VybFByZXZpZXd9XG4gICAgICAgICAgICB0aWxlU2hhcGU9e3RoaXMucHJvcHMudGlsZVNoYXBlfVxuICAgICAgICAgICAgbWF4SW1hZ2VIZWlnaHQ9e3RoaXMucHJvcHMubWF4SW1hZ2VIZWlnaHR9XG4gICAgICAgICAgICByZXBsYWNpbmdFdmVudElkPXt0aGlzLnByb3BzLnJlcGxhY2luZ0V2ZW50SWR9XG4gICAgICAgICAgICBlZGl0U3RhdGU9e3RoaXMucHJvcHMuZWRpdFN0YXRlfVxuICAgICAgICAgICAgb25IZWlnaHRDaGFuZ2VkPXt0aGlzLnByb3BzLm9uSGVpZ2h0Q2hhbmdlZH1cbiAgICAgICAgICAgIG9uTWVzc2FnZUFsbG93ZWQ9e3RoaXMub25UaWxlVXBkYXRlfVxuICAgICAgICAvPjtcbiAgICB9LFxufSk7XG4iXX0=