"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var sdk = _interopRequireWildcard(require("../../../index"));

var _CrossSigningManager = require("../../../CrossSigningManager");

var _Modal = _interopRequireDefault(require("../../../Modal"));

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class CrossSigningPanel extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onAccountData", event => {
      const type = event.getType();

      if (type.startsWith("m.cross_signing") || type.startsWith("m.secret_storage")) {
        this._getUpdatedStatus();
      }
    });
    (0, _defineProperty2.default)(this, "_onBootstrapClick", () => {
      this._bootstrapSecureSecretStorage(false);
    });
    (0, _defineProperty2.default)(this, "onStatusChanged", () => {
      this._getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "_bootstrapSecureSecretStorage", async (forceReset = false) => {
      this.setState({
        error: null
      });

      try {
        await (0, _CrossSigningManager.accessSecretStorage)(() => undefined, forceReset);
      } catch (e) {
        this.setState({
          error: e
        });
        console.error("Error bootstrapping secret storage", e);
      }

      if (this._unmounted) return;

      this._getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "onDestroyStorage", act => {
      if (!act) return;

      this._bootstrapSecureSecretStorage(true);
    });
    (0, _defineProperty2.default)(this, "_destroySecureSecretStorage", () => {
      const ConfirmDestroyCrossSigningDialog = sdk.getComponent("dialogs.ConfirmDestroyCrossSigningDialog");

      _Modal.default.createDialog(ConfirmDestroyCrossSigningDialog, {
        onFinished: this.onDestroyStorage
      });
    });
    this._unmounted = false;
    this.state = {
      error: null,
      crossSigningPublicKeysOnDevice: false,
      crossSigningPrivateKeysInStorage: false,
      selfSigningPrivateKeyCached: false,
      userSigningPrivateKeyCached: false,
      sessionBackupKeyCached: false,
      secretStorageKeyInAccount: false
    };
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.on("accountData", this.onAccountData);
    cli.on("userTrustStatusChanged", this.onStatusChanged);
    cli.on("crossSigning.keysChanged", this.onStatusChanged);

    this._getUpdatedStatus();
  }

  componentWillUnmount() {
    this._unmounted = true;

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (!cli) return;
    cli.removeListener("accountData", this.onAccountData);
    cli.removeListener("userTrustStatusChanged", this.onStatusChanged);
    cli.removeListener("crossSigning.keysChanged", this.onStatusChanged);
  }

  async _getUpdatedStatus() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const pkCache = cli.getCrossSigningCacheCallbacks();
    const crossSigning = cli._crypto._crossSigningInfo;
    const secretStorage = cli._crypto._secretStorage;
    const crossSigningPublicKeysOnDevice = crossSigning.getId();
    const crossSigningPrivateKeysInStorage = await crossSigning.isStoredInSecretStorage(secretStorage);
    const selfSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("self_signing")));
    const userSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("user_signing")));
    const sessionBackupKeyFromCache = await cli._crypto.getSessionBackupPrivateKey();
    const sessionBackupKeyCached = !!sessionBackupKeyFromCache;
    const sessionBackupKeyWellFormed = sessionBackupKeyFromCache instanceof Uint8Array;
    const secretStorageKeyInAccount = await secretStorage.hasKey();
    const homeserverSupportsCrossSigning = await cli.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");
    const crossSigningReady = await cli.isCrossSigningReady();
    this.setState({
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      sessionBackupKeyCached,
      sessionBackupKeyWellFormed,
      secretStorageKeyInAccount,
      homeserverSupportsCrossSigning,
      crossSigningReady
    });
  }
  /**
   * Bootstrapping secret storage may take one of these paths:
   * 1. Create secret storage from a passphrase and store cross-signing keys
   *    in secret storage.
   * 2. Access existing secret storage by requesting passphrase and accessing
   *    cross-signing keys as needed.
   * 3. All keys are loaded and there's nothing to do.
   * @param {bool} [forceReset] Bootstrap again even if keys already present
   */


  render() {
    const AccessibleButton = sdk.getComponent("elements.AccessibleButton");
    const {
      error,
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      sessionBackupKeyCached,
      sessionBackupKeyWellFormed,
      secretStorageKeyInAccount,
      homeserverSupportsCrossSigning,
      crossSigningReady
    } = this.state;
    let errorSection;

    if (error) {
      errorSection = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, error.toString());
    } // Whether the various keys exist on your account (but not necessarily
    // on this device).


    const enabledForAccount = crossSigningPrivateKeysInStorage && secretStorageKeyInAccount;
    let summarisedStatus;

    if (homeserverSupportsCrossSigning === undefined) {
      const InlineSpinner = sdk.getComponent('views.elements.InlineSpinner');
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, /*#__PURE__*/_react.default.createElement(InlineSpinner, null));
    } else if (!homeserverSupportsCrossSigning) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your homeserver does not support cross-signing."));
    } else if (crossSigningReady) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, "\u2705 ", (0, _languageHandler._t)("Cross-signing and secret storage are enabled."));
    } else if (crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your account has a cross-signing identity in secret storage, but it " + "is not yet trusted by this session."));
    } else {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Cross-signing and secret storage are not yet set up."));
    }

    let resetButton;

    if (enabledForAccount) {
      resetButton = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CrossSigningPanel_buttonRow"
      }, /*#__PURE__*/_react.default.createElement(AccessibleButton, {
        kind: "danger",
        onClick: this._destroySecureSecretStorage
      }, (0, _languageHandler._t)("Reset cross-signing and secret storage")));
    }

    let bootstrapButton;

    if ((!enabledForAccount || !crossSigningPublicKeysOnDevice) && homeserverSupportsCrossSigning) {
      bootstrapButton = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CrossSigningPanel_buttonRow"
      }, /*#__PURE__*/_react.default.createElement(AccessibleButton, {
        kind: "primary",
        onClick: this._onBootstrapClick
      }, (0, _languageHandler._t)("Bootstrap cross-signing and secret storage")));
    }

    let sessionBackupKeyWellFormedText = "";

    if (sessionBackupKeyCached) {
      sessionBackupKeyWellFormedText = ", ";

      if (sessionBackupKeyWellFormed) {
        sessionBackupKeyWellFormedText += (0, _languageHandler._t)("well formed");
      } else {
        sessionBackupKeyWellFormedText += (0, _languageHandler._t)("unexpected type");
      }
    }

    return /*#__PURE__*/_react.default.createElement("div", null, summarisedStatus, /*#__PURE__*/_react.default.createElement("details", null, /*#__PURE__*/_react.default.createElement("summary", null, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("table", {
      className: "mx_CrossSigningPanel_statusList"
    }, /*#__PURE__*/_react.default.createElement("tbody", null, /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing public keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPublicKeysOnDevice ? (0, _languageHandler._t)("in memory") : (0, _languageHandler._t)("not found"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing private keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPrivateKeysInStorage ? (0, _languageHandler._t)("in secret storage") : (0, _languageHandler._t)("not found"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Self signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, selfSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("User signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, userSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Session backup key:")), /*#__PURE__*/_react.default.createElement("td", null, sessionBackupKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"), sessionBackupKeyWellFormedText)), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Secret storage public key:")), /*#__PURE__*/_react.default.createElement("td", null, secretStorageKeyInAccount ? (0, _languageHandler._t)("in account data") : (0, _languageHandler._t)("not found"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Homeserver feature support:")), /*#__PURE__*/_react.default.createElement("td", null, homeserverSupportsCrossSigning ? (0, _languageHandler._t)("exists") : (0, _languageHandler._t)("not found")))))), errorSection, bootstrapButton, resetButton);
  }

}

exports.default = CrossSigningPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3NldHRpbmdzL0Nyb3NzU2lnbmluZ1BhbmVsLmpzIl0sIm5hbWVzIjpbIkNyb3NzU2lnbmluZ1BhbmVsIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImV2ZW50IiwidHlwZSIsImdldFR5cGUiLCJzdGFydHNXaXRoIiwiX2dldFVwZGF0ZWRTdGF0dXMiLCJfYm9vdHN0cmFwU2VjdXJlU2VjcmV0U3RvcmFnZSIsImZvcmNlUmVzZXQiLCJzZXRTdGF0ZSIsImVycm9yIiwidW5kZWZpbmVkIiwiZSIsImNvbnNvbGUiLCJfdW5tb3VudGVkIiwiYWN0IiwiQ29uZmlybURlc3Ryb3lDcm9zc1NpZ25pbmdEaWFsb2ciLCJzZGsiLCJnZXRDb21wb25lbnQiLCJNb2RhbCIsImNyZWF0ZURpYWxvZyIsIm9uRmluaXNoZWQiLCJvbkRlc3Ryb3lTdG9yYWdlIiwic3RhdGUiLCJjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UiLCJjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSIsInNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCIsInVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCIsInNlc3Npb25CYWNrdXBLZXlDYWNoZWQiLCJzZWNyZXRTdG9yYWdlS2V5SW5BY2NvdW50IiwiY29tcG9uZW50RGlkTW91bnQiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJvbiIsIm9uQWNjb3VudERhdGEiLCJvblN0YXR1c0NoYW5nZWQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwicGtDYWNoZSIsImdldENyb3NzU2lnbmluZ0NhY2hlQ2FsbGJhY2tzIiwiY3Jvc3NTaWduaW5nIiwiX2NyeXB0byIsIl9jcm9zc1NpZ25pbmdJbmZvIiwic2VjcmV0U3RvcmFnZSIsIl9zZWNyZXRTdG9yYWdlIiwiZ2V0SWQiLCJpc1N0b3JlZEluU2VjcmV0U3RvcmFnZSIsImdldENyb3NzU2lnbmluZ0tleUNhY2hlIiwic2Vzc2lvbkJhY2t1cEtleUZyb21DYWNoZSIsImdldFNlc3Npb25CYWNrdXBQcml2YXRlS2V5Iiwic2Vzc2lvbkJhY2t1cEtleVdlbGxGb3JtZWQiLCJVaW50OEFycmF5IiwiaGFzS2V5IiwiaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nIiwiZG9lc1NlcnZlclN1cHBvcnRVbnN0YWJsZUZlYXR1cmUiLCJjcm9zc1NpZ25pbmdSZWFkeSIsImlzQ3Jvc3NTaWduaW5nUmVhZHkiLCJyZW5kZXIiLCJBY2Nlc3NpYmxlQnV0dG9uIiwiZXJyb3JTZWN0aW9uIiwidG9TdHJpbmciLCJlbmFibGVkRm9yQWNjb3VudCIsInN1bW1hcmlzZWRTdGF0dXMiLCJJbmxpbmVTcGlubmVyIiwicmVzZXRCdXR0b24iLCJfZGVzdHJveVNlY3VyZVNlY3JldFN0b3JhZ2UiLCJib290c3RyYXBCdXR0b24iLCJfb25Cb290c3RyYXBDbGljayIsInNlc3Npb25CYWNrdXBLZXlXZWxsRm9ybWVkVGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWdCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUF0QkE7Ozs7Ozs7Ozs7Ozs7OztBQXdCZSxNQUFNQSxpQkFBTixTQUFnQ0MsZUFBTUMsYUFBdEMsQ0FBb0Q7QUFDL0RDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQURlLHlEQWlDRkMsS0FBRCxJQUFXO0FBQ3ZCLFlBQU1DLElBQUksR0FBR0QsS0FBSyxDQUFDRSxPQUFOLEVBQWI7O0FBQ0EsVUFBSUQsSUFBSSxDQUFDRSxVQUFMLENBQWdCLGlCQUFoQixLQUFzQ0YsSUFBSSxDQUFDRSxVQUFMLENBQWdCLGtCQUFoQixDQUExQyxFQUErRTtBQUMzRSxhQUFLQyxpQkFBTDtBQUNIO0FBQ0osS0F0Q2tCO0FBQUEsNkRBd0NDLE1BQU07QUFDdEIsV0FBS0MsNkJBQUwsQ0FBbUMsS0FBbkM7QUFDSCxLQTFDa0I7QUFBQSwyREE0Q0QsTUFBTTtBQUNwQixXQUFLRCxpQkFBTDtBQUNILEtBOUNrQjtBQUFBLHlFQXVGYSxPQUFPRSxVQUFVLEdBQUMsS0FBbEIsS0FBNEI7QUFDeEQsV0FBS0MsUUFBTCxDQUFjO0FBQUVDLFFBQUFBLEtBQUssRUFBRTtBQUFULE9BQWQ7O0FBQ0EsVUFBSTtBQUNBLGNBQU0sOENBQW9CLE1BQU1DLFNBQTFCLEVBQXFDSCxVQUFyQyxDQUFOO0FBQ0gsT0FGRCxDQUVFLE9BQU9JLENBQVAsRUFBVTtBQUNSLGFBQUtILFFBQUwsQ0FBYztBQUFFQyxVQUFBQSxLQUFLLEVBQUVFO0FBQVQsU0FBZDtBQUNBQyxRQUFBQSxPQUFPLENBQUNILEtBQVIsQ0FBYyxvQ0FBZCxFQUFvREUsQ0FBcEQ7QUFDSDs7QUFDRCxVQUFJLEtBQUtFLFVBQVQsRUFBcUI7O0FBQ3JCLFdBQUtSLGlCQUFMO0FBQ0gsS0FqR2tCO0FBQUEsNERBbUdDUyxHQUFELElBQVM7QUFDeEIsVUFBSSxDQUFDQSxHQUFMLEVBQVU7O0FBQ1YsV0FBS1IsNkJBQUwsQ0FBbUMsSUFBbkM7QUFDSCxLQXRHa0I7QUFBQSx1RUF3R1csTUFBTTtBQUNoQyxZQUFNUyxnQ0FBZ0MsR0FBR0MsR0FBRyxDQUFDQyxZQUFKLENBQWlCLDBDQUFqQixDQUF6Qzs7QUFDQUMscUJBQU1DLFlBQU4sQ0FBbUJKLGdDQUFuQixFQUFxRDtBQUNqREssUUFBQUEsVUFBVSxFQUFFLEtBQUtDO0FBRGdDLE9BQXJEO0FBR0gsS0E3R2tCO0FBR2YsU0FBS1IsVUFBTCxHQUFrQixLQUFsQjtBQUVBLFNBQUtTLEtBQUwsR0FBYTtBQUNUYixNQUFBQSxLQUFLLEVBQUUsSUFERTtBQUVUYyxNQUFBQSw4QkFBOEIsRUFBRSxLQUZ2QjtBQUdUQyxNQUFBQSxnQ0FBZ0MsRUFBRSxLQUh6QjtBQUlUQyxNQUFBQSwyQkFBMkIsRUFBRSxLQUpwQjtBQUtUQyxNQUFBQSwyQkFBMkIsRUFBRSxLQUxwQjtBQU1UQyxNQUFBQSxzQkFBc0IsRUFBRSxLQU5mO0FBT1RDLE1BQUFBLHlCQUF5QixFQUFFO0FBUGxCLEtBQWI7QUFTSDs7QUFFREMsRUFBQUEsaUJBQWlCLEdBQUc7QUFDaEIsVUFBTUMsR0FBRyxHQUFHQyxpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0FGLElBQUFBLEdBQUcsQ0FBQ0csRUFBSixDQUFPLGFBQVAsRUFBc0IsS0FBS0MsYUFBM0I7QUFDQUosSUFBQUEsR0FBRyxDQUFDRyxFQUFKLENBQU8sd0JBQVAsRUFBaUMsS0FBS0UsZUFBdEM7QUFDQUwsSUFBQUEsR0FBRyxDQUFDRyxFQUFKLENBQU8sMEJBQVAsRUFBbUMsS0FBS0UsZUFBeEM7O0FBQ0EsU0FBSzlCLGlCQUFMO0FBQ0g7O0FBRUQrQixFQUFBQSxvQkFBb0IsR0FBRztBQUNuQixTQUFLdkIsVUFBTCxHQUFrQixJQUFsQjs7QUFDQSxVQUFNaUIsR0FBRyxHQUFHQyxpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0EsUUFBSSxDQUFDRixHQUFMLEVBQVU7QUFDVkEsSUFBQUEsR0FBRyxDQUFDTyxjQUFKLENBQW1CLGFBQW5CLEVBQWtDLEtBQUtILGFBQXZDO0FBQ0FKLElBQUFBLEdBQUcsQ0FBQ08sY0FBSixDQUFtQix3QkFBbkIsRUFBNkMsS0FBS0YsZUFBbEQ7QUFDQUwsSUFBQUEsR0FBRyxDQUFDTyxjQUFKLENBQW1CLDBCQUFuQixFQUErQyxLQUFLRixlQUFwRDtBQUNIOztBQWlCRCxRQUFNOUIsaUJBQU4sR0FBMEI7QUFDdEIsVUFBTXlCLEdBQUcsR0FBR0MsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBLFVBQU1NLE9BQU8sR0FBR1IsR0FBRyxDQUFDUyw2QkFBSixFQUFoQjtBQUNBLFVBQU1DLFlBQVksR0FBR1YsR0FBRyxDQUFDVyxPQUFKLENBQVlDLGlCQUFqQztBQUNBLFVBQU1DLGFBQWEsR0FBR2IsR0FBRyxDQUFDVyxPQUFKLENBQVlHLGNBQWxDO0FBQ0EsVUFBTXJCLDhCQUE4QixHQUFHaUIsWUFBWSxDQUFDSyxLQUFiLEVBQXZDO0FBQ0EsVUFBTXJCLGdDQUFnQyxHQUFHLE1BQU1nQixZQUFZLENBQUNNLHVCQUFiLENBQXFDSCxhQUFyQyxDQUEvQztBQUNBLFVBQU1sQiwyQkFBMkIsR0FBRyxDQUFDLEVBQUVhLE9BQU8sS0FBSSxNQUFNQSxPQUFPLENBQUNTLHVCQUFSLENBQWdDLGNBQWhDLENBQVYsQ0FBVCxDQUFyQztBQUNBLFVBQU1yQiwyQkFBMkIsR0FBRyxDQUFDLEVBQUVZLE9BQU8sS0FBSSxNQUFNQSxPQUFPLENBQUNTLHVCQUFSLENBQWdDLGNBQWhDLENBQVYsQ0FBVCxDQUFyQztBQUNBLFVBQU1DLHlCQUF5QixHQUFHLE1BQU1sQixHQUFHLENBQUNXLE9BQUosQ0FBWVEsMEJBQVosRUFBeEM7QUFDQSxVQUFNdEIsc0JBQXNCLEdBQUcsQ0FBQyxDQUFFcUIseUJBQWxDO0FBQ0EsVUFBTUUsMEJBQTBCLEdBQUdGLHlCQUF5QixZQUFZRyxVQUF4RTtBQUNBLFVBQU12Qix5QkFBeUIsR0FBRyxNQUFNZSxhQUFhLENBQUNTLE1BQWQsRUFBeEM7QUFDQSxVQUFNQyw4QkFBOEIsR0FDaEMsTUFBTXZCLEdBQUcsQ0FBQ3dCLGdDQUFKLENBQXFDLDhCQUFyQyxDQURWO0FBRUEsVUFBTUMsaUJBQWlCLEdBQUcsTUFBTXpCLEdBQUcsQ0FBQzBCLG1CQUFKLEVBQWhDO0FBRUEsU0FBS2hELFFBQUwsQ0FBYztBQUNWZSxNQUFBQSw4QkFEVTtBQUVWQyxNQUFBQSxnQ0FGVTtBQUdWQyxNQUFBQSwyQkFIVTtBQUlWQyxNQUFBQSwyQkFKVTtBQUtWQyxNQUFBQSxzQkFMVTtBQU1WdUIsTUFBQUEsMEJBTlU7QUFPVnRCLE1BQUFBLHlCQVBVO0FBUVZ5QixNQUFBQSw4QkFSVTtBQVNWRSxNQUFBQTtBQVRVLEtBQWQ7QUFXSDtBQUVEOzs7Ozs7Ozs7OztBQWlDQUUsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsVUFBTUMsZ0JBQWdCLEdBQUcxQyxHQUFHLENBQUNDLFlBQUosQ0FBaUIsMkJBQWpCLENBQXpCO0FBQ0EsVUFBTTtBQUNGUixNQUFBQSxLQURFO0FBRUZjLE1BQUFBLDhCQUZFO0FBR0ZDLE1BQUFBLGdDQUhFO0FBSUZDLE1BQUFBLDJCQUpFO0FBS0ZDLE1BQUFBLDJCQUxFO0FBTUZDLE1BQUFBLHNCQU5FO0FBT0Z1QixNQUFBQSwwQkFQRTtBQVFGdEIsTUFBQUEseUJBUkU7QUFTRnlCLE1BQUFBLDhCQVRFO0FBVUZFLE1BQUFBO0FBVkUsUUFXRixLQUFLakMsS0FYVDtBQWFBLFFBQUlxQyxZQUFKOztBQUNBLFFBQUlsRCxLQUFKLEVBQVc7QUFDUGtELE1BQUFBLFlBQVksZ0JBQUc7QUFBSyxRQUFBLFNBQVMsRUFBQztBQUFmLFNBQXdCbEQsS0FBSyxDQUFDbUQsUUFBTixFQUF4QixDQUFmO0FBQ0gsS0FsQkksQ0FvQkw7QUFDQTs7O0FBQ0EsVUFBTUMsaUJBQWlCLEdBQ25CckMsZ0NBQWdDLElBQ2hDSSx5QkFGSjtBQUtBLFFBQUlrQyxnQkFBSjs7QUFDQSxRQUFJVCw4QkFBOEIsS0FBSzNDLFNBQXZDLEVBQWtEO0FBQzlDLFlBQU1xRCxhQUFhLEdBQUcvQyxHQUFHLENBQUNDLFlBQUosQ0FBaUIsOEJBQWpCLENBQXRCO0FBQ0E2QyxNQUFBQSxnQkFBZ0IsZ0JBQUcscURBQUcsNkJBQUMsYUFBRCxPQUFILENBQW5CO0FBQ0gsS0FIRCxNQUdPLElBQUksQ0FBQ1QsOEJBQUwsRUFBcUM7QUFDeENTLE1BQUFBLGdCQUFnQixnQkFBRyx3Q0FBSSx5QkFDbkIsaURBRG1CLENBQUosQ0FBbkI7QUFHSCxLQUpNLE1BSUEsSUFBSVAsaUJBQUosRUFBdUI7QUFDMUJPLE1BQUFBLGdCQUFnQixnQkFBRyxtREFBTSx5QkFDckIsK0NBRHFCLENBQU4sQ0FBbkI7QUFHSCxLQUpNLE1BSUEsSUFBSXRDLGdDQUFKLEVBQXNDO0FBQ3pDc0MsTUFBQUEsZ0JBQWdCLGdCQUFHLHdDQUFJLHlCQUNuQix5RUFDQSxxQ0FGbUIsQ0FBSixDQUFuQjtBQUlILEtBTE0sTUFLQTtBQUNIQSxNQUFBQSxnQkFBZ0IsZ0JBQUcsd0NBQUkseUJBQ25CLHNEQURtQixDQUFKLENBQW5CO0FBR0g7O0FBRUQsUUFBSUUsV0FBSjs7QUFDQSxRQUFJSCxpQkFBSixFQUF1QjtBQUNuQkcsTUFBQUEsV0FBVyxnQkFDUDtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsc0JBQ0ksNkJBQUMsZ0JBQUQ7QUFBa0IsUUFBQSxJQUFJLEVBQUMsUUFBdkI7QUFBZ0MsUUFBQSxPQUFPLEVBQUUsS0FBS0M7QUFBOUMsU0FDSyx5QkFBRyx3Q0FBSCxDQURMLENBREosQ0FESjtBQU9IOztBQUNELFFBQUlDLGVBQUo7O0FBQ0EsUUFDSSxDQUFDLENBQUNMLGlCQUFELElBQXNCLENBQUN0Qyw4QkFBeEIsS0FDQThCLDhCQUZKLEVBR0U7QUFDRWEsTUFBQUEsZUFBZSxnQkFDWDtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsc0JBQ0ksNkJBQUMsZ0JBQUQ7QUFBa0IsUUFBQSxJQUFJLEVBQUMsU0FBdkI7QUFBaUMsUUFBQSxPQUFPLEVBQUUsS0FBS0M7QUFBL0MsU0FDSyx5QkFBRyw0Q0FBSCxDQURMLENBREosQ0FESjtBQU9IOztBQUVELFFBQUlDLDhCQUE4QixHQUFHLEVBQXJDOztBQUNBLFFBQUl6QyxzQkFBSixFQUE0QjtBQUN4QnlDLE1BQUFBLDhCQUE4QixHQUFHLElBQWpDOztBQUNBLFVBQUlsQiwwQkFBSixFQUFnQztBQUM1QmtCLFFBQUFBLDhCQUE4QixJQUFJLHlCQUFHLGFBQUgsQ0FBbEM7QUFDSCxPQUZELE1BRU87QUFDSEEsUUFBQUEsOEJBQThCLElBQUkseUJBQUcsaUJBQUgsQ0FBbEM7QUFDSDtBQUNKOztBQUVELHdCQUNJLDBDQUNLTixnQkFETCxlQUVJLDJEQUNJLDhDQUFVLHlCQUFHLFVBQUgsQ0FBVixDQURKLGVBRUk7QUFBTyxNQUFBLFNBQVMsRUFBQztBQUFqQixvQkFBbUQseURBQy9DLHNEQUNJLHlDQUFLLHlCQUFHLDRCQUFILENBQUwsQ0FESixlQUVJLHlDQUFLdkMsOEJBQThCLEdBQUcseUJBQUcsV0FBSCxDQUFILEdBQXFCLHlCQUFHLFdBQUgsQ0FBeEQsQ0FGSixDQUQrQyxlQUsvQyxzREFDSSx5Q0FBSyx5QkFBRyw2QkFBSCxDQUFMLENBREosZUFFSSx5Q0FBS0MsZ0NBQWdDLEdBQUcseUJBQUcsbUJBQUgsQ0FBSCxHQUE2Qix5QkFBRyxXQUFILENBQWxFLENBRkosQ0FMK0MsZUFTL0Msc0RBQ0kseUNBQUsseUJBQUcsMkJBQUgsQ0FBTCxDQURKLGVBRUkseUNBQUtDLDJCQUEyQixHQUFHLHlCQUFHLGdCQUFILENBQUgsR0FBMEIseUJBQUcsbUJBQUgsQ0FBMUQsQ0FGSixDQVQrQyxlQWEvQyxzREFDSSx5Q0FBSyx5QkFBRywyQkFBSCxDQUFMLENBREosZUFFSSx5Q0FBS0MsMkJBQTJCLEdBQUcseUJBQUcsZ0JBQUgsQ0FBSCxHQUEwQix5QkFBRyxtQkFBSCxDQUExRCxDQUZKLENBYitDLGVBaUIvQyxzREFDSSx5Q0FBSyx5QkFBRyxxQkFBSCxDQUFMLENBREosZUFFSSx5Q0FDS0Msc0JBQXNCLEdBQUcseUJBQUcsZ0JBQUgsQ0FBSCxHQUEwQix5QkFBRyxtQkFBSCxDQURyRCxFQUVLeUMsOEJBRkwsQ0FGSixDQWpCK0MsZUF3Qi9DLHNEQUNJLHlDQUFLLHlCQUFHLDRCQUFILENBQUwsQ0FESixlQUVJLHlDQUFLeEMseUJBQXlCLEdBQUcseUJBQUcsaUJBQUgsQ0FBSCxHQUEyQix5QkFBRyxXQUFILENBQXpELENBRkosQ0F4QitDLGVBNEIvQyxzREFDSSx5Q0FBSyx5QkFBRyw2QkFBSCxDQUFMLENBREosZUFFSSx5Q0FBS3lCLDhCQUE4QixHQUFHLHlCQUFHLFFBQUgsQ0FBSCxHQUFrQix5QkFBRyxXQUFILENBQXJELENBRkosQ0E1QitDLENBQW5ELENBRkosQ0FGSixFQXNDS00sWUF0Q0wsRUF1Q0tPLGVBdkNMLEVBd0NLRixXQXhDTCxDQURKO0FBNENIOztBQWhQOEQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi8uLi8uLi9pbmRleCc7XG5pbXBvcnQgeyBhY2Nlc3NTZWNyZXRTdG9yYWdlIH0gZnJvbSAnLi4vLi4vLi4vQ3Jvc3NTaWduaW5nTWFuYWdlcic7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vTW9kYWwnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDcm9zc1NpZ25pbmdQYW5lbCBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLl91bm1vdW50ZWQgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZXJyb3I6IG51bGwsXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2U6IGZhbHNlLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2U6IGZhbHNlLFxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZDogZmFsc2UsXG4gICAgICAgICAgICBzZXNzaW9uQmFja3VwS2V5Q2FjaGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHNlY3JldFN0b3JhZ2VLZXlJbkFjY291bnQ6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNsaS5vbihcImFjY291bnREYXRhXCIsIHRoaXMub25BY2NvdW50RGF0YSk7XG4gICAgICAgIGNsaS5vbihcInVzZXJUcnVzdFN0YXR1c0NoYW5nZWRcIiwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICBjbGkub24oXCJjcm9zc1NpZ25pbmcua2V5c0NoYW5nZWRcIiwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICB0aGlzLl9nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgICAgIHRoaXMuX3VubW91bnRlZCA9IHRydWU7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgaWYgKCFjbGkpIHJldHVybjtcbiAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwiYWNjb3VudERhdGFcIiwgdGhpcy5vbkFjY291bnREYXRhKTtcbiAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwidXNlclRydXN0U3RhdHVzQ2hhbmdlZFwiLCB0aGlzLm9uU3RhdHVzQ2hhbmdlZCk7XG4gICAgICAgIGNsaS5yZW1vdmVMaXN0ZW5lcihcImNyb3NzU2lnbmluZy5rZXlzQ2hhbmdlZFwiLCB0aGlzLm9uU3RhdHVzQ2hhbmdlZCk7XG4gICAgfVxuXG4gICAgb25BY2NvdW50RGF0YSA9IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCB0eXBlID0gZXZlbnQuZ2V0VHlwZSgpO1xuICAgICAgICBpZiAodHlwZS5zdGFydHNXaXRoKFwibS5jcm9zc19zaWduaW5nXCIpIHx8IHR5cGUuc3RhcnRzV2l0aChcIm0uc2VjcmV0X3N0b3JhZ2VcIikpIHtcbiAgICAgICAgICAgIHRoaXMuX2dldFVwZGF0ZWRTdGF0dXMoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBfb25Cb290c3RyYXBDbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5fYm9vdHN0cmFwU2VjdXJlU2VjcmV0U3RvcmFnZShmYWxzZSk7XG4gICAgfTtcblxuICAgIG9uU3RhdHVzQ2hhbmdlZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5fZ2V0VXBkYXRlZFN0YXR1cygpO1xuICAgIH07XG5cbiAgICBhc3luYyBfZ2V0VXBkYXRlZFN0YXR1cygpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBjb25zdCBwa0NhY2hlID0gY2xpLmdldENyb3NzU2lnbmluZ0NhY2hlQ2FsbGJhY2tzKCk7XG4gICAgICAgIGNvbnN0IGNyb3NzU2lnbmluZyA9IGNsaS5fY3J5cHRvLl9jcm9zc1NpZ25pbmdJbmZvO1xuICAgICAgICBjb25zdCBzZWNyZXRTdG9yYWdlID0gY2xpLl9jcnlwdG8uX3NlY3JldFN0b3JhZ2U7XG4gICAgICAgIGNvbnN0IGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSA9IGNyb3NzU2lnbmluZy5nZXRJZCgpO1xuICAgICAgICBjb25zdCBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSA9IGF3YWl0IGNyb3NzU2lnbmluZy5pc1N0b3JlZEluU2VjcmV0U3RvcmFnZShzZWNyZXRTdG9yYWdlKTtcbiAgICAgICAgY29uc3Qgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkID0gISEocGtDYWNoZSAmJiBhd2FpdCBwa0NhY2hlLmdldENyb3NzU2lnbmluZ0tleUNhY2hlKFwic2VsZl9zaWduaW5nXCIpKTtcbiAgICAgICAgY29uc3QgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkID0gISEocGtDYWNoZSAmJiBhd2FpdCBwa0NhY2hlLmdldENyb3NzU2lnbmluZ0tleUNhY2hlKFwidXNlcl9zaWduaW5nXCIpKTtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbkJhY2t1cEtleUZyb21DYWNoZSA9IGF3YWl0IGNsaS5fY3J5cHRvLmdldFNlc3Npb25CYWNrdXBQcml2YXRlS2V5KCk7XG4gICAgICAgIGNvbnN0IHNlc3Npb25CYWNrdXBLZXlDYWNoZWQgPSAhIShzZXNzaW9uQmFja3VwS2V5RnJvbUNhY2hlKTtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbkJhY2t1cEtleVdlbGxGb3JtZWQgPSBzZXNzaW9uQmFja3VwS2V5RnJvbUNhY2hlIGluc3RhbmNlb2YgVWludDhBcnJheTtcbiAgICAgICAgY29uc3Qgc2VjcmV0U3RvcmFnZUtleUluQWNjb3VudCA9IGF3YWl0IHNlY3JldFN0b3JhZ2UuaGFzS2V5KCk7XG4gICAgICAgIGNvbnN0IGhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyA9XG4gICAgICAgICAgICBhd2FpdCBjbGkuZG9lc1NlcnZlclN1cHBvcnRVbnN0YWJsZUZlYXR1cmUoXCJvcmcubWF0cml4LmUyZV9jcm9zc19zaWduaW5nXCIpO1xuICAgICAgICBjb25zdCBjcm9zc1NpZ25pbmdSZWFkeSA9IGF3YWl0IGNsaS5pc0Nyb3NzU2lnbmluZ1JlYWR5KCk7XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UsXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSxcbiAgICAgICAgICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHNlc3Npb25CYWNrdXBLZXlDYWNoZWQsXG4gICAgICAgICAgICBzZXNzaW9uQmFja3VwS2V5V2VsbEZvcm1lZCxcbiAgICAgICAgICAgIHNlY3JldFN0b3JhZ2VLZXlJbkFjY291bnQsXG4gICAgICAgICAgICBob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcsXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdSZWFkeSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQm9vdHN0cmFwcGluZyBzZWNyZXQgc3RvcmFnZSBtYXkgdGFrZSBvbmUgb2YgdGhlc2UgcGF0aHM6XG4gICAgICogMS4gQ3JlYXRlIHNlY3JldCBzdG9yYWdlIGZyb20gYSBwYXNzcGhyYXNlIGFuZCBzdG9yZSBjcm9zcy1zaWduaW5nIGtleXNcbiAgICAgKiAgICBpbiBzZWNyZXQgc3RvcmFnZS5cbiAgICAgKiAyLiBBY2Nlc3MgZXhpc3Rpbmcgc2VjcmV0IHN0b3JhZ2UgYnkgcmVxdWVzdGluZyBwYXNzcGhyYXNlIGFuZCBhY2Nlc3NpbmdcbiAgICAgKiAgICBjcm9zcy1zaWduaW5nIGtleXMgYXMgbmVlZGVkLlxuICAgICAqIDMuIEFsbCBrZXlzIGFyZSBsb2FkZWQgYW5kIHRoZXJlJ3Mgbm90aGluZyB0byBkby5cbiAgICAgKiBAcGFyYW0ge2Jvb2x9IFtmb3JjZVJlc2V0XSBCb290c3RyYXAgYWdhaW4gZXZlbiBpZiBrZXlzIGFscmVhZHkgcHJlc2VudFxuICAgICAqL1xuICAgIF9ib290c3RyYXBTZWN1cmVTZWNyZXRTdG9yYWdlID0gYXN5bmMgKGZvcmNlUmVzZXQ9ZmFsc2UpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVycm9yOiBudWxsIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgYWNjZXNzU2VjcmV0U3RvcmFnZSgoKSA9PiB1bmRlZmluZWQsIGZvcmNlUmVzZXQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyb3I6IGUgfSk7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgYm9vdHN0cmFwcGluZyBzZWNyZXQgc3RvcmFnZVwiLCBlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5fdW5tb3VudGVkKSByZXR1cm47XG4gICAgICAgIHRoaXMuX2dldFVwZGF0ZWRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBvbkRlc3Ryb3lTdG9yYWdlID0gKGFjdCkgPT4ge1xuICAgICAgICBpZiAoIWFjdCkgcmV0dXJuO1xuICAgICAgICB0aGlzLl9ib290c3RyYXBTZWN1cmVTZWNyZXRTdG9yYWdlKHRydWUpO1xuICAgIH1cblxuICAgIF9kZXN0cm95U2VjdXJlU2VjcmV0U3RvcmFnZSA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgQ29uZmlybURlc3Ryb3lDcm9zc1NpZ25pbmdEaWFsb2cgPSBzZGsuZ2V0Q29tcG9uZW50KFwiZGlhbG9ncy5Db25maXJtRGVzdHJveUNyb3NzU2lnbmluZ0RpYWxvZ1wiKTtcbiAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKENvbmZpcm1EZXN0cm95Q3Jvc3NTaWduaW5nRGlhbG9nLCB7XG4gICAgICAgICAgICBvbkZpbmlzaGVkOiB0aGlzLm9uRGVzdHJveVN0b3JhZ2UsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgQWNjZXNzaWJsZUJ1dHRvbiA9IHNkay5nZXRDb21wb25lbnQoXCJlbGVtZW50cy5BY2Nlc3NpYmxlQnV0dG9uXCIpO1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlLFxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgc2Vzc2lvbkJhY2t1cEtleUNhY2hlZCxcbiAgICAgICAgICAgIHNlc3Npb25CYWNrdXBLZXlXZWxsRm9ybWVkLFxuICAgICAgICAgICAgc2VjcmV0U3RvcmFnZUtleUluQWNjb3VudCxcbiAgICAgICAgICAgIGhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1JlYWR5LFxuICAgICAgICB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBsZXQgZXJyb3JTZWN0aW9uO1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yU2VjdGlvbiA9IDxkaXYgY2xhc3NOYW1lPVwiZXJyb3JcIj57ZXJyb3IudG9TdHJpbmcoKX08L2Rpdj47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBXaGV0aGVyIHRoZSB2YXJpb3VzIGtleXMgZXhpc3Qgb24geW91ciBhY2NvdW50IChidXQgbm90IG5lY2Vzc2FyaWx5XG4gICAgICAgIC8vIG9uIHRoaXMgZGV2aWNlKS5cbiAgICAgICAgY29uc3QgZW5hYmxlZEZvckFjY291bnQgPSAoXG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSAmJlxuICAgICAgICAgICAgc2VjcmV0U3RvcmFnZUtleUluQWNjb3VudFxuICAgICAgICApO1xuXG4gICAgICAgIGxldCBzdW1tYXJpc2VkU3RhdHVzO1xuICAgICAgICBpZiAoaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IElubGluZVNwaW5uZXIgPSBzZGsuZ2V0Q29tcG9uZW50KCd2aWV3cy5lbGVtZW50cy5JbmxpbmVTcGlubmVyJyk7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+PElubGluZVNwaW5uZXIgLz48L3A+O1xuICAgICAgICB9IGVsc2UgaWYgKCFob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcpIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8cD57X3QoXG4gICAgICAgICAgICAgICAgXCJZb3VyIGhvbWVzZXJ2ZXIgZG9lcyBub3Qgc3VwcG9ydCBjcm9zcy1zaWduaW5nLlwiLFxuICAgICAgICAgICAgKX08L3A+O1xuICAgICAgICB9IGVsc2UgaWYgKGNyb3NzU2lnbmluZ1JlYWR5KSB7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+4pyFIHtfdChcbiAgICAgICAgICAgICAgICBcIkNyb3NzLXNpZ25pbmcgYW5kIHNlY3JldCBzdG9yYWdlIGFyZSBlbmFibGVkLlwiLFxuICAgICAgICAgICAgKX08L3A+O1xuICAgICAgICB9IGVsc2UgaWYgKGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlKSB7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+e190KFxuICAgICAgICAgICAgICAgIFwiWW91ciBhY2NvdW50IGhhcyBhIGNyb3NzLXNpZ25pbmcgaWRlbnRpdHkgaW4gc2VjcmV0IHN0b3JhZ2UsIGJ1dCBpdCBcIiArXG4gICAgICAgICAgICAgICAgXCJpcyBub3QgeWV0IHRydXN0ZWQgYnkgdGhpcyBzZXNzaW9uLlwiLFxuICAgICAgICAgICAgKX08L3A+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VtbWFyaXNlZFN0YXR1cyA9IDxwPntfdChcbiAgICAgICAgICAgICAgICBcIkNyb3NzLXNpZ25pbmcgYW5kIHNlY3JldCBzdG9yYWdlIGFyZSBub3QgeWV0IHNldCB1cC5cIixcbiAgICAgICAgICAgICl9PC9wPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXNldEJ1dHRvbjtcbiAgICAgICAgaWYgKGVuYWJsZWRGb3JBY2NvdW50KSB7XG4gICAgICAgICAgICByZXNldEJ1dHRvbiA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0Nyb3NzU2lnbmluZ1BhbmVsX2J1dHRvblJvd1wiPlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwiZGFuZ2VyXCIgb25DbGljaz17dGhpcy5fZGVzdHJveVNlY3VyZVNlY3JldFN0b3JhZ2V9PlxuICAgICAgICAgICAgICAgICAgICAgICAge190KFwiUmVzZXQgY3Jvc3Mtc2lnbmluZyBhbmQgc2VjcmV0IHN0b3JhZ2VcIil9XG4gICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGJvb3RzdHJhcEJ1dHRvbjtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgKCFlbmFibGVkRm9yQWNjb3VudCB8fCAhY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlKSAmJlxuICAgICAgICAgICAgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nXG4gICAgICAgICkge1xuICAgICAgICAgICAgYm9vdHN0cmFwQnV0dG9uID0gKFxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ3Jvc3NTaWduaW5nUGFuZWxfYnV0dG9uUm93XCI+XG4gICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17dGhpcy5fb25Cb290c3RyYXBDbGlja30+XG4gICAgICAgICAgICAgICAgICAgICAgICB7X3QoXCJCb290c3RyYXAgY3Jvc3Mtc2lnbmluZyBhbmQgc2VjcmV0IHN0b3JhZ2VcIil9XG4gICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc2Vzc2lvbkJhY2t1cEtleVdlbGxGb3JtZWRUZXh0ID0gXCJcIjtcbiAgICAgICAgaWYgKHNlc3Npb25CYWNrdXBLZXlDYWNoZWQpIHtcbiAgICAgICAgICAgIHNlc3Npb25CYWNrdXBLZXlXZWxsRm9ybWVkVGV4dCA9IFwiLCBcIjtcbiAgICAgICAgICAgIGlmIChzZXNzaW9uQmFja3VwS2V5V2VsbEZvcm1lZCkge1xuICAgICAgICAgICAgICAgIHNlc3Npb25CYWNrdXBLZXlXZWxsRm9ybWVkVGV4dCArPSBfdChcIndlbGwgZm9ybWVkXCIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uQmFja3VwS2V5V2VsbEZvcm1lZFRleHQgKz0gX3QoXCJ1bmV4cGVjdGVkIHR5cGVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICB7c3VtbWFyaXNlZFN0YXR1c31cbiAgICAgICAgICAgICAgICA8ZGV0YWlscz5cbiAgICAgICAgICAgICAgICAgICAgPHN1bW1hcnk+e190KFwiQWR2YW5jZWRcIil9PC9zdW1tYXJ5PlxuICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPVwibXhfQ3Jvc3NTaWduaW5nUGFuZWxfc3RhdHVzTGlzdFwiPjx0Ym9keT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e190KFwiQ3Jvc3Mtc2lnbmluZyBwdWJsaWMga2V5czpcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2Nyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSA/IF90KFwiaW4gbWVtb3J5XCIpIDogX3QoXCJub3QgZm91bmRcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntfdChcIkNyb3NzLXNpZ25pbmcgcHJpdmF0ZSBrZXlzOlwiKX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57Y3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UgPyBfdChcImluIHNlY3JldCBzdG9yYWdlXCIpIDogX3QoXCJub3QgZm91bmRcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntfdChcIlNlbGYgc2lnbmluZyBwcml2YXRlIGtleTpcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e3NlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCA/IF90KFwiY2FjaGVkIGxvY2FsbHlcIikgOiBfdChcIm5vdCBmb3VuZCBsb2NhbGx5XCIpfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57X3QoXCJVc2VyIHNpZ25pbmcgcHJpdmF0ZSBrZXk6XCIpfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2VyU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQgPyBfdChcImNhY2hlZCBsb2NhbGx5XCIpIDogX3QoXCJub3QgZm91bmQgbG9jYWxseVwiKX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e190KFwiU2Vzc2lvbiBiYWNrdXAga2V5OlwiKX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge3Nlc3Npb25CYWNrdXBLZXlDYWNoZWQgPyBfdChcImNhY2hlZCBsb2NhbGx5XCIpIDogX3QoXCJub3QgZm91bmQgbG9jYWxseVwiKX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge3Nlc3Npb25CYWNrdXBLZXlXZWxsRm9ybWVkVGV4dH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e190KFwiU2VjcmV0IHN0b3JhZ2UgcHVibGljIGtleTpcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e3NlY3JldFN0b3JhZ2VLZXlJbkFjY291bnQgPyBfdChcImluIGFjY291bnQgZGF0YVwiKSA6IF90KFwibm90IGZvdW5kXCIpfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57X3QoXCJIb21lc2VydmVyIGZlYXR1cmUgc3VwcG9ydDpcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2hvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyA/IF90KFwiZXhpc3RzXCIpIDogX3QoXCJub3QgZm91bmRcIil9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgPC90Ym9keT48L3RhYmxlPlxuICAgICAgICAgICAgICAgIDwvZGV0YWlscz5cbiAgICAgICAgICAgICAgICB7ZXJyb3JTZWN0aW9ufVxuICAgICAgICAgICAgICAgIHtib290c3RyYXBCdXR0b259XG4gICAgICAgICAgICAgICAge3Jlc2V0QnV0dG9ufVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl19