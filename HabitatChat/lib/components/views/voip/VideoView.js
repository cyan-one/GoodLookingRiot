"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var _classnames = _interopRequireDefault(require("classnames"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function getFullScreenElement() {
  return document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
}

var _default = (0, _createReactClass.default)({
  displayName: 'VideoView',
  propTypes: {
    // maxHeight style attribute for the video element
    maxHeight: _propTypes.default.number,
    // a callback which is called when the user clicks on the video div
    onClick: _propTypes.default.func,
    // a callback which is called when the video element is resized due to
    // a change in video metadata
    onResize: _propTypes.default.func
  },
  // TODO: [REACT-WARNING] Replace component with real class, use constructor for refs
  UNSAFE_componentWillMount: function () {
    this._local = (0, _react.createRef)();
    this._remote = (0, _react.createRef)();
  },
  componentDidMount: function () {
    this.dispatcherRef = _dispatcher.default.register(this.onAction);
  },
  componentWillUnmount: function () {
    _dispatcher.default.unregister(this.dispatcherRef);
  },
  getRemoteVideoElement: function () {
    return _reactDom.default.findDOMNode(this._remote.current);
  },
  getRemoteAudioElement: function () {
    // this needs to be somewhere at the top of the DOM which
    // always exists to avoid audio interruptions.
    // Might as well just use DOM.
    const remoteAudioElement = document.getElementById("remoteAudio");

    if (!remoteAudioElement) {
      console.error("Failed to find remoteAudio element - cannot play audio!" + "You need to add an <audio/> to the DOM.");
    }

    return remoteAudioElement;
  },
  getLocalVideoElement: function () {
    return _reactDom.default.findDOMNode(this._local.current);
  },
  setContainer: function (c) {
    this.container = c;
  },
  onAction: function (payload) {
    switch (payload.action) {
      case 'video_fullscreen':
        {
          if (!this.container) {
            return;
          }

          const element = this.container;

          if (payload.fullscreen) {
            const requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullscreen;
            requestMethod.call(element);
          } else if (getFullScreenElement()) {
            const exitMethod = document.exitFullscreen || document.mozCancelFullScreen || document.webkitExitFullscreen || document.msExitFullscreen;

            if (exitMethod) {
              exitMethod.call(document);
            }
          }

          break;
        }
    }
  },
  render: function () {
    const VideoFeed = sdk.getComponent('voip.VideoFeed'); // if we're fullscreen, we don't want to set a maxHeight on the video element.

    const maxVideoHeight = getFullScreenElement() ? null : this.props.maxHeight;
    const localVideoFeedClasses = (0, _classnames.default)("mx_VideoView_localVideoFeed", {
      "mx_VideoView_localVideoFeed_flipped": _SettingsStore.default.getValue('VideoView.flipVideoHorizontally')
    });
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_VideoView",
      ref: this.setContainer,
      onClick: this.props.onClick
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_VideoView_remoteVideoFeed"
    }, /*#__PURE__*/_react.default.createElement(VideoFeed, {
      ref: this._remote,
      onResize: this.props.onResize,
      maxHeight: maxVideoHeight
    })), /*#__PURE__*/_react.default.createElement("div", {
      className: localVideoFeedClasses
    }, /*#__PURE__*/_react.default.createElement(VideoFeed, {
      ref: this._local
    })));
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3ZvaXAvVmlkZW9WaWV3LmpzIl0sIm5hbWVzIjpbImdldEZ1bGxTY3JlZW5FbGVtZW50IiwiZG9jdW1lbnQiLCJmdWxsc2NyZWVuRWxlbWVudCIsIm1vekZ1bGxTY3JlZW5FbGVtZW50Iiwid2Via2l0RnVsbHNjcmVlbkVsZW1lbnQiLCJtc0Z1bGxzY3JlZW5FbGVtZW50IiwiZGlzcGxheU5hbWUiLCJwcm9wVHlwZXMiLCJtYXhIZWlnaHQiLCJQcm9wVHlwZXMiLCJudW1iZXIiLCJvbkNsaWNrIiwiZnVuYyIsIm9uUmVzaXplIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCIsIl9sb2NhbCIsIl9yZW1vdGUiLCJjb21wb25lbnREaWRNb3VudCIsImRpc3BhdGNoZXJSZWYiLCJkaXMiLCJyZWdpc3RlciIsIm9uQWN0aW9uIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJ1bnJlZ2lzdGVyIiwiZ2V0UmVtb3RlVmlkZW9FbGVtZW50IiwiUmVhY3RET00iLCJmaW5kRE9NTm9kZSIsImN1cnJlbnQiLCJnZXRSZW1vdGVBdWRpb0VsZW1lbnQiLCJyZW1vdGVBdWRpb0VsZW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImNvbnNvbGUiLCJlcnJvciIsImdldExvY2FsVmlkZW9FbGVtZW50Iiwic2V0Q29udGFpbmVyIiwiYyIsImNvbnRhaW5lciIsInBheWxvYWQiLCJhY3Rpb24iLCJlbGVtZW50IiwiZnVsbHNjcmVlbiIsInJlcXVlc3RNZXRob2QiLCJyZXF1ZXN0RnVsbFNjcmVlbiIsIndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuIiwibW96UmVxdWVzdEZ1bGxTY3JlZW4iLCJtc1JlcXVlc3RGdWxsc2NyZWVuIiwiY2FsbCIsImV4aXRNZXRob2QiLCJleGl0RnVsbHNjcmVlbiIsIm1vekNhbmNlbEZ1bGxTY3JlZW4iLCJ3ZWJraXRFeGl0RnVsbHNjcmVlbiIsIm1zRXhpdEZ1bGxzY3JlZW4iLCJyZW5kZXIiLCJWaWRlb0ZlZWQiLCJzZGsiLCJnZXRDb21wb25lbnQiLCJtYXhWaWRlb0hlaWdodCIsInByb3BzIiwibG9jYWxWaWRlb0ZlZWRDbGFzc2VzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUExQkE7Ozs7Ozs7Ozs7Ozs7Ozs7QUE0QkEsU0FBU0Esb0JBQVQsR0FBZ0M7QUFDNUIsU0FDSUMsUUFBUSxDQUFDQyxpQkFBVCxJQUNBRCxRQUFRLENBQUNFLG9CQURULElBRUFGLFFBQVEsQ0FBQ0csdUJBRlQsSUFHQUgsUUFBUSxDQUFDSSxtQkFKYjtBQU1IOztlQUVjLCtCQUFpQjtBQUM1QkMsRUFBQUEsV0FBVyxFQUFFLFdBRGU7QUFHNUJDLEVBQUFBLFNBQVMsRUFBRTtBQUNQO0FBQ0FDLElBQUFBLFNBQVMsRUFBRUMsbUJBQVVDLE1BRmQ7QUFJUDtBQUNBQyxJQUFBQSxPQUFPLEVBQUVGLG1CQUFVRyxJQUxaO0FBT1A7QUFDQTtBQUNBQyxJQUFBQSxRQUFRLEVBQUVKLG1CQUFVRztBQVRiLEdBSGlCO0FBZTVCO0FBQ0FFLEVBQUFBLHlCQUF5QixFQUFFLFlBQVc7QUFDbEMsU0FBS0MsTUFBTCxHQUFjLHVCQUFkO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLHVCQUFmO0FBQ0gsR0FuQjJCO0FBcUI1QkMsRUFBQUEsaUJBQWlCLEVBQUUsWUFBVztBQUMxQixTQUFLQyxhQUFMLEdBQXFCQyxvQkFBSUMsUUFBSixDQUFhLEtBQUtDLFFBQWxCLENBQXJCO0FBQ0gsR0F2QjJCO0FBeUI1QkMsRUFBQUEsb0JBQW9CLEVBQUUsWUFBVztBQUM3Qkgsd0JBQUlJLFVBQUosQ0FBZSxLQUFLTCxhQUFwQjtBQUNILEdBM0IyQjtBQTZCNUJNLEVBQUFBLHFCQUFxQixFQUFFLFlBQVc7QUFDOUIsV0FBT0Msa0JBQVNDLFdBQVQsQ0FBcUIsS0FBS1YsT0FBTCxDQUFhVyxPQUFsQyxDQUFQO0FBQ0gsR0EvQjJCO0FBaUM1QkMsRUFBQUEscUJBQXFCLEVBQUUsWUFBVztBQUM5QjtBQUNBO0FBQ0E7QUFDQSxVQUFNQyxrQkFBa0IsR0FBRzVCLFFBQVEsQ0FBQzZCLGNBQVQsQ0FBd0IsYUFBeEIsQ0FBM0I7O0FBQ0EsUUFBSSxDQUFDRCxrQkFBTCxFQUF5QjtBQUNyQkUsTUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWMsNERBQ1IseUNBRE47QUFFSDs7QUFDRCxXQUFPSCxrQkFBUDtBQUNILEdBM0MyQjtBQTZDNUJJLEVBQUFBLG9CQUFvQixFQUFFLFlBQVc7QUFDN0IsV0FBT1Isa0JBQVNDLFdBQVQsQ0FBcUIsS0FBS1gsTUFBTCxDQUFZWSxPQUFqQyxDQUFQO0FBQ0gsR0EvQzJCO0FBaUQ1Qk8sRUFBQUEsWUFBWSxFQUFFLFVBQVNDLENBQVQsRUFBWTtBQUN0QixTQUFLQyxTQUFMLEdBQWlCRCxDQUFqQjtBQUNILEdBbkQyQjtBQXFENUJkLEVBQUFBLFFBQVEsRUFBRSxVQUFTZ0IsT0FBVCxFQUFrQjtBQUN4QixZQUFRQSxPQUFPLENBQUNDLE1BQWhCO0FBQ0ksV0FBSyxrQkFBTDtBQUF5QjtBQUNyQixjQUFJLENBQUMsS0FBS0YsU0FBVixFQUFxQjtBQUNqQjtBQUNIOztBQUNELGdCQUFNRyxPQUFPLEdBQUcsS0FBS0gsU0FBckI7O0FBQ0EsY0FBSUMsT0FBTyxDQUFDRyxVQUFaLEVBQXdCO0FBQ3BCLGtCQUFNQyxhQUFhLEdBQ2ZGLE9BQU8sQ0FBQ0csaUJBQVIsSUFDQUgsT0FBTyxDQUFDSSx1QkFEUixJQUVBSixPQUFPLENBQUNLLG9CQUZSLElBR0FMLE9BQU8sQ0FBQ00sbUJBSlo7QUFNQUosWUFBQUEsYUFBYSxDQUFDSyxJQUFkLENBQW1CUCxPQUFuQjtBQUNILFdBUkQsTUFRTyxJQUFJdkMsb0JBQW9CLEVBQXhCLEVBQTRCO0FBQy9CLGtCQUFNK0MsVUFBVSxHQUNaOUMsUUFBUSxDQUFDK0MsY0FBVCxJQUNBL0MsUUFBUSxDQUFDZ0QsbUJBRFQsSUFFQWhELFFBQVEsQ0FBQ2lELG9CQUZULElBR0FqRCxRQUFRLENBQUNrRCxnQkFKYjs7QUFNQSxnQkFBSUosVUFBSixFQUFnQjtBQUNaQSxjQUFBQSxVQUFVLENBQUNELElBQVgsQ0FBZ0I3QyxRQUFoQjtBQUNIO0FBQ0o7O0FBQ0Q7QUFDSDtBQTFCTDtBQTRCSCxHQWxGMkI7QUFvRjVCbUQsRUFBQUEsTUFBTSxFQUFFLFlBQVc7QUFDZixVQUFNQyxTQUFTLEdBQUdDLEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixnQkFBakIsQ0FBbEIsQ0FEZSxDQUdmOztBQUNBLFVBQU1DLGNBQWMsR0FBR3hELG9CQUFvQixLQUFLLElBQUwsR0FBWSxLQUFLeUQsS0FBTCxDQUFXakQsU0FBbEU7QUFDQSxVQUFNa0QscUJBQXFCLEdBQUcseUJBQVcsNkJBQVgsRUFDMUI7QUFBRSw2Q0FDRUMsdUJBQWNDLFFBQWQsQ0FBdUIsaUNBQXZCO0FBREosS0FEMEIsQ0FBOUI7QUFLQSx3QkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDLGNBQWY7QUFBOEIsTUFBQSxHQUFHLEVBQUUsS0FBSzFCLFlBQXhDO0FBQXNELE1BQUEsT0FBTyxFQUFFLEtBQUt1QixLQUFMLENBQVc5QztBQUExRSxvQkFDSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsb0JBQ0ksNkJBQUMsU0FBRDtBQUFXLE1BQUEsR0FBRyxFQUFFLEtBQUtLLE9BQXJCO0FBQThCLE1BQUEsUUFBUSxFQUFFLEtBQUt5QyxLQUFMLENBQVc1QyxRQUFuRDtBQUNJLE1BQUEsU0FBUyxFQUFFMkM7QUFEZixNQURKLENBREosZUFLSTtBQUFLLE1BQUEsU0FBUyxFQUFFRTtBQUFoQixvQkFDSSw2QkFBQyxTQUFEO0FBQVcsTUFBQSxHQUFHLEVBQUUsS0FBSzNDO0FBQXJCLE1BREosQ0FMSixDQURKO0FBV0g7QUF6RzJCLENBQWpCLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUsIDIwMTYgT3Blbk1hcmtldCBMdGRcbkNvcHlyaWdodCAyMDE5IFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0LCB7Y3JlYXRlUmVmfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgY3JlYXRlUmVhY3RDbGFzcyBmcm9tICdjcmVhdGUtcmVhY3QtY2xhc3MnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5cbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi8uLi8uLi9pbmRleCc7XG5pbXBvcnQgZGlzIGZyb20gJy4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlcic7XG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5cbmZ1bmN0aW9uIGdldEZ1bGxTY3JlZW5FbGVtZW50KCkge1xuICAgIHJldHVybiAoXG4gICAgICAgIGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50IHx8XG4gICAgICAgIGRvY3VtZW50Lm1vekZ1bGxTY3JlZW5FbGVtZW50IHx8XG4gICAgICAgIGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbGVtZW50IHx8XG4gICAgICAgIGRvY3VtZW50Lm1zRnVsbHNjcmVlbkVsZW1lbnRcbiAgICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVSZWFjdENsYXNzKHtcbiAgICBkaXNwbGF5TmFtZTogJ1ZpZGVvVmlldycsXG5cbiAgICBwcm9wVHlwZXM6IHtcbiAgICAgICAgLy8gbWF4SGVpZ2h0IHN0eWxlIGF0dHJpYnV0ZSBmb3IgdGhlIHZpZGVvIGVsZW1lbnRcbiAgICAgICAgbWF4SGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgICAgIC8vIGEgY2FsbGJhY2sgd2hpY2ggaXMgY2FsbGVkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIG9uIHRoZSB2aWRlbyBkaXZcbiAgICAgICAgb25DbGljazogUHJvcFR5cGVzLmZ1bmMsXG5cbiAgICAgICAgLy8gYSBjYWxsYmFjayB3aGljaCBpcyBjYWxsZWQgd2hlbiB0aGUgdmlkZW8gZWxlbWVudCBpcyByZXNpemVkIGR1ZSB0b1xuICAgICAgICAvLyBhIGNoYW5nZSBpbiB2aWRlbyBtZXRhZGF0YVxuICAgICAgICBvblJlc2l6ZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgfSxcblxuICAgIC8vIFRPRE86IFtSRUFDVC1XQVJOSU5HXSBSZXBsYWNlIGNvbXBvbmVudCB3aXRoIHJlYWwgY2xhc3MsIHVzZSBjb25zdHJ1Y3RvciBmb3IgcmVmc1xuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLl9sb2NhbCA9IGNyZWF0ZVJlZigpO1xuICAgICAgICB0aGlzLl9yZW1vdGUgPSBjcmVhdGVSZWYoKTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmRpc3BhdGNoZXJSZWYgPSBkaXMucmVnaXN0ZXIodGhpcy5vbkFjdGlvbik7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgZGlzLnVucmVnaXN0ZXIodGhpcy5kaXNwYXRjaGVyUmVmKTtcbiAgICB9LFxuXG4gICAgZ2V0UmVtb3RlVmlkZW9FbGVtZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMuX3JlbW90ZS5jdXJyZW50KTtcbiAgICB9LFxuXG4gICAgZ2V0UmVtb3RlQXVkaW9FbGVtZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgLy8gdGhpcyBuZWVkcyB0byBiZSBzb21ld2hlcmUgYXQgdGhlIHRvcCBvZiB0aGUgRE9NIHdoaWNoXG4gICAgICAgIC8vIGFsd2F5cyBleGlzdHMgdG8gYXZvaWQgYXVkaW8gaW50ZXJydXB0aW9ucy5cbiAgICAgICAgLy8gTWlnaHQgYXMgd2VsbCBqdXN0IHVzZSBET00uXG4gICAgICAgIGNvbnN0IHJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmVtb3RlQXVkaW9cIik7XG4gICAgICAgIGlmICghcmVtb3RlQXVkaW9FbGVtZW50KSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGZpbmQgcmVtb3RlQXVkaW8gZWxlbWVudCAtIGNhbm5vdCBwbGF5IGF1ZGlvIVwiXG4gICAgICAgICAgICAgICAgKyBcIllvdSBuZWVkIHRvIGFkZCBhbiA8YXVkaW8vPiB0byB0aGUgRE9NLlwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVtb3RlQXVkaW9FbGVtZW50O1xuICAgIH0sXG5cbiAgICBnZXRMb2NhbFZpZGVvRWxlbWVudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBSZWFjdERPTS5maW5kRE9NTm9kZSh0aGlzLl9sb2NhbC5jdXJyZW50KTtcbiAgICB9LFxuXG4gICAgc2V0Q29udGFpbmVyOiBmdW5jdGlvbihjKSB7XG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gYztcbiAgICB9LFxuXG4gICAgb25BY3Rpb246IGZ1bmN0aW9uKHBheWxvYWQpIHtcbiAgICAgICAgc3dpdGNoIChwYXlsb2FkLmFjdGlvbikge1xuICAgICAgICAgICAgY2FzZSAndmlkZW9fZnVsbHNjcmVlbic6IHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLmZ1bGxzY3JlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdE1ldGhvZCA9IChcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdEZ1bGxTY3JlZW4gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQubXNSZXF1ZXN0RnVsbHNjcmVlblxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TWV0aG9kLmNhbGwoZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChnZXRGdWxsU2NyZWVuRWxlbWVudCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXRNZXRob2QgPSAoXG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5leGl0RnVsbHNjcmVlbiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQud2Via2l0RXhpdEZ1bGxzY3JlZW4gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50Lm1zRXhpdEZ1bGxzY3JlZW5cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXRNZXRob2QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXRNZXRob2QuY2FsbChkb2N1bWVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc3QgVmlkZW9GZWVkID0gc2RrLmdldENvbXBvbmVudCgndm9pcC5WaWRlb0ZlZWQnKTtcblxuICAgICAgICAvLyBpZiB3ZSdyZSBmdWxsc2NyZWVuLCB3ZSBkb24ndCB3YW50IHRvIHNldCBhIG1heEhlaWdodCBvbiB0aGUgdmlkZW8gZWxlbWVudC5cbiAgICAgICAgY29uc3QgbWF4VmlkZW9IZWlnaHQgPSBnZXRGdWxsU2NyZWVuRWxlbWVudCgpID8gbnVsbCA6IHRoaXMucHJvcHMubWF4SGVpZ2h0O1xuICAgICAgICBjb25zdCBsb2NhbFZpZGVvRmVlZENsYXNzZXMgPSBjbGFzc05hbWVzKFwibXhfVmlkZW9WaWV3X2xvY2FsVmlkZW9GZWVkXCIsXG4gICAgICAgICAgICB7IFwibXhfVmlkZW9WaWV3X2xvY2FsVmlkZW9GZWVkX2ZsaXBwZWRcIjpcbiAgICAgICAgICAgICAgICBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKCdWaWRlb1ZpZXcuZmxpcFZpZGVvSG9yaXpvbnRhbGx5JyksXG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9WaWRlb1ZpZXdcIiByZWY9e3RoaXMuc2V0Q29udGFpbmVyfSBvbkNsaWNrPXt0aGlzLnByb3BzLm9uQ2xpY2t9PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfVmlkZW9WaWV3X3JlbW90ZVZpZGVvRmVlZFwiPlxuICAgICAgICAgICAgICAgICAgICA8VmlkZW9GZWVkIHJlZj17dGhpcy5fcmVtb3RlfSBvblJlc2l6ZT17dGhpcy5wcm9wcy5vblJlc2l6ZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG1heEhlaWdodD17bWF4VmlkZW9IZWlnaHR9IC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2xvY2FsVmlkZW9GZWVkQ2xhc3Nlc30+XG4gICAgICAgICAgICAgICAgICAgIDxWaWRlb0ZlZWQgcmVmPXt0aGlzLl9sb2NhbH0gLz5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG59KTtcbiJdfQ==