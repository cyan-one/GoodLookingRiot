"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _AppTile = _interopRequireDefault(require("../elements/AppTile"));

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var sdk = _interopRequireWildcard(require("../../../index"));

var ScalarMessaging = _interopRequireWildcard(require("../../../ScalarMessaging"));

var _languageHandler = require("../../../languageHandler");

var _WidgetUtils = _interopRequireDefault(require("../../../utils/WidgetUtils"));

var _WidgetEchoStore = _interopRequireDefault(require("../../../stores/WidgetEchoStore"));

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _IntegrationManagers = require("../../../integrations/IntegrationManagers");

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

/*
Copyright 2017 Vector Creations Ltd
Copyright 2018 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// The maximum number of widgets that can be added in a room
const MAX_WIDGETS = 2;

var _default = (0, _createReactClass.default)({
  displayName: 'AppsDrawer',
  propTypes: {
    userId: _propTypes.default.string.isRequired,
    room: _propTypes.default.object.isRequired,
    showApps: _propTypes.default.bool,
    // Should apps be rendered
    hide: _propTypes.default.bool // If rendered, should apps drawer be visible

  },
  getDefaultProps: () => ({
    showApps: true,
    hide: false
  }),
  getInitialState: function () {
    return {
      apps: this._getApps()
    };
  },
  componentDidMount: function () {
    ScalarMessaging.startListening();

    _MatrixClientPeg.MatrixClientPeg.get().on('RoomState.events', this.onRoomStateEvents);

    _WidgetEchoStore.default.on('update', this._updateApps);

    this.dispatcherRef = _dispatcher.default.register(this.onAction);
  },
  componentWillUnmount: function () {
    ScalarMessaging.stopListening();

    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener('RoomState.events', this.onRoomStateEvents);
    }

    _WidgetEchoStore.default.removeListener('update', this._updateApps);

    if (this.dispatcherRef) _dispatcher.default.unregister(this.dispatcherRef);
  },

  // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  UNSAFE_componentWillReceiveProps(newProps) {
    // Room has changed probably, update apps
    this._updateApps();
  },

  onAction: function (action) {
    const hideWidgetKey = this.props.room.roomId + '_hide_widget_drawer';

    switch (action.action) {
      case 'appsDrawer':
        // Note: these booleans are awkward because localstorage is fundamentally
        // string-based. We also do exact equality on the strings later on.
        if (action.show) {
          localStorage.setItem(hideWidgetKey, "false");
        } else {
          // Store hidden state of widget
          // Don't show if previously hidden
          localStorage.setItem(hideWidgetKey, "true");
        }

        break;
    }
  },
  onRoomStateEvents: function (ev, state) {
    if (ev.getRoomId() !== this.props.room.roomId || ev.getType() !== 'im.vector.modular.widgets') {
      return;
    }

    this._updateApps();
  },
  _getApps: function () {
    const widgets = _WidgetEchoStore.default.getEchoedRoomWidgets(this.props.room.roomId, _WidgetUtils.default.getRoomWidgets(this.props.room));

    return widgets.map(ev => {
      return _WidgetUtils.default.makeAppConfig(ev.getStateKey(), ev.getContent(), ev.getSender(), ev.getRoomId(), ev.getId());
    });
  },
  _updateApps: function () {
    const apps = this._getApps();

    this.setState({
      apps: apps
    });
  },
  _canUserModify: function () {
    try {
      return _WidgetUtils.default.canUserModifyWidgets(this.props.room.roomId);
    } catch (err) {
      console.error(err);
      return false;
    }
  },
  _launchManageIntegrations: function () {
    if (_SettingsStore.default.isFeatureEnabled("feature_many_integration_managers")) {
      _IntegrationManagers.IntegrationManagers.sharedInstance().openAll();
    } else {
      _IntegrationManagers.IntegrationManagers.sharedInstance().getPrimaryManager().open(this.props.room, 'add_integ');
    }
  },
  onClickAddWidget: function (e) {
    e.preventDefault(); // Display a warning dialog if the max number of widgets have already been added to the room

    const apps = this._getApps();

    if (apps && apps.length >= MAX_WIDGETS) {
      const ErrorDialog = sdk.getComponent('dialogs.ErrorDialog');
      const errorMsg = "The maximum number of ".concat(MAX_WIDGETS, " widgets have already been added to this room.");
      console.error(errorMsg);

      _Modal.default.createDialog(ErrorDialog, {
        title: (0, _languageHandler._t)('Cannot add any more widgets'),
        description: (0, _languageHandler._t)('The maximum permitted number of widgets have already been added to this room.')
      });

      return;
    }

    this._launchManageIntegrations();
  },
  render: function () {
    const apps = this.state.apps.map((app, index, arr) => {
      const capWhitelist = _WidgetUtils.default.getCapWhitelistForAppTypeInRoomId(app.type, this.props.room.roomId);

      return /*#__PURE__*/_react.default.createElement(_AppTile.default, {
        key: app.id,
        app: app,
        fullWidth: arr.length < 2 ? true : false,
        room: this.props.room,
        userId: this.props.userId,
        show: this.props.showApps,
        creatorUserId: app.creatorUserId,
        widgetPageTitle: app.data && app.data.title ? app.data.title : '',
        waitForIframeLoad: app.waitForIframeLoad,
        whitelistCapabilities: capWhitelist
      });
    });

    if (apps.length == 0) {
      return /*#__PURE__*/_react.default.createElement("div", null);
    }

    let addWidget;

    if (this.props.showApps && this._canUserModify()) {
      addWidget = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onClickAddWidget,
        className: this.state.apps.length < 2 ? 'mx_AddWidget_button mx_AddWidget_button_full_width' : 'mx_AddWidget_button',
        title: (0, _languageHandler._t)('Add a widget')
      }, "[+] ", (0, _languageHandler._t)('Add a widget'));
    }

    let spinner;

    if (apps.length === 0 && _WidgetEchoStore.default.roomHasPendingWidgets(this.props.room.roomId, _WidgetUtils.default.getRoomWidgets(this.props.room))) {
      const Loader = sdk.getComponent("elements.Spinner");
      spinner = /*#__PURE__*/_react.default.createElement(Loader, null);
    }

    return /*#__PURE__*/_react.default.createElement("div", {
      className: 'mx_AppsDrawer' + (this.props.hide ? ' mx_AppsDrawer_hidden' : '')
    }, /*#__PURE__*/_react.default.createElement("div", {
      id: "apps",
      className: "mx_AppsContainer"
    }, apps, spinner), this._canUserModify() && addWidget);
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL0FwcHNEcmF3ZXIuanMiXSwibmFtZXMiOlsiTUFYX1dJREdFVFMiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsInVzZXJJZCIsIlByb3BUeXBlcyIsInN0cmluZyIsImlzUmVxdWlyZWQiLCJyb29tIiwib2JqZWN0Iiwic2hvd0FwcHMiLCJib29sIiwiaGlkZSIsImdldERlZmF1bHRQcm9wcyIsImdldEluaXRpYWxTdGF0ZSIsImFwcHMiLCJfZ2V0QXBwcyIsImNvbXBvbmVudERpZE1vdW50IiwiU2NhbGFyTWVzc2FnaW5nIiwic3RhcnRMaXN0ZW5pbmciLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJvbiIsIm9uUm9vbVN0YXRlRXZlbnRzIiwiV2lkZ2V0RWNob1N0b3JlIiwiX3VwZGF0ZUFwcHMiLCJkaXNwYXRjaGVyUmVmIiwiZGlzIiwicmVnaXN0ZXIiLCJvbkFjdGlvbiIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwic3RvcExpc3RlbmluZyIsInJlbW92ZUxpc3RlbmVyIiwidW5yZWdpc3RlciIsIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwibmV3UHJvcHMiLCJhY3Rpb24iLCJoaWRlV2lkZ2V0S2V5IiwicHJvcHMiLCJyb29tSWQiLCJzaG93IiwibG9jYWxTdG9yYWdlIiwic2V0SXRlbSIsImV2Iiwic3RhdGUiLCJnZXRSb29tSWQiLCJnZXRUeXBlIiwid2lkZ2V0cyIsImdldEVjaG9lZFJvb21XaWRnZXRzIiwiV2lkZ2V0VXRpbHMiLCJnZXRSb29tV2lkZ2V0cyIsIm1hcCIsIm1ha2VBcHBDb25maWciLCJnZXRTdGF0ZUtleSIsImdldENvbnRlbnQiLCJnZXRTZW5kZXIiLCJnZXRJZCIsInNldFN0YXRlIiwiX2NhblVzZXJNb2RpZnkiLCJjYW5Vc2VyTW9kaWZ5V2lkZ2V0cyIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIl9sYXVuY2hNYW5hZ2VJbnRlZ3JhdGlvbnMiLCJTZXR0aW5nc1N0b3JlIiwiaXNGZWF0dXJlRW5hYmxlZCIsIkludGVncmF0aW9uTWFuYWdlcnMiLCJzaGFyZWRJbnN0YW5jZSIsIm9wZW5BbGwiLCJnZXRQcmltYXJ5TWFuYWdlciIsIm9wZW4iLCJvbkNsaWNrQWRkV2lkZ2V0IiwiZSIsInByZXZlbnREZWZhdWx0IiwibGVuZ3RoIiwiRXJyb3JEaWFsb2ciLCJzZGsiLCJnZXRDb21wb25lbnQiLCJlcnJvck1zZyIsIk1vZGFsIiwiY3JlYXRlRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsInJlbmRlciIsImFwcCIsImluZGV4IiwiYXJyIiwiY2FwV2hpdGVsaXN0IiwiZ2V0Q2FwV2hpdGVsaXN0Rm9yQXBwVHlwZUluUm9vbUlkIiwidHlwZSIsImlkIiwiY3JlYXRvclVzZXJJZCIsImRhdGEiLCJ3YWl0Rm9ySWZyYW1lTG9hZCIsImFkZFdpZGdldCIsInNwaW5uZXIiLCJyb29tSGFzUGVuZGluZ1dpZGdldHMiLCJMb2FkZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQS9CQTs7Ozs7Ozs7Ozs7Ozs7OztBQWlDQTtBQUNBLE1BQU1BLFdBQVcsR0FBRyxDQUFwQjs7ZUFFZSwrQkFBaUI7QUFDNUJDLEVBQUFBLFdBQVcsRUFBRSxZQURlO0FBRzVCQyxFQUFBQSxTQUFTLEVBQUU7QUFDUEMsSUFBQUEsTUFBTSxFQUFFQyxtQkFBVUMsTUFBVixDQUFpQkMsVUFEbEI7QUFFUEMsSUFBQUEsSUFBSSxFQUFFSCxtQkFBVUksTUFBVixDQUFpQkYsVUFGaEI7QUFHUEcsSUFBQUEsUUFBUSxFQUFFTCxtQkFBVU0sSUFIYjtBQUdtQjtBQUMxQkMsSUFBQUEsSUFBSSxFQUFFUCxtQkFBVU0sSUFKVCxDQUllOztBQUpmLEdBSGlCO0FBVTVCRSxFQUFBQSxlQUFlLEVBQUUsT0FBTztB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LENBREo7QUFTSDtBQWpMMkIsQ0FBakIsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZFxuQ29weXJpZ2h0IDIwMTggTmV3IFZlY3RvciBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBBcHBUaWxlIGZyb20gJy4uL2VsZW1lbnRzL0FwcFRpbGUnO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uLy4uL01vZGFsJztcbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuLi8uLi8uLi9pbmRleCc7XG5pbXBvcnQgKiBhcyBTY2FsYXJNZXNzYWdpbmcgZnJvbSAnLi4vLi4vLi4vU2NhbGFyTWVzc2FnaW5nJztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCBXaWRnZXRVdGlscyBmcm9tICcuLi8uLi8uLi91dGlscy9XaWRnZXRVdGlscyc7XG5pbXBvcnQgV2lkZ2V0RWNob1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvV2lkZ2V0RWNob1N0b3JlXCI7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tICcuLi9lbGVtZW50cy9BY2Nlc3NpYmxlQnV0dG9uJztcbmltcG9ydCB7SW50ZWdyYXRpb25NYW5hZ2Vyc30gZnJvbSBcIi4uLy4uLy4uL2ludGVncmF0aW9ucy9JbnRlZ3JhdGlvbk1hbmFnZXJzXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuXG4vLyBUaGUgbWF4aW11bSBudW1iZXIgb2Ygd2lkZ2V0cyB0aGF0IGNhbiBiZSBhZGRlZCBpbiBhIHJvb21cbmNvbnN0IE1BWF9XSURHRVRTID0gMjtcblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlUmVhY3RDbGFzcyh7XG4gICAgZGlzcGxheU5hbWU6ICdBcHBzRHJhd2VyJyxcblxuICAgIHByb3BUeXBlczoge1xuICAgICAgICB1c2VySWQ6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICAgICAgcm9vbTogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgICAgICBzaG93QXBwczogUHJvcFR5cGVzLmJvb2wsIC8vIFNob3VsZCBhcHBzIGJlIHJlbmRlcmVkXG4gICAgICAgIGhpZGU6IFByb3BUeXBlcy5ib29sLCAvLyBJZiByZW5kZXJlZCwgc2hvdWxkIGFwcHMgZHJhd2VyIGJlIHZpc2libGVcbiAgICB9LFxuXG4gICAgZ2V0RGVmYXVsdFByb3BzOiAoKSA9PiAoe1xuICAgICAgICBzaG93QXBwczogdHJ1ZSxcbiAgICAgICAgaGlkZTogZmFsc2UsXG4gICAgfSksXG5cbiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYXBwczogdGhpcy5fZ2V0QXBwcygpLFxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIFNjYWxhck1lc3NhZ2luZy5zdGFydExpc3RlbmluZygpO1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oJ1Jvb21TdGF0ZS5ldmVudHMnLCB0aGlzLm9uUm9vbVN0YXRlRXZlbnRzKTtcbiAgICAgICAgV2lkZ2V0RWNob1N0b3JlLm9uKCd1cGRhdGUnLCB0aGlzLl91cGRhdGVBcHBzKTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gZGlzLnJlZ2lzdGVyKHRoaXMub25BY3Rpb24pO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIFNjYWxhck1lc3NhZ2luZy5zdG9wTGlzdGVuaW5nKCk7XG4gICAgICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZW1vdmVMaXN0ZW5lcignUm9vbVN0YXRlLmV2ZW50cycsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICB9XG4gICAgICAgIFdpZGdldEVjaG9TdG9yZS5yZW1vdmVMaXN0ZW5lcigndXBkYXRlJywgdGhpcy5fdXBkYXRlQXBwcyk7XG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXJSZWYpIGRpcy51bnJlZ2lzdGVyKHRoaXMuZGlzcGF0Y2hlclJlZik7XG4gICAgfSxcblxuICAgIC8vIFRPRE86IFtSRUFDVC1XQVJOSU5HXSBSZXBsYWNlIHdpdGggYXBwcm9wcmlhdGUgbGlmZWN5Y2xlIGV2ZW50XG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMpIHtcbiAgICAgICAgLy8gUm9vbSBoYXMgY2hhbmdlZCBwcm9iYWJseSwgdXBkYXRlIGFwcHNcbiAgICAgICAgdGhpcy5fdXBkYXRlQXBwcygpO1xuICAgIH0sXG5cbiAgICBvbkFjdGlvbjogZnVuY3Rpb24oYWN0aW9uKSB7XG4gICAgICAgIGNvbnN0IGhpZGVXaWRnZXRLZXkgPSB0aGlzLnByb3BzLnJvb20ucm9vbUlkICsgJ19oaWRlX3dpZGdldF9kcmF3ZXInO1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbi5hY3Rpb24pIHtcbiAgICAgICAgICAgIGNhc2UgJ2FwcHNEcmF3ZXInOlxuICAgICAgICAgICAgICAgIC8vIE5vdGU6IHRoZXNlIGJvb2xlYW5zIGFyZSBhd2t3YXJkIGJlY2F1c2UgbG9jYWxzdG9yYWdlIGlzIGZ1bmRhbWVudGFsbHlcbiAgICAgICAgICAgICAgICAvLyBzdHJpbmctYmFzZWQuIFdlIGFsc28gZG8gZXhhY3QgZXF1YWxpdHkgb24gdGhlIHN0cmluZ3MgbGF0ZXIgb24uXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5zaG93KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGhpZGVXaWRnZXRLZXksIFwiZmFsc2VcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU3RvcmUgaGlkZGVuIHN0YXRlIG9mIHdpZGdldFxuICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBzaG93IGlmIHByZXZpb3VzbHkgaGlkZGVuXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGhpZGVXaWRnZXRLZXksIFwidHJ1ZVwiKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBvblJvb21TdGF0ZUV2ZW50czogZnVuY3Rpb24oZXYsIHN0YXRlKSB7XG4gICAgICAgIGlmIChldi5nZXRSb29tSWQoKSAhPT0gdGhpcy5wcm9wcy5yb29tLnJvb21JZCB8fCBldi5nZXRUeXBlKCkgIT09ICdpbS52ZWN0b3IubW9kdWxhci53aWRnZXRzJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3VwZGF0ZUFwcHMoKTtcbiAgICB9LFxuXG4gICAgX2dldEFwcHM6IGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCB3aWRnZXRzID0gV2lkZ2V0RWNob1N0b3JlLmdldEVjaG9lZFJvb21XaWRnZXRzKFxuICAgICAgICAgICAgdGhpcy5wcm9wcy5yb29tLnJvb21JZCwgV2lkZ2V0VXRpbHMuZ2V0Um9vbVdpZGdldHModGhpcy5wcm9wcy5yb29tKSxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHdpZGdldHMubWFwKChldikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFdpZGdldFV0aWxzLm1ha2VBcHBDb25maWcoXG4gICAgICAgICAgICAgICAgZXYuZ2V0U3RhdGVLZXkoKSwgZXYuZ2V0Q29udGVudCgpLCBldi5nZXRTZW5kZXIoKSwgZXYuZ2V0Um9vbUlkKCksIGV2LmdldElkKCksXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgX3VwZGF0ZUFwcHM6IGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCBhcHBzID0gdGhpcy5fZ2V0QXBwcygpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGFwcHM6IGFwcHMsXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBfY2FuVXNlck1vZGlmeTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gV2lkZ2V0VXRpbHMuY2FuVXNlck1vZGlmeVdpZGdldHModGhpcy5wcm9wcy5yb29tLnJvb21JZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9sYXVuY2hNYW5hZ2VJbnRlZ3JhdGlvbnM6IGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5pc0ZlYXR1cmVFbmFibGVkKFwiZmVhdHVyZV9tYW55X2ludGVncmF0aW9uX21hbmFnZXJzXCIpKSB7XG4gICAgICAgICAgICBJbnRlZ3JhdGlvbk1hbmFnZXJzLnNoYXJlZEluc3RhbmNlKCkub3BlbkFsbCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgSW50ZWdyYXRpb25NYW5hZ2Vycy5zaGFyZWRJbnN0YW5jZSgpLmdldFByaW1hcnlNYW5hZ2VyKCkub3Blbih0aGlzLnByb3BzLnJvb20sICdhZGRfaW50ZWcnKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBvbkNsaWNrQWRkV2lkZ2V0OiBmdW5jdGlvbihlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgLy8gRGlzcGxheSBhIHdhcm5pbmcgZGlhbG9nIGlmIHRoZSBtYXggbnVtYmVyIG9mIHdpZGdldHMgaGF2ZSBhbHJlYWR5IGJlZW4gYWRkZWQgdG8gdGhlIHJvb21cbiAgICAgICAgY29uc3QgYXBwcyA9IHRoaXMuX2dldEFwcHMoKTtcbiAgICAgICAgaWYgKGFwcHMgJiYgYXBwcy5sZW5ndGggPj0gTUFYX1dJREdFVFMpIHtcbiAgICAgICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudCgnZGlhbG9ncy5FcnJvckRpYWxvZycpO1xuICAgICAgICAgICAgY29uc3QgZXJyb3JNc2cgPSBgVGhlIG1heGltdW0gbnVtYmVyIG9mICR7TUFYX1dJREdFVFN9IHdpZGdldHMgaGF2ZSBhbHJlYWR5IGJlZW4gYWRkZWQgdG8gdGhpcyByb29tLmA7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yTXNnKTtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdCgnQ2Fubm90IGFkZCBhbnkgbW9yZSB3aWRnZXRzJyksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF90KCdUaGUgbWF4aW11bSBwZXJtaXR0ZWQgbnVtYmVyIG9mIHdpZGdldHMgaGF2ZSBhbHJlYWR5IGJlZW4gYWRkZWQgdG8gdGhpcyByb29tLicpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fbGF1bmNoTWFuYWdlSW50ZWdyYXRpb25zKCk7XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnN0IGFwcHMgPSB0aGlzLnN0YXRlLmFwcHMubWFwKChhcHAsIGluZGV4LCBhcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNhcFdoaXRlbGlzdCA9IFdpZGdldFV0aWxzLmdldENhcFdoaXRlbGlzdEZvckFwcFR5cGVJblJvb21JZChhcHAudHlwZSwgdGhpcy5wcm9wcy5yb29tLnJvb21JZCk7XG5cbiAgICAgICAgICAgIHJldHVybiAoPEFwcFRpbGVcbiAgICAgICAgICAgICAgICBrZXk9e2FwcC5pZH1cbiAgICAgICAgICAgICAgICBhcHA9e2FwcH1cbiAgICAgICAgICAgICAgICBmdWxsV2lkdGg9e2Fyci5sZW5ndGg8MiA/IHRydWUgOiBmYWxzZX1cbiAgICAgICAgICAgICAgICByb29tPXt0aGlzLnByb3BzLnJvb219XG4gICAgICAgICAgICAgICAgdXNlcklkPXt0aGlzLnByb3BzLnVzZXJJZH1cbiAgICAgICAgICAgICAgICBzaG93PXt0aGlzLnByb3BzLnNob3dBcHBzfVxuICAgICAgICAgICAgICAgIGNyZWF0b3JVc2VySWQ9e2FwcC5jcmVhdG9yVXNlcklkfVxuICAgICAgICAgICAgICAgIHdpZGdldFBhZ2VUaXRsZT17KGFwcC5kYXRhICYmIGFwcC5kYXRhLnRpdGxlKSA/IGFwcC5kYXRhLnRpdGxlIDogJyd9XG4gICAgICAgICAgICAgICAgd2FpdEZvcklmcmFtZUxvYWQ9e2FwcC53YWl0Rm9ySWZyYW1lTG9hZH1cbiAgICAgICAgICAgICAgICB3aGl0ZWxpc3RDYXBhYmlsaXRpZXM9e2NhcFdoaXRlbGlzdH1cbiAgICAgICAgICAgIC8+KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGFwcHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHJldHVybiA8ZGl2PjwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhZGRXaWRnZXQ7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnNob3dBcHBzICYmXG4gICAgICAgICAgICB0aGlzLl9jYW5Vc2VyTW9kaWZ5KClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBhZGRXaWRnZXQgPSA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25DbGlja0FkZFdpZGdldH1cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e3RoaXMuc3RhdGUuYXBwcy5sZW5ndGg8MiA/XG4gICAgICAgICAgICAgICAgICAgICdteF9BZGRXaWRnZXRfYnV0dG9uIG14X0FkZFdpZGdldF9idXR0b25fZnVsbF93aWR0aCcgOlxuICAgICAgICAgICAgICAgICAgICAnbXhfQWRkV2lkZ2V0X2J1dHRvbidcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGl0bGU9e190KCdBZGQgYSB3aWRnZXQnKX0+XG4gICAgICAgICAgICAgICAgWytdIHsgX3QoJ0FkZCBhIHdpZGdldCcpIH1cbiAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc3Bpbm5lcjtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgYXBwcy5sZW5ndGggPT09IDAgJiYgV2lkZ2V0RWNob1N0b3JlLnJvb21IYXNQZW5kaW5nV2lkZ2V0cyhcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLnJvb20ucm9vbUlkLFxuICAgICAgICAgICAgICAgIFdpZGdldFV0aWxzLmdldFJvb21XaWRnZXRzKHRoaXMucHJvcHMucm9vbSksXG4gICAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgTG9hZGVyID0gc2RrLmdldENvbXBvbmVudChcImVsZW1lbnRzLlNwaW5uZXJcIik7XG4gICAgICAgICAgICBzcGlubmVyID0gPExvYWRlciAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17J214X0FwcHNEcmF3ZXInICsgKHRoaXMucHJvcHMuaGlkZSA/ICcgbXhfQXBwc0RyYXdlcl9oaWRkZW4nIDogJycpfT5cbiAgICAgICAgICAgICAgICA8ZGl2IGlkPSdhcHBzJyBjbGFzc05hbWU9J214X0FwcHNDb250YWluZXInPlxuICAgICAgICAgICAgICAgICAgICB7IGFwcHMgfVxuICAgICAgICAgICAgICAgICAgICB7IHNwaW5uZXIgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIHsgdGhpcy5fY2FuVXNlck1vZGlmeSgpICYmIGFkZFdpZGdldCB9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9LFxufSk7XG4iXX0=