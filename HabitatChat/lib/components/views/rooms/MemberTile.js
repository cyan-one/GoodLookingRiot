"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _actions = require("../../../dispatcher/actions");

/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
var _default = (0, _createReactClass.default)({
  displayName: 'MemberTile',
  propTypes: {
    member: _propTypes.default.any.isRequired,
    // RoomMember
    showPresence: _propTypes.default.bool
  },
  getDefaultProps: function () {
    return {
      showPresence: true
    };
  },
  getInitialState: function () {
    return {
      statusMessage: this.getStatusMessage(),
      isRoomEncrypted: false,
      e2eStatus: null
    };
  },

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (_SettingsStore.default.isFeatureEnabled("feature_custom_status")) {
      const {
        user
      } = this.props.member;

      if (user) {
        user.on("User._unstable_statusMessage", this._onStatusMessageCommitted);
      }
    }

    if (_SettingsStore.default.getValue("feature_cross_signing")) {
      const {
        roomId
      } = this.props.member;

      if (roomId) {
        const isRoomEncrypted = cli.isRoomEncrypted(roomId);
        this.setState({
          isRoomEncrypted
        });

        if (isRoomEncrypted) {
          cli.on("userTrustStatusChanged", this.onUserTrustStatusChanged);
          cli.on("deviceVerificationChanged", this.onDeviceVerificationChanged);
          this.updateE2EStatus();
        } else {
          // Listen for room to become encrypted
          cli.on("RoomState.events", this.onRoomStateEvents);
        }
      }
    }
  },

  componentWillUnmount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      user
    } = this.props.member;

    if (user) {
      user.removeListener("User._unstable_statusMessage", this._onStatusMessageCommitted);
    }

    if (cli) {
      cli.removeListener("RoomState.events", this.onRoomStateEvents);
      cli.removeListener("userTrustStatusChanged", this.onUserTrustStatusChanged);
      cli.removeListener("deviceVerificationChanged", this.onDeviceVerificationChanged);
    }
  },

  onRoomStateEvents: function (ev) {
    if (ev.getType() !== "m.room.encryption") return;
    const {
      roomId
    } = this.props.member;
    if (ev.getRoomId() !== roomId) return; // The room is encrypted now.

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.removeListener("RoomState.events", this.onRoomStateEvents);
    this.setState({
      isRoomEncrypted: true
    });
    this.updateE2EStatus();
  },
  onUserTrustStatusChanged: function (userId, trustStatus) {
    if (userId !== this.props.member.userId) return;
    this.updateE2EStatus();
  },
  onDeviceVerificationChanged: function (userId, deviceId, deviceInfo) {
    if (userId !== this.props.member.userId) return;
    this.updateE2EStatus();
  },
  updateE2EStatus: async function () {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const {
      userId
    } = this.props.member;
    const isMe = userId === cli.getUserId();
    const userTrust = cli.checkUserTrust(userId);

    if (!userTrust.isCrossSigningVerified()) {
      this.setState({
        e2eStatus: userTrust.wasCrossSigningVerified() ? "warning" : "normal"
      });
      return;
    }

    const devices = cli.getStoredDevicesForUser(userId);
    const anyDeviceUnverified = devices.some(device => {
      const {
        deviceId
      } = device; // For your own devices, we use the stricter check of cross-signing
      // verification to encourage everyone to trust their own devices via
      // cross-signing so that other users can then safely trust you.
      // For other people's devices, the more general verified check that
      // includes locally verified devices can be used.

      const deviceTrust = cli.checkDeviceTrust(userId, deviceId);
      return isMe ? !deviceTrust.isCrossSigningVerified() : !deviceTrust.isVerified();
    });
    this.setState({
      e2eStatus: anyDeviceUnverified ? "warning" : "verified"
    });
  },

  getStatusMessage() {
    const {
      user
    } = this.props.member;

    if (!user) {
      return "";
    }

    return user._unstable_statusMessage;
  },

  _onStatusMessageCommitted() {
    // The `User` object has observed a status message change.
    this.setState({
      statusMessage: this.getStatusMessage()
    });
  },

  shouldComponentUpdate: function (nextProps, nextState) {
    if (this.member_last_modified_time === undefined || this.member_last_modified_time < nextProps.member.getLastModifiedTime()) {
      return true;
    }

    if (nextProps.member.user && (this.user_last_modified_time === undefined || this.user_last_modified_time < nextProps.member.user.getLastModifiedTime())) {
      return true;
    }

    if (nextState.isRoomEncrypted !== this.state.isRoomEncrypted || nextState.e2eStatus !== this.state.e2eStatus) {
      return true;
    }

    return false;
  },
  onClick: function (e) {
    _dispatcher.default.dispatch({
      action: _actions.Action.ViewUser,
      member: this.props.member
    });
  },
  _getDisplayName: function () {
    return this.props.member.name;
  },
  getPowerLabel: function () {
    return (0, _languageHandler._t)("%(userName)s (power %(powerLevelNumber)s)", {
      userName: this.props.member.userId,
      powerLevelNumber: this.props.member.powerLevel
    });
  },
  render: function () {
    const MemberAvatar = sdk.getComponent('avatars.MemberAvatar');
    const EntityTile = sdk.getComponent('rooms.EntityTile');
    const member = this.props.member;

    const name = this._getDisplayName();

    const presenceState = member.user ? member.user.presence : null;
    let statusMessage = null;

    if (member.user && _SettingsStore.default.isFeatureEnabled("feature_custom_status")) {
      statusMessage = this.state.statusMessage;
    }

    const av = /*#__PURE__*/_react.default.createElement(MemberAvatar, {
      member: member,
      width: 36,
      height: 36,
      "aria-hidden": "true"
    });

    if (member.user) {
      this.user_last_modified_time = member.user.getLastModifiedTime();
    }

    this.member_last_modified_time = member.getLastModifiedTime();
    const powerStatusMap = new Map([[100, EntityTile.POWER_STATUS_ADMIN], [50, EntityTile.POWER_STATUS_MODERATOR]]); // Find the nearest power level with a badge

    let powerLevel = this.props.member.powerLevel;

    for (const [pl] of powerStatusMap) {
      if (this.props.member.powerLevel >= pl) {
        powerLevel = pl;
        break;
      }
    }

    const powerStatus = powerStatusMap.get(powerLevel);
    let e2eStatus;

    if (this.state.isRoomEncrypted) {
      e2eStatus = this.state.e2eStatus;
    }

    return /*#__PURE__*/_react.default.createElement(EntityTile, (0, _extends2.default)({}, this.props, {
      presenceState: presenceState,
      presenceLastActiveAgo: member.user ? member.user.lastActiveAgo : 0,
      presenceLastTs: member.user ? member.user.lastPresenceTs : 0,
      presenceCurrentlyActive: member.user ? member.user.currentlyActive : false,
      avatarJsx: av,
      title: this.getPowerLabel(),
      name: name,
      powerStatus: powerStatus,
      showPresence: this.props.showPresence,
      subtextLabel: statusMessage,
      e2eStatus: e2eStatus,
      onClick: this.onClick
    }));
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL01lbWJlclRpbGUuanMiXSwibmFtZXMiOlsiZGlzcGxheU5hbWUiLCJwcm9wVHlwZXMiLCJtZW1iZXIiLCJQcm9wVHlwZXMiLCJhbnkiLCJpc1JlcXVpcmVkIiwic2hvd1ByZXNlbmNlIiwiYm9vbCIsImdldERlZmF1bHRQcm9wcyIsImdldEluaXRpYWxTdGF0ZSIsInN0YXR1c01lc3NhZ2UiLCJnZXRTdGF0dXNNZXNzYWdlIiwiaXNSb29tRW5jcnlwdGVkIiwiZTJlU3RhdHVzIiwiY29tcG9uZW50RGlkTW91bnQiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJTZXR0aW5nc1N0b3JlIiwiaXNGZWF0dXJlRW5hYmxlZCIsInVzZXIiLCJwcm9wcyIsIm9uIiwiX29uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCIsImdldFZhbHVlIiwicm9vbUlkIiwic2V0U3RhdGUiLCJvblVzZXJUcnVzdFN0YXR1c0NoYW5nZWQiLCJvbkRldmljZVZlcmlmaWNhdGlvbkNoYW5nZWQiLCJ1cGRhdGVFMkVTdGF0dXMiLCJvblJvb21TdGF0ZUV2ZW50cyIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwicmVtb3ZlTGlzdGVuZXIiLCJldiIsImdldFR5cGUiLCJnZXRSb29tSWQiLCJ1c2VySWQiLCJ0cnVzdFN0YXR1cyIsImRldmljZUlkIiwiZGV2aWNlSW5mbyIsImlzTWUiLCJnZXRVc2VySWQiLCJ1c2VyVHJ1c3QiLCJjaGVja1VzZXJUcnVzdCIsImlzQ3Jvc3NTaWduaW5nVmVyaWZpZWQiLCJ3YXNDcm9zc1NpZ25pbmdWZXJpZmllZCIsImRldmljZXMiLCJnZXRTdG9yZWREZXZpY2VzRm9yVXNlciIsImFueURldmljZVVudmVyaWZpZWQiLCJzb21lIiwiZGV2aWNlIiwiZGV2aWNlVHJ1c3QiLCJjaGVja0RldmljZVRydXN0IiwiaXNWZXJpZmllZCIsIl91bnN0YWJsZV9zdGF0dXNNZXNzYWdlIiwic2hvdWxkQ29tcG9uZW50VXBkYXRlIiwibmV4dFByb3BzIiwibmV4dFN0YXRlIiwibWVtYmVyX2xhc3RfbW9kaWZpZWRfdGltZSIsInVuZGVmaW5lZCIsImdldExhc3RNb2RpZmllZFRpbWUiLCJ1c2VyX2xhc3RfbW9kaWZpZWRfdGltZSIsInN0YXRlIiwib25DbGljayIsImUiLCJkaXMiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIlZpZXdVc2VyIiwiX2dldERpc3BsYXlOYW1lIiwibmFtZSIsImdldFBvd2VyTGFiZWwiLCJ1c2VyTmFtZSIsInBvd2VyTGV2ZWxOdW1iZXIiLCJwb3dlckxldmVsIiwicmVuZGVyIiwiTWVtYmVyQXZhdGFyIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiRW50aXR5VGlsZSIsInByZXNlbmNlU3RhdGUiLCJwcmVzZW5jZSIsImF2IiwicG93ZXJTdGF0dXNNYXAiLCJNYXAiLCJQT1dFUl9TVEFUVVNfQURNSU4iLCJQT1dFUl9TVEFUVVNfTU9ERVJBVE9SIiwicGwiLCJwb3dlclN0YXR1cyIsImxhc3RBY3RpdmVBZ28iLCJsYXN0UHJlc2VuY2VUcyIsImN1cnJlbnRseUFjdGl2ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUF6QkE7Ozs7Ozs7Ozs7Ozs7Ozs7ZUEyQmUsK0JBQWlCO0FBQzVCQSxFQUFBQSxXQUFXLEVBQUUsWUFEZTtBQUc1QkMsRUFBQUEsU0FBUyxFQUFFO0FBQ1BDLElBQUFBLE1BQU0sRUFBRUMsbUJBQVVDLEdBQVYsQ0FBY0MsVUFEZjtBQUMyQjtBQUNsQ0MsSUFBQUEsWUFBWSxFQUFFSCxtQkFBVUk7QUFGakIsR0FIaUI7QUFRNUJDLEVBQUFBLGVBQWUsRUFBRSxZQUFXO0FBQ3hCLFdBQU87QUFDSEYsTUFBQUEsWUFBWSxFQUFFO0FBRFgsS0FBUDtBQUdILEdBWjJCO0FBYzVCRyxFQUFBQSxlQUFlLEVBQUUsWUFBVztBQUN4QixXQUFPO0FBQ0hDLE1BQUFBLGFBQWEsRUFBRSxLQUFLQyxnQkFBTCxFQURaO0FBRUhDLE1BQUFBLGVBQWUsRUFBRSxLQUZkO0FBR0hDLE1BQUFBLFNBQVMsRUFBRTtBQUhSLEtBQVA7QUFLSCxHQXBCMkI7O0FBc0I1QkMsRUFBQUEsaUJBQWlCLEdBQUc7QUFDaEIsVUFBTUMsR0FBRyxHQUFHQyxpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBRUEsUUFBSUMsdUJBQWNDLGdCQUFkLENBQStCLHVCQUEvQixDQUFKLEVBQTZEO0FBQ3pELFlBQU07QUFBRUMsUUFBQUE7QUFBRixVQUFXLEtBQUtDLEtBQUwsQ0FBV25CLE1BQTVCOztBQUNBLFVBQUlrQixJQUFKLEVBQVU7QUFDTkEsUUFBQUEsSUFBSSxDQUFDRSxFQUFMLENBQVEsOEJBQVIsRUFBd0MsS0FBS0MseUJBQTdDO0FBQ0g7QUFDSjs7QUFFRCxRQUFJTCx1QkFBY00sUUFBZCxDQUF1Qix1QkFBdkIsQ0FBSixFQUFxRDtBQUNqRCxZQUFNO0FBQUVDLFFBQUFBO0FBQUYsVUFBYSxLQUFLSixLQUFMLENBQVduQixNQUE5Qjs7QUFDQSxVQUFJdUIsTUFBSixFQUFZO0FBQ1IsY0FBTWIsZUFBZSxHQUFHRyxHQUFHLENBQUNILGVBQUosQ0FBb0JhLE1BQXBCLENBQXhCO0FBQ0EsYUFBS0MsUUFBTCxDQUFjO0FBQ1ZkLFVBQUFBO0FBRFUsU0FBZDs7QUFHQSxZQUFJQSxlQUFKLEVBQXFCO0FBQ2pCRyxVQUFBQSxHQUFHLENBQUNPLEVBQUosQ0FBTyx3QkFBUCxFQUFpQyxLQUFLSyx3QkFBdEM7QUFDQVosVUFBQUEsR0FBRyxDQUFDTyxFQUFKLENBQU8sMkJBQVAsRUFBb0MsS0FBS00sMkJBQXpDO0FBQ0EsZUFBS0MsZUFBTDtBQUNILFNBSkQsTUFJTztBQUNIO0FBQ0FkLFVBQUFBLEdBQUcsQ0FBQ08sRUFBSixDQUFPLGtCQUFQLEVBQTJCLEtBQUtRLGlCQUFoQztBQUNIO0FBQ0o7QUFDSjtBQUNKLEdBakQyQjs7QUFtRDVCQyxFQUFBQSxvQkFBb0IsR0FBRztBQUNuQixVQUFNaEIsR0FBRyxHQUFHQyxpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBRUEsVUFBTTtBQUFFRyxNQUFBQTtBQUFGLFFBQVcsS0FBS0MsS0FBTCxDQUFXbkIsTUFBNUI7O0FBQ0EsUUFBSWtCLElBQUosRUFBVTtBQUNOQSxNQUFBQSxJQUFJLENBQUNZLGNBQUwsQ0FDSSw4QkFESixFQUVJLEtBQUtULHlCQUZUO0FBSUg7O0FBRUQsUUFBSVIsR0FBSixFQUFTO0FBQ0xBLE1BQUFBLEdBQUcsQ0FBQ2lCLGNBQUosQ0FBbUIsa0JBQW5CLEVBQXVDLEtBQUtGLGlCQUE1QztBQUNBZixNQUFBQSxHQUFHLENBQUNpQixjQUFKLENBQW1CLHdCQUFuQixFQUE2QyxLQUFLTCx3QkFBbEQ7QUFDQVosTUFBQUEsR0FBRyxDQUFDaUIsY0FBSixDQUFtQiwyQkFBbkIsRUFBZ0QsS0FBS0osMkJBQXJEO0FBQ0g7QUFDSixHQW5FMkI7O0FBcUU1QkUsRUFBQUEsaUJBQWlCLEVBQUUsVUFBU0csRUFBVCxFQUFhO0FBQzVCLFFBQUlBLEVBQUUsQ0FBQ0MsT0FBSCxPQUFpQixtQkFBckIsRUFBMEM7QUFDMUMsVUFBTTtBQUFFVCxNQUFBQTtBQUFGLFFBQWEsS0FBS0osS0FBTCxDQUFXbkIsTUFBOUI7QUFDQSxRQUFJK0IsRUFBRSxDQUFDRSxTQUFILE9BQW1CVixNQUF2QixFQUErQixPQUhILENBSzVCOztBQUNBLFVBQU1WLEdBQUcsR0FBR0MsaUNBQWdCQyxHQUFoQixFQUFaOztBQUNBRixJQUFBQSxHQUFHLENBQUNpQixjQUFKLENBQW1CLGtCQUFuQixFQUF1QyxLQUFLRixpQkFBNUM7QUFDQSxTQUFLSixRQUFMLENBQWM7QUFDVmQsTUFBQUEsZUFBZSxFQUFFO0FBRFAsS0FBZDtBQUdBLFNBQUtpQixlQUFMO0FBQ0gsR0FqRjJCO0FBbUY1QkYsRUFBQUEsd0JBQXdCLEVBQUUsVUFBU1MsTUFBVCxFQUFpQkMsV0FBakIsRUFBOEI7QUFDcEQsUUFBSUQsTUFBTSxLQUFLLEtBQUtmLEtBQUwsQ0FBV25CLE1BQVgsQ0FBa0JrQyxNQUFqQyxFQUF5QztBQUN6QyxTQUFLUCxlQUFMO0FBQ0gsR0F0RjJCO0FBd0Y1QkQsRUFBQUEsMkJBQTJCLEVBQUUsVUFBU1EsTUFBVCxFQUFpQkUsUUFBakIsRUFBMkJDLFVBQTNCLEVBQXVDO0FBQ2hFLFFBQUlILE1BQU0sS0FBSyxLQUFLZixLQUFMLENBQVduQixNQUFYLENBQWtCa0MsTUFBakMsRUFBeUM7QUFDekMsU0FBS1AsZUFBTDtBQUNILEdBM0YyQjtBQTZGNUJBLEVBQUFBLGVBQWUsRUFBRSxrQkFBaUI7QUFDOUIsVUFBTWQsR0FBRyxHQUFHQyxpQ0FBZ0JDLEdBQWhCLEVBQVo7O0FBQ0EsVUFBTTtBQUFFbUIsTUFBQUE7QUFBRixRQUFhLEtBQUtmLEtBQUwsQ0FBV25CLE1BQTlCO0FBQ0EsVUFBTXNDLElBQUksR0FBR0osTUFBTSxLQUFLckIsR0FBRyxDQUFDMEIsU0FBSixFQUF4QjtBQUNBLFVBQU1DLFNBQVMsR0FBRzNCLEdBQUcsQ0FBQzRCLGNBQUosQ0FBbUJQLE1BQW5CLENBQWxCOztBQUNBLFFBQUksQ0FBQ00sU0FBUyxDQUFDRSxzQkFBVixFQUFMLEVBQXlDO0FBQ3JDLFdBQUtsQixRQUFMLENBQWM7QUFDVmIsUUFBQUEsU0FBUyxFQUFFNkIsU0FBUyxDQUFDRyx1QkFBVixLQUFzQyxTQUF0QyxHQUFrRDtBQURuRCxPQUFkO0FBR0E7QUFDSDs7QUFFRCxVQUFNQyxPQUFPLEdBQUcvQixHQUFHLENBQUNnQyx1QkFBSixDQUE0QlgsTUFBNUIsQ0FBaEI7QUFDQSxVQUFNWSxtQkFBbUIsR0FBR0YsT0FBTyxDQUFDRyxJQUFSLENBQWFDLE1BQU0sSUFBSTtBQUMvQyxZQUFNO0FBQUVaLFFBQUFBO0FBQUYsVUFBZVksTUFBckIsQ0FEK0MsQ0FFL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQSxZQUFNQyxXQUFXLEdBQUdwQyxHQUFHLENBQUNxQyxnQkFBSixDQUFxQmhCLE1BQXJCLEVBQTZCRSxRQUE3QixDQUFwQjtBQUNBLGFBQU9FLElBQUksR0FBRyxDQUFDVyxXQUFXLENBQUNQLHNCQUFaLEVBQUosR0FBMkMsQ0FBQ08sV0FBVyxDQUFDRSxVQUFaLEVBQXZEO0FBQ0gsS0FUMkIsQ0FBNUI7QUFVQSxTQUFLM0IsUUFBTCxDQUFjO0FBQ1ZiLE1BQUFBLFNBQVMsRUFBRW1DLG1CQUFtQixHQUFHLFNBQUgsR0FBZTtBQURuQyxLQUFkO0FBR0gsR0F2SDJCOztBQXlINUJyQyxFQUFBQSxnQkFBZ0IsR0FBRztBQUNmLFVBQU07QUFBRVMsTUFBQUE7QUFBRixRQUFXLEtBQUtDLEtBQUwsQ0FBV25CLE1BQTVCOztBQUNBLFFBQUksQ0FBQ2tCLElBQUwsRUFBVztBQUNQLGFBQU8sRUFBUDtBQUNIOztBQUNELFdBQU9BLElBQUksQ0FBQ2tDLHVCQUFaO0FBQ0gsR0EvSDJCOztBQWlJNUIvQixFQUFBQSx5QkFBeUIsR0FBRztBQUN4QjtBQUNBLFNBQUtHLFFBQUwsQ0FBYztBQUNWaEIsTUFBQUEsYUFBYSxFQUFFLEtBQUtDLGdCQUFMO0FBREwsS0FBZDtBQUdILEdBdEkyQjs7QUF3STVCNEMsRUFBQUEscUJBQXFCLEVBQUUsVUFBU0MsU0FBVCxFQUFvQkMsU0FBcEIsRUFBK0I7QUFDbEQsUUFDSSxLQUFLQyx5QkFBTCxLQUFtQ0MsU0FBbkMsSUFDQSxLQUFLRCx5QkFBTCxHQUFpQ0YsU0FBUyxDQUFDdEQsTUFBVixDQUFpQjBELG1CQUFqQixFQUZyQyxFQUdFO0FBQ0UsYUFBTyxJQUFQO0FBQ0g7O0FBQ0QsUUFDSUosU0FBUyxDQUFDdEQsTUFBVixDQUFpQmtCLElBQWpCLEtBQ0MsS0FBS3lDLHVCQUFMLEtBQWlDRixTQUFqQyxJQUNELEtBQUtFLHVCQUFMLEdBQStCTCxTQUFTLENBQUN0RCxNQUFWLENBQWlCa0IsSUFBakIsQ0FBc0J3QyxtQkFBdEIsRUFGL0IsQ0FESixFQUlFO0FBQ0UsYUFBTyxJQUFQO0FBQ0g7O0FBQ0QsUUFDSUgsU0FBUyxDQUFDN0MsZUFBVixLQUE4QixLQUFLa0QsS0FBTCxDQUFXbEQsZUFBekMsSUFDQTZDLFNBQVMsQ0FBQzVDLFNBQVYsS0FBd0IsS0FBS2lELEtBQUwsQ0FBV2pELFNBRnZDLEVBR0U7QUFDRSxhQUFPLElBQVA7QUFDSDs7QUFDRCxXQUFPLEtBQVA7QUFDSCxHQTdKMkI7QUErSjVCa0QsRUFBQUEsT0FBTyxFQUFFLFVBQVNDLENBQVQsRUFBWTtBQUNqQkMsd0JBQUlDLFFBQUosQ0FBYTtBQUNUQyxNQUFBQSxNQUFNLEVBQUVDLGdCQUFPQyxRQUROO0FBRVRuRSxNQUFBQSxNQUFNLEVBQUUsS0FBS21CLEtBQUwsQ0FBV25CO0FBRlYsS0FBYjtBQUlILEdBcEsyQjtBQXNLNUJvRSxFQUFBQSxlQUFlLEVBQUUsWUFBVztBQUN4QixXQUFPLEtBQUtqRCxLQUFMLENBQVduQixNQUFYLENBQWtCcUUsSUFBekI7QUFDSCxHQXhLMkI7QUEwSzVCQyxFQUFBQSxhQUFhLEVBQUUsWUFBVztBQUN0QixXQUFPLHlCQUFHLDJDQUFILEVBQWdEO0FBQ25EQyxNQUFBQSxRQUFRLEVBQUUsS0FBS3BELEtBQUwsQ0FBV25CLE1BQVgsQ0FBa0JrQyxNQUR1QjtBQUVuRHNDLE1BQUFBLGdCQUFnQixFQUFFLEtBQUtyRCxLQUFMLENBQVduQixNQUFYLENBQWtCeUU7QUFGZSxLQUFoRCxDQUFQO0FBSUgsR0EvSzJCO0FBaUw1QkMsRUFBQUEsTUFBTSxFQUFFLFlBQVc7QUFDZixVQUFNQyxZQUFZLEdBQUdDLEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixzQkFBakIsQ0FBckI7QUFDQSxVQUFNQyxVQUFVLEdBQUdGLEdBQUcsQ0FBQ0MsWUFBSixDQUFpQixrQkFBakIsQ0FBbkI7QUFFQSxVQUFNN0UsTUFBTSxHQUFHLEtBQUttQixLQUFMLENBQVduQixNQUExQjs7QUFDQSxVQUFNcUUsSUFBSSxHQUFHLEtBQUtELGVBQUwsRUFBYjs7QUFDQSxVQUFNVyxhQUFhLEdBQUcvRSxNQUFNLENBQUNrQixJQUFQLEdBQWNsQixNQUFNLENBQUNrQixJQUFQLENBQVk4RCxRQUExQixHQUFxQyxJQUEzRDtBQUVBLFFBQUl4RSxhQUFhLEdBQUcsSUFBcEI7O0FBQ0EsUUFBSVIsTUFBTSxDQUFDa0IsSUFBUCxJQUFlRix1QkFBY0MsZ0JBQWQsQ0FBK0IsdUJBQS9CLENBQW5CLEVBQTRFO0FBQ3hFVCxNQUFBQSxhQUFhLEdBQUcsS0FBS29ELEtBQUwsQ0FBV3BELGFBQTNCO0FBQ0g7O0FBRUQsVUFBTXlFLEVBQUUsZ0JBQ0osNkJBQUMsWUFBRDtBQUFjLE1BQUEsTUFBTSxFQUFFakYsTUFBdEI7QUFBOEIsTUFBQSxLQUFLLEVBQUUsRUFBckM7QUFBeUMsTUFBQSxNQUFNLEVBQUUsRUFBakQ7QUFBcUQscUJBQVk7QUFBakUsTUFESjs7QUFJQSxRQUFJQSxNQUFNLENBQUNrQixJQUFYLEVBQWlCO0FBQ2IsV0FBS3lDLHVCQUFMLEdBQStCM0QsTUFBTSxDQUFDa0IsSUFBUCxDQUFZd0MsbUJBQVosRUFBL0I7QUFDSDs7QUFDRCxTQUFLRix5QkFBTCxHQUFpQ3hELE1BQU0sQ0FBQzBELG1CQUFQLEVBQWpDO0FBRUEsVUFBTXdCLGNBQWMsR0FBRyxJQUFJQyxHQUFKLENBQVEsQ0FDM0IsQ0FBQyxHQUFELEVBQU1MLFVBQVUsQ0FBQ00sa0JBQWpCLENBRDJCLEVBRTNCLENBQUMsRUFBRCxFQUFLTixVQUFVLENBQUNPLHNCQUFoQixDQUYyQixDQUFSLENBQXZCLENBdEJlLENBMkJmOztBQUNBLFFBQUlaLFVBQVUsR0FBRyxLQUFLdEQsS0FBTCxDQUFXbkIsTUFBWCxDQUFrQnlFLFVBQW5DOztBQUNBLFNBQUssTUFBTSxDQUFDYSxFQUFELENBQVgsSUFBbUJKLGNBQW5CLEVBQW1DO0FBQy9CLFVBQUksS0FBSy9ELEtBQUwsQ0FBV25CLE1BQVgsQ0FBa0J5RSxVQUFsQixJQUFnQ2EsRUFBcEMsRUFBd0M7QUFDcENiLFFBQUFBLFVBQVUsR0FBR2EsRUFBYjtBQUNBO0FBQ0g7QUFDSjs7QUFFRCxVQUFNQyxXQUFXLEdBQUdMLGNBQWMsQ0FBQ25FLEdBQWYsQ0FBbUIwRCxVQUFuQixDQUFwQjtBQUVBLFFBQUk5RCxTQUFKOztBQUNBLFFBQUksS0FBS2lELEtBQUwsQ0FBV2xELGVBQWYsRUFBZ0M7QUFDNUJDLE1BQUFBLFNBQVMsR0FBRyxLQUFLaUQsS0FBTCxDQUFXakQsU0FBdkI7QUFDSDs7QUFFRCx3QkFDSSw2QkFBQyxVQUFELDZCQUNRLEtBQUtRLEtBRGI7QUFFSSxNQUFBLGFBQWEsRUFBRTRELGFBRm5CO0FBR0ksTUFBQSxxQkFBcUIsRUFBRS9FLE1BQU0sQ0FBQ2tCLElBQVAsR0FBY2xCLE1BQU0sQ0FBQ2tCLElBQVAsQ0FBWXNFLGFBQTFCLEdBQTBDLENBSHJFO0FBSUksTUFBQSxjQUFjLEVBQUV4RixNQUFNLENBQUNrQixJQUFQLEdBQWNsQixNQUFNLENBQUNrQixJQUFQLENBQVl1RSxjQUExQixHQUEyQyxDQUovRDtBQUtJLE1BQUEsdUJBQXVCLEVBQUV6RixNQUFNLENBQUNrQixJQUFQLEdBQWNsQixNQUFNLENBQUNrQixJQUFQLENBQVl3RSxlQUExQixHQUE0QyxLQUx6RTtBQU1JLE1BQUEsU0FBUyxFQUFFVCxFQU5mO0FBT0ksTUFBQSxLQUFLLEVBQUUsS0FBS1gsYUFBTCxFQVBYO0FBUUksTUFBQSxJQUFJLEVBQUVELElBUlY7QUFTSSxNQUFBLFdBQVcsRUFBRWtCLFdBVGpCO0FBVUksTUFBQSxZQUFZLEVBQUUsS0FBS3BFLEtBQUwsQ0FBV2YsWUFWN0I7QUFXSSxNQUFBLFlBQVksRUFBRUksYUFYbEI7QUFZSSxNQUFBLFNBQVMsRUFBRUcsU0FaZjtBQWFJLE1BQUEsT0FBTyxFQUFFLEtBQUtrRDtBQWJsQixPQURKO0FBaUJIO0FBN08yQixDQUFqQixDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE1LCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSBcIi4uLy4uLy4uL2luZGV4XCI7XG5pbXBvcnQgZGlzIGZyb20gXCIuLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IF90IH0gZnJvbSAnLi4vLi4vLi4vbGFuZ3VhZ2VIYW5kbGVyJztcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7QWN0aW9ufSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZVJlYWN0Q2xhc3Moe1xuICAgIGRpc3BsYXlOYW1lOiAnTWVtYmVyVGlsZScsXG5cbiAgICBwcm9wVHlwZXM6IHtcbiAgICAgICAgbWVtYmVyOiBQcm9wVHlwZXMuYW55LmlzUmVxdWlyZWQsIC8vIFJvb21NZW1iZXJcbiAgICAgICAgc2hvd1ByZXNlbmNlOiBQcm9wVHlwZXMuYm9vbCxcbiAgICB9LFxuXG4gICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHNob3dQcmVzZW5jZTogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2U6IHRoaXMuZ2V0U3RhdHVzTWVzc2FnZSgpLFxuICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkOiBmYWxzZSxcbiAgICAgICAgICAgIGUyZVN0YXR1czogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcblxuICAgICAgICBpZiAoU2V0dGluZ3NTdG9yZS5pc0ZlYXR1cmVFbmFibGVkKFwiZmVhdHVyZV9jdXN0b21fc3RhdHVzXCIpKSB7XG4gICAgICAgICAgICBjb25zdCB7IHVzZXIgfSA9IHRoaXMucHJvcHMubWVtYmVyO1xuICAgICAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgICAgICB1c2VyLm9uKFwiVXNlci5fdW5zdGFibGVfc3RhdHVzTWVzc2FnZVwiLCB0aGlzLl9vblN0YXR1c01lc3NhZ2VDb21taXR0ZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX2Nyb3NzX3NpZ25pbmdcIikpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcm9vbUlkIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgICAgIGlmIChyb29tSWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc1Jvb21FbmNyeXB0ZWQgPSBjbGkuaXNSb29tRW5jcnlwdGVkKHJvb21JZCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIGlzUm9vbUVuY3J5cHRlZCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoaXNSb29tRW5jcnlwdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaS5vbihcInVzZXJUcnVzdFN0YXR1c0NoYW5nZWRcIiwgdGhpcy5vblVzZXJUcnVzdFN0YXR1c0NoYW5nZWQpO1xuICAgICAgICAgICAgICAgICAgICBjbGkub24oXCJkZXZpY2VWZXJpZmljYXRpb25DaGFuZ2VkXCIsIHRoaXMub25EZXZpY2VWZXJpZmljYXRpb25DaGFuZ2VkKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFMkVTdGF0dXMoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIHJvb20gdG8gYmVjb21lIGVuY3J5cHRlZFxuICAgICAgICAgICAgICAgICAgICBjbGkub24oXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuXG4gICAgICAgIGNvbnN0IHsgdXNlciB9ID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGlmICh1c2VyKSB7XG4gICAgICAgICAgICB1c2VyLnJlbW92ZUxpc3RlbmVyKFxuICAgICAgICAgICAgICAgIFwiVXNlci5fdW5zdGFibGVfc3RhdHVzTWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgIHRoaXMuX29uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2xpKSB7XG4gICAgICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJSb29tU3RhdGUuZXZlbnRzXCIsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgICAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKFwidXNlclRydXN0U3RhdHVzQ2hhbmdlZFwiLCB0aGlzLm9uVXNlclRydXN0U3RhdHVzQ2hhbmdlZCk7XG4gICAgICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoXCJkZXZpY2VWZXJpZmljYXRpb25DaGFuZ2VkXCIsIHRoaXMub25EZXZpY2VWZXJpZmljYXRpb25DaGFuZ2VkKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBvblJvb21TdGF0ZUV2ZW50czogZnVuY3Rpb24oZXYpIHtcbiAgICAgICAgaWYgKGV2LmdldFR5cGUoKSAhPT0gXCJtLnJvb20uZW5jcnlwdGlvblwiKSByZXR1cm47XG4gICAgICAgIGNvbnN0IHsgcm9vbUlkIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgaWYgKGV2LmdldFJvb21JZCgpICE9PSByb29tSWQpIHJldHVybjtcblxuICAgICAgICAvLyBUaGUgcm9vbSBpcyBlbmNyeXB0ZWQgbm93LlxuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNsaS5yZW1vdmVMaXN0ZW5lcihcIlJvb21TdGF0ZS5ldmVudHNcIiwgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy51cGRhdGVFMkVTdGF0dXMoKTtcbiAgICB9LFxuXG4gICAgb25Vc2VyVHJ1c3RTdGF0dXNDaGFuZ2VkOiBmdW5jdGlvbih1c2VySWQsIHRydXN0U3RhdHVzKSB7XG4gICAgICAgIGlmICh1c2VySWQgIT09IHRoaXMucHJvcHMubWVtYmVyLnVzZXJJZCkgcmV0dXJuO1xuICAgICAgICB0aGlzLnVwZGF0ZUUyRVN0YXR1cygpO1xuICAgIH0sXG5cbiAgICBvbkRldmljZVZlcmlmaWNhdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKHVzZXJJZCwgZGV2aWNlSWQsIGRldmljZUluZm8pIHtcbiAgICAgICAgaWYgKHVzZXJJZCAhPT0gdGhpcy5wcm9wcy5tZW1iZXIudXNlcklkKSByZXR1cm47XG4gICAgICAgIHRoaXMudXBkYXRlRTJFU3RhdHVzKCk7XG4gICAgfSxcblxuICAgIHVwZGF0ZUUyRVN0YXR1czogYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHRoaXMucHJvcHMubWVtYmVyO1xuICAgICAgICBjb25zdCBpc01lID0gdXNlcklkID09PSBjbGkuZ2V0VXNlcklkKCk7XG4gICAgICAgIGNvbnN0IHVzZXJUcnVzdCA9IGNsaS5jaGVja1VzZXJUcnVzdCh1c2VySWQpO1xuICAgICAgICBpZiAoIXVzZXJUcnVzdC5pc0Nyb3NzU2lnbmluZ1ZlcmlmaWVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgIGUyZVN0YXR1czogdXNlclRydXN0Lndhc0Nyb3NzU2lnbmluZ1ZlcmlmaWVkKCkgPyBcIndhcm5pbmdcIiA6IFwibm9ybWFsXCIsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRldmljZXMgPSBjbGkuZ2V0U3RvcmVkRGV2aWNlc0ZvclVzZXIodXNlcklkKTtcbiAgICAgICAgY29uc3QgYW55RGV2aWNlVW52ZXJpZmllZCA9IGRldmljZXMuc29tZShkZXZpY2UgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBkZXZpY2VJZCB9ID0gZGV2aWNlO1xuICAgICAgICAgICAgLy8gRm9yIHlvdXIgb3duIGRldmljZXMsIHdlIHVzZSB0aGUgc3RyaWN0ZXIgY2hlY2sgb2YgY3Jvc3Mtc2lnbmluZ1xuICAgICAgICAgICAgLy8gdmVyaWZpY2F0aW9uIHRvIGVuY291cmFnZSBldmVyeW9uZSB0byB0cnVzdCB0aGVpciBvd24gZGV2aWNlcyB2aWFcbiAgICAgICAgICAgIC8vIGNyb3NzLXNpZ25pbmcgc28gdGhhdCBvdGhlciB1c2VycyBjYW4gdGhlbiBzYWZlbHkgdHJ1c3QgeW91LlxuICAgICAgICAgICAgLy8gRm9yIG90aGVyIHBlb3BsZSdzIGRldmljZXMsIHRoZSBtb3JlIGdlbmVyYWwgdmVyaWZpZWQgY2hlY2sgdGhhdFxuICAgICAgICAgICAgLy8gaW5jbHVkZXMgbG9jYWxseSB2ZXJpZmllZCBkZXZpY2VzIGNhbiBiZSB1c2VkLlxuICAgICAgICAgICAgY29uc3QgZGV2aWNlVHJ1c3QgPSBjbGkuY2hlY2tEZXZpY2VUcnVzdCh1c2VySWQsIGRldmljZUlkKTtcbiAgICAgICAgICAgIHJldHVybiBpc01lID8gIWRldmljZVRydXN0LmlzQ3Jvc3NTaWduaW5nVmVyaWZpZWQoKSA6ICFkZXZpY2VUcnVzdC5pc1ZlcmlmaWVkKCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGUyZVN0YXR1czogYW55RGV2aWNlVW52ZXJpZmllZCA/IFwid2FybmluZ1wiIDogXCJ2ZXJpZmllZFwiLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdHVzTWVzc2FnZSgpIHtcbiAgICAgICAgY29uc3QgeyB1c2VyIH0gPSB0aGlzLnByb3BzLm1lbWJlcjtcbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdXNlci5fdW5zdGFibGVfc3RhdHVzTWVzc2FnZTtcbiAgICB9LFxuXG4gICAgX29uU3RhdHVzTWVzc2FnZUNvbW1pdHRlZCgpIHtcbiAgICAgICAgLy8gVGhlIGBVc2VyYCBvYmplY3QgaGFzIG9ic2VydmVkIGEgc3RhdHVzIG1lc3NhZ2UgY2hhbmdlLlxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHN0YXR1c01lc3NhZ2U6IHRoaXMuZ2V0U3RhdHVzTWVzc2FnZSgpLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgc2hvdWxkQ29tcG9uZW50VXBkYXRlOiBmdW5jdGlvbihuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLm1lbWJlcl9sYXN0X21vZGlmaWVkX3RpbWUgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgdGhpcy5tZW1iZXJfbGFzdF9tb2RpZmllZF90aW1lIDwgbmV4dFByb3BzLm1lbWJlci5nZXRMYXN0TW9kaWZpZWRUaW1lKClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBuZXh0UHJvcHMubWVtYmVyLnVzZXIgJiZcbiAgICAgICAgICAgICh0aGlzLnVzZXJfbGFzdF9tb2RpZmllZF90aW1lID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgIHRoaXMudXNlcl9sYXN0X21vZGlmaWVkX3RpbWUgPCBuZXh0UHJvcHMubWVtYmVyLnVzZXIuZ2V0TGFzdE1vZGlmaWVkVGltZSgpKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIG5leHRTdGF0ZS5pc1Jvb21FbmNyeXB0ZWQgIT09IHRoaXMuc3RhdGUuaXNSb29tRW5jcnlwdGVkIHx8XG4gICAgICAgICAgICBuZXh0U3RhdGUuZTJlU3RhdHVzICE9PSB0aGlzLnN0YXRlLmUyZVN0YXR1c1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9LFxuXG4gICAgb25DbGljazogZnVuY3Rpb24oZSkge1xuICAgICAgICBkaXMuZGlzcGF0Y2goe1xuICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1VzZXIsXG4gICAgICAgICAgICBtZW1iZXI6IHRoaXMucHJvcHMubWVtYmVyLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgX2dldERpc3BsYXlOYW1lOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWVtYmVyLm5hbWU7XG4gICAgfSxcblxuICAgIGdldFBvd2VyTGFiZWw6IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gX3QoXCIlKHVzZXJOYW1lKXMgKHBvd2VyICUocG93ZXJMZXZlbE51bWJlcilzKVwiLCB7XG4gICAgICAgICAgICB1c2VyTmFtZTogdGhpcy5wcm9wcy5tZW1iZXIudXNlcklkLFxuICAgICAgICAgICAgcG93ZXJMZXZlbE51bWJlcjogdGhpcy5wcm9wcy5tZW1iZXIucG93ZXJMZXZlbCxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnN0IE1lbWJlckF2YXRhciA9IHNkay5nZXRDb21wb25lbnQoJ2F2YXRhcnMuTWVtYmVyQXZhdGFyJyk7XG4gICAgICAgIGNvbnN0IEVudGl0eVRpbGUgPSBzZGsuZ2V0Q29tcG9uZW50KCdyb29tcy5FbnRpdHlUaWxlJyk7XG5cbiAgICAgICAgY29uc3QgbWVtYmVyID0gdGhpcy5wcm9wcy5tZW1iZXI7XG4gICAgICAgIGNvbnN0IG5hbWUgPSB0aGlzLl9nZXREaXNwbGF5TmFtZSgpO1xuICAgICAgICBjb25zdCBwcmVzZW5jZVN0YXRlID0gbWVtYmVyLnVzZXIgPyBtZW1iZXIudXNlci5wcmVzZW5jZSA6IG51bGw7XG5cbiAgICAgICAgbGV0IHN0YXR1c01lc3NhZ2UgPSBudWxsO1xuICAgICAgICBpZiAobWVtYmVyLnVzZXIgJiYgU2V0dGluZ3NTdG9yZS5pc0ZlYXR1cmVFbmFibGVkKFwiZmVhdHVyZV9jdXN0b21fc3RhdHVzXCIpKSB7XG4gICAgICAgICAgICBzdGF0dXNNZXNzYWdlID0gdGhpcy5zdGF0ZS5zdGF0dXNNZXNzYWdlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXYgPSAoXG4gICAgICAgICAgICA8TWVtYmVyQXZhdGFyIG1lbWJlcj17bWVtYmVyfSB3aWR0aD17MzZ9IGhlaWdodD17MzZ9IGFyaWEtaGlkZGVuPVwidHJ1ZVwiIC8+XG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKG1lbWJlci51c2VyKSB7XG4gICAgICAgICAgICB0aGlzLnVzZXJfbGFzdF9tb2RpZmllZF90aW1lID0gbWVtYmVyLnVzZXIuZ2V0TGFzdE1vZGlmaWVkVGltZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubWVtYmVyX2xhc3RfbW9kaWZpZWRfdGltZSA9IG1lbWJlci5nZXRMYXN0TW9kaWZpZWRUaW1lKCk7XG5cbiAgICAgICAgY29uc3QgcG93ZXJTdGF0dXNNYXAgPSBuZXcgTWFwKFtcbiAgICAgICAgICAgIFsxMDAsIEVudGl0eVRpbGUuUE9XRVJfU1RBVFVTX0FETUlOXSxcbiAgICAgICAgICAgIFs1MCwgRW50aXR5VGlsZS5QT1dFUl9TVEFUVVNfTU9ERVJBVE9SXSxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgLy8gRmluZCB0aGUgbmVhcmVzdCBwb3dlciBsZXZlbCB3aXRoIGEgYmFkZ2VcbiAgICAgICAgbGV0IHBvd2VyTGV2ZWwgPSB0aGlzLnByb3BzLm1lbWJlci5wb3dlckxldmVsO1xuICAgICAgICBmb3IgKGNvbnN0IFtwbF0gb2YgcG93ZXJTdGF0dXNNYXApIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLm1lbWJlci5wb3dlckxldmVsID49IHBsKSB7XG4gICAgICAgICAgICAgICAgcG93ZXJMZXZlbCA9IHBsO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcG93ZXJTdGF0dXMgPSBwb3dlclN0YXR1c01hcC5nZXQocG93ZXJMZXZlbCk7XG5cbiAgICAgICAgbGV0IGUyZVN0YXR1cztcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuaXNSb29tRW5jcnlwdGVkKSB7XG4gICAgICAgICAgICBlMmVTdGF0dXMgPSB0aGlzLnN0YXRlLmUyZVN0YXR1cztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8RW50aXR5VGlsZVxuICAgICAgICAgICAgICAgIHsuLi50aGlzLnByb3BzfVxuICAgICAgICAgICAgICAgIHByZXNlbmNlU3RhdGU9e3ByZXNlbmNlU3RhdGV9XG4gICAgICAgICAgICAgICAgcHJlc2VuY2VMYXN0QWN0aXZlQWdvPXttZW1iZXIudXNlciA/IG1lbWJlci51c2VyLmxhc3RBY3RpdmVBZ28gOiAwfVxuICAgICAgICAgICAgICAgIHByZXNlbmNlTGFzdFRzPXttZW1iZXIudXNlciA/IG1lbWJlci51c2VyLmxhc3RQcmVzZW5jZVRzIDogMH1cbiAgICAgICAgICAgICAgICBwcmVzZW5jZUN1cnJlbnRseUFjdGl2ZT17bWVtYmVyLnVzZXIgPyBtZW1iZXIudXNlci5jdXJyZW50bHlBY3RpdmUgOiBmYWxzZX1cbiAgICAgICAgICAgICAgICBhdmF0YXJKc3g9e2F2fVxuICAgICAgICAgICAgICAgIHRpdGxlPXt0aGlzLmdldFBvd2VyTGFiZWwoKX1cbiAgICAgICAgICAgICAgICBuYW1lPXtuYW1lfVxuICAgICAgICAgICAgICAgIHBvd2VyU3RhdHVzPXtwb3dlclN0YXR1c31cbiAgICAgICAgICAgICAgICBzaG93UHJlc2VuY2U9e3RoaXMucHJvcHMuc2hvd1ByZXNlbmNlfVxuICAgICAgICAgICAgICAgIHN1YnRleHRMYWJlbD17c3RhdHVzTWVzc2FnZX1cbiAgICAgICAgICAgICAgICBlMmVTdGF0dXM9e2UyZVN0YXR1c31cbiAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uQ2xpY2t9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH0sXG59KTtcbiJdfQ==