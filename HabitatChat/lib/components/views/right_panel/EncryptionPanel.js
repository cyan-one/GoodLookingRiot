"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _EncryptionInfo = _interopRequireDefault(require("./EncryptionInfo"));

var _VerificationPanel = _interopRequireDefault(require("./VerificationPanel"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _createRoom = require("../../../createRoom");

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _VerificationRequest = require("matrix-js-sdk/src/crypto/verification/request/VerificationRequest");

var sdk = _interopRequireWildcard(require("../../../index"));

var _languageHandler = require("../../../languageHandler");

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// cancellation codes which constitute a key mismatch
const MISMATCHES = ["m.key_mismatch", "m.user_error", "m.mismatched_sas"];

const EncryptionPanel = props => {
  const {
    verificationRequest,
    verificationRequestPromise,
    member,
    onClose,
    layout,
    isRoomEncrypted
  } = props;
  const [request, setRequest] = (0, _react.useState)(verificationRequest); // state to show a spinner immediately after clicking "start verification",
  // before we have a request

  const [isRequesting, setRequesting] = (0, _react.useState)(false);
  const [phase, setPhase] = (0, _react.useState)(request && request.phase);
  (0, _react.useEffect)(() => {
    setRequest(verificationRequest);

    if (verificationRequest) {
      setRequesting(false);
      setPhase(verificationRequest.phase);
    }
  }, [verificationRequest]);
  (0, _react.useEffect)(() => {
    async function awaitPromise() {
      setRequesting(true);
      const request = await verificationRequestPromise;
      setRequesting(false);
      setRequest(request);
      setPhase(request.phase);
    }

    if (verificationRequestPromise) {
      awaitPromise();
    }
  }, [verificationRequestPromise]);
  const changeHandler = (0, _react.useCallback)(() => {
    // handle transitions -> cancelled for mismatches which fire a modal instead of showing a card
    if (request && request.cancelled && MISMATCHES.includes(request.cancellationCode)) {
      const ErrorDialog = sdk.getComponent("dialogs.ErrorDialog");

      _Modal.default.createTrackedDialog("Verification failed", "insecure", ErrorDialog, {
        headerImage: require("../../../../res/img/e2e/warning.svg"),
        title: (0, _languageHandler._t)("Your messages are not secure"),
        description: /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("One of the following may be compromised:"), /*#__PURE__*/_react.default.createElement("ul", null, /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your homeserver")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("The homeserver the user you’re verifying is connected to")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users’ internet connection")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users’ session")))),
        onFinished: onClose
      });

      return; // don't update phase here as we will be transitioning away from this view shortly
    }

    if (request) {
      setPhase(request.phase);
    }
  }, [onClose, request]);
  (0, _useEventEmitter.useEventEmitter)(request, "change", changeHandler);
  const onCancel = (0, _react.useCallback)(function () {
    if (request) {
      request.cancel();
    }
  }, [request]);
  let cancelButton;

  if (layout !== "dialog" && request && request.pending) {
    const AccessibleButton = sdk.getComponent("elements.AccessibleButton");
    cancelButton = /*#__PURE__*/_react.default.createElement(AccessibleButton, {
      className: "mx_EncryptionPanel_cancel",
      onClick: onCancel,
      title: (0, _languageHandler._t)('Cancel')
    });
  }

  const onStartVerification = (0, _react.useCallback)(async () => {
    setRequesting(true);

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const roomId = await (0, _createRoom.ensureDMExists)(cli, member.userId);
    const verificationRequest = await cli.requestVerificationDM(member.userId, roomId);
    setRequest(verificationRequest);
    setPhase(verificationRequest.phase);
  }, [member.userId]);
  const requested = !request && isRequesting || request && (phase === _VerificationRequest.PHASE_REQUESTED || phase === _VerificationRequest.PHASE_UNSENT || phase === undefined);
  const isSelfVerification = request ? request.isSelfVerification : member.userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId();

  if (!request || requested) {
    const initiatedByMe = !request && isRequesting || request && request.initiatedByMe;
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, cancelButton, /*#__PURE__*/_react.default.createElement(_EncryptionInfo.default, {
      isRoomEncrypted: isRoomEncrypted,
      onStartVerification: onStartVerification,
      member: member,
      isSelfVerification: isSelfVerification,
      waitingForOtherParty: requested && initiatedByMe,
      waitingForNetwork: requested && !initiatedByMe,
      inDialog: layout === "dialog"
    }));
  } else {
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, cancelButton, /*#__PURE__*/_react.default.createElement(_VerificationPanel.default, {
      isRoomEncrypted: isRoomEncrypted,
      layout: layout,
      onClose: onClose,
      member: member,
      request: request,
      key: request.channel.transactionId,
      inDialog: layout === "dialog",
      phase: phase
    }));
  }
};

EncryptionPanel.propTypes = {
  member: _propTypes.default.object.isRequired,
  onClose: _propTypes.default.func.isRequired,
  verificationRequest: _propTypes.default.object,
  layout: _propTypes.default.string,
  inDialog: _propTypes.default.bool
};
var _default = EncryptionPanel;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3JpZ2h0X3BhbmVsL0VuY3J5cHRpb25QYW5lbC5qcyJdLCJuYW1lcyI6WyJNSVNNQVRDSEVTIiwiRW5jcnlwdGlvblBhbmVsIiwicHJvcHMiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0IiwidmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UiLCJtZW1iZXIiLCJvbkNsb3NlIiwibGF5b3V0IiwiaXNSb29tRW5jcnlwdGVkIiwicmVxdWVzdCIsInNldFJlcXVlc3QiLCJpc1JlcXVlc3RpbmciLCJzZXRSZXF1ZXN0aW5nIiwicGhhc2UiLCJzZXRQaGFzZSIsImF3YWl0UHJvbWlzZSIsImNoYW5nZUhhbmRsZXIiLCJjYW5jZWxsZWQiLCJpbmNsdWRlcyIsImNhbmNlbGxhdGlvbkNvZGUiLCJFcnJvckRpYWxvZyIsInNkayIsImdldENvbXBvbmVudCIsIk1vZGFsIiwiY3JlYXRlVHJhY2tlZERpYWxvZyIsImhlYWRlckltYWdlIiwicmVxdWlyZSIsInRpdGxlIiwiZGVzY3JpcHRpb24iLCJvbkZpbmlzaGVkIiwib25DYW5jZWwiLCJjYW5jZWwiLCJjYW5jZWxCdXR0b24iLCJwZW5kaW5nIiwiQWNjZXNzaWJsZUJ1dHRvbiIsIm9uU3RhcnRWZXJpZmljYXRpb24iLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJyb29tSWQiLCJ1c2VySWQiLCJyZXF1ZXN0VmVyaWZpY2F0aW9uRE0iLCJyZXF1ZXN0ZWQiLCJQSEFTRV9SRVFVRVNURUQiLCJQSEFTRV9VTlNFTlQiLCJ1bmRlZmluZWQiLCJpc1NlbGZWZXJpZmljYXRpb24iLCJnZXRVc2VySWQiLCJpbml0aWF0ZWRCeU1lIiwiY2hhbm5lbCIsInRyYW5zYWN0aW9uSWQiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwiZnVuYyIsInN0cmluZyIsImluRGlhbG9nIiwiYm9vbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7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S0FBSyxRQVB6QjtBQVFJLE1BQUEsS0FBSyxFQUFFTTtBQVJYLE1BRkksQ0FBUjtBQWFIO0FBQ0osQ0FqSEQ7O0FBa0hBWixlQUFlLENBQUNrRCxTQUFoQixHQUE0QjtBQUN4QjlDLEVBQUFBLE1BQU0sRUFBRStDLG1CQUFVQyxNQUFWLENBQWlCQyxVQUREO0FBRXhCaEQsRUFBQUEsT0FBTyxFQUFFOEMsbUJBQVVHLElBQVYsQ0FBZUQsVUFGQTtBQUd4Qm5ELEVBQUFBLG1CQUFtQixFQUFFaUQsbUJBQVVDLE1BSFA7QUFJeEI5QyxFQUFBQSxNQUFNLEVBQUU2QyxtQkFBVUksTUFKTTtBQUt4QkMsRUFBQUEsUUFBUSxFQUFFTCxtQkFBVU07QUFMSSxDQUE1QjtlQVFlekQsZSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwge3VzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZVN0YXRlfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSBcInByb3AtdHlwZXNcIjtcblxuaW1wb3J0IEVuY3J5cHRpb25JbmZvIGZyb20gXCIuL0VuY3J5cHRpb25JbmZvXCI7XG5pbXBvcnQgVmVyaWZpY2F0aW9uUGFuZWwgZnJvbSBcIi4vVmVyaWZpY2F0aW9uUGFuZWxcIjtcbmltcG9ydCB7TWF0cml4Q2xpZW50UGVnfSBmcm9tIFwiLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQge2Vuc3VyZURNRXhpc3RzfSBmcm9tIFwiLi4vLi4vLi4vY3JlYXRlUm9vbVwiO1xuaW1wb3J0IHt1c2VFdmVudEVtaXR0ZXJ9IGZyb20gXCIuLi8uLi8uLi9ob29rcy91c2VFdmVudEVtaXR0ZXJcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vLi4vLi4vTW9kYWxcIjtcbmltcG9ydCB7UEhBU0VfUkVRVUVTVEVELCBQSEFTRV9VTlNFTlR9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vdmVyaWZpY2F0aW9uL3JlcXVlc3QvVmVyaWZpY2F0aW9uUmVxdWVzdFwiO1xuaW1wb3J0ICogYXMgc2RrIGZyb20gXCIuLi8uLi8uLi9pbmRleFwiO1xuaW1wb3J0IHtfdH0gZnJvbSBcIi4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuXG4vLyBjYW5jZWxsYXRpb24gY29kZXMgd2hpY2ggY29uc3RpdHV0ZSBhIGtleSBtaXNtYXRjaFxuY29uc3QgTUlTTUFUQ0hFUyA9IFtcIm0ua2V5X21pc21hdGNoXCIsIFwibS51c2VyX2Vycm9yXCIsIFwibS5taXNtYXRjaGVkX3Nhc1wiXTtcblxuY29uc3QgRW5jcnlwdGlvblBhbmVsID0gKHByb3BzKSA9PiB7XG4gICAgY29uc3Qge3ZlcmlmaWNhdGlvblJlcXVlc3QsIHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlLCBtZW1iZXIsIG9uQ2xvc2UsIGxheW91dCwgaXNSb29tRW5jcnlwdGVkfSA9IHByb3BzO1xuICAgIGNvbnN0IFtyZXF1ZXN0LCBzZXRSZXF1ZXN0XSA9IHVzZVN0YXRlKHZlcmlmaWNhdGlvblJlcXVlc3QpO1xuICAgIC8vIHN0YXRlIHRvIHNob3cgYSBzcGlubmVyIGltbWVkaWF0ZWx5IGFmdGVyIGNsaWNraW5nIFwic3RhcnQgdmVyaWZpY2F0aW9uXCIsXG4gICAgLy8gYmVmb3JlIHdlIGhhdmUgYSByZXF1ZXN0XG4gICAgY29uc3QgW2lzUmVxdWVzdGluZywgc2V0UmVxdWVzdGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG4gICAgY29uc3QgW3BoYXNlLCBzZXRQaGFzZV0gPSB1c2VTdGF0ZShyZXF1ZXN0ICYmIHJlcXVlc3QucGhhc2UpO1xuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIHNldFJlcXVlc3QodmVyaWZpY2F0aW9uUmVxdWVzdCk7XG4gICAgICAgIGlmICh2ZXJpZmljYXRpb25SZXF1ZXN0KSB7XG4gICAgICAgICAgICBzZXRSZXF1ZXN0aW5nKGZhbHNlKTtcbiAgICAgICAgICAgIHNldFBoYXNlKHZlcmlmaWNhdGlvblJlcXVlc3QucGhhc2UpO1xuICAgICAgICB9XG4gICAgfSwgW3ZlcmlmaWNhdGlvblJlcXVlc3RdKTtcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uIGF3YWl0UHJvbWlzZSgpIHtcbiAgICAgICAgICAgIHNldFJlcXVlc3RpbmcodHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2U7XG4gICAgICAgICAgICBzZXRSZXF1ZXN0aW5nKGZhbHNlKTtcbiAgICAgICAgICAgIHNldFJlcXVlc3QocmVxdWVzdCk7XG4gICAgICAgICAgICBzZXRQaGFzZShyZXF1ZXN0LnBoYXNlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UpIHtcbiAgICAgICAgICAgIGF3YWl0UHJvbWlzZSgpO1xuICAgICAgICB9XG4gICAgfSwgW3ZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlXSk7XG4gICAgY29uc3QgY2hhbmdlSGFuZGxlciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgICAgLy8gaGFuZGxlIHRyYW5zaXRpb25zIC0+IGNhbmNlbGxlZCBmb3IgbWlzbWF0Y2hlcyB3aGljaCBmaXJlIGEgbW9kYWwgaW5zdGVhZCBvZiBzaG93aW5nIGEgY2FyZFxuICAgICAgICBpZiAocmVxdWVzdCAmJiByZXF1ZXN0LmNhbmNlbGxlZCAmJiBNSVNNQVRDSEVTLmluY2x1ZGVzKHJlcXVlc3QuY2FuY2VsbGF0aW9uQ29kZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IEVycm9yRGlhbG9nID0gc2RrLmdldENvbXBvbmVudChcImRpYWxvZ3MuRXJyb3JEaWFsb2dcIik7XG4gICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFwiVmVyaWZpY2F0aW9uIGZhaWxlZFwiLCBcImluc2VjdXJlXCIsIEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgaGVhZGVySW1hZ2U6IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9yZXMvaW1nL2UyZS93YXJuaW5nLnN2Z1wiKSxcbiAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJZb3VyIG1lc3NhZ2VzIGFyZSBub3Qgc2VjdXJlXCIpLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICB7X3QoXCJPbmUgb2YgdGhlIGZvbGxvd2luZyBtYXkgYmUgY29tcHJvbWlzZWQ6XCIpfVxuICAgICAgICAgICAgICAgICAgICA8dWw+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bGk+e190KFwiWW91ciBob21lc2VydmVyXCIpfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bGk+e190KFwiVGhlIGhvbWVzZXJ2ZXIgdGhlIHVzZXIgeW914oCZcmUgdmVyaWZ5aW5nIGlzIGNvbm5lY3RlZCB0b1wiKX08L2xpPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPntfdChcIllvdXJzLCBvciB0aGUgb3RoZXIgdXNlcnPigJkgaW50ZXJuZXQgY29ubmVjdGlvblwiKX08L2xpPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPntfdChcIllvdXJzLCBvciB0aGUgb3RoZXIgdXNlcnPigJkgc2Vzc2lvblwiKX08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8L3VsPlxuICAgICAgICAgICAgICAgIDwvZGl2PixcbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkOiBvbkNsb3NlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47IC8vIGRvbid0IHVwZGF0ZSBwaGFzZSBoZXJlIGFzIHdlIHdpbGwgYmUgdHJhbnNpdGlvbmluZyBhd2F5IGZyb20gdGhpcyB2aWV3IHNob3J0bHlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgICAgICBzZXRQaGFzZShyZXF1ZXN0LnBoYXNlKTtcbiAgICAgICAgfVxuICAgIH0sIFtvbkNsb3NlLCByZXF1ZXN0XSk7XG4gICAgdXNlRXZlbnRFbWl0dGVyKHJlcXVlc3QsIFwiY2hhbmdlXCIsIGNoYW5nZUhhbmRsZXIpO1xuXG4gICAgY29uc3Qgb25DYW5jZWwgPSB1c2VDYWxsYmFjayhmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsKCk7XG4gICAgICAgIH1cbiAgICB9LCBbcmVxdWVzdF0pO1xuXG4gICAgbGV0IGNhbmNlbEJ1dHRvbjtcbiAgICBpZiAobGF5b3V0ICE9PSBcImRpYWxvZ1wiICYmIHJlcXVlc3QgJiYgcmVxdWVzdC5wZW5kaW5nKSB7XG4gICAgICAgIGNvbnN0IEFjY2Vzc2libGVCdXR0b24gPSBzZGsuZ2V0Q29tcG9uZW50KFwiZWxlbWVudHMuQWNjZXNzaWJsZUJ1dHRvblwiKTtcbiAgICAgICAgY2FuY2VsQnV0dG9uID0gKDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9FbmNyeXB0aW9uUGFuZWxfY2FuY2VsXCJcbiAgICAgICAgICAgIG9uQ2xpY2s9e29uQ2FuY2VsfVxuICAgICAgICAgICAgdGl0bGU9e190KCdDYW5jZWwnKX1cbiAgICAgICAgPjwvQWNjZXNzaWJsZUJ1dHRvbj4pO1xuICAgIH1cblxuICAgIGNvbnN0IG9uU3RhcnRWZXJpZmljYXRpb24gPSB1c2VDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgICAgIHNldFJlcXVlc3RpbmcodHJ1ZSk7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gYXdhaXQgZW5zdXJlRE1FeGlzdHMoY2xpLCBtZW1iZXIudXNlcklkKTtcbiAgICAgICAgY29uc3QgdmVyaWZpY2F0aW9uUmVxdWVzdCA9IGF3YWl0IGNsaS5yZXF1ZXN0VmVyaWZpY2F0aW9uRE0obWVtYmVyLnVzZXJJZCwgcm9vbUlkKTtcbiAgICAgICAgc2V0UmVxdWVzdCh2ZXJpZmljYXRpb25SZXF1ZXN0KTtcbiAgICAgICAgc2V0UGhhc2UodmVyaWZpY2F0aW9uUmVxdWVzdC5waGFzZSk7XG4gICAgfSwgW21lbWJlci51c2VySWRdKTtcblxuICAgIGNvbnN0IHJlcXVlc3RlZCA9XG4gICAgICAgICghcmVxdWVzdCAmJiBpc1JlcXVlc3RpbmcpIHx8XG4gICAgICAgIChyZXF1ZXN0ICYmIChwaGFzZSA9PT0gUEhBU0VfUkVRVUVTVEVEIHx8IHBoYXNlID09PSBQSEFTRV9VTlNFTlQgfHwgcGhhc2UgPT09IHVuZGVmaW5lZCkpO1xuICAgIGNvbnN0IGlzU2VsZlZlcmlmaWNhdGlvbiA9IHJlcXVlc3QgP1xuICAgICAgICByZXF1ZXN0LmlzU2VsZlZlcmlmaWNhdGlvbiA6XG4gICAgICAgIG1lbWJlci51c2VySWQgPT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKTtcbiAgICBpZiAoIXJlcXVlc3QgfHwgcmVxdWVzdGVkKSB7XG4gICAgICAgIGNvbnN0IGluaXRpYXRlZEJ5TWUgPSAoIXJlcXVlc3QgJiYgaXNSZXF1ZXN0aW5nKSB8fCAocmVxdWVzdCAmJiByZXF1ZXN0LmluaXRpYXRlZEJ5TWUpO1xuICAgICAgICByZXR1cm4gKDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgIHtjYW5jZWxCdXR0b259XG4gICAgICAgICAgICA8RW5jcnlwdGlvbkluZm9cbiAgICAgICAgICAgICAgICBpc1Jvb21FbmNyeXB0ZWQ9e2lzUm9vbUVuY3J5cHRlZH1cbiAgICAgICAgICAgICAgICBvblN0YXJ0VmVyaWZpY2F0aW9uPXtvblN0YXJ0VmVyaWZpY2F0aW9ufVxuICAgICAgICAgICAgICAgIG1lbWJlcj17bWVtYmVyfVxuICAgICAgICAgICAgICAgIGlzU2VsZlZlcmlmaWNhdGlvbj17aXNTZWxmVmVyaWZpY2F0aW9ufVxuICAgICAgICAgICAgICAgIHdhaXRpbmdGb3JPdGhlclBhcnR5PXtyZXF1ZXN0ZWQgJiYgaW5pdGlhdGVkQnlNZX1cbiAgICAgICAgICAgICAgICB3YWl0aW5nRm9yTmV0d29yaz17cmVxdWVzdGVkICYmICFpbml0aWF0ZWRCeU1lfVxuICAgICAgICAgICAgICAgIGluRGlhbG9nPXtsYXlvdXQgPT09IFwiZGlhbG9nXCJ9IC8+XG4gICAgICAgIDwvUmVhY3QuRnJhZ21lbnQ+KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgIHtjYW5jZWxCdXR0b259XG4gICAgICAgICAgICA8VmVyaWZpY2F0aW9uUGFuZWxcbiAgICAgICAgICAgICAgICBpc1Jvb21FbmNyeXB0ZWQ9e2lzUm9vbUVuY3J5cHRlZH1cbiAgICAgICAgICAgICAgICBsYXlvdXQ9e2xheW91dH1cbiAgICAgICAgICAgICAgICBvbkNsb3NlPXtvbkNsb3NlfVxuICAgICAgICAgICAgICAgIG1lbWJlcj17bWVtYmVyfVxuICAgICAgICAgICAgICAgIHJlcXVlc3Q9e3JlcXVlc3R9XG4gICAgICAgICAgICAgICAga2V5PXtyZXF1ZXN0LmNoYW5uZWwudHJhbnNhY3Rpb25JZH1cbiAgICAgICAgICAgICAgICBpbkRpYWxvZz17bGF5b3V0ID09PSBcImRpYWxvZ1wifVxuICAgICAgICAgICAgICAgIHBoYXNlPXtwaGFzZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgIDwvUmVhY3QuRnJhZ21lbnQ+KTtcbiAgICB9XG59O1xuRW5jcnlwdGlvblBhbmVsLnByb3BUeXBlcyA9IHtcbiAgICBtZW1iZXI6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBvbkNsb3NlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgbGF5b3V0OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGluRGlhbG9nOiBQcm9wVHlwZXMuYm9vbCxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IEVuY3J5cHRpb25QYW5lbDtcbiJdfQ==