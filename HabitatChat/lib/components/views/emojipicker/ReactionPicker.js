"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _EmojiPicker = _interopRequireDefault(require("./EmojiPicker"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

/*
Copyright 2019 Tulir Asokan <tulir@maunium.net>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class ReactionPicker extends _react.default.Component {
  constructor(props) {
    super(props);
    this.state = {
      selectedEmojis: new Set(Object.keys(this.getReactions()))
    };
    this.onChoose = this.onChoose.bind(this);
    this.onReactionsChange = this.onReactionsChange.bind(this);
    this.addListeners();
  }

  componentDidUpdate(prevProps) {
    if (prevProps.reactions !== this.props.reactions) {
      this.addListeners();
      this.onReactionsChange();
    }
  }

  addListeners() {
    if (this.props.reactions) {
      this.props.reactions.on("Relations.add", this.onReactionsChange);
      this.props.reactions.on("Relations.remove", this.onReactionsChange);
      this.props.reactions.on("Relations.redaction", this.onReactionsChange);
    }
  }

  componentWillUnmount() {
    if (this.props.reactions) {
      this.props.reactions.removeListener("Relations.add", this.onReactionsChange);
      this.props.reactions.removeListener("Relations.remove", this.onReactionsChange);
      this.props.reactions.removeListener("Relations.redaction", this.onReactionsChange);
    }
  }

  getReactions() {
    if (!this.props.reactions) {
      return {};
    }

    const userId = _MatrixClientPeg.MatrixClientPeg.get().getUserId();

    const myAnnotations = this.props.reactions.getAnnotationsBySender()[userId] || [];
    return Object.fromEntries([...myAnnotations].filter(event => !event.isRedacted()).map(event => [event.getRelation().key, event.getId()]));
  }

  onReactionsChange() {
    this.setState({
      selectedEmojis: new Set(Object.keys(this.getReactions()))
    });
  }

  onChoose(reaction) {
    this.componentWillUnmount();
    this.props.onFinished();
    const myReactions = this.getReactions();

    if (myReactions.hasOwnProperty(reaction)) {
      _MatrixClientPeg.MatrixClientPeg.get().redactEvent(this.props.mxEvent.getRoomId(), myReactions[reaction]); // Tell the emoji picker not to bump this in the more frequently used list.


      return false;
    } else {
      _MatrixClientPeg.MatrixClientPeg.get().sendEvent(this.props.mxEvent.getRoomId(), "m.reaction", {
        "m.relates_to": {
          "rel_type": "m.annotation",
          "event_id": this.props.mxEvent.getId(),
          "key": reaction
        }
      });

      return true;
    }
  }

  render() {
    return /*#__PURE__*/_react.default.createElement(_EmojiPicker.default, {
      onChoose: this.onChoose,
      selectedEmojis: this.state.selectedEmojis,
      showQuickReactions: true
    });
  }

}

(0, _defineProperty2.default)(ReactionPicker, "propTypes", {
  mxEvent: _propTypes.default.object.isRequired,
  onFinished: _propTypes.default.func.isRequired,
  reactions: _propTypes.default.object
});
var _default = ReactionPicker;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2Vtb2ppcGlja2VyL1JlYWN0aW9uUGlja2VyLmpzIl0sIm5hbWVzIjpbIlJlYWN0aW9uUGlja2VyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RhdGUiLCJzZWxlY3RlZEVtb2ppcyIsIlNldCIsIk9iamVjdCIsImtleXMiLCJnZXRSZWFjdGlvbnMiLCJvbkNob29zZSIsImJpbmQiLCJvblJlYWN0aW9uc0NoYW5nZSIsImFkZExpc3RlbmVycyIsImNvbXBvbmVudERpZFVwZGF0ZSIsInByZXZQcm9wcyIsInJlYWN0aW9ucyIsIm9uIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVMaXN0ZW5lciIsInVzZXJJZCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsIm15QW5ub3RhdGlvbnMiLCJnZXRBbm5vdGF0aW9uc0J5U2VuZGVyIiwiZnJvbUVudHJpZXMiLCJmaWx0ZXIiLCJldmVudCIsImlzUmVkYWN0ZWQiLCJtYXAiLCJnZXRSZWxhdGlvbiIsImtleSIsImdldElkIiwic2V0U3RhdGUiLCJyZWFjdGlvbiIsIm9uRmluaXNoZWQiLCJteVJlYWN0aW9ucyIsImhhc093blByb3BlcnR5IiwicmVkYWN0RXZlbnQiLCJteEV2ZW50IiwiZ2V0Um9vbUlkIiwic2VuZEV2ZW50IiwicmVuZGVyIiwiUHJvcFR5cGVzIiwib2JqZWN0IiwiaXNSZXF1aXJlZCIsImZ1bmMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUNBOztBQW5CQTs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLE1BQU1BLGNBQU4sU0FBNkJDLGVBQU1DLFNBQW5DLENBQTZDO0FBT3pDQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUNmLFVBQU1BLEtBQU47QUFFQSxTQUFLQyxLQUFMLEdBQWE7QUFDVEMsTUFBQUEsY0FBYyxFQUFFLElBQUlD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c0MsQ0FLdEM7OztBQUNBLGFBQU8sS0FBUDtBQUNILEtBUEQsTUFPTztBQUNIZCx1Q0FBZ0JDLEdBQWhCLEdBQXNCb0IsU0FBdEIsQ0FBZ0MsS0FBS3ZDLEtBQUwsQ0FBV3FDLE9BQVgsQ0FBbUJDLFNBQW5CLEVBQWhDLEVBQWdFLFlBQWhFLEVBQThFO0FBQzFFLHdCQUFnQjtBQUNaLHNCQUFZLGNBREE7QUFFWixzQkFBWSxLQUFLdEMsS0FBTCxDQUFXcUMsT0FBWCxDQUFtQlAsS0FBbkIsRUFGQTtBQUdaLGlCQUFPRTtBQUhLO0FBRDBELE9BQTlFOztBQU9BLGFBQU8sSUFBUDtBQUNIO0FBQ0o7O0FBRURRLEVBQUFBLE1BQU0sR0FBRztBQUNMLHdCQUFPLDZCQUFDLG9CQUFEO0FBQ0gsTUFBQSxRQUFRLEVBQUUsS0FBS2pDLFFBRFo7QUFFSCxNQUFBLGNBQWMsRUFBRSxLQUFLTixLQUFMLENBQVdDLGNBRnhCO0FBR0gsTUFBQSxrQkFBa0IsRUFBRTtBQUhqQixNQUFQO0FBS0g7O0FBaEd3Qzs7OEJBQXZDTixjLGVBQ2lCO0FBQ2Z5QyxFQUFBQSxPQUFPLEVBQUVJLG1CQUFVQyxNQUFWLENBQWlCQyxVQURYO0FBRWZWLEVBQUFBLFVBQVUsRUFBRVEsbUJBQVVHLElBQVYsQ0FBZUQsVUFGWjtBQUdmOUIsRUFBQUEsU0FBUyxFQUFFNEIsbUJBQVVDO0FBSE4sQztlQWtHUjlDLGMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgVHVsaXIgQXNva2FuIDx0dWxpckBtYXVuaXVtLm5ldD5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tIFwicHJvcC10eXBlc1wiO1xuaW1wb3J0IEVtb2ppUGlja2VyIGZyb20gXCIuL0Vtb2ppUGlja2VyXCI7XG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuXG5jbGFzcyBSZWFjdGlvblBpY2tlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gICAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAgICAgbXhFdmVudDogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgICAgICBvbkZpbmlzaGVkOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgICAgICByZWFjdGlvbnM6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWRFbW9qaXM6IG5ldyBTZXQoT2JqZWN0LmtleXModGhpcy5nZXRSZWFjdGlvbnMoKSkpLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLm9uQ2hvb3NlID0gdGhpcy5vbkNob29zZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlID0gdGhpcy5vblJlYWN0aW9uc0NoYW5nZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmFkZExpc3RlbmVycygpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcbiAgICAgICAgaWYgKHByZXZQcm9wcy5yZWFjdGlvbnMgIT09IHRoaXMucHJvcHMucmVhY3Rpb25zKSB7XG4gICAgICAgICAgICB0aGlzLmFkZExpc3RlbmVycygpO1xuICAgICAgICAgICAgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkTGlzdGVuZXJzKCkge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5yZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVhY3Rpb25zLm9uKFwiUmVsYXRpb25zLmFkZFwiLCB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKTtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVhY3Rpb25zLm9uKFwiUmVsYXRpb25zLnJlbW92ZVwiLCB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKTtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVhY3Rpb25zLm9uKFwiUmVsYXRpb25zLnJlZGFjdGlvblwiLCB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5yZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucmVhY3Rpb25zLnJlbW92ZUxpc3RlbmVyKFxuICAgICAgICAgICAgICAgIFwiUmVsYXRpb25zLmFkZFwiLFxuICAgICAgICAgICAgICAgIHRoaXMub25SZWFjdGlvbnNDaGFuZ2UsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZWFjdGlvbnMucmVtb3ZlTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgXCJSZWxhdGlvbnMucmVtb3ZlXCIsXG4gICAgICAgICAgICAgICAgdGhpcy5vblJlYWN0aW9uc0NoYW5nZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLnByb3BzLnJlYWN0aW9ucy5yZW1vdmVMaXN0ZW5lcihcbiAgICAgICAgICAgICAgICBcIlJlbGF0aW9ucy5yZWRhY3Rpb25cIixcbiAgICAgICAgICAgICAgICB0aGlzLm9uUmVhY3Rpb25zQ2hhbmdlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldFJlYWN0aW9ucygpIHtcbiAgICAgICAgaWYgKCF0aGlzLnByb3BzLnJlYWN0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKTtcbiAgICAgICAgY29uc3QgbXlBbm5vdGF0aW9ucyA9IHRoaXMucHJvcHMucmVhY3Rpb25zLmdldEFubm90YXRpb25zQnlTZW5kZXIoKVt1c2VySWRdIHx8IFtdO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKFsuLi5teUFubm90YXRpb25zXVxuICAgICAgICAgICAgLmZpbHRlcihldmVudCA9PiAhZXZlbnQuaXNSZWRhY3RlZCgpKVxuICAgICAgICAgICAgLm1hcChldmVudCA9PiBbZXZlbnQuZ2V0UmVsYXRpb24oKS5rZXksIGV2ZW50LmdldElkKCldKSk7XG4gICAgfVxuXG4gICAgb25SZWFjdGlvbnNDaGFuZ2UoKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2VsZWN0ZWRFbW9qaXM6IG5ldyBTZXQoT2JqZWN0LmtleXModGhpcy5nZXRSZWFjdGlvbnMoKSkpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbkNob29zZShyZWFjdGlvbikge1xuICAgICAgICB0aGlzLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgICAgICBjb25zdCBteVJlYWN0aW9ucyA9IHRoaXMuZ2V0UmVhY3Rpb25zKCk7XG4gICAgICAgIGlmIChteVJlYWN0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWFjdGlvbikpIHtcbiAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZWRhY3RFdmVudChcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCksXG4gICAgICAgICAgICAgICAgbXlSZWFjdGlvbnNbcmVhY3Rpb25dLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIC8vIFRlbGwgdGhlIGVtb2ppIHBpY2tlciBub3QgdG8gYnVtcCB0aGlzIGluIHRoZSBtb3JlIGZyZXF1ZW50bHkgdXNlZCBsaXN0LlxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnNlbmRFdmVudCh0aGlzLnByb3BzLm14RXZlbnQuZ2V0Um9vbUlkKCksIFwibS5yZWFjdGlvblwiLCB7XG4gICAgICAgICAgICAgICAgXCJtLnJlbGF0ZXNfdG9cIjoge1xuICAgICAgICAgICAgICAgICAgICBcInJlbF90eXBlXCI6IFwibS5hbm5vdGF0aW9uXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiZXZlbnRfaWRcIjogdGhpcy5wcm9wcy5teEV2ZW50LmdldElkKCksXG4gICAgICAgICAgICAgICAgICAgIFwia2V5XCI6IHJlYWN0aW9uLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gPEVtb2ppUGlja2VyXG4gICAgICAgICAgICBvbkNob29zZT17dGhpcy5vbkNob29zZX1cbiAgICAgICAgICAgIHNlbGVjdGVkRW1vamlzPXt0aGlzLnN0YXRlLnNlbGVjdGVkRW1vamlzfVxuICAgICAgICAgICAgc2hvd1F1aWNrUmVhY3Rpb25zPXt0cnVlfVxuICAgICAgICAvPjtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlYWN0aW9uUGlja2VyO1xuIl19