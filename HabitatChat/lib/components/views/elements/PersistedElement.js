"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _resizeObserverPolyfill = _interopRequireDefault(require("resize-observer-polyfill"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

/*
Copyright 2018 New Vector Ltd.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// Shamelessly ripped off Modal.js.  There's probably a better way
// of doing reusable widgets like dialog boxes & menus where we go and
// pass in a custom control as the actual body.
function getContainer(containerId) {
  return document.getElementById(containerId);
}

function getOrCreateContainer(containerId) {
  let container = getContainer(containerId);

  if (!container) {
    container = document.createElement("div");
    container.id = containerId;
    document.body.appendChild(container);
  }

  return container;
}
/*
 * Class of component that renders its children in a separate ReactDOM virtual tree
 * in a container element appended to document.body.
 *
 * This prevents the children from being unmounted when the parent of PersistedElement
 * unmounts, allowing them to persist.
 *
 * When PE is unmounted, it hides the children using CSS. When mounted or updated, the
 * children are made visible and are positioned into a div that is given the same
 * bounding rect as the parent of PE.
 */


class PersistedElement extends _react.default.Component {
  constructor() {
    super();
    this.collectChildContainer = this.collectChildContainer.bind(this);
    this.collectChild = this.collectChild.bind(this);
    this._repositionChild = this._repositionChild.bind(this);
    this._onAction = this._onAction.bind(this);
    this.resizeObserver = new _resizeObserverPolyfill.default(this._repositionChild); // Annoyingly, a resize observer is insufficient, since we also care
    // about when the element moves on the screen without changing its
    // dimensions. Doesn't look like there's a ResizeObserver equivalent
    // for this, so we bodge it by listening for document resize and
    // the timeline_resize action.

    window.addEventListener('resize', this._repositionChild);
    this._dispatcherRef = _dispatcher.default.register(this._onAction);
  }
  /**
   * Removes the DOM elements created when a PersistedElement with the given
   * persistKey was mounted. The DOM elements will be re-added if another
   * PeristedElement is mounted in the future.
   *
   * @param {string} persistKey Key used to uniquely identify this PersistedElement
   */


  static destroyElement(persistKey) {
    const container = getContainer('mx_persistedElement_' + persistKey);

    if (container) {
      container.remove();
    }
  }

  static isMounted(persistKey) {
    return Boolean(getContainer('mx_persistedElement_' + persistKey));
  }

  collectChildContainer(ref) {
    if (this.childContainer) {
      this.resizeObserver.unobserve(this.childContainer);
    }

    this.childContainer = ref;

    if (ref) {
      this.resizeObserver.observe(ref);
    }
  }

  collectChild(ref) {
    this.child = ref;
    this.updateChild();
  }

  componentDidMount() {
    this.updateChild();
    this.renderApp();
  }

  componentDidUpdate() {
    this.updateChild();
    this.renderApp();
  }

  componentWillUnmount() {
    this.updateChildVisibility(this.child, false);
    this.resizeObserver.disconnect();
    window.removeEventListener('resize', this._repositionChild);

    _dispatcher.default.unregister(this._dispatcherRef);
  }

  _onAction(payload) {
    if (payload.action === 'timeline_resize') {
      this._repositionChild();
    }
  }

  _repositionChild() {
    this.updateChildPosition(this.child, this.childContainer);
  }

  updateChild() {
    this.updateChildPosition(this.child, this.childContainer);
    this.updateChildVisibility(this.child, true);
  }

  renderApp() {
    const content = /*#__PURE__*/_react.default.createElement("div", {
      ref: this.collectChild,
      style: this.props.style
    }, this.props.children);

    _reactDom.default.render(content, getOrCreateContainer('mx_persistedElement_' + this.props.persistKey));
  }

  updateChildVisibility(child, visible) {
    if (!child) return;
    child.style.display = visible ? 'block' : 'none';
  }

  updateChildPosition(child, parent) {
    if (!child || !parent) return;
    const parentRect = parent.getBoundingClientRect();
    Object.assign(child.style, {
      position: 'absolute',
      top: parentRect.top + 'px',
      left: parentRect.left + 'px',
      width: parentRect.width + 'px',
      height: parentRect.height + 'px'
    });
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("div", {
      ref: this.collectChildContainer
    });
  }

}

exports.default = PersistedElement;
(0, _defineProperty2.default)(PersistedElement, "propTypes", {
  // Unique identifier for this PersistedElement instance
  // Any PersistedElements with the same persistKey will use
  // the same DOM container.
  persistKey: _propTypes.default.string.isRequired
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1BlcnNpc3RlZEVsZW1lbnQuanMiXSwibmFtZXMiOlsiZ2V0Q29udGFpbmVyIiwiY29udGFpbmVySWQiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiZ2V0T3JDcmVhdGVDb250YWluZXIiLCJjb250YWluZXIiLCJjcmVhdGVFbGVtZW50IiwiaWQiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJQZXJzaXN0ZWRFbGVtZW50IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsImNvbGxlY3RDaGlsZENvbnRhaW5lciIsImJpbmQiLCJjb2xsZWN0Q2hpbGQiLCJfcmVwb3NpdGlvbkNoaWxkIiwiX29uQWN0aW9uIiwicmVzaXplT2JzZXJ2ZXIiLCJSZXNpemVPYnNlcnZlciIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJfZGlzcGF0Y2hlclJlZiIsImRpcyIsInJlZ2lzdGVyIiwiZGVzdHJveUVsZW1lbnQiLCJwZXJzaXN0S2V5IiwicmVtb3ZlIiwiaXNNb3VudGVkIiwiQm9vbGVhbiIsInJlZiIsImNoaWxkQ29udGFpbmVyIiwidW5vYnNlcnZlIiwib2JzZXJ2ZSIsImNoaWxkIiwidXBkYXRlQ2hpbGQiLCJjb21wb25lbnREaWRNb3VudCIsInJlbmRlckFwcCIsImNvbXBvbmVudERpZFVwZGF0ZSIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwidXBkYXRlQ2hpbGRWaXNpYmlsaXR5IiwiZGlzY29ubmVjdCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJ1bnJlZ2lzdGVyIiwicGF5bG9hZCIsImFjdGlvbiIsInVwZGF0ZUNoaWxkUG9zaXRpb24iLCJjb250ZW50IiwicHJvcHMiLCJzdHlsZSIsImNoaWxkcmVuIiwiUmVhY3RET00iLCJyZW5kZXIiLCJ2aXNpYmxlIiwiZGlzcGxheSIsInBhcmVudCIsInBhcmVudFJlY3QiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJPYmplY3QiLCJhc3NpZ24iLCJwb3NpdGlvbiIsInRvcCIsImxlZnQiLCJ3aWR0aCIsImhlaWdodCIsIlByb3BUeXBlcyIsInN0cmluZyIsImlzUmVxdWlyZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQXRCQTs7Ozs7Ozs7Ozs7Ozs7O0FBd0JBO0FBQ0E7QUFDQTtBQUVBLFNBQVNBLFlBQVQsQ0FBc0JDLFdBQXRCLEVBQW1DO0FBQy9CLFNBQU9DLFFBQVEsQ0FBQ0MsY0FBVCxDQUF3QkYsV0FBeEIsQ0FBUDtBQUNIOztBQUVELFNBQVNHLG9CQUFULENBQThCSCxXQUE5QixFQUEyQztBQUN2QyxNQUFJSSxTQUFTLEdBQUdMLFlBQVksQ0FBQ0MsV0FBRCxDQUE1Qjs7QUFFQSxNQUFJLENBQUNJLFNBQUwsRUFBZ0I7QUFDWkEsSUFBQUEsU0FBUyxHQUFHSCxRQUFRLENBQUNJLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBWjtBQUNBRCxJQUFBQSxTQUFTLENBQUNFLEVBQVYsR0FBZU4sV0FBZjtBQUNBQyxJQUFBQSxRQUFRLENBQUNNLElBQVQsQ0FBY0MsV0FBZCxDQUEwQkosU0FBMUI7QUFDSDs7QUFFRCxTQUFPQSxTQUFQO0FBQ0g7QUFFRDs7Ozs7Ozs7Ozs7OztBQVdlLE1BQU1LLGdCQUFOLFNBQStCQyxlQUFNQyxTQUFyQyxDQUErQztBQVExREMsRUFBQUEsV0FBVyxHQUFHO0FBQ1Y7QUFDQSxTQUFLQyxxQkFBTCxHQUE2QixLQUFLQSxxQkFBTCxDQUEyQkMsSUFBM0IsQ0FBZ0MsSUFBaEMsQ0FBN0I7QUFDQSxTQUFLQyxZQUFMLEdBQW9CLEtBQUtBLFlBQUwsQ0FBa0JELElBQWxCLENBQXVCLElBQXZCLENBQXBCO0FBQ0EsU0FBS0UsZ0JBQUwsR0FBd0IsS0FBS0EsZ0JBQUwsQ0FBc0JGLElBQXRCLENBQTJCLElBQTNCLENBQXhCO0FBQ0EsU0FBS0csU0FBTCxHQUFpQixLQUFLQSxTQUFMLENBQWVILElBQWYsQ0FBb0IsSUFBcEIsQ0FBakI7QUFF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QVosR0FBc0JELE9BQU8sR0FBRyxPQUFILEdBQWEsTUFBMUM7QUFDSDs7QUFFRFAsRUFBQUEsbUJBQW1CLENBQUNaLEtBQUQsRUFBUXFCLE1BQVIsRUFBZ0I7QUFDL0IsUUFBSSxDQUFDckIsS0FBRCxJQUFVLENBQUNxQixNQUFmLEVBQXVCO0FBRXZCLFVBQU1DLFVBQVUsR0FBR0QsTUFBTSxDQUFDRSxxQkFBUCxFQUFuQjtBQUNBQyxJQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY3pCLEtBQUssQ0FBQ2UsS0FBcEIsRUFBMkI7QUFDdkJXLE1BQUFBLFFBQVEsRUFBRSxVQURhO0FBRXZCQyxNQUFBQSxHQUFHLEVBQUVMLFVBQVUsQ0FBQ0ssR0FBWCxHQUFpQixJQUZDO0FBR3ZCQyxNQUFBQSxJQUFJLEVBQUVOLFVBQVUsQ0FBQ00sSUFBWCxHQUFrQixJQUhEO0FBSXZCQyxNQUFBQSxLQUFLLEVBQUVQLFVBQVUsQ0FBQ08sS0FBWCxHQUFtQixJQUpIO0FBS3ZCQyxNQUFBQSxNQUFNLEVBQUVSLFVBQVUsQ0FBQ1EsTUFBWCxHQUFvQjtBQUxMLEtBQTNCO0FBT0g7O0FBRURaLEVBQUFBLE1BQU0sR0FBRztBQUNMLHdCQUFPO0FBQUssTUFBQSxHQUFHLEVBQUUsS0FBS3ZDO0FBQWYsTUFBUDtBQUNIOztBQXRIeUQ7Ozs4QkFBekNKLGdCLGVBQ0U7QUFDZjtBQUNBO0FBQ0E7QUFDQWlCLEVBQUFBLFVBQVUsRUFBRXVDLG1CQUFVQyxNQUFWLENBQWlCQztBQUpkLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTggTmV3IFZlY3RvciBMdGQuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcblxuaW1wb3J0IFJlc2l6ZU9ic2VydmVyIGZyb20gJ3Jlc2l6ZS1vYnNlcnZlci1wb2x5ZmlsbCc7XG5cbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcblxuLy8gU2hhbWVsZXNzbHkgcmlwcGVkIG9mZiBNb2RhbC5qcy4gIFRoZXJlJ3MgcHJvYmFibHkgYSBiZXR0ZXIgd2F5XG4vLyBvZiBkb2luZyByZXVzYWJsZSB3aWRnZXRzIGxpa2UgZGlhbG9nIGJveGVzICYgbWVudXMgd2hlcmUgd2UgZ28gYW5kXG4vLyBwYXNzIGluIGEgY3VzdG9tIGNvbnRyb2wgYXMgdGhlIGFjdHVhbCBib2R5LlxuXG5mdW5jdGlvbiBnZXRDb250YWluZXIoY29udGFpbmVySWQpIHtcbiAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGFpbmVySWQpO1xufVxuXG5mdW5jdGlvbiBnZXRPckNyZWF0ZUNvbnRhaW5lcihjb250YWluZXJJZCkge1xuICAgIGxldCBjb250YWluZXIgPSBnZXRDb250YWluZXIoY29udGFpbmVySWQpO1xuXG4gICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgY29udGFpbmVyLmlkID0gY29udGFpbmVySWQ7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29udGFpbmVyO1xufVxuXG4vKlxuICogQ2xhc3Mgb2YgY29tcG9uZW50IHRoYXQgcmVuZGVycyBpdHMgY2hpbGRyZW4gaW4gYSBzZXBhcmF0ZSBSZWFjdERPTSB2aXJ0dWFsIHRyZWVcbiAqIGluIGEgY29udGFpbmVyIGVsZW1lbnQgYXBwZW5kZWQgdG8gZG9jdW1lbnQuYm9keS5cbiAqXG4gKiBUaGlzIHByZXZlbnRzIHRoZSBjaGlsZHJlbiBmcm9tIGJlaW5nIHVubW91bnRlZCB3aGVuIHRoZSBwYXJlbnQgb2YgUGVyc2lzdGVkRWxlbWVudFxuICogdW5tb3VudHMsIGFsbG93aW5nIHRoZW0gdG8gcGVyc2lzdC5cbiAqXG4gKiBXaGVuIFBFIGlzIHVubW91bnRlZCwgaXQgaGlkZXMgdGhlIGNoaWxkcmVuIHVzaW5nIENTUy4gV2hlbiBtb3VudGVkIG9yIHVwZGF0ZWQsIHRoZVxuICogY2hpbGRyZW4gYXJlIG1hZGUgdmlzaWJsZSBhbmQgYXJlIHBvc2l0aW9uZWQgaW50byBhIGRpdiB0aGF0IGlzIGdpdmVuIHRoZSBzYW1lXG4gKiBib3VuZGluZyByZWN0IGFzIHRoZSBwYXJlbnQgb2YgUEUuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBlcnNpc3RlZEVsZW1lbnQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgICAgIC8vIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIFBlcnNpc3RlZEVsZW1lbnQgaW5zdGFuY2VcbiAgICAgICAgLy8gQW55IFBlcnNpc3RlZEVsZW1lbnRzIHdpdGggdGhlIHNhbWUgcGVyc2lzdEtleSB3aWxsIHVzZVxuICAgICAgICAvLyB0aGUgc2FtZSBET00gY29udGFpbmVyLlxuICAgICAgICBwZXJzaXN0S2V5OiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmNvbGxlY3RDaGlsZENvbnRhaW5lciA9IHRoaXMuY29sbGVjdENoaWxkQ29udGFpbmVyLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuY29sbGVjdENoaWxkID0gdGhpcy5jb2xsZWN0Q2hpbGQuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5fcmVwb3NpdGlvbkNoaWxkID0gdGhpcy5fcmVwb3NpdGlvbkNoaWxkLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuX29uQWN0aW9uID0gdGhpcy5fb25BY3Rpb24uYmluZCh0aGlzKTtcblxuICAgICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKHRoaXMuX3JlcG9zaXRpb25DaGlsZCk7XG4gICAgICAgIC8vIEFubm95aW5nbHksIGEgcmVzaXplIG9ic2VydmVyIGlzIGluc3VmZmljaWVudCwgc2luY2Ugd2UgYWxzbyBjYXJlXG4gICAgICAgIC8vIGFib3V0IHdoZW4gdGhlIGVsZW1lbnQgbW92ZXMgb24gdGhlIHNjcmVlbiB3aXRob3V0IGNoYW5naW5nIGl0c1xuICAgICAgICAvLyBkaW1lbnNpb25zLiBEb2Vzbid0IGxvb2sgbGlrZSB0aGVyZSdzIGEgUmVzaXplT2JzZXJ2ZXIgZXF1aXZhbGVudFxuICAgICAgICAvLyBmb3IgdGhpcywgc28gd2UgYm9kZ2UgaXQgYnkgbGlzdGVuaW5nIGZvciBkb2N1bWVudCByZXNpemUgYW5kXG4gICAgICAgIC8vIHRoZSB0aW1lbGluZV9yZXNpemUgYWN0aW9uLlxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5fcmVwb3NpdGlvbkNoaWxkKTtcbiAgICAgICAgdGhpcy5fZGlzcGF0Y2hlclJlZiA9IGRpcy5yZWdpc3Rlcih0aGlzLl9vbkFjdGlvbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyB0aGUgRE9NIGVsZW1lbnRzIGNyZWF0ZWQgd2hlbiBhIFBlcnNpc3RlZEVsZW1lbnQgd2l0aCB0aGUgZ2l2ZW5cbiAgICAgKiBwZXJzaXN0S2V5IHdhcyBtb3VudGVkLiBUaGUgRE9NIGVsZW1lbnRzIHdpbGwgYmUgcmUtYWRkZWQgaWYgYW5vdGhlclxuICAgICAqIFBlcmlzdGVkRWxlbWVudCBpcyBtb3VudGVkIGluIHRoZSBmdXR1cmUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGVyc2lzdEtleSBLZXkgdXNlZCB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIFBlcnNpc3RlZEVsZW1lbnRcbiAgICAgKi9cbiAgICBzdGF0aWMgZGVzdHJveUVsZW1lbnQocGVyc2lzdEtleSkge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSBnZXRDb250YWluZXIoJ214X3BlcnNpc3RlZEVsZW1lbnRfJyArIHBlcnNpc3RLZXkpO1xuICAgICAgICBpZiAoY29udGFpbmVyKSB7XG4gICAgICAgICAgICBjb250YWluZXIucmVtb3ZlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgaXNNb3VudGVkKHBlcnNpc3RLZXkpIHtcbiAgICAgICAgcmV0dXJuIEJvb2xlYW4oZ2V0Q29udGFpbmVyKCdteF9wZXJzaXN0ZWRFbGVtZW50XycgKyBwZXJzaXN0S2V5KSk7XG4gICAgfVxuXG4gICAgY29sbGVjdENoaWxkQ29udGFpbmVyKHJlZikge1xuICAgICAgICBpZiAodGhpcy5jaGlsZENvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlci51bm9ic2VydmUodGhpcy5jaGlsZENvbnRhaW5lcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGlsZENvbnRhaW5lciA9IHJlZjtcbiAgICAgICAgaWYgKHJlZikge1xuICAgICAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlci5vYnNlcnZlKHJlZik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb2xsZWN0Q2hpbGQocmVmKSB7XG4gICAgICAgIHRoaXMuY2hpbGQgPSByZWY7XG4gICAgICAgIHRoaXMudXBkYXRlQ2hpbGQoKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDaGlsZCgpO1xuICAgICAgICB0aGlzLnJlbmRlckFwcCgpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDaGlsZCgpO1xuICAgICAgICB0aGlzLnJlbmRlckFwcCgpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLnVwZGF0ZUNoaWxkVmlzaWJpbGl0eSh0aGlzLmNoaWxkLCBmYWxzZSk7XG4gICAgICAgIHRoaXMucmVzaXplT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5fcmVwb3NpdGlvbkNoaWxkKTtcbiAgICAgICAgZGlzLnVucmVnaXN0ZXIodGhpcy5fZGlzcGF0Y2hlclJlZik7XG4gICAgfVxuXG4gICAgX29uQWN0aW9uKHBheWxvYWQpIHtcbiAgICAgICAgaWYgKHBheWxvYWQuYWN0aW9uID09PSAndGltZWxpbmVfcmVzaXplJykge1xuICAgICAgICAgICAgdGhpcy5fcmVwb3NpdGlvbkNoaWxkKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcmVwb3NpdGlvbkNoaWxkKCkge1xuICAgICAgICB0aGlzLnVwZGF0ZUNoaWxkUG9zaXRpb24odGhpcy5jaGlsZCwgdGhpcy5jaGlsZENvbnRhaW5lcik7XG4gICAgfVxuXG4gICAgdXBkYXRlQ2hpbGQoKSB7XG4gICAgICAgIHRoaXMudXBkYXRlQ2hpbGRQb3NpdGlvbih0aGlzLmNoaWxkLCB0aGlzLmNoaWxkQ29udGFpbmVyKTtcbiAgICAgICAgdGhpcy51cGRhdGVDaGlsZFZpc2liaWxpdHkodGhpcy5jaGlsZCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgcmVuZGVyQXBwKCkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gPGRpdiByZWY9e3RoaXMuY29sbGVjdENoaWxkfSBzdHlsZT17dGhpcy5wcm9wcy5zdHlsZX0+XG4gICAgICAgICAgICB7dGhpcy5wcm9wcy5jaGlsZHJlbn1cbiAgICAgICAgPC9kaXY+O1xuXG4gICAgICAgIFJlYWN0RE9NLnJlbmRlcihjb250ZW50LCBnZXRPckNyZWF0ZUNvbnRhaW5lcignbXhfcGVyc2lzdGVkRWxlbWVudF8nK3RoaXMucHJvcHMucGVyc2lzdEtleSkpO1xuICAgIH1cblxuICAgIHVwZGF0ZUNoaWxkVmlzaWJpbGl0eShjaGlsZCwgdmlzaWJsZSkge1xuICAgICAgICBpZiAoIWNoaWxkKSByZXR1cm47XG4gICAgICAgIGNoaWxkLnN0eWxlLmRpc3BsYXkgPSB2aXNpYmxlID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICB9XG5cbiAgICB1cGRhdGVDaGlsZFBvc2l0aW9uKGNoaWxkLCBwYXJlbnQpIHtcbiAgICAgICAgaWYgKCFjaGlsZCB8fCAhcGFyZW50KSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgcGFyZW50UmVjdCA9IHBhcmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjaGlsZC5zdHlsZSwge1xuICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICB0b3A6IHBhcmVudFJlY3QudG9wICsgJ3B4JyxcbiAgICAgICAgICAgIGxlZnQ6IHBhcmVudFJlY3QubGVmdCArICdweCcsXG4gICAgICAgICAgICB3aWR0aDogcGFyZW50UmVjdC53aWR0aCArICdweCcsXG4gICAgICAgICAgICBoZWlnaHQ6IHBhcmVudFJlY3QuaGVpZ2h0ICsgJ3B4JyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICByZXR1cm4gPGRpdiByZWY9e3RoaXMuY29sbGVjdENoaWxkQ29udGFpbmVyfT48L2Rpdj47XG4gICAgfVxufVxuIl19