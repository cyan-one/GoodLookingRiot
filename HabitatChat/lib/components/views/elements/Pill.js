"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var sdk = _interopRequireWildcard(require("../../../index"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _classnames = _interopRequireDefault(require("classnames"));

var _matrixJsSdk = require("matrix-js-sdk");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _FlairStore = _interopRequireDefault(require("../../../stores/FlairStore"));

var _Permalinks = require("../../../utils/permalinks/Permalinks");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _actions = require("../../../dispatcher/actions");

/*
Copyright 2017 Vector Creations Ltd
Copyright 2018 New Vector Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// For URLs of matrix.to links in the timeline which have been reformatted by
// HttpUtils transformTags to relative links. This excludes event URLs (with `[^\/]*`)
const REGEX_LOCAL_PERMALINK = /^#\/(?:user|room|group)\/(([#!@+])[^/]*)$/;
const Pill = (0, _createReactClass.default)({
  displayName: "Pill",
  statics: {
    isPillUrl: url => {
      return !!(0, _Permalinks.getPrimaryPermalinkEntity)(url);
    },
    isMessagePillUrl: url => {
      return !!REGEX_LOCAL_PERMALINK.exec(url);
    },
    roomNotifPos: text => {
      return text.indexOf("@room");
    },
    roomNotifLen: () => {
      return "@room".length;
    },
    TYPE_USER_MENTION: 'TYPE_USER_MENTION',
    TYPE_ROOM_MENTION: 'TYPE_ROOM_MENTION',
    TYPE_GROUP_MENTION: 'TYPE_GROUP_MENTION',
    TYPE_AT_ROOM_MENTION: 'TYPE_AT_ROOM_MENTION' // '@room' mention

  },
  props: {
    // The Type of this Pill. If url is given, this is auto-detected.
    type: _propTypes.default.string,
    // The URL to pillify (no validation is done, see isPillUrl and isMessagePillUrl)
    url: _propTypes.default.string,
    // Whether the pill is in a message
    inMessage: _propTypes.default.bool,
    // The room in which this pill is being rendered
    room: _propTypes.default.instanceOf(_matrixJsSdk.Room),
    // Whether to include an avatar in the pill
    shouldShowPillAvatar: _propTypes.default.bool,
    // Whether to render this pill as if it were highlit by a selection
    isSelected: _propTypes.default.bool
  },

  getInitialState() {
    return {
      // ID/alias of the room/user
      resourceId: null,
      // Type of pill
      pillType: null,
      // The member related to the user pill
      member: null,
      // The group related to the group pill
      group: null,
      // The room related to the room pill
      room: null
    };
  },

  // TODO: [REACT-WARNING] Replace with appropriate lifecycle event
  async UNSAFE_componentWillReceiveProps(nextProps) {
    let resourceId;
    let prefix;

    if (nextProps.url) {
      if (nextProps.inMessage) {
        // Default to the empty array if no match for simplicity
        // resource and prefix will be undefined instead of throwing
        const matrixToMatch = REGEX_LOCAL_PERMALINK.exec(nextProps.url) || [];
        resourceId = matrixToMatch[1]; // The room/user ID

        prefix = matrixToMatch[2]; // The first character of prefix
      } else {
        resourceId = (0, _Permalinks.getPrimaryPermalinkEntity)(nextProps.url);
        prefix = resourceId ? resourceId[0] : undefined;
      }
    }

    const pillType = this.props.type || {
      '@': Pill.TYPE_USER_MENTION,
      '#': Pill.TYPE_ROOM_MENTION,
      '!': Pill.TYPE_ROOM_MENTION,
      '+': Pill.TYPE_GROUP_MENTION
    }[prefix];
    let member;
    let group;
    let room;

    switch (pillType) {
      case Pill.TYPE_AT_ROOM_MENTION:
        {
          room = nextProps.room;
        }
        break;

      case Pill.TYPE_USER_MENTION:
        {
          const localMember = nextProps.room ? nextProps.room.getMember(resourceId) : undefined;
          member = localMember;

          if (!localMember) {
            member = new _matrixJsSdk.RoomMember(null, resourceId);
            this.doProfileLookup(resourceId, member);
          }
        }
        break;

      case Pill.TYPE_ROOM_MENTION:
        {
          const localRoom = resourceId[0] === '#' ? _MatrixClientPeg.MatrixClientPeg.get().getRooms().find(r => {
            return r.getCanonicalAlias() === resourceId || r.getAltAliases().includes(resourceId);
          }) : _MatrixClientPeg.MatrixClientPeg.get().getRoom(resourceId);
          room = localRoom;

          if (!localRoom) {// TODO: This would require a new API to resolve a room alias to
            // a room avatar and name.
            // this.doRoomProfileLookup(resourceId, member);
          }
        }
        break;

      case Pill.TYPE_GROUP_MENTION:
        {
          const cli = _MatrixClientPeg.MatrixClientPeg.get();

          try {
            group = await _FlairStore.default.getGroupProfileCached(cli, resourceId);
          } catch (e) {
            // if FlairStore failed, fall back to just groupId
            group = {
              groupId: resourceId,
              avatarUrl: null,
              name: null
            };
          }
        }
    }

    this.setState({
      resourceId,
      pillType,
      member,
      group,
      room
    });
  },

  componentDidMount() {
    this._unmounted = false;
    this._matrixClient = _MatrixClientPeg.MatrixClientPeg.get(); // eslint-disable-next-line new-cap

    this.UNSAFE_componentWillReceiveProps(this.props); // HACK: We shouldn't be calling lifecycle functions ourselves.
  },

  componentWillUnmount() {
    this._unmounted = true;
  },

  doProfileLookup: function (userId, member) {
    _MatrixClientPeg.MatrixClientPeg.get().getProfileInfo(userId).then(resp => {
      if (this._unmounted) {
        return;
      }

      member.name = resp.displayname;
      member.rawDisplayName = resp.displayname;
      member.events.member = {
        getContent: () => {
          return {
            avatar_url: resp.avatar_url
          };
        },
        getDirectionalContent: function () {
          return this.getContent();
        }
      };
      this.setState({
        member
      });
    }).catch(err => {
      console.error('Could not retrieve profile data for ' + userId + ':', err);
    });
  },
  onUserPillClicked: function () {
    _dispatcher.default.dispatch({
      action: _actions.Action.ViewUser,
      member: this.state.member
    });
  },
  render: function () {
    const BaseAvatar = sdk.getComponent('views.avatars.BaseAvatar');
    const MemberAvatar = sdk.getComponent('avatars.MemberAvatar');
    const RoomAvatar = sdk.getComponent('avatars.RoomAvatar');
    const resource = this.state.resourceId;
    let avatar = null;
    let linkText = resource;
    let pillClass;
    let userId;
    let href = this.props.url;
    let onClick;

    switch (this.state.pillType) {
      case Pill.TYPE_AT_ROOM_MENTION:
        {
          const room = this.props.room;

          if (room) {
            linkText = "@room";

            if (this.props.shouldShowPillAvatar) {
              avatar = /*#__PURE__*/_react.default.createElement(RoomAvatar, {
                room: room,
                width: 16,
                height: 16,
                "aria-hidden": "true"
              });
            }

            pillClass = 'mx_AtRoomPill';
          }
        }
        break;

      case Pill.TYPE_USER_MENTION:
        {
          // If this user is not a member of this room, default to the empty member
          const member = this.state.member;

          if (member) {
            userId = member.userId;
            member.rawDisplayName = member.rawDisplayName || '';
            linkText = member.rawDisplayName;

            if (this.props.shouldShowPillAvatar) {
              avatar = /*#__PURE__*/_react.default.createElement(MemberAvatar, {
                member: member,
                width: 16,
                height: 16,
                "aria-hidden": "true"
              });
            }

            pillClass = 'mx_UserPill';
            href = null;
            onClick = this.onUserPillClicked;
          }
        }
        break;

      case Pill.TYPE_ROOM_MENTION:
        {
          const room = this.state.room;

          if (room) {
            linkText = resource;

            if (this.props.shouldShowPillAvatar) {
              avatar = /*#__PURE__*/_react.default.createElement(RoomAvatar, {
                room: room,
                width: 16,
                height: 16,
                "aria-hidden": "true"
              });
            }
          }

          pillClass = 'mx_RoomPill';
        }
        break;

      case Pill.TYPE_GROUP_MENTION:
        {
          if (this.state.group) {
            const {
              avatarUrl,
              groupId,
              name
            } = this.state.group;

            const cli = _MatrixClientPeg.MatrixClientPeg.get();

            linkText = groupId;

            if (this.props.shouldShowPillAvatar) {
              avatar = /*#__PURE__*/_react.default.createElement(BaseAvatar, {
                name: name || groupId,
                width: 16,
                height: 16,
                "aria-hidden": "true",
                url: avatarUrl ? cli.mxcUrlToHttp(avatarUrl, 16, 16) : null
              });
            }

            pillClass = 'mx_GroupPill';
          }
        }
        break;
    }

    const classes = (0, _classnames.default)("mx_Pill", pillClass, {
      "mx_UserPill_me": userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId(),
      "mx_UserPill_selected": this.props.isSelected
    });

    if (this.state.pillType) {
      return /*#__PURE__*/_react.default.createElement(_MatrixClientContext.default.Provider, {
        value: this._matrixClient
      }, this.props.inMessage ? /*#__PURE__*/_react.default.createElement("a", {
        className: classes,
        href: href,
        onClick: onClick,
        title: resource,
        "data-offset-key": this.props.offsetKey
      }, avatar, linkText) : /*#__PURE__*/_react.default.createElement("span", {
        className: classes,
        title: resource,
        "data-offset-key": this.props.offsetKey
      }, avatar, linkText));
    } else {
      // Deliberately render nothing if the URL isn't recognised
      return null;
    }
  }
});
var _default = Pill;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2VsZW1lbnRzL1BpbGwuanMiXSwibmFtZXMiOlsiUkVHRVhfTE9DQUxfUEVSTUFMSU5LIiwiUGlsbCIsInN0YXRpY3MiLCJpc1BpbGxVcmwiLCJ1cmwiLCJpc01lc3NhZ2VQaWxsVXJsIiwiZXhlYyIsInJvb21Ob3RpZlBvcyIsInRleHQiLCJpbmRleE9mIiwicm9vbU5vdGlmTGVuIiwibGVuZ3RoIiwiVFlQRV9VU0VSX01FTlRJT04iLCJUWVBFX1JPT01fTUVOVElPTiIsIlRZUEVfR1JPVVBfTUVOVElPTiIsIlRZUEVfQVRfUk9PTV9NRU5USU9OIiwicHJvcHMiLCJ0eXBlIiwiUHJvcFR5cGVzIiwic3RyaW5nIiwiaW5NZXNzYWdlIiwiYm9vbCIsInJvb20iLCJpbnN0YW5jZU9mIiwiUm9vbSIsInNob3VsZFNob3dQaWxsQXZhdGFyIiwiaXNTZWxlY3RlZCIsImdldEluaXRpYWxTdGF0ZSIsInJlc291cmNlSWQiLCJwaWxsVHlwZSIsIm1lbWJlciIsImdyb3VwIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXh0UHJvcHMiLCJwcmVmaXgiLCJtYXRyaXhUb01hdGNoIiwidW5kZWZpbmVkIiwibG9jYWxNZW1iZXIiLCJnZXRNZW1iZXIiLCJSb29tTWVtYmVyIiwiZG9Qcm9maWxlTG9va3VwIiwibG9jYWxSb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbXMiLCJmaW5kIiwiciIsImdldENhbm9uaWNhbEFsaWFzIiwiZ2V0QWx0QWxpYXNlcyIsImluY2x1ZGVzIiwiZ2V0Um9vbSIsImNsaSIsIkZsYWlyU3RvcmUiLCJnZXRHcm91cFByb2ZpbGVDYWNoZWQiLCJlIiwiZ3JvdXBJZCIsImF2YXRhclVybCIsIm5hbWUiLCJzZXRTdGF0ZSIsImNvbXBvbmVudERpZE1vdW50IiwiX3VubW91bnRlZCIsIl9tYXRyaXhDbGllbnQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInVzZXJJZCIsImdldFByb2ZpbGVJbmZvIiwidGhlbiIsInJlc3AiLCJkaXNwbGF5bmFtZSIsInJhd0Rpc3BsYXlOYW1lIiwiZXZlbnRzIiwiZ2V0Q29udGVudCIsImF2YXRhcl91cmwiLCJnZXREaXJlY3Rpb25hbENvbnRlbnQiLCJjYXRjaCIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIm9uVXNlclBpbGxDbGlja2VkIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJWaWV3VXNlciIsInN0YXRlIiwicmVuZGVyIiwiQmFzZUF2YXRhciIsInNkayIsImdldENvbXBvbmVudCIsIk1lbWJlckF2YXRhciIsIlJvb21BdmF0YXIiLCJyZXNvdXJjZSIsImF2YXRhciIsImxpbmtUZXh0IiwicGlsbENsYXNzIiwiaHJlZiIsIm9uQ2xpY2siLCJteGNVcmxUb0h0dHAiLCJjbGFzc2VzIiwiZ2V0VXNlcklkIiwib2Zmc2V0S2V5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUE1QkE7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBOEJBO0FBQ0E7QUFDQSxNQUFNQSxxQkFBcUIsR0FBRywyQ0FBOUI7QUFFQSxNQUFNQyxJQUFJLEdBQUcsK0JBQWlCO0FBQUE7QUFDMUJDLEVBQUFBLE9BQU8sRUFBRTtBQUNMQyxJQUFBQSxTQUFTLEVBQUdDLEdBQUQsSUFBUztBQUNoQixhQUFPLENBQUMsQ0FBQywyQ0FBMEJBLEdBQTFCLENBQVQ7QUFDSCxLQUhJO0FBSUxDLElBQUFBLGdCQUFnQixFQUFHRCxHQUFELElBQVM7QUFDdkIsYUFBTyxDQUFDLENBQUNKLHFCQUFxQixDQUFDTSxJQUF0QixDQUEyQkYsR0FBM0IsQ0FBVDtBQUNILEtBTkk7QUFPTEcsSUFBQUEsWUFBWSxFQUFHQyxJQUFELElBQVU7QUFDcEIsYUFBT0EsSUFBSSxDQUFDQyxPQUFMLENBQWEsT0FBYixDQUFQO0FB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S0FBTCxDQUFXVTtBQUZVLEtBQWpDLENBQWhCOztBQUtBLFFBQUksS0FBS3lELEtBQUwsQ0FBV3RELFFBQWYsRUFBeUI7QUFDckIsMEJBQU8sNkJBQUMsNEJBQUQsQ0FBcUIsUUFBckI7QUFBOEIsUUFBQSxLQUFLLEVBQUUsS0FBS2dDO0FBQTFDLFNBQ0QsS0FBSzdDLEtBQUwsQ0FBV0ksU0FBWCxnQkFDRTtBQUFHLFFBQUEsU0FBUyxFQUFFNkUsT0FBZDtBQUF1QixRQUFBLElBQUksRUFBRUgsSUFBN0I7QUFBbUMsUUFBQSxPQUFPLEVBQUVDLE9BQTVDO0FBQXFELFFBQUEsS0FBSyxFQUFFTCxRQUE1RDtBQUFzRSwyQkFBaUIsS0FBSzFFLEtBQUwsQ0FBV21GO0FBQWxHLFNBQ01SLE1BRE4sRUFFTUMsUUFGTixDQURGLGdCQUtFO0FBQU0sUUFBQSxTQUFTLEVBQUVLLE9BQWpCO0FBQTBCLFFBQUEsS0FBSyxFQUFFUCxRQUFqQztBQUEyQywyQkFBaUIsS0FBSzFFLEtBQUwsQ0FBV21GO0FBQXZFLFNBQ01SLE1BRE4sRUFFTUMsUUFGTixDQU5ELENBQVA7QUFXSCxLQVpELE1BWU87QUFDSDtBQUNBLGFBQU8sSUFBUDtBQUNIO0FBQ0o7QUE3UHlCLENBQWpCLENBQWI7ZUFnUWUzRixJIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5Db3B5cmlnaHQgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vLi4vaW5kZXgnO1xuaW1wb3J0IGRpcyBmcm9tICcuLi8uLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBSb29tLCBSb29tTWVtYmVyIH0gZnJvbSAnbWF0cml4LWpzLXNkayc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHtNYXRyaXhDbGllbnRQZWd9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgRmxhaXJTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL0ZsYWlyU3RvcmVcIjtcbmltcG9ydCB7Z2V0UHJpbWFyeVBlcm1hbGlua0VudGl0eX0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3Blcm1hbGlua3MvUGVybWFsaW5rc1wiO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCB7QWN0aW9ufSBmcm9tIFwiLi4vLi4vLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5cbi8vIEZvciBVUkxzIG9mIG1hdHJpeC50byBsaW5rcyBpbiB0aGUgdGltZWxpbmUgd2hpY2ggaGF2ZSBiZWVuIHJlZm9ybWF0dGVkIGJ5XG4vLyBIdHRwVXRpbHMgdHJhbnNmb3JtVGFncyB0byByZWxhdGl2ZSBsaW5rcy4gVGhpcyBleGNsdWRlcyBldmVudCBVUkxzICh3aXRoIGBbXlxcL10qYClcbmNvbnN0IFJFR0VYX0xPQ0FMX1BFUk1BTElOSyA9IC9eI1xcLyg/OnVzZXJ8cm9vbXxncm91cClcXC8oKFsjIUArXSlbXi9dKikkLztcblxuY29uc3QgUGlsbCA9IGNyZWF0ZVJlYWN0Q2xhc3Moe1xuICAgIHN0YXRpY3M6IHtcbiAgICAgICAgaXNQaWxsVXJsOiAodXJsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gISFnZXRQcmltYXJ5UGVybWFsaW5rRW50aXR5KHVybCk7XG4gICAgICAgIH0sXG4gICAgICAgIGlzTWVzc2FnZVBpbGxVcmw6ICh1cmwpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAhIVJFR0VYX0xPQ0FMX1BFUk1BTElOSy5leGVjKHVybCk7XG4gICAgICAgIH0sXG4gICAgICAgIHJvb21Ob3RpZlBvczogKHRleHQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0LmluZGV4T2YoXCJAcm9vbVwiKTtcbiAgICAgICAgfSxcbiAgICAgICAgcm9vbU5vdGlmTGVuOiAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gXCJAcm9vbVwiLmxlbmd0aDtcbiAgICAgICAgfSxcbiAgICAgICAgVFlQRV9VU0VSX01FTlRJT046ICdUWVBFX1VTRVJfTUVOVElPTicsXG4gICAgICAgIFRZUEVfUk9PTV9NRU5USU9OOiAnVFlQRV9ST09NX01FTlRJT04nLFxuICAgICAgICBUWVBFX0dST1VQX01FTlRJT046ICdUWVBFX0dST1VQX01FTlRJT04nLFxuICAgICAgICBUWVBFX0FUX1JPT01fTUVOVElPTjogJ1RZUEVfQVRfUk9PTV9NRU5USU9OJywgLy8gJ0Byb29tJyBtZW50aW9uXG4gICAgfSxcblxuICAgIHByb3BzOiB7XG4gICAgICAgIC8vIFRoZSBUeXBlIG9mIHRoaXMgUGlsbC4gSWYgdXJsIGlzIGdpdmVuLCB0aGlzIGlzIGF1dG8tZGV0ZWN0ZWQuXG4gICAgICAgIHR5cGU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIC8vIFRoZSBVUkwgdG8gcGlsbGlmeSAobm8gdmFsaWRhdGlvbiBpcyBkb25lLCBzZWUgaXNQaWxsVXJsIGFuZCBpc01lc3NhZ2VQaWxsVXJsKVxuICAgICAgICB1cmw6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIC8vIFdoZXRoZXIgdGhlIHBpbGwgaXMgaW4gYSBtZXNzYWdlXG4gICAgICAgIGluTWVzc2FnZTogUHJvcFR5cGVzLmJvb2wsXG4gICAgICAgIC8vIFRoZSByb29tIGluIHdoaWNoIHRoaXMgcGlsbCBpcyBiZWluZyByZW5kZXJlZFxuICAgICAgICByb29tOiBQcm9wVHlwZXMuaW5zdGFuY2VPZihSb29tKSxcbiAgICAgICAgLy8gV2hldGhlciB0byBpbmNsdWRlIGFuIGF2YXRhciBpbiB0aGUgcGlsbFxuICAgICAgICBzaG91bGRTaG93UGlsbEF2YXRhcjogUHJvcFR5cGVzLmJvb2wsXG4gICAgICAgIC8vIFdoZXRoZXIgdG8gcmVuZGVyIHRoaXMgcGlsbCBhcyBpZiBpdCB3ZXJlIGhpZ2hsaXQgYnkgYSBzZWxlY3Rpb25cbiAgICAgICAgaXNTZWxlY3RlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgfSxcblxuICAgIGdldEluaXRpYWxTdGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC8vIElEL2FsaWFzIG9mIHRoZSByb29tL3VzZXJcbiAgICAgICAgICAgIHJlc291cmNlSWQ6IG51bGwsXG4gICAgICAgICAgICAvLyBUeXBlIG9mIHBpbGxcbiAgICAgICAgICAgIHBpbGxUeXBlOiBudWxsLFxuXG4gICAgICAgICAgICAvLyBUaGUgbWVtYmVyIHJlbGF0ZWQgdG8gdGhlIHVzZXIgcGlsbFxuICAgICAgICAgICAgbWVtYmVyOiBudWxsLFxuICAgICAgICAgICAgLy8gVGhlIGdyb3VwIHJlbGF0ZWQgdG8gdGhlIGdyb3VwIHBpbGxcbiAgICAgICAgICAgIGdyb3VwOiBudWxsLFxuICAgICAgICAgICAgLy8gVGhlIHJvb20gcmVsYXRlZCB0byB0aGUgcm9vbSBwaWxsXG4gICAgICAgICAgICByb29tOiBudWxsLFxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICAvLyBUT0RPOiBbUkVBQ1QtV0FSTklOR10gUmVwbGFjZSB3aXRoIGFwcHJvcHJpYXRlIGxpZmVjeWNsZSBldmVudFxuICAgIGFzeW5jIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykge1xuICAgICAgICBsZXQgcmVzb3VyY2VJZDtcbiAgICAgICAgbGV0IHByZWZpeDtcblxuICAgICAgICBpZiAobmV4dFByb3BzLnVybCkge1xuICAgICAgICAgICAgaWYgKG5leHRQcm9wcy5pbk1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHRvIHRoZSBlbXB0eSBhcnJheSBpZiBubyBtYXRjaCBmb3Igc2ltcGxpY2l0eVxuICAgICAgICAgICAgICAgIC8vIHJlc291cmNlIGFuZCBwcmVmaXggd2lsbCBiZSB1bmRlZmluZWQgaW5zdGVhZCBvZiB0aHJvd2luZ1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdHJpeFRvTWF0Y2ggPSBSRUdFWF9MT0NBTF9QRVJNQUxJTksuZXhlYyhuZXh0UHJvcHMudXJsKSB8fCBbXTtcblxuICAgICAgICAgICAgICAgIHJlc291cmNlSWQgPSBtYXRyaXhUb01hdGNoWzFdOyAvLyBUaGUgcm9vbS91c2VyIElEXG4gICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0cml4VG9NYXRjaFsyXTsgLy8gVGhlIGZpcnN0IGNoYXJhY3RlciBvZiBwcmVmaXhcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb3VyY2VJZCA9IGdldFByaW1hcnlQZXJtYWxpbmtFbnRpdHkobmV4dFByb3BzLnVybCk7XG4gICAgICAgICAgICAgICAgcHJlZml4ID0gcmVzb3VyY2VJZCA/IHJlc291cmNlSWRbMF0gOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwaWxsVHlwZSA9IHRoaXMucHJvcHMudHlwZSB8fCB7XG4gICAgICAgICAgICAnQCc6IFBpbGwuVFlQRV9VU0VSX01FTlRJT04sXG4gICAgICAgICAgICAnIyc6IFBpbGwuVFlQRV9ST09NX01FTlRJT04sXG4gICAgICAgICAgICAnISc6IFBpbGwuVFlQRV9ST09NX01FTlRJT04sXG4gICAgICAgICAgICAnKyc6IFBpbGwuVFlQRV9HUk9VUF9NRU5USU9OLFxuICAgICAgICB9W3ByZWZpeF07XG5cbiAgICAgICAgbGV0IG1lbWJlcjtcbiAgICAgICAgbGV0IGdyb3VwO1xuICAgICAgICBsZXQgcm9vbTtcbiAgICAgICAgc3dpdGNoIChwaWxsVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBQaWxsLlRZUEVfQVRfUk9PTV9NRU5USU9OOiB7XG4gICAgICAgICAgICAgICAgcm9vbSA9IG5leHRQcm9wcy5yb29tO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQaWxsLlRZUEVfVVNFUl9NRU5USU9OOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYWxNZW1iZXIgPSBuZXh0UHJvcHMucm9vbSA/IG5leHRQcm9wcy5yb29tLmdldE1lbWJlcihyZXNvdXJjZUlkKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBtZW1iZXIgPSBsb2NhbE1lbWJlcjtcbiAgICAgICAgICAgICAgICBpZiAoIWxvY2FsTWVtYmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lbWJlciA9IG5ldyBSb29tTWVtYmVyKG51bGwsIHJlc291cmNlSWQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvUHJvZmlsZUxvb2t1cChyZXNvdXJjZUlkLCBtZW1iZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgUGlsbC5UWVBFX1JPT01fTUVOVElPTjoge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsUm9vbSA9IHJlc291cmNlSWRbMF0gPT09ICcjJyA/XG4gICAgICAgICAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tcygpLmZpbmQoKHIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByLmdldENhbm9uaWNhbEFsaWFzKCkgPT09IHJlc291cmNlSWQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByLmdldEFsdEFsaWFzZXMoKS5pbmNsdWRlcyhyZXNvdXJjZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgfSkgOiBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShyZXNvdXJjZUlkKTtcbiAgICAgICAgICAgICAgICByb29tID0gbG9jYWxSb29tO1xuICAgICAgICAgICAgICAgIGlmICghbG9jYWxSb29tKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IFRoaXMgd291bGQgcmVxdWlyZSBhIG5ldyBBUEkgdG8gcmVzb2x2ZSBhIHJvb20gYWxpYXMgdG9cbiAgICAgICAgICAgICAgICAgICAgLy8gYSByb29tIGF2YXRhciBhbmQgbmFtZS5cbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5kb1Jvb21Qcm9maWxlTG9va3VwKHJlc291cmNlSWQsIG1lbWJlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQaWxsLlRZUEVfR1JPVVBfTUVOVElPTjoge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGdyb3VwID0gYXdhaXQgRmxhaXJTdG9yZS5nZXRHcm91cFByb2ZpbGVDYWNoZWQoY2xpLCByZXNvdXJjZUlkKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7IC8vIGlmIEZsYWlyU3RvcmUgZmFpbGVkLCBmYWxsIGJhY2sgdG8ganVzdCBncm91cElkXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJZDogcmVzb3VyY2VJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe3Jlc291cmNlSWQsIHBpbGxUeXBlLCBtZW1iZXIsIGdyb3VwLCByb29tfSk7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLl91bm1vdW50ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fbWF0cml4Q2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuZXctY2FwXG4gICAgICAgIHRoaXMuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHModGhpcy5wcm9wcyk7IC8vIEhBQ0s6IFdlIHNob3VsZG4ndCBiZSBjYWxsaW5nIGxpZmVjeWNsZSBmdW5jdGlvbnMgb3Vyc2VsdmVzLlxuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgdGhpcy5fdW5tb3VudGVkID0gdHJ1ZTtcbiAgICB9LFxuXG4gICAgZG9Qcm9maWxlTG9va3VwOiBmdW5jdGlvbih1c2VySWQsIG1lbWJlcikge1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0UHJvZmlsZUluZm8odXNlcklkKS50aGVuKChyZXNwKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5fdW5tb3VudGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWVtYmVyLm5hbWUgPSByZXNwLmRpc3BsYXluYW1lO1xuICAgICAgICAgICAgbWVtYmVyLnJhd0Rpc3BsYXlOYW1lID0gcmVzcC5kaXNwbGF5bmFtZTtcbiAgICAgICAgICAgIG1lbWJlci5ldmVudHMubWVtYmVyID0ge1xuICAgICAgICAgICAgICAgIGdldENvbnRlbnQ6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHthdmF0YXJfdXJsOiByZXNwLmF2YXRhcl91cmx9O1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0RGlyZWN0aW9uYWxDb250ZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29udGVudCgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7bWVtYmVyfSk7XG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkIG5vdCByZXRyaWV2ZSBwcm9maWxlIGRhdGEgZm9yICcgKyB1c2VySWQgKyAnOicsIGVycik7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBvblVzZXJQaWxsQ2xpY2tlZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3VXNlcixcbiAgICAgICAgICAgIG1lbWJlcjogdGhpcy5zdGF0ZS5tZW1iZXIsXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc3QgQmFzZUF2YXRhciA9IHNkay5nZXRDb21wb25lbnQoJ3ZpZXdzLmF2YXRhcnMuQmFzZUF2YXRhcicpO1xuICAgICAgICBjb25zdCBNZW1iZXJBdmF0YXIgPSBzZGsuZ2V0Q29tcG9uZW50KCdhdmF0YXJzLk1lbWJlckF2YXRhcicpO1xuICAgICAgICBjb25zdCBSb29tQXZhdGFyID0gc2RrLmdldENvbXBvbmVudCgnYXZhdGFycy5Sb29tQXZhdGFyJyk7XG5cbiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzLnN0YXRlLnJlc291cmNlSWQ7XG5cbiAgICAgICAgbGV0IGF2YXRhciA9IG51bGw7XG4gICAgICAgIGxldCBsaW5rVGV4dCA9IHJlc291cmNlO1xuICAgICAgICBsZXQgcGlsbENsYXNzO1xuICAgICAgICBsZXQgdXNlcklkO1xuICAgICAgICBsZXQgaHJlZiA9IHRoaXMucHJvcHMudXJsO1xuICAgICAgICBsZXQgb25DbGljaztcbiAgICAgICAgc3dpdGNoICh0aGlzLnN0YXRlLnBpbGxUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIFBpbGwuVFlQRV9BVF9ST09NX01FTlRJT046IHtcbiAgICAgICAgICAgICAgICBjb25zdCByb29tID0gdGhpcy5wcm9wcy5yb29tO1xuICAgICAgICAgICAgICAgIGlmIChyb29tKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmtUZXh0ID0gXCJAcm9vbVwiO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5zaG91bGRTaG93UGlsbEF2YXRhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyID0gPFJvb21BdmF0YXIgcm9vbT17cm9vbX0gd2lkdGg9ezE2fSBoZWlnaHQ9ezE2fSBhcmlhLWhpZGRlbj1cInRydWVcIiAvPjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwaWxsQ2xhc3MgPSAnbXhfQXRSb29tUGlsbCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBQaWxsLlRZUEVfVVNFUl9NRU5USU9OOiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgdXNlciBpcyBub3QgYSBtZW1iZXIgb2YgdGhpcyByb29tLCBkZWZhdWx0IHRvIHRoZSBlbXB0eSBtZW1iZXJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVtYmVyID0gdGhpcy5zdGF0ZS5tZW1iZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJJZCA9IG1lbWJlci51c2VySWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXIucmF3RGlzcGxheU5hbWUgPSBtZW1iZXIucmF3RGlzcGxheU5hbWUgfHwgJyc7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5rVGV4dCA9IG1lbWJlci5yYXdEaXNwbGF5TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLnNob3VsZFNob3dQaWxsQXZhdGFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyID0gPE1lbWJlckF2YXRhciBtZW1iZXI9e21lbWJlcn0gd2lkdGg9ezE2fSBoZWlnaHQ9ezE2fSBhcmlhLWhpZGRlbj1cInRydWVcIiAvPjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHBpbGxDbGFzcyA9ICdteF9Vc2VyUGlsbCc7XG4gICAgICAgICAgICAgICAgICAgICAgICBocmVmID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2sgPSB0aGlzLm9uVXNlclBpbGxDbGlja2VkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFBpbGwuVFlQRV9ST09NX01FTlRJT046IHtcbiAgICAgICAgICAgICAgICBjb25zdCByb29tID0gdGhpcy5zdGF0ZS5yb29tO1xuICAgICAgICAgICAgICAgIGlmIChyb29tKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmtUZXh0ID0gcmVzb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3BzLnNob3VsZFNob3dQaWxsQXZhdGFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdmF0YXIgPSA8Um9vbUF2YXRhciByb29tPXtyb29tfSB3aWR0aD17MTZ9IGhlaWdodD17MTZ9IGFyaWEtaGlkZGVuPVwidHJ1ZVwiIC8+O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBpbGxDbGFzcyA9ICdteF9Sb29tUGlsbCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFBpbGwuVFlQRV9HUk9VUF9NRU5USU9OOiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuZ3JvdXApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qge2F2YXRhclVybCwgZ3JvdXBJZCwgbmFtZX0gPSB0aGlzLnN0YXRlLmdyb3VwO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGlua1RleHQgPSBncm91cElkO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5zaG91bGRTaG93UGlsbEF2YXRhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyID0gPEJhc2VBdmF0YXIgbmFtZT17bmFtZSB8fCBncm91cElkfSB3aWR0aD17MTZ9IGhlaWdodD17MTZ9IGFyaWEtaGlkZGVuPVwidHJ1ZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw9e2F2YXRhclVybCA/IGNsaS5teGNVcmxUb0h0dHAoYXZhdGFyVXJsLCAxNiwgMTYpIDogbnVsbH0gLz47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcGlsbENsYXNzID0gJ214X0dyb3VwUGlsbCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzTmFtZXMoXCJteF9QaWxsXCIsIHBpbGxDbGFzcywge1xuICAgICAgICAgICAgXCJteF9Vc2VyUGlsbF9tZVwiOiB1c2VySWQgPT09IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKSxcbiAgICAgICAgICAgIFwibXhfVXNlclBpbGxfc2VsZWN0ZWRcIjogdGhpcy5wcm9wcy5pc1NlbGVjdGVkLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5waWxsVHlwZSkge1xuICAgICAgICAgICAgcmV0dXJuIDxNYXRyaXhDbGllbnRDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXt0aGlzLl9tYXRyaXhDbGllbnR9PlxuICAgICAgICAgICAgICAgIHsgdGhpcy5wcm9wcy5pbk1lc3NhZ2UgP1xuICAgICAgICAgICAgICAgICAgICA8YSBjbGFzc05hbWU9e2NsYXNzZXN9IGhyZWY9e2hyZWZ9IG9uQ2xpY2s9e29uQ2xpY2t9IHRpdGxlPXtyZXNvdXJjZX0gZGF0YS1vZmZzZXQta2V5PXt0aGlzLnByb3BzLm9mZnNldEtleX0+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGF2YXRhciB9XG4gICAgICAgICAgICAgICAgICAgICAgICB7IGxpbmtUZXh0IH1cbiAgICAgICAgICAgICAgICAgICAgPC9hPiA6XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3Nlc30gdGl0bGU9e3Jlc291cmNlfSBkYXRhLW9mZnNldC1rZXk9e3RoaXMucHJvcHMub2Zmc2V0S2V5fT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgYXZhdGFyIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgbGlua1RleHQgfVxuICAgICAgICAgICAgICAgICAgICA8L3NwYW4+IH1cbiAgICAgICAgICAgIDwvTWF0cml4Q2xpZW50Q29udGV4dC5Qcm92aWRlcj47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBEZWxpYmVyYXRlbHkgcmVuZGVyIG5vdGhpbmcgaWYgdGhlIFVSTCBpc24ndCByZWNvZ25pc2VkXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0sXG59KTtcblxuZXhwb3J0IGRlZmF1bHQgUGlsbDtcbiJdfQ==