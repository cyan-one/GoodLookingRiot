"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ERROR_USER_CANCELLED = void 0;

var _matrixJsSdk = require("matrix-js-sdk");

var _react = _interopRequireWildcard(require("react"));

var _createReactClass = _interopRequireDefault(require("create-react-class"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _InteractiveAuthEntryComponents = _interopRequireDefault(require("../views/auth/InteractiveAuthEntryComponents"));

var sdk = _interopRequireWildcard(require("../../index"));

/*
Copyright 2017 Vector Creations Ltd.
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ERROR_USER_CANCELLED = new Error("User cancelled auth session");
exports.ERROR_USER_CANCELLED = ERROR_USER_CANCELLED;

var _default = (0, _createReactClass.default)({
  displayName: 'InteractiveAuth',
  propTypes: {
    // matrix client to use for UI auth requests
    matrixClient: _propTypes.default.object.isRequired,
    // response from initial request. If not supplied, will do a request on
    // mount.
    authData: _propTypes.default.shape({
      flows: _propTypes.default.array,
      params: _propTypes.default.object,
      session: _propTypes.default.string
    }),
    // callback
    makeRequest: _propTypes.default.func.isRequired,
    // callback called when the auth process has finished,
    // successfully or unsuccessfully.
    // @param {bool} status True if the operation requiring
    //     auth was completed sucessfully, false if canceled.
    // @param {object} result The result of the authenticated call
    //     if successful, otherwise the error object.
    // @param {object} extra Additional information about the UI Auth
    //     process:
    //      * emailSid {string} If email auth was performed, the sid of
    //            the auth session.
    //      * clientSecret {string} The client secret used in auth
    //            sessions with the ID server.
    onAuthFinished: _propTypes.default.func.isRequired,
    // Inputs provided by the user to the auth process
    // and used by various stages. As passed to js-sdk
    // interactive-auth
    inputs: _propTypes.default.object,
    // As js-sdk interactive-auth
    requestEmailToken: _propTypes.default.func,
    sessionId: _propTypes.default.string,
    clientSecret: _propTypes.default.string,
    emailSid: _propTypes.default.string,
    // If true, poll to see if the auth flow has been completed
    // out-of-band
    poll: _propTypes.default.bool,
    // If true, components will be told that the 'Continue' button
    // is managed by some other party and should not be managed by
    // the component itself.
    continueIsManaged: _propTypes.default.bool,
    // Called when the stage changes, or the stage's phase changes. First
    // argument is the stage, second is the phase. Some stages do not have
    // phases and will be counted as 0 (numeric).
    onStagePhaseChange: _propTypes.default.func,
    // continueText and continueKind are passed straight through to the AuthEntryComponent.
    continueText: _propTypes.default.string,
    continueKind: _propTypes.default.string
  },
  getInitialState: function () {
    return {
      authStage: null,
      busy: false,
      errorText: null,
      stageErrorText: null,
      submitButtonEnabled: false
    };
  },
  // TODO: [REACT-WARNING] Replace component with real class, use constructor for refs
  UNSAFE_componentWillMount: function () {
    this._unmounted = false;
    this._authLogic = new _matrixJsSdk.InteractiveAuth({
      authData: this.props.authData,
      doRequest: this._requestCallback,
      busyChanged: this._onBusyChanged,
      inputs: this.props.inputs,
      stateUpdated: this._authStateUpdated,
      matrixClient: this.props.matrixClient,
      sessionId: this.props.sessionId,
      clientSecret: this.props.clientSecret,
      emailSid: this.props.emailSid,
      requestEmailToken: this._requestEmailToken
    });

    this._authLogic.attemptAuth().then(result => {
      const extra = {
        emailSid: this._authLogic.getEmailSid(),
        clientSecret: this._authLogic.getClientSecret()
      };
      this.props.onAuthFinished(true, result, extra);
    }).catch(error => {
      this.props.onAuthFinished(false, error);
      console.error("Error during user-interactive auth:", error);

      if (this._unmounted) {
        return;
      }

      const msg = error.message || error.toString();
      this.setState({
        errorText: msg
      });
    });

    this._intervalId = null;

    if (this.props.poll) {
      this._intervalId = setInterval(() => {
        this._authLogic.poll();
      }, 2000);
    }

    this._stageComponent = (0, _react.createRef)();
  },
  componentWillUnmount: function () {
    this._unmounted = true;

    if (this._intervalId !== null) {
      clearInterval(this._intervalId);
    }
  },
  _requestEmailToken: async function (...args) {
    this.setState({
      busy: true
    });

    try {
      return await this.props.requestEmailToken(...args);
    } finally {
      this.setState({
        busy: false
      });
    }
  },
  tryContinue: function () {
    if (this._stageComponent.current && this._stageComponent.current.tryContinue) {
      this._stageComponent.current.tryContinue();
    }
  },
  _authStateUpdated: function (stageType, stageState) {
    const oldStage = this.state.authStage;
    this.setState({
      busy: false,
      authStage: stageType,
      stageState: stageState,
      errorText: stageState.error
    }, () => {
      if (oldStage != stageType) this._setFocus();
    });
  },
  _requestCallback: function (auth) {
    // This wrapper just exists because the js-sdk passes a second
    // 'busy' param for backwards compat. This throws the tests off
    // so discard it here.
    return this.props.makeRequest(auth);
  },
  _onBusyChanged: function (busy) {
    // if we've started doing stuff, reset the error messages
    if (busy) {
      this.setState({
        busy: true,
        errorText: null,
        stageErrorText: null
      });
    } // The JS SDK eagerly reports itself as "not busy" right after any
    // immediate work has completed, but that's not really what we want at
    // the UI layer, so we ignore this signal and show a spinner until
    // there's a new screen to show the user. This is implemented by setting
    // `busy: false` in `_authStateUpdated`.
    // See also https://github.com/vector-im/riot-web/issues/12546

  },
  _setFocus: function () {
    if (this._stageComponent.current && this._stageComponent.current.focus) {
      this._stageComponent.current.focus();
    }
  },
  _submitAuthDict: function (authData) {
    this._authLogic.submitAuthDict(authData);
  },
  _onPhaseChange: function (newPhase) {
    if (this.props.onStagePhaseChange) {
      this.props.onStagePhaseChange(this.state.authStage, newPhase || 0);
    }
  },
  _onStageCancel: function () {
    this.props.onAuthFinished(false, ERROR_USER_CANCELLED);
  },
  _renderCurrentStage: function () {
    const stage = this.state.authStage;

    if (!stage) {
      if (this.state.busy) {
        const Loader = sdk.getComponent("elements.Spinner");
        return /*#__PURE__*/_react.default.createElement(Loader, null);
      } else {
        return null;
      }
    }

    const StageComponent = (0, _InteractiveAuthEntryComponents.default)(stage);
    return /*#__PURE__*/_react.default.createElement(StageComponent, {
      ref: this._stageComponent,
      loginType: stage,
      matrixClient: this.props.matrixClient,
      authSessionId: this._authLogic.getSessionId(),
      clientSecret: this._authLogic.getClientSecret(),
      stageParams: this._authLogic.getStageParams(stage),
      submitAuthDict: this._submitAuthDict,
      errorText: this.state.stageErrorText,
      busy: this.state.busy,
      inputs: this.props.inputs,
      stageState: this.state.stageState,
      fail: this._onAuthStageFailed,
      setEmailSid: this._setEmailSid,
      showContinue: !this.props.continueIsManaged,
      onPhaseChange: this._onPhaseChange,
      continueText: this.props.continueText,
      continueKind: this.props.continueKind,
      onCancel: this._onStageCancel
    });
  },
  _onAuthStageFailed: function (e) {
    this.props.onAuthFinished(false, e);
  },
  _setEmailSid: function (sid) {
    this._authLogic.setEmailSid(sid);
  },
  render: function () {
    let error = null;

    if (this.state.errorText) {
      error = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, this.state.errorText);
    }

    return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", null, this._renderCurrentStage(), error));
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvSW50ZXJhY3RpdmVBdXRoLmpzIl0sIm5hbWVzIjpbIkVSUk9SX1VTRVJfQ0FOQ0VMTEVEIiwiRXJyb3IiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsIm1hdHJpeENsaWVudCIsIlByb3BUeXBlcyIsIm9iamVjdCIsImlzUmVxdWlyZWQiLCJhdXRoRGF0YSIsInNoYXBlIiwiZmxvd3MiLCJhcnJheSIsInBhcmFtcyIsInNlc3Npb24iLCJzdHJpbmciLCJtYWtlUmVxdWVzdCIsImZ1bmMiLCJvbkF1dGhGaW5pc2hlZCIsImlucHV0cyIsInJlcXVlc3RFbWFpbFRva2VuIiwic2Vzc2lvbklkIiwiY2xpZW50U2VjcmV0IiwiZW1haWxTaWQiLCJwb2xsIiwiYm9vbCIsImNvbnRpbnVlSXNNYW5hZ2VkIiwib25TdGFnZVBoYXNlQ2hhbmdlIiwiY29udGludWVUZXh0IiwiY29udGludWVLaW5kIiwiZ2V0SW5pdGlhbFN0YXRlIiwiYXV0aFN0YWdlIiwiYnVzeSIsImVycm9yVGV4dCIsInN0YWdlRXJyb3JUZXh0Iiwic3VibWl0QnV0dG9uRW5hYmxlZCIsIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiLCJfdW5tb3VudGVkIiwiX2F1dGhMb2dpYyIsIkludGVyYWN0aXZlQXV0aCIsInByb3BzIiwiZG9SZXF1ZXN0IiwiX3JlcXVlc3RDYWxsYmFjayIsImJ1c3lDaGFuZ2VkIiwiX29uQnVzeUNoYW5nZWQiLCJzdGF0ZVVwZGF0ZWQiLCJfYXV0aFN0YXRlVXBkYXRlZCIsIl9yZXF1ZXN0RW1haWxUb2tlbiIsImF0dGVtcHRBdXRoIiwidGhlbiIsInJlc3VsdCIsImV4dHJhIiwiZ2V0RW1haWxTaWQiLCJnZXRDbGllbnRTZWNyZXQiLCJjYXRjaCIsImVycm9yIiwiY29uc29sZSIsIm1zZyIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsInNldFN0YXRlIiwiX2ludGVydmFsSWQiLCJzZXRJbnRlcnZhbCIsIl9zdGFnZUNvbXBvbmVudCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiY2xlYXJJbnRlcnZhbCIsImFyZ3MiLCJ0cnlDb250aW51ZSIsImN1cnJlbnQiLCJzdGFnZVR5cGUiLCJzdGFnZVN0YXRlIiwib2xkU3RhZ2UiLCJzdGF0ZSIsIl9zZXRGb2N1cyIsImF1dGgiLCJmb2N1cyIsIl9zdWJtaXRBdXRoRGljdCIsInN1Ym1pdEF1dGhEaWN0IiwiX29uUGhhc2VDaGFuZ2UiLCJuZXdQaGFzZSIsIl9vblN0YWdlQ2FuY2VsIiwiX3JlbmRlckN1cnJlbnRTdGFnZSIsInN0YWdlIiwiTG9hZGVyIiwic2RrIiwiZ2V0Q29tcG9uZW50IiwiU3RhZ2VDb21wb25lbnQiLCJnZXRTZXNzaW9uSWQiLCJnZXRTdGFnZVBhcmFtcyIsIl9vbkF1dGhTdGFnZUZhaWxlZCIsIl9zZXRFbWFpbFNpZCIsImUiLCJzaWQiLCJzZXRFbWFpbFNpZCIsInJlbmRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBeEJBOzs7Ozs7Ozs7Ozs7Ozs7O0FBMEJPLE1BQU1BLG9CQUFvQixHQUFHLElBQUlDLEtBQUosQ0FBVSw2QkFBVixDQUE3Qjs7O2VBRVEsK0JBQWlCO0FBQzVCQyxFQUFBQSxXQUFXLEVBQUUsaUJBRGU7QUFHNUJDLEVBQUFBLFNBQVMsRUFBRTtBQUNQO0FBQ0FDLElBQUFBLFlBQVksRUFBRUMsbUJBQVVDLE1BQVYsQ0FBaUJDLFVBRnhCO0FBSVA7QUFDQTtBQUNBQyxJQUFBQSxRQUFRLEVBQUVILG1CQUFVSSxLQUFWLENBQWdCO0FBQ3RCQyxNQUFBQSxLQUFLLEVBQUVMLG1CQUFVTSxLQURLO0FBRXRCQyxNQUFBQSxNQUFNLEVBQUVQLG1CQUFVQyxNQUZJO0FBR3RCTyxNQUFBQSxPQUFPLEVBQUVSLG1CQUFVUztBQUhHLEtBQWhCLENBTkg7QUFZUDtBQUNBQyxJQUFBQSxXQUFXLEVBQUVWLG1CQUFVVyxJQUFWLENBQWVULFVBYnJCO0FBZVA7QUFDQTtB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QztBQUFmLFNBQ00sS0FBS2lCLEtBQUwsQ0FBV3ZDLFNBRGpCLENBREo7QUFLSDs7QUFFRCx3QkFDSSx1REFDSSwwQ0FDTSxLQUFLZ0QsbUJBQUwsRUFETixFQUVNMUIsS0FGTixDQURKLENBREo7QUFRSDtBQXJRMkIsQ0FBakIsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZC5cbkNvcHlyaWdodCAyMDE5LCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHtJbnRlcmFjdGl2ZUF1dGh9IGZyb20gXCJtYXRyaXgtanMtc2RrXCI7XG5pbXBvcnQgUmVhY3QsIHtjcmVhdGVSZWZ9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjcmVhdGVSZWFjdENsYXNzIGZyb20gJ2NyZWF0ZS1yZWFjdC1jbGFzcyc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuXG5pbXBvcnQgZ2V0RW50cnlDb21wb25lbnRGb3JMb2dpblR5cGUgZnJvbSAnLi4vdmlld3MvYXV0aC9JbnRlcmFjdGl2ZUF1dGhFbnRyeUNvbXBvbmVudHMnO1xuXG5pbXBvcnQgKiBhcyBzZGsgZnJvbSAnLi4vLi4vaW5kZXgnO1xuXG5leHBvcnQgY29uc3QgRVJST1JfVVNFUl9DQU5DRUxMRUQgPSBuZXcgRXJyb3IoXCJVc2VyIGNhbmNlbGxlZCBhdXRoIHNlc3Npb25cIik7XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZVJlYWN0Q2xhc3Moe1xuICAgIGRpc3BsYXlOYW1lOiAnSW50ZXJhY3RpdmVBdXRoJyxcblxuICAgIHByb3BUeXBlczoge1xuICAgICAgICAvLyBtYXRyaXggY2xpZW50IHRvIHVzZSBmb3IgVUkgYXV0aCByZXF1ZXN0c1xuICAgICAgICBtYXRyaXhDbGllbnQ6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcblxuICAgICAgICAvLyByZXNwb25zZSBmcm9tIGluaXRpYWwgcmVxdWVzdC4gSWYgbm90IHN1cHBsaWVkLCB3aWxsIGRvIGEgcmVxdWVzdCBvblxuICAgICAgICAvLyBtb3VudC5cbiAgICAgICAgYXV0aERhdGE6IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICAgICAgICBmbG93czogUHJvcFR5cGVzLmFycmF5LFxuICAgICAgICAgICAgcGFyYW1zOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgICAgICAgICAgc2Vzc2lvbjogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgfSksXG5cbiAgICAgICAgLy8gY2FsbGJhY2tcbiAgICAgICAgbWFrZVJlcXVlc3Q6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgICAgICAgLy8gY2FsbGJhY2sgY2FsbGVkIHdoZW4gdGhlIGF1dGggcHJvY2VzcyBoYXMgZmluaXNoZWQsXG4gICAgICAgIC8vIHN1Y2Nlc3NmdWxseSBvciB1bnN1Y2Nlc3NmdWxseS5cbiAgICAgICAgLy8gQHBhcmFtIHtib29sfSBzdGF0dXMgVHJ1ZSBpZiB0aGUgb3BlcmF0aW9uIHJlcXVpcmluZ1xuICAgICAgICAvLyAgICAgYXV0aCB3YXMgY29tcGxldGVkIHN1Y2Vzc2Z1bGx5LCBmYWxzZSBpZiBjYW5jZWxlZC5cbiAgICAgICAgLy8gQHBhcmFtIHtvYmplY3R9IHJlc3VsdCBUaGUgcmVzdWx0IG9mIHRoZSBhdXRoZW50aWNhdGVkIGNhbGxcbiAgICAgICAgLy8gICAgIGlmIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSB0aGUgZXJyb3Igb2JqZWN0LlxuICAgICAgICAvLyBAcGFyYW0ge29iamVjdH0gZXh0cmEgQWRkaXRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgVUkgQXV0aFxuICAgICAgICAvLyAgICAgcHJvY2VzczpcbiAgICAgICAgLy8gICAgICAqIGVtYWlsU2lkIHtzdHJpbmd9IElmIGVtYWlsIGF1dGggd2FzIHBlcmZvcm1lZCwgdGhlIHNpZCBvZlxuICAgICAgICAvLyAgICAgICAgICAgIHRoZSBhdXRoIHNlc3Npb24uXG4gICAgICAgIC8vICAgICAgKiBjbGllbnRTZWNyZXQge3N0cmluZ30gVGhlIGNsaWVudCBzZWNyZXQgdXNlZCBpbiBhdXRoXG4gICAgICAgIC8vICAgICAgICAgICAgc2Vzc2lvbnMgd2l0aCB0aGUgSUQgc2VydmVyLlxuICAgICAgICBvbkF1dGhGaW5pc2hlZDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgICAgICAvLyBJbnB1dHMgcHJvdmlkZWQgYnkgdGhlIHVzZXIgdG8gdGhlIGF1dGggcHJvY2Vzc1xuICAgICAgICAvLyBhbmQgdXNlZCBieSB2YXJpb3VzIHN0YWdlcy4gQXMgcGFzc2VkIHRvIGpzLXNka1xuICAgICAgICAvLyBpbnRlcmFjdGl2ZS1hdXRoXG4gICAgICAgIGlucHV0czogUHJvcFR5cGVzLm9iamVjdCxcblxuICAgICAgICAvLyBBcyBqcy1zZGsgaW50ZXJhY3RpdmUtYXV0aFxuICAgICAgICByZXF1ZXN0RW1haWxUb2tlbjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgICAgIHNlc3Npb25JZDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgY2xpZW50U2VjcmV0OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBlbWFpbFNpZDogUHJvcFR5cGVzLnN0cmluZyxcblxuICAgICAgICAvLyBJZiB0cnVlLCBwb2xsIHRvIHNlZSBpZiB0aGUgYXV0aCBmbG93IGhhcyBiZWVuIGNvbXBsZXRlZFxuICAgICAgICAvLyBvdXQtb2YtYmFuZFxuICAgICAgICBwb2xsOiBQcm9wVHlwZXMuYm9vbCxcblxuICAgICAgICAvLyBJZiB0cnVlLCBjb21wb25lbnRzIHdpbGwgYmUgdG9sZCB0aGF0IHRoZSAnQ29udGludWUnIGJ1dHRvblxuICAgICAgICAvLyBpcyBtYW5hZ2VkIGJ5IHNvbWUgb3RoZXIgcGFydHkgYW5kIHNob3VsZCBub3QgYmUgbWFuYWdlZCBieVxuICAgICAgICAvLyB0aGUgY29tcG9uZW50IGl0c2VsZi5cbiAgICAgICAgY29udGludWVJc01hbmFnZWQ6IFByb3BUeXBlcy5ib29sLFxuXG4gICAgICAgIC8vIENhbGxlZCB3aGVuIHRoZSBzdGFnZSBjaGFuZ2VzLCBvciB0aGUgc3RhZ2UncyBwaGFzZSBjaGFuZ2VzLiBGaXJzdFxuICAgICAgICAvLyBhcmd1bWVudCBpcyB0aGUgc3RhZ2UsIHNlY29uZCBpcyB0aGUgcGhhc2UuIFNvbWUgc3RhZ2VzIGRvIG5vdCBoYXZlXG4gICAgICAgIC8vIHBoYXNlcyBhbmQgd2lsbCBiZSBjb3VudGVkIGFzIDAgKG51bWVyaWMpLlxuICAgICAgICBvblN0YWdlUGhhc2VDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLFxuXG4gICAgICAgIC8vIGNvbnRpbnVlVGV4dCBhbmQgY29udGludWVLaW5kIGFyZSBwYXNzZWQgc3RyYWlnaHQgdGhyb3VnaCB0byB0aGUgQXV0aEVudHJ5Q29tcG9uZW50LlxuICAgICAgICBjb250aW51ZVRleHQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIGNvbnRpbnVlS2luZDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICB9LFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGF1dGhTdGFnZTogbnVsbCxcbiAgICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3JUZXh0OiBudWxsLFxuICAgICAgICAgICAgc3RhZ2VFcnJvclRleHQ6IG51bGwsXG4gICAgICAgICAgICBzdWJtaXRCdXR0b25FbmFibGVkOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gICAgLy8gVE9ETzogW1JFQUNULVdBUk5JTkddIFJlcGxhY2UgY29tcG9uZW50IHdpdGggcmVhbCBjbGFzcywgdXNlIGNvbnN0cnVjdG9yIGZvciByZWZzXG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuX3VubW91bnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9hdXRoTG9naWMgPSBuZXcgSW50ZXJhY3RpdmVBdXRoKHtcbiAgICAgICAgICAgIGF1dGhEYXRhOiB0aGlzLnByb3BzLmF1dGhEYXRhLFxuICAgICAgICAgICAgZG9SZXF1ZXN0OiB0aGlzLl9yZXF1ZXN0Q2FsbGJhY2ssXG4gICAgICAgICAgICBidXN5Q2hhbmdlZDogdGhpcy5fb25CdXN5Q2hhbmdlZCxcbiAgICAgICAgICAgIGlucHV0czogdGhpcy5wcm9wcy5pbnB1dHMsXG4gICAgICAgICAgICBzdGF0ZVVwZGF0ZWQ6IHRoaXMuX2F1dGhTdGF0ZVVwZGF0ZWQsXG4gICAgICAgICAgICBtYXRyaXhDbGllbnQ6IHRoaXMucHJvcHMubWF0cml4Q2xpZW50LFxuICAgICAgICAgICAgc2Vzc2lvbklkOiB0aGlzLnByb3BzLnNlc3Npb25JZCxcbiAgICAgICAgICAgIGNsaWVudFNlY3JldDogdGhpcy5wcm9wcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgICBlbWFpbFNpZDogdGhpcy5wcm9wcy5lbWFpbFNpZCxcbiAgICAgICAgICAgIHJlcXVlc3RFbWFpbFRva2VuOiB0aGlzLl9yZXF1ZXN0RW1haWxUb2tlbixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fYXV0aExvZ2ljLmF0dGVtcHRBdXRoKCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHRyYSA9IHtcbiAgICAgICAgICAgICAgICBlbWFpbFNpZDogdGhpcy5fYXV0aExvZ2ljLmdldEVtYWlsU2lkKCksXG4gICAgICAgICAgICAgICAgY2xpZW50U2VjcmV0OiB0aGlzLl9hdXRoTG9naWMuZ2V0Q2xpZW50U2VjcmV0KCksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkF1dGhGaW5pc2hlZCh0cnVlLCByZXN1bHQsIGV4dHJhKTtcbiAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uQXV0aEZpbmlzaGVkKGZhbHNlLCBlcnJvcik7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZHVyaW5nIHVzZXItaW50ZXJhY3RpdmUgYXV0aDpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX3VubW91bnRlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgbXNnID0gZXJyb3IubWVzc2FnZSB8fCBlcnJvci50b1N0cmluZygpO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZXJyb3JUZXh0OiBtc2csXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5faW50ZXJ2YWxJZCA9IG51bGw7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnBvbGwpIHtcbiAgICAgICAgICAgIHRoaXMuX2ludGVydmFsSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYXV0aExvZ2ljLnBvbGwoKTtcbiAgICAgICAgICAgIH0sIDIwMDApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RhZ2VDb21wb25lbnQgPSBjcmVhdGVSZWYoKTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLl91bm1vdW50ZWQgPSB0cnVlO1xuXG4gICAgICAgIGlmICh0aGlzLl9pbnRlcnZhbElkICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuX2ludGVydmFsSWQpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9yZXF1ZXN0RW1haWxUb2tlbjogYXN5bmMgZnVuY3Rpb24oLi4uYXJncykge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIGJ1c3k6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJvcHMucmVxdWVzdEVtYWlsVG9rZW4oLi4uYXJncyk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIHRyeUNvbnRpbnVlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YWdlQ29tcG9uZW50LmN1cnJlbnQgJiYgdGhpcy5fc3RhZ2VDb21wb25lbnQuY3VycmVudC50cnlDb250aW51ZSkge1xuICAgICAgICAgICAgdGhpcy5fc3RhZ2VDb21wb25lbnQuY3VycmVudC50cnlDb250aW51ZSgpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIF9hdXRoU3RhdGVVcGRhdGVkOiBmdW5jdGlvbihzdGFnZVR5cGUsIHN0YWdlU3RhdGUpIHtcbiAgICAgICAgY29uc3Qgb2xkU3RhZ2UgPSB0aGlzLnN0YXRlLmF1dGhTdGFnZTtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgICAgIGF1dGhTdGFnZTogc3RhZ2VUeXBlLFxuICAgICAgICAgICAgc3RhZ2VTdGF0ZTogc3RhZ2VTdGF0ZSxcbiAgICAgICAgICAgIGVycm9yVGV4dDogc3RhZ2VTdGF0ZS5lcnJvcixcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKG9sZFN0YWdlICE9IHN0YWdlVHlwZSkgdGhpcy5fc2V0Rm9jdXMoKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIF9yZXF1ZXN0Q2FsbGJhY2s6IGZ1bmN0aW9uKGF1dGgpIHtcbiAgICAgICAgLy8gVGhpcyB3cmFwcGVyIGp1c3QgZXhpc3RzIGJlY2F1c2UgdGhlIGpzLXNkayBwYXNzZXMgYSBzZWNvbmRcbiAgICAgICAgLy8gJ2J1c3knIHBhcmFtIGZvciBiYWNrd2FyZHMgY29tcGF0LiBUaGlzIHRocm93cyB0aGUgdGVzdHMgb2ZmXG4gICAgICAgIC8vIHNvIGRpc2NhcmQgaXQgaGVyZS5cbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWFrZVJlcXVlc3QoYXV0aCk7XG4gICAgfSxcblxuICAgIF9vbkJ1c3lDaGFuZ2VkOiBmdW5jdGlvbihidXN5KSB7XG4gICAgICAgIC8vIGlmIHdlJ3ZlIHN0YXJ0ZWQgZG9pbmcgc3R1ZmYsIHJlc2V0IHRoZSBlcnJvciBtZXNzYWdlc1xuICAgICAgICBpZiAoYnVzeSkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgYnVzeTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBlcnJvclRleHQ6IG51bGwsXG4gICAgICAgICAgICAgICAgc3RhZ2VFcnJvclRleHQ6IG51bGwsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICAvLyBUaGUgSlMgU0RLIGVhZ2VybHkgcmVwb3J0cyBpdHNlbGYgYXMgXCJub3QgYnVzeVwiIHJpZ2h0IGFmdGVyIGFueVxuICAgICAgICAvLyBpbW1lZGlhdGUgd29yayBoYXMgY29tcGxldGVkLCBidXQgdGhhdCdzIG5vdCByZWFsbHkgd2hhdCB3ZSB3YW50IGF0XG4gICAgICAgIC8vIHRoZSBVSSBsYXllciwgc28gd2UgaWdub3JlIHRoaXMgc2lnbmFsIGFuZCBzaG93IGEgc3Bpbm5lciB1bnRpbFxuICAgICAgICAvLyB0aGVyZSdzIGEgbmV3IHNjcmVlbiB0byBzaG93IHRoZSB1c2VyLiBUaGlzIGlzIGltcGxlbWVudGVkIGJ5IHNldHRpbmdcbiAgICAgICAgLy8gYGJ1c3k6IGZhbHNlYCBpbiBgX2F1dGhTdGF0ZVVwZGF0ZWRgLlxuICAgICAgICAvLyBTZWUgYWxzbyBodHRwczovL2dpdGh1Yi5jb20vdmVjdG9yLWltL3Jpb3Qtd2ViL2lzc3Vlcy8xMjU0NlxuICAgIH0sXG5cbiAgICBfc2V0Rm9jdXM6IGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5fc3RhZ2VDb21wb25lbnQuY3VycmVudCAmJiB0aGlzLl9zdGFnZUNvbXBvbmVudC5jdXJyZW50LmZvY3VzKSB7XG4gICAgICAgICAgICB0aGlzLl9zdGFnZUNvbXBvbmVudC5jdXJyZW50LmZvY3VzKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX3N1Ym1pdEF1dGhEaWN0OiBmdW5jdGlvbihhdXRoRGF0YSkge1xuICAgICAgICB0aGlzLl9hdXRoTG9naWMuc3VibWl0QXV0aERpY3QoYXV0aERhdGEpO1xuICAgIH0sXG5cbiAgICBfb25QaGFzZUNoYW5nZTogZnVuY3Rpb24obmV3UGhhc2UpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25TdGFnZVBoYXNlQ2hhbmdlKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uU3RhZ2VQaGFzZUNoYW5nZSh0aGlzLnN0YXRlLmF1dGhTdGFnZSwgbmV3UGhhc2UgfHwgMCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX29uU3RhZ2VDYW5jZWw6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnByb3BzLm9uQXV0aEZpbmlzaGVkKGZhbHNlLCBFUlJPUl9VU0VSX0NBTkNFTExFRCk7XG4gICAgfSxcblxuICAgIF9yZW5kZXJDdXJyZW50U3RhZ2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCBzdGFnZSA9IHRoaXMuc3RhdGUuYXV0aFN0YWdlO1xuICAgICAgICBpZiAoIXN0YWdlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5idXN5KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgTG9hZGVyID0gc2RrLmdldENvbXBvbmVudChcImVsZW1lbnRzLlNwaW5uZXJcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxMb2FkZXIgLz47XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgU3RhZ2VDb21wb25lbnQgPSBnZXRFbnRyeUNvbXBvbmVudEZvckxvZ2luVHlwZShzdGFnZSk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8U3RhZ2VDb21wb25lbnRcbiAgICAgICAgICAgICAgICByZWY9e3RoaXMuX3N0YWdlQ29tcG9uZW50fVxuICAgICAgICAgICAgICAgIGxvZ2luVHlwZT17c3RhZ2V9XG4gICAgICAgICAgICAgICAgbWF0cml4Q2xpZW50PXt0aGlzLnByb3BzLm1hdHJpeENsaWVudH1cbiAgICAgICAgICAgICAgICBhdXRoU2Vzc2lvbklkPXt0aGlzLl9hdXRoTG9naWMuZ2V0U2Vzc2lvbklkKCl9XG4gICAgICAgICAgICAgICAgY2xpZW50U2VjcmV0PXt0aGlzLl9hdXRoTG9naWMuZ2V0Q2xpZW50U2VjcmV0KCl9XG4gICAgICAgICAgICAgICAgc3RhZ2VQYXJhbXM9e3RoaXMuX2F1dGhMb2dpYy5nZXRTdGFnZVBhcmFtcyhzdGFnZSl9XG4gICAgICAgICAgICAgICAgc3VibWl0QXV0aERpY3Q9e3RoaXMuX3N1Ym1pdEF1dGhEaWN0fVxuICAgICAgICAgICAgICAgIGVycm9yVGV4dD17dGhpcy5zdGF0ZS5zdGFnZUVycm9yVGV4dH1cbiAgICAgICAgICAgICAgICBidXN5PXt0aGlzLnN0YXRlLmJ1c3l9XG4gICAgICAgICAgICAgICAgaW5wdXRzPXt0aGlzLnByb3BzLmlucHV0c31cbiAgICAgICAgICAgICAgICBzdGFnZVN0YXRlPXt0aGlzLnN0YXRlLnN0YWdlU3RhdGV9XG4gICAgICAgICAgICAgICAgZmFpbD17dGhpcy5fb25BdXRoU3RhZ2VGYWlsZWR9XG4gICAgICAgICAgICAgICAgc2V0RW1haWxTaWQ9e3RoaXMuX3NldEVtYWlsU2lkfVxuICAgICAgICAgICAgICAgIHNob3dDb250aW51ZT17IXRoaXMucHJvcHMuY29udGludWVJc01hbmFnZWR9XG4gICAgICAgICAgICAgICAgb25QaGFzZUNoYW5nZT17dGhpcy5fb25QaGFzZUNoYW5nZX1cbiAgICAgICAgICAgICAgICBjb250aW51ZVRleHQ9e3RoaXMucHJvcHMuY29udGludWVUZXh0fVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZD17dGhpcy5wcm9wcy5jb250aW51ZUtpbmR9XG4gICAgICAgICAgICAgICAgb25DYW5jZWw9e3RoaXMuX29uU3RhZ2VDYW5jZWx9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICBfb25BdXRoU3RhZ2VGYWlsZWQ6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkF1dGhGaW5pc2hlZChmYWxzZSwgZSk7XG4gICAgfSxcbiAgICBfc2V0RW1haWxTaWQ6IGZ1bmN0aW9uKHNpZCkge1xuICAgICAgICB0aGlzLl9hdXRoTG9naWMuc2V0RW1haWxTaWQoc2lkKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgbGV0IGVycm9yID0gbnVsbDtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZXJyb3JUZXh0KSB7XG4gICAgICAgICAgICBlcnJvciA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImVycm9yXCI+XG4gICAgICAgICAgICAgICAgICAgIHsgdGhpcy5zdGF0ZS5lcnJvclRleHQgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIHsgdGhpcy5fcmVuZGVyQ3VycmVudFN0YWdlKCkgfVxuICAgICAgICAgICAgICAgICAgICB7IGVycm9yIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG59KTtcbiJdfQ==