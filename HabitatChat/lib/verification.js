"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.verifyDevice = verifyDevice;
exports.legacyVerifyUser = legacyVerifyUser;
exports.verifyUser = verifyUser;
exports.pendingVerificationRequestForUser = pendingVerificationRequestForUser;

var _MatrixClientPeg = require("./MatrixClientPeg");

var _dispatcher = _interopRequireDefault(require("./dispatcher/dispatcher"));

var _Modal = _interopRequireDefault(require("./Modal"));

var sdk = _interopRequireWildcard(require("./index"));

var _languageHandler = require("./languageHandler");

var _RightPanelStorePhases = require("./stores/RightPanelStorePhases");

var _createRoom = require("./createRoom");

var _CrossSigningManager = require("./CrossSigningManager");

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _crypto = require("matrix-js-sdk/src/crypto");

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
async function enable4SIfNeeded() {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  if (!cli.isCryptoEnabled() || !_SettingsStore.default.getValue("feature_cross_signing")) {
    return false;
  }

  const usk = cli.getCrossSigningId("user_signing");

  if (!usk) {
    await (0, _CrossSigningManager.accessSecretStorage)();
    return false;
  }

  return true;
}

function UntrustedDeviceDialog(props) {
  const {
    device,
    user,
    onFinished
  } = props;
  const BaseDialog = sdk.getComponent("dialogs.BaseDialog");
  const AccessibleButton = sdk.getComponent("elements.AccessibleButton");
  let askToVerifyText;
  let newSessionText;

  if (_MatrixClientPeg.MatrixClientPeg.get().getUserId() === user.userId) {
    newSessionText = (0, _languageHandler._t)("You signed in to a new session without verifying it:");
    askToVerifyText = (0, _languageHandler._t)("Verify your other session using one of the options below.");
  } else {
    newSessionText = (0, _languageHandler._t)("%(name)s (%(userId)s) signed in to a new session without verifying it:", {
      name: user.displayName,
      userId: user.userId
    });
    askToVerifyText = (0, _languageHandler._t)("Ask this user to verify their session, or manually verify it below.");
  }

  return /*#__PURE__*/React.createElement(BaseDialog, {
    onFinished: onFinished,
    headerImage: require("../res/img/e2e/warning.svg"),
    title: (0, _languageHandler._t)("Not Trusted")
  }, /*#__PURE__*/React.createElement("div", {
    className: "mx_Dialog_content",
    id: "mx_Dialog_content"
  }, /*#__PURE__*/React.createElement("p", null, newSessionText), /*#__PURE__*/React.createElement("p", null, device.getDisplayName(), " (", device.deviceId, ")"), /*#__PURE__*/React.createElement("p", null, askToVerifyText)), /*#__PURE__*/React.createElement("div", {
    className: "mx_Dialog_buttons"
  }, /*#__PURE__*/React.createElement(AccessibleButton, {
    element: "button",
    kind: "secondary",
    onClick: () => onFinished("legacy")
  }, (0, _languageHandler._t)("Manually Verify by Text")), /*#__PURE__*/React.createElement(AccessibleButton, {
    element: "button",
    kind: "secondary",
    onClick: () => onFinished("sas")
  }, (0, _languageHandler._t)("Interactively verify by Emoji")), /*#__PURE__*/React.createElement(AccessibleButton, {
    kind: "primary",
    onClick: () => onFinished()
  }, (0, _languageHandler._t)("Done"))));
}

async function verifyDevice(user, device) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get(); // if cross-signing is not explicitly disabled, check if it should be enabled first.


  if (cli.getCryptoTrustCrossSignedDevices()) {
    if (!(await enable4SIfNeeded())) {
      return;
    }
  }

  _Modal.default.createTrackedDialog("Verification warning", "unverified session", UntrustedDeviceDialog, {
    user,
    device,
    onFinished: async action => {
      if (action === "sas") {
        const verificationRequestPromise = cli.legacyDeviceVerification(user.userId, device.deviceId, _crypto.verificationMethods.SAS);

        _dispatcher.default.dispatch({
          action: "set_right_panel_phase",
          phase: _RightPanelStorePhases.RIGHT_PANEL_PHASES.EncryptionPanel,
          refireParams: {
            member: user,
            verificationRequestPromise
          }
        });
      } else if (action === "legacy") {
        const ManualDeviceKeyVerificationDialog = sdk.getComponent("dialogs.ManualDeviceKeyVerificationDialog");

        _Modal.default.createTrackedDialog("Legacy verify session", "legacy verify session", ManualDeviceKeyVerificationDialog, {
          userId: user.userId,
          device
        });
      }
    }
  });
}

async function legacyVerifyUser(user) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get(); // if cross-signing is not explicitly disabled, check if it should be enabled first.


  if (cli.getCryptoTrustCrossSignedDevices()) {
    if (!(await enable4SIfNeeded())) {
      return;
    }
  }

  const verificationRequestPromise = cli.requestVerification(user.userId);

  _dispatcher.default.dispatch({
    action: "set_right_panel_phase",
    phase: _RightPanelStorePhases.RIGHT_PANEL_PHASES.EncryptionPanel,
    refireParams: {
      member: user,
      verificationRequestPromise
    }
  });
}

async function verifyUser(user) {
  if (!(await enable4SIfNeeded())) {
    return;
  }

  const existingRequest = pendingVerificationRequestForUser(user);

  _dispatcher.default.dispatch({
    action: "set_right_panel_phase",
    phase: _RightPanelStorePhases.RIGHT_PANEL_PHASES.EncryptionPanel,
    refireParams: {
      member: user,
      verificationRequest: existingRequest
    }
  });
}

function pendingVerificationRequestForUser(user) {
  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  const dmRoom = (0, _createRoom.findDMForUser)(cli, user.userId);

  if (dmRoom) {
    return cli.findVerificationRequestDMInProgress(dmRoom.roomId);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy92ZXJpZmljYXRpb24uanMiXSwibmFtZXMiOlsiZW5hYmxlNFNJZk5lZWRlZCIsImNsaSIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImlzQ3J5cHRvRW5hYmxlZCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsInVzayIsImdldENyb3NzU2lnbmluZ0lkIiwiVW50cnVzdGVkRGV2aWNlRGlhbG9nIiwicHJvcHMiLCJkZXZpY2UiLCJ1c2VyIiwib25GaW5pc2hlZCIsIkJhc2VEaWFsb2ciLCJzZGsiLCJnZXRDb21wb25lbnQiLCJBY2Nlc3NpYmxlQnV0dG9uIiwiYXNrVG9WZXJpZnlUZXh0IiwibmV3U2Vzc2lvblRleHQiLCJnZXRVc2VySWQiLCJ1c2VySWQiLCJuYW1lIiwiZGlzcGxheU5hbWUiLCJyZXF1aXJlIiwiZ2V0RGlzcGxheU5hbWUiLCJkZXZpY2VJZCIsInZlcmlmeURldmljZSIsImdldENyeXB0b1RydXN0Q3Jvc3NTaWduZWREZXZpY2VzIiwiTW9kYWwiLCJjcmVhdGVUcmFja2VkRGlhbG9nIiwiYWN0aW9uIiwidmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UiLCJsZWdhY3lEZXZpY2VWZXJpZmljYXRpb24iLCJ2ZXJpZmljYXRpb25NZXRob2RzIiwiU0FTIiwiZGlzIiwiZGlzcGF0Y2giLCJwaGFzZSIsIlJJR0hUX1BBTkVMX1BIQVNFUyIsIkVuY3J5cHRpb25QYW5lbCIsInJlZmlyZVBhcmFtcyIsIm1lbWJlciIsIk1hbnVhbERldmljZUtleVZlcmlmaWNhdGlvbkRpYWxvZyIsImxlZ2FjeVZlcmlmeVVzZXIiLCJyZXF1ZXN0VmVyaWZpY2F0aW9uIiwidmVyaWZ5VXNlciIsImV4aXN0aW5nUmVxdWVzdCIsInBlbmRpbmdWZXJpZmljYXRpb25SZXF1ZXN0Rm9yVXNlciIsInZlcmlmaWNhdGlvblJlcXVlc3QiLCJkbVJvb20iLCJmaW5kVmVyaWZpY2F0aW9uUmVxdWVzdERNSW5Qcm9ncmVzcyIsInJvb21JZCJdLCJtYXBwaW5n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SUFBSSxDQUFDUyxNQUF4QixDQUFmOztBQUNBLE1BQUk2QixNQUFKLEVBQVk7QUFDUixXQUFPakQsR0FBRyxDQUFDa0QsbUNBQUosQ0FBd0NELE1BQU0sQ0FBQ0UsTUFBL0MsQ0FBUDtBQUNIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSAnLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCBNb2RhbCBmcm9tICcuL01vZGFsJztcbmltcG9ydCAqIGFzIHNkayBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7IF90IH0gZnJvbSAnLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHtSSUdIVF9QQU5FTF9QSEFTRVN9IGZyb20gXCIuL3N0b3Jlcy9SaWdodFBhbmVsU3RvcmVQaGFzZXNcIjtcbmltcG9ydCB7ZmluZERNRm9yVXNlcn0gZnJvbSAnLi9jcmVhdGVSb29tJztcbmltcG9ydCB7YWNjZXNzU2VjcmV0U3RvcmFnZX0gZnJvbSAnLi9Dcm9zc1NpZ25pbmdNYW5hZ2VyJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gJy4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZSc7XG5pbXBvcnQge3ZlcmlmaWNhdGlvbk1ldGhvZHN9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL2NyeXB0byc7XG5cbmFzeW5jIGZ1bmN0aW9uIGVuYWJsZTRTSWZOZWVkZWQoKSB7XG4gICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgIGlmICghY2xpLmlzQ3J5cHRvRW5hYmxlZCgpIHx8ICFTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiZmVhdHVyZV9jcm9zc19zaWduaW5nXCIpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgdXNrID0gY2xpLmdldENyb3NzU2lnbmluZ0lkKFwidXNlcl9zaWduaW5nXCIpO1xuICAgIGlmICghdXNrKSB7XG4gICAgICAgIGF3YWl0IGFjY2Vzc1NlY3JldFN0b3JhZ2UoKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBVbnRydXN0ZWREZXZpY2VEaWFsb2cocHJvcHMpIHtcbiAgICBjb25zdCB7ZGV2aWNlLCB1c2VyLCBvbkZpbmlzaGVkfSA9IHByb3BzO1xuICAgIGNvbnN0IEJhc2VEaWFsb2cgPSBzZGsuZ2V0Q29tcG9uZW50KFwiZGlhbG9ncy5CYXNlRGlhbG9nXCIpO1xuICAgIGNvbnN0IEFjY2Vzc2libGVCdXR0b24gPSBzZGsuZ2V0Q29tcG9uZW50KFwiZWxlbWVudHMuQWNjZXNzaWJsZUJ1dHRvblwiKTtcbiAgICBsZXQgYXNrVG9WZXJpZnlUZXh0O1xuICAgIGxldCBuZXdTZXNzaW9uVGV4dDtcblxuICAgIGlmIChNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0VXNlcklkKCkgPT09IHVzZXIudXNlcklkKSB7XG4gICAgICAgIG5ld1Nlc3Npb25UZXh0ID0gX3QoXCJZb3Ugc2lnbmVkIGluIHRvIGEgbmV3IHNlc3Npb24gd2l0aG91dCB2ZXJpZnlpbmcgaXQ6XCIpO1xuICAgICAgICBhc2tUb1ZlcmlmeVRleHQgPSBfdChcIlZlcmlmeSB5b3VyIG90aGVyIHNlc3Npb24gdXNpbmcgb25lIG9mIHRoZSBvcHRpb25zIGJlbG93LlwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBuZXdTZXNzaW9uVGV4dCA9IF90KFwiJShuYW1lKXMgKCUodXNlcklkKXMpIHNpZ25lZCBpbiB0byBhIG5ldyBzZXNzaW9uIHdpdGhvdXQgdmVyaWZ5aW5nIGl0OlwiLFxuICAgICAgICAgICAge25hbWU6IHVzZXIuZGlzcGxheU5hbWUsIHVzZXJJZDogdXNlci51c2VySWR9KTtcbiAgICAgICAgYXNrVG9WZXJpZnlUZXh0ID0gX3QoXCJBc2sgdGhpcyB1c2VyIHRvIHZlcmlmeSB0aGVpciBzZXNzaW9uLCBvciBtYW51YWxseSB2ZXJpZnkgaXQgYmVsb3cuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiA8QmFzZURpYWxvZ1xuICAgICAgICBvbkZpbmlzaGVkPXtvbkZpbmlzaGVkfVxuICAgICAgICBoZWFkZXJJbWFnZT17cmVxdWlyZShcIi4uL3Jlcy9pbWcvZTJlL3dhcm5pbmcuc3ZnXCIpfVxuICAgICAgICB0aXRsZT17X3QoXCJOb3QgVHJ1c3RlZFwiKX0+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfRGlhbG9nX2NvbnRlbnRcIiBpZD0nbXhfRGlhbG9nX2NvbnRlbnQnPlxuICAgICAgICAgICAgPHA+e25ld1Nlc3Npb25UZXh0fTwvcD5cbiAgICAgICAgICAgIDxwPntkZXZpY2UuZ2V0RGlzcGxheU5hbWUoKX0gKHtkZXZpY2UuZGV2aWNlSWR9KTwvcD5cbiAgICAgICAgICAgIDxwPnthc2tUb1ZlcmlmeVRleHR9PC9wPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J214X0RpYWxvZ19idXR0b25zJz5cbiAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGVsZW1lbnQ9XCJidXR0b25cIiBraW5kPVwic2Vjb25kYXJ5XCIgb25DbGljaz17KCkgPT4gb25GaW5pc2hlZChcImxlZ2FjeVwiKX0+e190KFwiTWFudWFsbHkgVmVyaWZ5IGJ5IFRleHRcIil9PC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gZWxlbWVudD1cImJ1dHRvblwiIGtpbmQ9XCJzZWNvbmRhcnlcIiBvbkNsaWNrPXsoKSA9PiBvbkZpbmlzaGVkKFwic2FzXCIpfT57X3QoXCJJbnRlcmFjdGl2ZWx5IHZlcmlmeSBieSBFbW9qaVwiKX08L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBraW5kPVwicHJpbWFyeVwiIG9uQ2xpY2s9eygpID0+IG9uRmluaXNoZWQoKX0+e190KFwiRG9uZVwiKX08L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgIDwvZGl2PlxuICAgIDwvQmFzZURpYWxvZz47XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlEZXZpY2UodXNlciwgZGV2aWNlKSB7XG4gICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgIC8vIGlmIGNyb3NzLXNpZ25pbmcgaXMgbm90IGV4cGxpY2l0bHkgZGlzYWJsZWQsIGNoZWNrIGlmIGl0IHNob3VsZCBiZSBlbmFibGVkIGZpcnN0LlxuICAgIGlmIChjbGkuZ2V0Q3J5cHRvVHJ1c3RDcm9zc1NpZ25lZERldmljZXMoKSkge1xuICAgICAgICBpZiAoIWF3YWl0IGVuYWJsZTRTSWZOZWVkZWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgTW9kYWwuY3JlYXRlVHJhY2tlZERpYWxvZyhcIlZlcmlmaWNhdGlvbiB3YXJuaW5nXCIsIFwidW52ZXJpZmllZCBzZXNzaW9uXCIsIFVudHJ1c3RlZERldmljZURpYWxvZywge1xuICAgICAgICB1c2VyLFxuICAgICAgICBkZXZpY2UsXG4gICAgICAgIG9uRmluaXNoZWQ6IGFzeW5jIChhY3Rpb24pID0+IHtcbiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09IFwic2FzXCIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSA9IGNsaS5sZWdhY3lEZXZpY2VWZXJpZmljYXRpb24oXG4gICAgICAgICAgICAgICAgICAgIHVzZXIudXNlcklkLFxuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuZGV2aWNlSWQsXG4gICAgICAgICAgICAgICAgICAgIHZlcmlmaWNhdGlvbk1ldGhvZHMuU0FTLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBcInNldF9yaWdodF9wYW5lbF9waGFzZVwiLFxuICAgICAgICAgICAgICAgICAgICBwaGFzZTogUklHSFRfUEFORUxfUEhBU0VTLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgICAgICAgICAgICAgcmVmaXJlUGFyYW1zOiB7bWVtYmVyOiB1c2VyLCB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZX0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJsZWdhY3lcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0IE1hbnVhbERldmljZUtleVZlcmlmaWNhdGlvbkRpYWxvZyA9XG4gICAgICAgICAgICAgICAgICAgIHNkay5nZXRDb21wb25lbnQoXCJkaWFsb2dzLk1hbnVhbERldmljZUtleVZlcmlmaWNhdGlvbkRpYWxvZ1wiKTtcbiAgICAgICAgICAgICAgICBNb2RhbC5jcmVhdGVUcmFja2VkRGlhbG9nKFwiTGVnYWN5IHZlcmlmeSBzZXNzaW9uXCIsIFwibGVnYWN5IHZlcmlmeSBzZXNzaW9uXCIsXG4gICAgICAgICAgICAgICAgICAgIE1hbnVhbERldmljZUtleVZlcmlmaWNhdGlvbkRpYWxvZyxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkOiB1c2VyLnVzZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGVnYWN5VmVyaWZ5VXNlcih1c2VyKSB7XG4gICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgIC8vIGlmIGNyb3NzLXNpZ25pbmcgaXMgbm90IGV4cGxpY2l0bHkgZGlzYWJsZWQsIGNoZWNrIGlmIGl0IHNob3VsZCBiZSBlbmFibGVkIGZpcnN0LlxuICAgIGlmIChjbGkuZ2V0Q3J5cHRvVHJ1c3RDcm9zc1NpZ25lZERldmljZXMoKSkge1xuICAgICAgICBpZiAoIWF3YWl0IGVuYWJsZTRTSWZOZWVkZWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlID0gY2xpLnJlcXVlc3RWZXJpZmljYXRpb24odXNlci51c2VySWQpO1xuICAgIGRpcy5kaXNwYXRjaCh7XG4gICAgICAgIGFjdGlvbjogXCJzZXRfcmlnaHRfcGFuZWxfcGhhc2VcIixcbiAgICAgICAgcGhhc2U6IFJJR0hUX1BBTkVMX1BIQVNFUy5FbmNyeXB0aW9uUGFuZWwsXG4gICAgICAgIHJlZmlyZVBhcmFtczoge21lbWJlcjogdXNlciwgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2V9LFxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5VXNlcih1c2VyKSB7XG4gICAgaWYgKCFhd2FpdCBlbmFibGU0U0lmTmVlZGVkKCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBleGlzdGluZ1JlcXVlc3QgPSBwZW5kaW5nVmVyaWZpY2F0aW9uUmVxdWVzdEZvclVzZXIodXNlcik7XG4gICAgZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgYWN0aW9uOiBcInNldF9yaWdodF9wYW5lbF9waGFzZVwiLFxuICAgICAgICBwaGFzZTogUklHSFRfUEFORUxfUEhBU0VTLkVuY3J5cHRpb25QYW5lbCxcbiAgICAgICAgcmVmaXJlUGFyYW1zOiB7XG4gICAgICAgICAgICBtZW1iZXI6IHVzZXIsXG4gICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0OiBleGlzdGluZ1JlcXVlc3QsXG4gICAgICAgIH0sXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZW5kaW5nVmVyaWZpY2F0aW9uUmVxdWVzdEZvclVzZXIodXNlcikge1xuICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICBjb25zdCBkbVJvb20gPSBmaW5kRE1Gb3JVc2VyKGNsaSwgdXNlci51c2VySWQpO1xuICAgIGlmIChkbVJvb20pIHtcbiAgICAgICAgcmV0dXJuIGNsaS5maW5kVmVyaWZpY2F0aW9uUmVxdWVzdERNSW5Qcm9ncmVzcyhkbVJvb20ucm9vbUlkKTtcbiAgICB9XG59XG4iXX0=