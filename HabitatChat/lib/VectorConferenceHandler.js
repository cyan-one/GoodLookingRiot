"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConferenceCall = ConferenceCall;
exports.isConferenceUser = isConferenceUser;
exports.getConferenceUserIdForRoom = getConferenceUserIdForRoom;
exports.createNewMatrixCall = createNewMatrixCall;
exports.getConferenceCallForRoom = getConferenceCallForRoom;
exports.slot = void 0;

var _matrixJsSdk = require("matrix-js-sdk");

var _CallHandler = _interopRequireDefault(require("./CallHandler"));

var _MatrixClientPeg = require("./MatrixClientPeg");

/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// FIXME: this is Riot (Vector) specific code, but will be removed shortly when
// we switch over to jitsi entirely for video conferencing.
// FIXME: This currently forces Vector to try to hit the matrix.org AS for conferencing.
// This is bad because it prevents people running their own ASes from being used.
// This isn't permanent and will be customisable in the future: see the proposal
// at docs/conferencing.md for more info.
const USER_PREFIX = "fs_";
const DOMAIN = "matrix.org";

function ConferenceCall(matrixClient, groupChatRoomId) {
  this.client = matrixClient;
  this.groupRoomId = groupChatRoomId;
  this.confUserId = getConferenceUserIdForRoom(this.groupRoomId);
}

ConferenceCall.prototype.setup = function () {
  const self = this;
  return this._joinConferenceUser().then(function () {
    return self._getConferenceUserRoom();
  }).then(function (room) {
    // return a call for *this* room to be placed. We also tack on
    // confUserId to speed up lookups (else we'd need to loop every room
    // looking for a 1:1 room with this conf user ID!)
    const call = (0, _matrixJsSdk.createNewMatrixCall)(self.client, room.roomId);
    call.confUserId = self.confUserId;
    call.groupRoomId = self.groupRoomId;
    return call;
  });
};

ConferenceCall.prototype._joinConferenceUser = function () {
  // Make sure the conference user is in the group chat room
  const groupRoom = this.client.getRoom(this.groupRoomId);

  if (!groupRoom) {
    return Promise.reject("Bad group room ID");
  }

  const member = groupRoom.getMember(this.confUserId);

  if (member && member.membership === "join") {
    return Promise.resolve();
  }

  return this.client.invite(this.groupRoomId, this.confUserId);
};

ConferenceCall.prototype._getConferenceUserRoom = function () {
  // Use an existing 1:1 with the conference user; else make one
  const rooms = this.client.getRooms();
  let confRoom = null;

  for (let i = 0; i < rooms.length; i++) {
    const confUser = rooms[i].getMember(this.confUserId);

    if (confUser && confUser.membership === "join" && rooms[i].getJoinedMemberCount() === 2) {
      confRoom = rooms[i];
      break;
    }
  }

  if (confRoom) {
    return Promise.resolve(confRoom);
  }

  return this.client.createRoom({
    preset: "private_chat",
    invite: [this.confUserId]
  }).then(function (res) {
    return new _matrixJsSdk.Room(res.room_id, null, _MatrixClientPeg.MatrixClientPeg.get().getUserId());
  });
};
/**
 * Check if this user ID is in fact a conference bot.
 * @param {string} userId The user ID to check.
 * @return {boolean} True if it is a conference bot.
 */


function isConferenceUser(userId) {
  if (userId.indexOf("@" + USER_PREFIX) !== 0) {
    return false;
  }

  const base64part = userId.split(":")[0].substring(1 + USER_PREFIX.length);

  if (base64part) {
    const decoded = new Buffer(base64part, "base64").toString(); // ! $STUFF : $STUFF

    return /^!.+:.+/.test(decoded);
  }

  return false;
}

function getConferenceUserIdForRoom(roomId) {
  // abuse browserify's core node Buffer support (strip padding ='s)
  const base64RoomId = new Buffer(roomId).toString("base64").replace(/=/g, "");
  return "@" + USER_PREFIX + base64RoomId + ":" + DOMAIN;
}

function createNewMatrixCall(client, roomId) {
  const confCall = new ConferenceCall(client, roomId);
  return confCall.setup();
}

function getConferenceCallForRoom(roomId) {
  // search for a conference 1:1 call for this group chat room ID
  const activeCall = _CallHandler.default.getAnyActiveCall();

  if (activeCall && activeCall.confUserId) {
    const thisRoomConfUserId = getConferenceUserIdForRoom(roomId);

    if (thisRoomConfUserId === activeCall.confUserId) {
      return activeCall;
    }
  }

  return null;
} // TODO: Document this.


const slot = 'conference';
exports.slot = slot;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9WZWN0b3JDb25mZXJlbmNlSGFuZGxlci5qcyJdLCJuYW1lcyI6WyJVU0VSX1BSRUZJWCIsIkRPTUFJTiIsIkNvbmZlcmVuY2VDYWxsIiwibWF0cml4Q2xpZW50IiwiZ3JvdXBDaGF0Um9vbUlkIiwiY2xpZW50IiwiZ3JvdXBSb29tSWQiLCJjb25mVXNlcklkIiwiZ2V0Q29uZmVyZW5jZVVzZXJJZEZvclJvb20iLCJwcm90b3R5cGUiLCJzZXR1cCIsInNlbGYiLCJfam9pbkNvbmZlcmVuY2VVc2VyIiwidGhlbiIsIl9nZXRDb25mZXJlbmNlVXNlclJvb20iLCJyb29tIiwiY2FsbCIsInJvb21JZCIsImdyb3VwUm9vbSIsImdldFJvb20iLCJQcm9taXNlIiwicmVqZWN0IiwibWVtYmVyIiwiZ2V0TWVtYmVyIiwibWVtYmVyc2hpcCIsInJlc29sdmUiLCJpbnZpdGUiLCJyb29tcyIsImdldFJvb21zIiwiY29uZlJvb20iLCJpIiwibGVuZ3RoIiwiY29uZlVzZXIiLCJnZXRKb2luZWRNZW1iZXJDb3VudCIsImNyZWF0ZVJvb20iLCJwcmVzZXQiLCJyZXMiLCJSb29tIiwicm9vbV9pZCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsImlzQ29uZmVyZW5jZVVzZXIiLCJ1c2VySWQiLCJpbmRleE9mIiwiYmFzZTY0cGFydCIsInNwbGl0Iiwic3Vic3RyaW5nIiwiZGVjb2RlZCIsIkJ1ZmZlciIsInRvU3RyaW5nIiwidGVzdCIsImJhc2U2NFJvb21JZCIsInJlcGxhY2UiLCJjcmVhdGVOZXdNYXRyaXhDYWxsIiwiY29uZkNhbGwiLCJnZXRDb25mZXJlbmNlQ2FsbEZvclJvb20iLCJhY3RpdmVDYWxsIiwiQ2FsbEhhbmRsZXIiLCJnZXRBbnlBY3RpdmVDYWxsIiwidGhpc1Jvb21Db25mVXNlcklkIiwic2xvdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBbkJBOzs7Ozs7Ozs7Ozs7Ozs7O0FB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O0FBR0EsU0FBT3NDLFFBQVEsQ0FBQzdDLEtBQVQsRUFBUDtBQUNIOztBQUVNLFNBQVM4Qyx3QkFBVCxDQUFrQ3ZDLE1BQWxDLEVBQTBDO0FBQzdDO0FBQ0EsUUFBTXdDLFVBQVUsR0FBR0MscUJBQVlDLGdCQUFaLEVBQW5COztBQUNBLE1BQUlGLFVBQVUsSUFBSUEsVUFBVSxDQUFDbEQsVUFBN0IsRUFBeUM7QUFDckMsVUFBTXFELGtCQUFrQixHQUFHcEQsMEJBQTBCLENBQ2pEUyxNQURpRCxDQUFyRDs7QUFHQSxRQUFJMkMsa0JBQWtCLEtBQUtILFVBQVUsQ0FBQ2xELFVBQXRDLEVBQWtEO0FBQzlDLGFBQU9rRCxVQUFQO0FBQ0g7QUFDSjs7QUFDRCxTQUFPLElBQVA7QUFDSCxDLENBRUQ7OztBQUNPLE1BQU1JLElBQUksR0FBRyxZQUFiIiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE1LCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7Y3JlYXRlTmV3TWF0cml4Q2FsbCBhcyBqc0NyZWF0ZU5ld01hdHJpeENhbGwsIFJvb219IGZyb20gXCJtYXRyaXgtanMtc2RrXCI7XG5pbXBvcnQgQ2FsbEhhbmRsZXIgZnJvbSAnLi9DYWxsSGFuZGxlcic7XG5pbXBvcnQge01hdHJpeENsaWVudFBlZ30gZnJvbSBcIi4vTWF0cml4Q2xpZW50UGVnXCI7XG5cbi8vIEZJWE1FOiB0aGlzIGlzIFJpb3QgKFZlY3Rvcikgc3BlY2lmaWMgY29kZSwgYnV0IHdpbGwgYmUgcmVtb3ZlZCBzaG9ydGx5IHdoZW5cbi8vIHdlIHN3aXRjaCBvdmVyIHRvIGppdHNpIGVudGlyZWx5IGZvciB2aWRlbyBjb25mZXJlbmNpbmcuXG5cbi8vIEZJWE1FOiBUaGlzIGN1cnJlbnRseSBmb3JjZXMgVmVjdG9yIHRvIHRyeSB0byBoaXQgdGhlIG1hdHJpeC5vcmcgQVMgZm9yIGNvbmZlcmVuY2luZy5cbi8vIFRoaXMgaXMgYmFkIGJlY2F1c2UgaXQgcHJldmVudHMgcGVvcGxlIHJ1bm5pbmcgdGhlaXIgb3duIEFTZXMgZnJvbSBiZWluZyB1c2VkLlxuLy8gVGhpcyBpc24ndCBwZXJtYW5lbnQgYW5kIHdpbGwgYmUgY3VzdG9taXNhYmxlIGluIHRoZSBmdXR1cmU6IHNlZSB0aGUgcHJvcG9zYWxcbi8vIGF0IGRvY3MvY29uZmVyZW5jaW5nLm1kIGZvciBtb3JlIGluZm8uXG5jb25zdCBVU0VSX1BSRUZJWCA9IFwiZnNfXCI7XG5jb25zdCBET01BSU4gPSBcIm1hdHJpeC5vcmdcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIENvbmZlcmVuY2VDYWxsKG1hdHJpeENsaWVudCwgZ3JvdXBDaGF0Um9vbUlkKSB7XG4gICAgdGhpcy5jbGllbnQgPSBtYXRyaXhDbGllbnQ7XG4gICAgdGhpcy5ncm91cFJvb21JZCA9IGdyb3VwQ2hhdFJvb21JZDtcbiAgICB0aGlzLmNvbmZVc2VySWQgPSBnZXRDb25mZXJlbmNlVXNlcklkRm9yUm9vbSh0aGlzLmdyb3VwUm9vbUlkKTtcbn1cblxuQ29uZmVyZW5jZUNhbGwucHJvdG90eXBlLnNldHVwID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIHRoaXMuX2pvaW5Db25mZXJlbmNlVXNlcigpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBzZWxmLl9nZXRDb25mZXJlbmNlVXNlclJvb20oKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uKHJvb20pIHtcbiAgICAgICAgLy8gcmV0dXJuIGEgY2FsbCBmb3IgKnRoaXMqIHJvb20gdG8gYmUgcGxhY2VkLiBXZSBhbHNvIHRhY2sgb25cbiAgICAgICAgLy8gY29uZlVzZXJJZCB0byBzcGVlZCB1cCBsb29rdXBzIChlbHNlIHdlJ2QgbmVlZCB0byBsb29wIGV2ZXJ5IHJvb21cbiAgICAgICAgLy8gbG9va2luZyBmb3IgYSAxOjEgcm9vbSB3aXRoIHRoaXMgY29uZiB1c2VyIElEISlcbiAgICAgICAgY29uc3QgY2FsbCA9IGpzQ3JlYXRlTmV3TWF0cml4Q2FsbChzZWxmLmNsaWVudCwgcm9vbS5yb29tSWQpO1xuICAgICAgICBjYWxsLmNvbmZVc2VySWQgPSBzZWxmLmNvbmZVc2VySWQ7XG4gICAgICAgIGNhbGwuZ3JvdXBSb29tSWQgPSBzZWxmLmdyb3VwUm9vbUlkO1xuICAgICAgICByZXR1cm4gY2FsbDtcbiAgICB9KTtcbn07XG5cbkNvbmZlcmVuY2VDYWxsLnByb3RvdHlwZS5fam9pbkNvbmZlcmVuY2VVc2VyID0gZnVuY3Rpb24oKSB7XG4gICAgLy8gTWFrZSBzdXJlIHRoZSBjb25mZXJlbmNlIHVzZXIgaXMgaW4gdGhlIGdyb3VwIGNoYXQgcm9vbVxuICAgIGNvbnN0IGdyb3VwUm9vbSA9IHRoaXMuY2xpZW50LmdldFJvb20odGhpcy5ncm91cFJvb21JZCk7XG4gICAgaWYgKCFncm91cFJvb20pIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFwiQmFkIGdyb3VwIHJvb20gSURcIik7XG4gICAgfVxuICAgIGNvbnN0IG1lbWJlciA9IGdyb3VwUm9vbS5nZXRNZW1iZXIodGhpcy5jb25mVXNlcklkKTtcbiAgICBpZiAobWVtYmVyICYmIG1lbWJlci5tZW1iZXJzaGlwID09PSBcImpvaW5cIikge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNsaWVudC5pbnZpdGUodGhpcy5ncm91cFJvb21JZCwgdGhpcy5jb25mVXNlcklkKTtcbn07XG5cbkNvbmZlcmVuY2VDYWxsLnByb3RvdHlwZS5fZ2V0Q29uZmVyZW5jZVVzZXJSb29tID0gZnVuY3Rpb24oKSB7XG4gICAgLy8gVXNlIGFuIGV4aXN0aW5nIDE6MSB3aXRoIHRoZSBjb25mZXJlbmNlIHVzZXI7IGVsc2UgbWFrZSBvbmVcbiAgICBjb25zdCByb29tcyA9IHRoaXMuY2xpZW50LmdldFJvb21zKCk7XG4gICAgbGV0IGNvbmZSb29tID0gbnVsbDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvb21zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNvbmZVc2VyID0gcm9vbXNbaV0uZ2V0TWVtYmVyKHRoaXMuY29uZlVzZXJJZCk7XG4gICAgICAgIGlmIChjb25mVXNlciAmJiBjb25mVXNlci5tZW1iZXJzaGlwID09PSBcImpvaW5cIiAmJlxuICAgICAgICAgICAgICAgIHJvb21zW2ldLmdldEpvaW5lZE1lbWJlckNvdW50KCkgPT09IDIpIHtcbiAgICAgICAgICAgIGNvbmZSb29tID0gcm9vbXNbaV07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoY29uZlJvb20pIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjb25mUm9vbSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNsaWVudC5jcmVhdGVSb29tKHtcbiAgICAgICAgcHJlc2V0OiBcInByaXZhdGVfY2hhdFwiLFxuICAgICAgICBpbnZpdGU6IFt0aGlzLmNvbmZVc2VySWRdLFxuICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgIHJldHVybiBuZXcgUm9vbShyZXMucm9vbV9pZCwgbnVsbCwgTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpKTtcbiAgICB9KTtcbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhpcyB1c2VyIElEIGlzIGluIGZhY3QgYSBjb25mZXJlbmNlIGJvdC5cbiAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgVGhlIHVzZXIgSUQgdG8gY2hlY2suXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGl0IGlzIGEgY29uZmVyZW5jZSBib3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0NvbmZlcmVuY2VVc2VyKHVzZXJJZCkge1xuICAgIGlmICh1c2VySWQuaW5kZXhPZihcIkBcIiArIFVTRVJfUFJFRklYKSAhPT0gMCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGJhc2U2NHBhcnQgPSB1c2VySWQuc3BsaXQoXCI6XCIpWzBdLnN1YnN0cmluZygxICsgVVNFUl9QUkVGSVgubGVuZ3RoKTtcbiAgICBpZiAoYmFzZTY0cGFydCkge1xuICAgICAgICBjb25zdCBkZWNvZGVkID0gbmV3IEJ1ZmZlcihiYXNlNjRwYXJ0LCBcImJhc2U2NFwiKS50b1N0cmluZygpO1xuICAgICAgICAvLyAhICRTVFVGRiA6ICRTVFVGRlxuICAgICAgICByZXR1cm4gL14hLis6LisvLnRlc3QoZGVjb2RlZCk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbmZlcmVuY2VVc2VySWRGb3JSb29tKHJvb21JZCkge1xuICAgIC8vIGFidXNlIGJyb3dzZXJpZnkncyBjb3JlIG5vZGUgQnVmZmVyIHN1cHBvcnQgKHN0cmlwIHBhZGRpbmcgPSdzKVxuICAgIGNvbnN0IGJhc2U2NFJvb21JZCA9IG5ldyBCdWZmZXIocm9vbUlkKS50b1N0cmluZyhcImJhc2U2NFwiKS5yZXBsYWNlKC89L2csIFwiXCIpO1xuICAgIHJldHVybiBcIkBcIiArIFVTRVJfUFJFRklYICsgYmFzZTY0Um9vbUlkICsgXCI6XCIgKyBET01BSU47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVOZXdNYXRyaXhDYWxsKGNsaWVudCwgcm9vbUlkKSB7XG4gICAgY29uc3QgY29uZkNhbGwgPSBuZXcgQ29uZmVyZW5jZUNhbGwoXG4gICAgICAgIGNsaWVudCwgcm9vbUlkLFxuICAgICk7XG4gICAgcmV0dXJuIGNvbmZDYWxsLnNldHVwKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25mZXJlbmNlQ2FsbEZvclJvb20ocm9vbUlkKSB7XG4gICAgLy8gc2VhcmNoIGZvciBhIGNvbmZlcmVuY2UgMToxIGNhbGwgZm9yIHRoaXMgZ3JvdXAgY2hhdCByb29tIElEXG4gICAgY29uc3QgYWN0aXZlQ2FsbCA9IENhbGxIYW5kbGVyLmdldEFueUFjdGl2ZUNhbGwoKTtcbiAgICBpZiAoYWN0aXZlQ2FsbCAmJiBhY3RpdmVDYWxsLmNvbmZVc2VySWQpIHtcbiAgICAgICAgY29uc3QgdGhpc1Jvb21Db25mVXNlcklkID0gZ2V0Q29uZmVyZW5jZVVzZXJJZEZvclJvb20oXG4gICAgICAgICAgICByb29tSWQsXG4gICAgICAgICk7XG4gICAgICAgIGlmICh0aGlzUm9vbUNvbmZVc2VySWQgPT09IGFjdGl2ZUNhbGwuY29uZlVzZXJJZCkge1xuICAgICAgICAgICAgcmV0dXJuIGFjdGl2ZUNhbGw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbi8vIFRPRE86IERvY3VtZW50IHRoaXMuXG5leHBvcnQgY29uc3Qgc2xvdCA9ICdjb25mZXJlbmNlJztcbiJdfQ==